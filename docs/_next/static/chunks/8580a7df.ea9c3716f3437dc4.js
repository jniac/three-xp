"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{1609:function(e,t,i){let s,r,n;i.d(t,{AEy:function(){return un},Fn:function(){return rS},Ilk:function(){return tt},Kj0:function(){return tk},R3C:function(){return rU},SPe:function(){return io},Sxh:function(){return xT},V7B:function(){return l5},XvJ:function(){return sm},YDX:function(){return m5},_12:function(){return sh},cJO:function(){return so},cPb:function(){return tQ},fzv:function(){return rA},hYO:function(){return op},p9q:function(){return xv},pD:function(){return xS},qzT:function(){return rP},tOc:function(){return m2},vBJ:function(){return tn},vhs:function(){return rD},vpu:function(){return fS},xsS:function(){return t2},yGw:function(){return eS}});let a="srgb",o="srgb-linear",l="display-p3-linear",h="linear",u="srgb",d="rec709";class c{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});let i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;let i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;let i=this._listeners[e];if(void 0!==i){let e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;let t=this._listeners[e.type];if(void 0!==t){e.target=this;let i=t.slice(0);for(let t=0,s=i.length;t<s;t++)i[t].call(this,e);e.target=null}}}let p=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],m=Math.PI/180,g=180/Math.PI;function f(){let e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(p[255&e]+p[e>>8&255]+p[e>>16&255]+p[e>>24&255]+"-"+p[255&t]+p[t>>8&255]+"-"+p[t>>16&15|64]+p[t>>24&255]+"-"+p[63&i|128]+p[i>>8&255]+"-"+p[i>>16&255]+p[i>>24&255]+p[255&s]+p[s>>8&255]+p[s>>16&255]+p[s>>24&255]).toLowerCase()}function y(e,t,i){return Math.max(t,Math.min(i,e))}function x(e,t,i){return(1-i)*e+i*t}function b(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw Error("Invalid component type.")}}function v(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw Error("Invalid component type.")}}let T={generateUUID:f,lerp:x};class S{constructor(e=0,t=0){S.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){let t=this.x,i=this.y,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6],this.y=s[1]*t+s[4]*i+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){let i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){let t=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===t?Math.PI/2:Math.acos(y(this.dot(e)/t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){let i=Math.cos(t),s=Math.sin(t),r=this.x-e.x,n=this.y-e.y;return this.x=r*i-n*s+e.x,this.y=r*s+n*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class _{constructor(e,t,i,s,r,n,a,o,l){_.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,i,s,r,n,a,o,l)}set(e,t,i,s,r,n,a,o,l){let h=this.elements;return h[0]=e,h[1]=s,h[2]=a,h[3]=t,h[4]=r,h[5]=o,h[6]=i,h[7]=n,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){let t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){let t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){let i=e.elements,s=t.elements,r=this.elements,n=i[0],a=i[3],o=i[6],l=i[1],h=i[4],u=i[7],d=i[2],c=i[5],p=i[8],m=s[0],g=s[3],f=s[6],y=s[1],x=s[4],b=s[7],v=s[2],T=s[5],S=s[8];return r[0]=n*m+a*y+o*v,r[3]=n*g+a*x+o*T,r[6]=n*f+a*b+o*S,r[1]=l*m+h*y+u*v,r[4]=l*g+h*x+u*T,r[7]=l*f+h*b+u*S,r[2]=d*m+c*y+p*v,r[5]=d*g+c*x+p*T,r[8]=d*f+c*b+p*S,this}multiplyScalar(e){let t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){let e=this.elements,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8];return t*n*h-t*a*l-i*r*h+i*a*o+s*r*l-s*n*o}invert(){let e=this.elements,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=h*n-a*l,d=a*o-h*r,c=l*r-n*o,p=t*u+i*d+s*c;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);let m=1/p;return e[0]=u*m,e[1]=(s*l-h*i)*m,e[2]=(a*i-s*n)*m,e[3]=d*m,e[4]=(h*t-s*o)*m,e[5]=(s*r-a*t)*m,e[6]=c*m,e[7]=(i*o-l*t)*m,e[8]=(n*t-i*r)*m,this}transpose(){let e;let t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){let t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,s,r,n,a){let o=Math.cos(r),l=Math.sin(r);return this.set(i*o,i*l,-i*(o*n+l*a)+n+e,-s*l,s*o,-s*(-l*n+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(M.makeScale(e,t)),this}rotate(e){return this.premultiply(M.makeRotation(-e)),this}translate(e,t){return this.premultiply(M.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){let t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){let t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){let i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return new this.constructor().fromArray(this.elements)}}let M=new _;function w(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;let N={};function A(e){e in N||(N[e]=!0,console.warn(e))}let R=new _().set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),C=new _().set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),E={[o]:{transfer:h,primaries:d,luminanceCoefficients:[.2126,.7152,.0722],toReference:e=>e,fromReference:e=>e},[a]:{transfer:u,primaries:d,luminanceCoefficients:[.2126,.7152,.0722],toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[l]:{transfer:h,primaries:"p3",luminanceCoefficients:[.2289,.6917,.0793],toReference:e=>e.applyMatrix3(C),fromReference:e=>e.applyMatrix3(R)},"display-p3":{transfer:u,primaries:"p3",luminanceCoefficients:[.2289,.6917,.0793],toReference:e=>e.convertSRGBToLinear().applyMatrix3(C),fromReference:e=>e.applyMatrix3(R).convertLinearToSRGB()}},B=new Set([o,l]),I={enabled:!0,_workingColorSpace:o,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(colorSpace){if(!B.has(colorSpace))throw Error(`Unsupported working color space, "${colorSpace}".`);this._workingColorSpace=colorSpace},convert:function(e,t,i){if(!1===this.enabled||t===i||!t||!i)return e;let s=E[t].toReference;return(0,E[i].fromReference)(s(e))},fromWorkingColorSpace:function(e,t){return this.convert(e,this._workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this._workingColorSpace)},getPrimaries:function(e){return E[e].primaries},getTransfer:function(e){return""===e?h:E[e].transfer},getLuminanceCoefficients:function(e,t=this._workingColorSpace){return e.fromArray(E[t].luminanceCoefficients)}};function P(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function F(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class U{static getDataURL(e){let t;if(/^data:/i.test(e.src)||"undefined"==typeof HTMLCanvasElement)return e.src;if(e instanceof HTMLCanvasElement)t=e;else{void 0===s&&(s=w("canvas")),s.width=e.width,s.height=e.height;let i=s.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=s}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){let t=w("canvas");t.width=e.width,t.height=e.height;let i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);let s=i.getImageData(0,0,e.width,e.height),r=s.data;for(let e=0;e<r.length;e++)r[e]=255*P(r[e]/255);return i.putImageData(s,0,0),t}if(!e.data)return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e;{let t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*P(t[e]/255)):t[e]=P(t[e]);return{data:t,width:e.width,height:e.height}}}}let O=0;class z{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:O++}),this.uuid=f(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){let t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];let i={uuid:this.uuid,url:""},s=this.data;if(null!==s){let e;if(Array.isArray(s)){e=[];for(let t=0,i=s.length;t<i;t++)s[t].isDataTexture?e.push(L(s[t].image)):e.push(L(s[t]))}else e=L(s);i.url=e}return t||(e.images[this.uuid]=i),i}}function L(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?U.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let D=0;class V extends c{constructor(e=V.DEFAULT_IMAGE,t=V.DEFAULT_MAPPING,i=1001,s=1001,r=1006,n=1008,a=1023,o=1009,l=V.DEFAULT_ANISOTROPY,h=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:D++}),this.uuid=f(),this.name="",this.source=new z(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=s,this.magFilter=r,this.minFilter=n,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new S(0,0),this.repeat=new S(1,1),this.center=new S(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new _,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=h,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){let t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];let i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case 1e3:e.x=e.x-Math.floor(e.x);break;case 1001:e.x=e.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case 1e3:e.y=e.y-Math.floor(e.y);break;case 1001:e.y=e.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}V.DEFAULT_IMAGE=null,V.DEFAULT_MAPPING=300,V.DEFAULT_ANISOTROPY=1;class k{constructor(e=0,t=0,i=0,s=1){k.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){let t=this.x,i=this.y,s=this.z,r=this.w,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*s+n[12]*r,this.y=n[1]*t+n[5]*i+n[9]*s+n[13]*r,this.z=n[2]*t+n[6]*i+n[10]*s+n[14]*r,this.w=n[3]*t+n[7]*i+n[11]*s+n[15]*r,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);let t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,s,r;let n=e.elements,a=n[0],o=n[4],l=n[8],h=n[1],u=n[5],d=n[9],c=n[2],p=n[6],m=n[10];if(.01>Math.abs(o-h)&&.01>Math.abs(l-c)&&.01>Math.abs(d-p)){if(.1>Math.abs(o+h)&&.1>Math.abs(l+c)&&.1>Math.abs(d+p)&&.1>Math.abs(a+u+m-3))return this.set(1,0,0,0),this;t=Math.PI;let e=(a+1)/2,n=(u+1)/2,g=(m+1)/2,f=(o+h)/4,y=(l+c)/4,x=(d+p)/4;return e>n&&e>g?e<.01?(i=0,s=.707106781,r=.707106781):(s=f/(i=Math.sqrt(e)),r=y/i):n>g?n<.01?(i=.707106781,s=0,r=.707106781):(i=f/(s=Math.sqrt(n)),r=x/s):g<.01?(i=.707106781,s=.707106781,r=0):(i=y/(r=Math.sqrt(g)),s=x/r),this.set(i,s,r,t),this}let g=Math.sqrt((p-d)*(p-d)+(l-c)*(l-c)+(h-o)*(h-o));return .001>Math.abs(g)&&(g=1),this.x=(p-d)/g,this.y=(l-c)/g,this.z=(h-o)/g,this.w=Math.acos((a+u+m-1)/2),this}setFromMatrixPosition(e){let t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){let i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class G extends c{constructor(e=1,t=1,i={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new k(0,0,e,t),this.scissorTest=!1,this.viewport=new k(0,0,e,t);let s=new V({width:e,height:t,depth:1},(i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:1006,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},i)).mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace);s.flipY=!1,s.generateMipmaps=i.generateMipmaps,s.internalFormat=i.internalFormat,this.textures=[];let r=i.count;for(let e=0;e<r;e++)this.textures[e]=s.clone(),this.textures[e].isRenderTargetTexture=!0;this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this.depthTexture=i.depthTexture,this.samples=i.samples}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let s=0,r=this.textures.length;s<r;s++)this.textures[s].image.width=e,this.textures[s].image.height=t,this.textures[s].image.depth=i;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,i=e.textures.length;t<i;t++)this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0;let t=Object.assign({},e.texture.image);return this.texture.source=new z(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class W extends G{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class H extends V{constructor(e=null,t=1,i=1,s=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class j{constructor(e=0,t=0,i=0,s=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=s}static slerpFlat(e,t,i,s,r,n,a){let o=i[s+0],l=i[s+1],h=i[s+2],u=i[s+3],d=r[n+0],c=r[n+1],p=r[n+2],m=r[n+3];if(0===a){e[t+0]=o,e[t+1]=l,e[t+2]=h,e[t+3]=u;return}if(1===a){e[t+0]=d,e[t+1]=c,e[t+2]=p,e[t+3]=m;return}if(u!==m||o!==d||l!==c||h!==p){let e=1-a,t=o*d+l*c+h*p+u*m,i=t>=0?1:-1,s=1-t*t;if(s>Number.EPSILON){let r=Math.sqrt(s),n=Math.atan2(r,t*i);e=Math.sin(e*n)/r,a=Math.sin(a*n)/r}let r=a*i;if(o=o*e+d*r,l=l*e+c*r,h=h*e+p*r,u=u*e+m*r,e===1-a){let e=1/Math.sqrt(o*o+l*l+h*h+u*u);o*=e,l*=e,h*=e,u*=e}}e[t]=o,e[t+1]=l,e[t+2]=h,e[t+3]=u}static multiplyQuaternionsFlat(e,t,i,s,r,n){let a=i[s],o=i[s+1],l=i[s+2],h=i[s+3],u=r[n],d=r[n+1],c=r[n+2],p=r[n+3];return e[t]=a*p+h*u+o*c-l*d,e[t+1]=o*p+h*d+l*u-a*c,e[t+2]=l*p+h*c+a*d-o*u,e[t+3]=h*p-a*u-o*d-l*c,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){let i=e._x,s=e._y,r=e._z,n=e._order,a=Math.cos,o=Math.sin,l=a(i/2),h=a(s/2),u=a(r/2),d=o(i/2),c=o(s/2),p=o(r/2);switch(n){case"XYZ":this._x=d*h*u+l*c*p,this._y=l*c*u-d*h*p,this._z=l*h*p+d*c*u,this._w=l*h*u-d*c*p;break;case"YXZ":this._x=d*h*u+l*c*p,this._y=l*c*u-d*h*p,this._z=l*h*p-d*c*u,this._w=l*h*u+d*c*p;break;case"ZXY":this._x=d*h*u-l*c*p,this._y=l*c*u+d*h*p,this._z=l*h*p+d*c*u,this._w=l*h*u-d*c*p;break;case"ZYX":this._x=d*h*u-l*c*p,this._y=l*c*u+d*h*p,this._z=l*h*p-d*c*u,this._w=l*h*u+d*c*p;break;case"YZX":this._x=d*h*u+l*c*p,this._y=l*c*u+d*h*p,this._z=l*h*p-d*c*u,this._w=l*h*u-d*c*p;break;case"XZY":this._x=d*h*u-l*c*p,this._y=l*c*u-d*h*p,this._z=l*h*p+d*c*u,this._w=l*h*u+d*c*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){let i=t/2,s=Math.sin(i);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){let t=e.elements,i=t[0],s=t[4],r=t[8],n=t[1],a=t[5],o=t[9],l=t[2],h=t[6],u=t[10],d=i+a+u;if(d>0){let e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(h-o)*e,this._y=(r-l)*e,this._z=(n-s)*e}else if(i>a&&i>u){let e=2*Math.sqrt(1+i-a-u);this._w=(h-o)/e,this._x=.25*e,this._y=(s+n)/e,this._z=(r+l)/e}else if(a>u){let e=2*Math.sqrt(1+a-i-u);this._w=(r-l)/e,this._x=(s+n)/e,this._y=.25*e,this._z=(o+h)/e}else{let e=2*Math.sqrt(1+u-i-a);this._w=(n-s)/e,this._x=(r+l)/e,this._y=(o+h)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0):(this._x=0,this._y=-e.z,this._z=e.y)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x),this._w=i,this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(y(this.dot(e),-1,1)))}rotateTowards(e,t){let i=this.angleTo(e);return 0===i||this.slerp(e,Math.min(1,t/i)),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){let i=e._x,s=e._y,r=e._z,n=e._w,a=t._x,o=t._y,l=t._z,h=t._w;return this._x=i*h+n*a+s*l-r*o,this._y=s*h+n*o+r*a-i*l,this._z=r*h+n*l+i*o-s*a,this._w=n*h-i*a-s*o-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);let i=this._x,s=this._y,r=this._z,n=this._w,a=n*e._w+i*e._x+s*e._y+r*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=n,this._x=i,this._y=s,this._z=r,this;let o=1-a*a;if(o<=Number.EPSILON){let e=1-t;return this._w=e*n+t*this._w,this._x=e*i+t*this._x,this._y=e*s+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}let l=Math.sqrt(o),h=Math.atan2(l,a),u=Math.sin((1-t)*h)/l,d=Math.sin(t*h)/l;return this._w=n*u+this._w*d,this._x=i*u+this._x*d,this._y=s*u+this._y*d,this._z=r*u+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){let e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),i=Math.random(),s=Math.sqrt(1-i),r=Math.sqrt(i);return this.set(s*Math.sin(e),s*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ${constructor(e=0,t=0,i=0){$.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(X.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(X.setFromAxisAngle(e,t))}applyMatrix3(e){let t=this.x,i=this.y,s=this.z,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6]*s,this.y=r[1]*t+r[4]*i+r[7]*s,this.z=r[2]*t+r[5]*i+r[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){let t=this.x,i=this.y,s=this.z,r=e.elements,n=1/(r[3]*t+r[7]*i+r[11]*s+r[15]);return this.x=(r[0]*t+r[4]*i+r[8]*s+r[12])*n,this.y=(r[1]*t+r[5]*i+r[9]*s+r[13])*n,this.z=(r[2]*t+r[6]*i+r[10]*s+r[14])*n,this}applyQuaternion(e){let t=this.x,i=this.y,s=this.z,r=e.x,n=e.y,a=e.z,o=e.w,l=2*(n*s-a*i),h=2*(a*t-r*s),u=2*(r*i-n*t);return this.x=t+o*l+n*u-a*h,this.y=i+o*h+a*l-r*u,this.z=s+o*u+r*h-n*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){let t=this.x,i=this.y,s=this.z,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*s,this.y=r[1]*t+r[5]*i+r[9]*s,this.z=r[2]*t+r[6]*i+r[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){let i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){let i=e.x,s=e.y,r=e.z,n=t.x,a=t.y,o=t.z;return this.x=s*o-r*a,this.y=r*n-i*o,this.z=i*a-s*n,this}projectOnVector(e){let t=e.lengthSq();if(0===t)return this.set(0,0,0);let i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return q.copy(this).projectOnVector(e),this.sub(q)}reflect(e){return this.sub(q.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){let t=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===t?Math.PI/2:Math.acos(y(this.dot(e)/t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return t*t+i*i+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){let s=Math.sin(t)*e;return this.x=s*Math.sin(i),this.y=Math.cos(t)*e,this.z=s*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){let t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){let t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){let e=Math.random()*Math.PI*2,t=2*Math.random()-1,i=Math.sqrt(1-t*t);return this.x=i*Math.cos(e),this.y=t,this.z=i*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}let q=new $,X=new j;class Y{constructor(e=new $(Infinity,Infinity,Infinity),t=new $(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint(K.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint(K.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){let i=K.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=Infinity,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);let i=e.geometry;if(void 0!==i){let s=i.getAttribute("position");if(!0===t&&void 0!==s&&!0!==e.isInstancedMesh)for(let t=0,i=s.count;t<i;t++)!0===e.isMesh?e.getVertexPosition(t,K):K.fromBufferAttribute(s,t),K.applyMatrix4(e.matrixWorld),this.expandByPoint(K);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Q.copy(e.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),Q.copy(i.boundingBox)),Q.applyMatrix4(e.matrixWorld),this.union(Q)}let s=e.children;for(let e=0,i=s.length;e<i;e++)this.expandByObject(s[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,K),K.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(en),ea.subVectors(this.max,en),Z.subVectors(e.a,en),ee.subVectors(e.b,en),et.subVectors(e.c,en),ei.subVectors(ee,Z),es.subVectors(et,ee),er.subVectors(Z,et);let t=[0,-ei.z,ei.y,0,-es.z,es.y,0,-er.z,er.y,ei.z,0,-ei.x,es.z,0,-es.x,er.z,0,-er.x,-ei.y,ei.x,0,-es.y,es.x,0,-er.y,er.x,0];return!!(eh(t,Z,ee,et,ea)&&eh(t=[1,0,0,0,1,0,0,0,1],Z,ee,et,ea))&&(eo.crossVectors(ei,es),eh(t=[eo.x,eo.y,eo.z],Z,ee,et,ea))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,K).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(K).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(J[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),J[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),J[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),J[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),J[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),J[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),J[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),J[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(J)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}let J=[new $,new $,new $,new $,new $,new $,new $,new $],K=new $,Q=new Y,Z=new $,ee=new $,et=new $,ei=new $,es=new $,er=new $,en=new $,ea=new $,eo=new $,el=new $;function eh(e,t,i,s,r){for(let n=0,a=e.length-3;n<=a;n+=3){el.fromArray(e,n);let a=r.x*Math.abs(el.x)+r.y*Math.abs(el.y)+r.z*Math.abs(el.z),o=t.dot(el),l=i.dot(el),h=s.dot(el);if(Math.max(-Math.max(o,l,h),Math.min(o,l,h))>a)return!1}return!0}let eu=new Y,ed=new $,ec=new $;class ep{constructor(e=new $,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){let i=this.center;void 0!==t?i.copy(t):eu.setFromPoints(e).getCenter(i);let s=0;for(let t=0,r=e.length;t<r;t++)s=Math.max(s,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(s),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){let t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){let i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?e.makeEmpty():(e.set(this.center,this.center),e.expandByScalar(this.radius)),e}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;ed.subVectors(e,this.center);let t=ed.lengthSq();if(t>this.radius*this.radius){let e=Math.sqrt(t),i=(e-this.radius)*.5;this.center.addScaledVector(ed,i/e),this.radius+=i}return this}union(e){return e.isEmpty()||(this.isEmpty()?this.copy(e):!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(ec.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(ed.copy(e.center).add(ec)),this.expandByPoint(ed.copy(e.center).sub(ec)))),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}}let em=new $,eg=new $,ef=new $,ey=new $,ex=new $,eb=new $,ev=new $;class eT{constructor(e=new $,t=new $(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,em)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);let i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){let t=em.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(em.copy(this.origin).addScaledVector(this.direction,t),em.distanceToSquared(e))}distanceSqToSegment(e,t,i,s){let r,n,a,o;eg.copy(e).add(t).multiplyScalar(.5),ef.copy(t).sub(e).normalize(),ey.copy(this.origin).sub(eg);let l=.5*e.distanceTo(t),h=-this.direction.dot(ef),u=ey.dot(this.direction),d=-ey.dot(ef),c=ey.lengthSq(),p=Math.abs(1-h*h);if(p>0){if(r=h*d-u,n=h*u-d,o=l*p,r>=0){if(n>=-o){if(n<=o){let e=1/p;r*=e,n*=e,a=r*(r+h*n+2*u)+n*(h*r+n+2*d)+c}else a=-(r=Math.max(0,-(h*(n=l)+u)))*r+n*(n+2*d)+c}else a=-(r=Math.max(0,-(h*(n=-l)+u)))*r+n*(n+2*d)+c}else n<=-o?(n=(r=Math.max(0,-(-h*l+u)))>0?-l:Math.min(Math.max(-l,-d),l),a=-r*r+n*(n+2*d)+c):n<=o?(r=0,a=(n=Math.min(Math.max(-l,-d),l))*(n+2*d)+c):(n=(r=Math.max(0,-(h*l+u)))>0?l:Math.min(Math.max(-l,-d),l),a=-r*r+n*(n+2*d)+c)}else n=h>0?-l:l,a=-(r=Math.max(0,-(h*n+u)))*r+n*(n+2*d)+c;return i&&i.copy(this.origin).addScaledVector(this.direction,r),s&&s.copy(eg).addScaledVector(ef,n),a}intersectSphere(e,t){em.subVectors(e.center,this.origin);let i=em.dot(this.direction),s=em.dot(em)-i*i,r=e.radius*e.radius;if(s>r)return null;let n=Math.sqrt(r-s),a=i-n,o=i+n;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){let t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;let i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){let i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){let t=e.distanceToPoint(this.origin);return!!(0===t||e.normal.dot(this.direction)*t<0)}intersectBox(e,t){let i,s,r,n,a,o;let l=1/this.direction.x,h=1/this.direction.y,u=1/this.direction.z,d=this.origin;return(l>=0?(i=(e.min.x-d.x)*l,s=(e.max.x-d.x)*l):(i=(e.max.x-d.x)*l,s=(e.min.x-d.x)*l),h>=0?(r=(e.min.y-d.y)*h,n=(e.max.y-d.y)*h):(r=(e.max.y-d.y)*h,n=(e.min.y-d.y)*h),i>n||r>s)?null:((r>i||isNaN(i))&&(i=r),(n<s||isNaN(s))&&(s=n),u>=0?(a=(e.min.z-d.z)*u,o=(e.max.z-d.z)*u):(a=(e.max.z-d.z)*u,o=(e.min.z-d.z)*u),i>o||a>s)?null:((a>i||i!=i)&&(i=a),(o<s||s!=s)&&(s=o),s<0)?null:this.at(i>=0?i:s,t)}intersectsBox(e){return null!==this.intersectBox(e,em)}intersectTriangle(e,t,i,s,r){let n;ex.subVectors(t,e),eb.subVectors(i,e),ev.crossVectors(ex,eb);let a=this.direction.dot(ev);if(a>0){if(s)return null;n=1}else{if(!(a<0))return null;n=-1,a=-a}ey.subVectors(this.origin,e);let o=n*this.direction.dot(eb.crossVectors(ey,eb));if(o<0)return null;let l=n*this.direction.dot(ex.cross(ey));if(l<0||o+l>a)return null;let h=-n*ey.dot(ev);return h<0?null:this.at(h/a,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class eS{constructor(e,t,i,s,r,n,a,o,l,h,u,d,c,p,m,g){eS.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,i,s,r,n,a,o,l,h,u,d,c,p,m,g)}set(e,t,i,s,r,n,a,o,l,h,u,d,c,p,m,g){let f=this.elements;return f[0]=e,f[4]=t,f[8]=i,f[12]=s,f[1]=r,f[5]=n,f[9]=a,f[13]=o,f[2]=l,f[6]=h,f[10]=u,f[14]=d,f[3]=c,f[7]=p,f[11]=m,f[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new eS().fromArray(this.elements)}copy(e){let t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){let t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){let t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){let t=this.elements,i=e.elements,s=1/e_.setFromMatrixColumn(e,0).length(),r=1/e_.setFromMatrixColumn(e,1).length(),n=1/e_.setFromMatrixColumn(e,2).length();return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=0,t[4]=i[4]*r,t[5]=i[5]*r,t[6]=i[6]*r,t[7]=0,t[8]=i[8]*n,t[9]=i[9]*n,t[10]=i[10]*n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){let t=this.elements,i=e.x,s=e.y,r=e.z,n=Math.cos(i),a=Math.sin(i),o=Math.cos(s),l=Math.sin(s),h=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){let e=n*h,i=n*u,s=a*h,r=a*u;t[0]=o*h,t[4]=-o*u,t[8]=l,t[1]=i+s*l,t[5]=e-r*l,t[9]=-a*o,t[2]=r-e*l,t[6]=s+i*l,t[10]=n*o}else if("YXZ"===e.order){let e=o*h,i=o*u,s=l*h,r=l*u;t[0]=e+r*a,t[4]=s*a-i,t[8]=n*l,t[1]=n*u,t[5]=n*h,t[9]=-a,t[2]=i*a-s,t[6]=r+e*a,t[10]=n*o}else if("ZXY"===e.order){let e=o*h,i=o*u,s=l*h,r=l*u;t[0]=e-r*a,t[4]=-n*u,t[8]=s+i*a,t[1]=i+s*a,t[5]=n*h,t[9]=r-e*a,t[2]=-n*l,t[6]=a,t[10]=n*o}else if("ZYX"===e.order){let e=n*h,i=n*u,s=a*h,r=a*u;t[0]=o*h,t[4]=s*l-i,t[8]=e*l+r,t[1]=o*u,t[5]=r*l+e,t[9]=i*l-s,t[2]=-l,t[6]=a*o,t[10]=n*o}else if("YZX"===e.order){let e=n*o,i=n*l,s=a*o,r=a*l;t[0]=o*h,t[4]=r-e*u,t[8]=s*u+i,t[1]=u,t[5]=n*h,t[9]=-a*h,t[2]=-l*h,t[6]=i*u+s,t[10]=e-r*u}else if("XZY"===e.order){let e=n*o,i=n*l,s=a*o,r=a*l;t[0]=o*h,t[4]=-u,t[8]=l*h,t[1]=e*u+r,t[5]=n*h,t[9]=i*u-s,t[2]=s*u-i,t[6]=a*h,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(ew,e,eN)}lookAt(e,t,i){let s=this.elements;return eC.subVectors(e,t),0===eC.lengthSq()&&(eC.z=1),eC.normalize(),eA.crossVectors(i,eC),0===eA.lengthSq()&&(1===Math.abs(i.z)?eC.x+=1e-4:eC.z+=1e-4,eC.normalize(),eA.crossVectors(i,eC)),eA.normalize(),eR.crossVectors(eC,eA),s[0]=eA.x,s[4]=eR.x,s[8]=eC.x,s[1]=eA.y,s[5]=eR.y,s[9]=eC.y,s[2]=eA.z,s[6]=eR.z,s[10]=eC.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){let i=e.elements,s=t.elements,r=this.elements,n=i[0],a=i[4],o=i[8],l=i[12],h=i[1],u=i[5],d=i[9],c=i[13],p=i[2],m=i[6],g=i[10],f=i[14],y=i[3],x=i[7],b=i[11],v=i[15],T=s[0],S=s[4],_=s[8],M=s[12],w=s[1],N=s[5],A=s[9],R=s[13],C=s[2],E=s[6],B=s[10],I=s[14],P=s[3],F=s[7],U=s[11],O=s[15];return r[0]=n*T+a*w+o*C+l*P,r[4]=n*S+a*N+o*E+l*F,r[8]=n*_+a*A+o*B+l*U,r[12]=n*M+a*R+o*I+l*O,r[1]=h*T+u*w+d*C+c*P,r[5]=h*S+u*N+d*E+c*F,r[9]=h*_+u*A+d*B+c*U,r[13]=h*M+u*R+d*I+c*O,r[2]=p*T+m*w+g*C+f*P,r[6]=p*S+m*N+g*E+f*F,r[10]=p*_+m*A+g*B+f*U,r[14]=p*M+m*R+g*I+f*O,r[3]=y*T+x*w+b*C+v*P,r[7]=y*S+x*N+b*E+v*F,r[11]=y*_+x*A+b*B+v*U,r[15]=y*M+x*R+b*I+v*O,this}multiplyScalar(e){let t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){let e=this.elements,t=e[0],i=e[4],s=e[8],r=e[12],n=e[1],a=e[5],o=e[9],l=e[13],h=e[2],u=e[6],d=e[10],c=e[14],p=e[3];return p*(+r*o*u-s*l*u-r*a*d+i*l*d+s*a*c-i*o*c)+e[7]*(+t*o*c-t*l*d+r*n*d-s*n*c+s*l*h-r*o*h)+e[11]*(+t*l*u-t*a*c-r*n*u+i*n*c+r*a*h-i*l*h)+e[15]*(-s*a*h-t*o*u+t*a*d+s*n*u-i*n*d+i*o*h)}transpose(){let e;let t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(e,t,i){let s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=i),this}invert(){let e=this.elements,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=e[9],d=e[10],c=e[11],p=e[12],m=e[13],g=e[14],f=e[15],y=u*g*l-m*d*l+m*o*c-a*g*c-u*o*f+a*d*f,x=p*d*l-h*g*l-p*o*c+n*g*c+h*o*f-n*d*f,b=h*m*l-p*u*l+p*a*c-n*m*c-h*a*f+n*u*f,v=p*u*o-h*m*o-p*a*d+n*m*d+h*a*g-n*u*g,T=t*y+i*x+s*b+r*v;if(0===T)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);let S=1/T;return e[0]=y*S,e[1]=(m*d*r-u*g*r-m*s*c+i*g*c+u*s*f-i*d*f)*S,e[2]=(a*g*r-m*o*r+m*s*l-i*g*l-a*s*f+i*o*f)*S,e[3]=(u*o*r-a*d*r-u*s*l+i*d*l+a*s*c-i*o*c)*S,e[4]=x*S,e[5]=(h*g*r-p*d*r+p*s*c-t*g*c-h*s*f+t*d*f)*S,e[6]=(p*o*r-n*g*r-p*s*l+t*g*l+n*s*f-t*o*f)*S,e[7]=(n*d*r-h*o*r+h*s*l-t*d*l-n*s*c+t*o*c)*S,e[8]=b*S,e[9]=(p*u*r-h*m*r-p*i*c+t*m*c+h*i*f-t*u*f)*S,e[10]=(n*m*r-p*a*r+p*i*l-t*m*l-n*i*f+t*a*f)*S,e[11]=(h*a*r-n*u*r-h*i*l+t*u*l+n*i*c-t*a*c)*S,e[12]=v*S,e[13]=(h*m*s-p*u*s+p*i*d-t*m*d-h*i*g+t*u*g)*S,e[14]=(p*a*s-n*m*s-p*i*o+t*m*o+n*i*g-t*a*g)*S,e[15]=(n*u*s-h*a*s+h*i*o-t*u*o-n*i*d+t*a*d)*S,this}scale(e){let t=this.elements,i=e.x,s=e.y,r=e.z;return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,this}getMaxScaleOnAxis(){let e=this.elements;return Math.sqrt(Math.max(e[0]*e[0]+e[1]*e[1]+e[2]*e[2],e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){let t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){let t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){let t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){let i=Math.cos(t),s=Math.sin(t),r=1-i,n=e.x,a=e.y,o=e.z,l=r*n,h=r*a;return this.set(l*n+i,l*a-s*o,l*o+s*a,0,l*a+s*o,h*a+i,h*o-s*n,0,l*o-s*a,h*o+s*n,r*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,s,r,n){return this.set(1,i,r,0,e,1,n,0,t,s,1,0,0,0,0,1),this}compose(e,t,i){let s=this.elements,r=t._x,n=t._y,a=t._z,o=t._w,l=r+r,h=n+n,u=a+a,d=r*l,c=r*h,p=r*u,m=n*h,g=n*u,f=a*u,y=o*l,x=o*h,b=o*u,v=i.x,T=i.y,S=i.z;return s[0]=(1-(m+f))*v,s[1]=(c+b)*v,s[2]=(p-x)*v,s[3]=0,s[4]=(c-b)*T,s[5]=(1-(d+f))*T,s[6]=(g+y)*T,s[7]=0,s[8]=(p+x)*S,s[9]=(g-y)*S,s[10]=(1-(d+m))*S,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,i){let s=this.elements,r=e_.set(s[0],s[1],s[2]).length(),n=e_.set(s[4],s[5],s[6]).length(),a=e_.set(s[8],s[9],s[10]).length();0>this.determinant()&&(r=-r),e.x=s[12],e.y=s[13],e.z=s[14],eM.copy(this);let o=1/r,l=1/n,h=1/a;return eM.elements[0]*=o,eM.elements[1]*=o,eM.elements[2]*=o,eM.elements[4]*=l,eM.elements[5]*=l,eM.elements[6]*=l,eM.elements[8]*=h,eM.elements[9]*=h,eM.elements[10]*=h,t.setFromRotationMatrix(eM),i.x=r,i.y=n,i.z=a,this}makePerspective(e,t,i,s,r,n,a=2e3){let o,l;let h=this.elements;if(2e3===a)o=-(n+r)/(n-r),l=-2*n*r/(n-r);else if(2001===a)o=-n/(n-r),l=-n*r/(n-r);else throw Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);return h[0]=2*r/(t-e),h[4]=0,h[8]=(t+e)/(t-e),h[12]=0,h[1]=0,h[5]=2*r/(i-s),h[9]=(i+s)/(i-s),h[13]=0,h[2]=0,h[6]=0,h[10]=o,h[14]=l,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(e,t,i,s,r,n,a=2e3){let o,l;let h=this.elements,u=1/(t-e),d=1/(i-s),c=1/(n-r);if(2e3===a)o=(n+r)*c,l=-2*c;else if(2001===a)o=r*c,l=-1*c;else throw Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);return h[0]=2*u,h[4]=0,h[8]=0,h[12]=-((t+e)*u),h[1]=0,h[5]=2*d,h[9]=0,h[13]=-((i+s)*d),h[2]=0,h[6]=0,h[10]=l,h[14]=-o,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(e){let t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){let i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}let e_=new $,eM=new eS,ew=new $(0,0,0),eN=new $(1,1,1),eA=new $,eR=new $,eC=new $,eE=new eS,eB=new j;class eI{constructor(e=0,t=0,i=0,s=eI.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=s}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,s=this._order){return this._x=e,this._y=t,this._z=i,this._order=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){let s=e.elements,r=s[0],n=s[4],a=s[8],o=s[1],l=s[5],h=s[9],u=s[2],d=s[6],c=s[10];switch(t){case"XYZ":this._y=Math.asin(y(a,-1,1)),.9999999>Math.abs(a)?(this._x=Math.atan2(-h,c),this._z=Math.atan2(-n,r)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-y(h,-1,1)),.9999999>Math.abs(h)?(this._y=Math.atan2(a,c),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(y(d,-1,1)),.9999999>Math.abs(d)?(this._y=Math.atan2(-u,c),this._z=Math.atan2(-n,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-y(u,-1,1)),.9999999>Math.abs(u)?(this._x=Math.atan2(d,c),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-n,l));break;case"YZX":this._z=Math.asin(y(o,-1,1)),.9999999>Math.abs(o)?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(a,c));break;case"XZY":this._z=Math.asin(-y(n,-1,1)),.9999999>Math.abs(n)?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-h,c),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return eE.makeRotationFromQuaternion(e),this.setFromRotationMatrix(eE,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return eB.setFromEuler(this),this.setFromQuaternion(eB,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}eI.DEFAULT_ORDER="XYZ";class eP{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!=0}isEnabled(e){return(this.mask&(1<<e|0))!=0}}let eF=0,eU=new $,eO=new j,ez=new eS,eL=new $,eD=new $,eV=new $,ek=new j,eG=new $(1,0,0),eW=new $(0,1,0),eH=new $(0,0,1),ej={type:"added"},e$={type:"removed"},eq={type:"childadded",child:null},eX={type:"childremoved",child:null};class eY extends c{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:eF++}),this.uuid=f(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=eY.DEFAULT_UP.clone();let e=new $,t=new eI,i=new j,s=new $(1,1,1);t._onChange(function(){i.setFromEuler(t,!1)}),i._onChange(function(){t.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new eS},normalMatrix:{value:new _}}),this.matrix=new eS,this.matrixWorld=new eS,this.matrixAutoUpdate=eY.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=eY.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new eP,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return eO.setFromAxisAngle(e,t),this.quaternion.multiply(eO),this}rotateOnWorldAxis(e,t){return eO.setFromAxisAngle(e,t),this.quaternion.premultiply(eO),this}rotateX(e){return this.rotateOnAxis(eG,e)}rotateY(e){return this.rotateOnAxis(eW,e)}rotateZ(e){return this.rotateOnAxis(eH,e)}translateOnAxis(e,t){return eU.copy(e).applyQuaternion(this.quaternion),this.position.add(eU.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(eG,e)}translateY(e){return this.translateOnAxis(eW,e)}translateZ(e){return this.translateOnAxis(eH,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(ez.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?eL.copy(e):eL.set(e,t,i);let s=this.parent;this.updateWorldMatrix(!0,!1),eD.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?ez.lookAt(eD,eL,this.up):ez.lookAt(eL,eD,this.up),this.quaternion.setFromRotationMatrix(ez),s&&(ez.extractRotation(s.matrixWorld),eO.setFromRotationMatrix(ez),this.quaternion.premultiply(eO.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?console.error("THREE.Object3D.add: object can't be added as a child of itself.",e):e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(ej),eq.child=e,this.dispatchEvent(eq),eq.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}let t=this.children.indexOf(e);return -1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(e$),eX.child=e,this.dispatchEvent(eX),eX.child=null),this}removeFromParent(){let e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),ez.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),ez.multiply(e.parent.matrixWorld)),e.applyMatrix4(ez),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(ej),eq.child=e,this.dispatchEvent(eq),eq.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,s=this.children.length;i<s;i++){let s=this.children[i].getObjectByProperty(e,t);if(void 0!==s)return s}}getObjectsByProperty(e,t,i=[]){this[e]===t&&i.push(this);let s=this.children;for(let r=0,n=s.length;r<n;r++)s[r].getObjectsByProperty(e,t,i);return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(eD,e,eV),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(eD,ek,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);let t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);let t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);let t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverseVisible(e)}traverseAncestors(e){let t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);let t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].updateMatrixWorld(e)}updateWorldMatrix(e,t){let i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){let e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){let t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});let s={};function r(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),s.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(s.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(s.type="BatchedMesh",s.perObjectFrustumCulled=this.perObjectFrustumCulled,s.sortObjects=this.sortObjects,s.drawRanges=this._drawRanges,s.reservedRanges=this._reservedRanges,s.visibility=this._visibility,s.active=this._active,s.bounds=this._bounds.map(e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()})),s.maxInstanceCount=this._maxInstanceCount,s.maxVertexCount=this._maxVertexCount,s.maxIndexCount=this._maxIndexCount,s.geometryInitialized=this._geometryInitialized,s.geometryCount=this._geometryCount,s.matricesTexture=this._matricesTexture.toJSON(e),null!==this._colorsTexture&&(s.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(s.boundingSphere={center:s.boundingSphere.center.toArray(),radius:s.boundingSphere.radius}),null!==this.boundingBox&&(s.boundingBox={min:s.boundingBox.min.toArray(),max:s.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?s.background=this.background.toJSON():this.background.isTexture&&(s.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(s.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){s.geometry=r(e.geometries,this.geometry);let t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){let i=t.shapes;if(Array.isArray(i))for(let t=0,s=i.length;t<s;t++){let s=i[t];r(e.shapes,s)}else r(e.shapes,i)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),void 0!==this.material){if(Array.isArray(this.material)){let t=[];for(let i=0,s=this.material.length;i<s;i++)t.push(r(e.materials,this.material[i]));s.material=t}else s.material=r(e.materials,this.material)}if(this.children.length>0){s.children=[];for(let t=0;t<this.children.length;t++)s.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){s.animations=[];for(let t=0;t<this.animations.length;t++){let i=this.animations[t];s.animations.push(r(e.animations,i))}}if(t){let t=n(e.geometries),s=n(e.materials),r=n(e.textures),a=n(e.images),o=n(e.shapes),l=n(e.skeletons),h=n(e.animations),u=n(e.nodes);t.length>0&&(i.geometries=t),s.length>0&&(i.materials=s),r.length>0&&(i.textures=r),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),h.length>0&&(i.animations=h),u.length>0&&(i.nodes=u)}return i.object=s,i;function n(e){let t=[];for(let i in e){let s=e[i];delete s.metadata,t.push(s)}return t}}clone(e){return new this.constructor().copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){let i=e.children[t];this.add(i.clone())}return this}}eY.DEFAULT_UP=new $(0,1,0),eY.DEFAULT_MATRIX_AUTO_UPDATE=!0,eY.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;let eJ=new $,eK=new $,eQ=new $,eZ=new $,e0=new $,e1=new $,e2=new $,e3=new $,e4=new $,e5=new $;class e6{constructor(e=new $,t=new $,i=new $){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,s){s.subVectors(i,t),eJ.subVectors(e,t),s.cross(eJ);let r=s.lengthSq();return r>0?s.multiplyScalar(1/Math.sqrt(r)):s.set(0,0,0)}static getBarycoord(e,t,i,s,r){eJ.subVectors(s,t),eK.subVectors(i,t),eQ.subVectors(e,t);let n=eJ.dot(eJ),a=eJ.dot(eK),o=eJ.dot(eQ),l=eK.dot(eK),h=eK.dot(eQ),u=n*l-a*a;if(0===u)return r.set(0,0,0),null;let d=1/u,c=(l*o-a*h)*d,p=(n*h-a*o)*d;return r.set(1-c-p,p,c)}static containsPoint(e,t,i,s){return null!==this.getBarycoord(e,t,i,s,eZ)&&eZ.x>=0&&eZ.y>=0&&eZ.x+eZ.y<=1}static getInterpolation(e,t,i,s,r,n,a,o){return null===this.getBarycoord(e,t,i,s,eZ)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,eZ.x),o.addScaledVector(n,eZ.y),o.addScaledVector(a,eZ.z),o)}static isFrontFacing(e,t,i,s){return eJ.subVectors(i,t),eK.subVectors(e,t),0>eJ.cross(eK).dot(s)}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,s){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[s]),this}setFromAttributeAndIndices(e,t,i,s){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,s),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return eJ.subVectors(this.c,this.b),eK.subVectors(this.a,this.b),.5*eJ.cross(eK).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return e6.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return e6.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,i,s,r){return e6.getInterpolation(e,this.a,this.b,this.c,t,i,s,r)}containsPoint(e){return e6.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return e6.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){let i,s;let r=this.a,n=this.b,a=this.c;e0.subVectors(n,r),e1.subVectors(a,r),e3.subVectors(e,r);let o=e0.dot(e3),l=e1.dot(e3);if(o<=0&&l<=0)return t.copy(r);e4.subVectors(e,n);let h=e0.dot(e4),u=e1.dot(e4);if(h>=0&&u<=h)return t.copy(n);let d=o*u-h*l;if(d<=0&&o>=0&&h<=0)return i=o/(o-h),t.copy(r).addScaledVector(e0,i);e5.subVectors(e,a);let c=e0.dot(e5),p=e1.dot(e5);if(p>=0&&c<=p)return t.copy(a);let m=c*l-o*p;if(m<=0&&l>=0&&p<=0)return s=l/(l-p),t.copy(r).addScaledVector(e1,s);let g=h*p-c*u;if(g<=0&&u-h>=0&&c-p>=0)return e2.subVectors(a,n),s=(u-h)/(u-h+(c-p)),t.copy(n).addScaledVector(e2,s);let f=1/(g+m+d);return i=m*f,s=d*f,t.copy(r).addScaledVector(e0,i).addScaledVector(e1,s)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let e8={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},e7={h:0,s:0,l:0},e9={h:0,s:0,l:0};function te(e,t,i){return(i<0&&(i+=1),i>1&&(i-=1),i<1/6)?e+(t-e)*6*i:i<.5?t:i<2/3?e+(t-e)*6*(2/3-i):e}class tt{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){return void 0===t&&void 0===i?e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e):this.setRGB(e,t,i),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=a){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,I.toWorkingColorSpace(this,t),this}setRGB(e,t,i,s=I.workingColorSpace){return this.r=e,this.g=t,this.b=i,I.toWorkingColorSpace(this,s),this}setHSL(e,t,i,s=I.workingColorSpace){if(e=(e%1+1)%1,t=y(t,0,1),i=y(i,0,1),0===t)this.r=this.g=this.b=i;else{let s=i<=.5?i*(1+t):i+t-i*t,r=2*i-s;this.r=te(r,s,e+1/3),this.g=te(r,s,e),this.b=te(r,s,e-1/3)}return I.toWorkingColorSpace(this,s),this}setStyle(e,t=a){let i;function s(t){void 0!==t&&1>parseFloat(t)&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;let n=i[1],a=i[2];switch(n){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){let s=i[1],r=s.length;if(3===r)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(s,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=a){let i=e8[e.toLowerCase()];return void 0!==i?this.setHex(i,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=P(e.r),this.g=P(e.g),this.b=P(e.b),this}copyLinearToSRGB(e){return this.r=F(e.r),this.g=F(e.g),this.b=F(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=a){return I.fromWorkingColorSpace(ti.copy(this),e),65536*Math.round(y(255*ti.r,0,255))+256*Math.round(y(255*ti.g,0,255))+Math.round(y(255*ti.b,0,255))}getHexString(e=a){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=I.workingColorSpace){let i,s;I.fromWorkingColorSpace(ti.copy(this),t);let r=ti.r,n=ti.g,a=ti.b,o=Math.max(r,n,a),l=Math.min(r,n,a),h=(l+o)/2;if(l===o)i=0,s=0;else{let e=o-l;switch(s=h<=.5?e/(o+l):e/(2-o-l),o){case r:i=(n-a)/e+(n<a?6:0);break;case n:i=(a-r)/e+2;break;case a:i=(r-n)/e+4}i/=6}return e.h=i,e.s=s,e.l=h,e}getRGB(e,t=I.workingColorSpace){return I.fromWorkingColorSpace(ti.copy(this),t),e.r=ti.r,e.g=ti.g,e.b=ti.b,e}getStyle(e=a){I.fromWorkingColorSpace(ti.copy(this),e);let t=ti.r,i=ti.g,s=ti.b;return e!==a?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${s.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*i)},${Math.round(255*s)})`}offsetHSL(e,t,i){return this.getHSL(e7),this.setHSL(e7.h+e,e7.s+t,e7.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(e7),e.getHSL(e9);let i=x(e7.h,e9.h,t),s=x(e7.s,e9.s,t),r=x(e7.l,e9.l,t);return this.setHSL(i,s,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){let t=this.r,i=this.g,s=this.b,r=e.elements;return this.r=r[0]*t+r[3]*i+r[6]*s,this.g=r[1]*t+r[4]*i+r[7]*s,this.b=r[2]*t+r[5]*i+r[8]*s,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let ti=new tt;tt.NAMES=e8;let ts=0;class tr extends c{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:ts++}),this.uuid=f(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new tt(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=7680,this.stencilZFail=7680,this.stencilZPass=7680,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(let t in e){let i=e[t];if(void 0===i){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}let s=this[t];if(void 0===s){console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`);continue}s&&s.isColor?s.set(i):s&&s.isVector3&&i&&i.isVector3?s.copy(i):this[t]=i}}toJSON(e){let t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});let i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function s(e){let t=[];for(let i in e){let s=e[i];delete s.metadata,t.push(s)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),100!==this.blendEquation&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),7680!==this.stencilFail&&(i.stencilFail=this.stencilFail),7680!==this.stencilZFail&&(i.stencilZFail=this.stencilZFail),7680!==this.stencilZPass&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),t){let t=s(e.textures),r=s(e.images);t.length>0&&(i.textures=t),r.length>0&&(i.images=r)}return i}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;let t=e.clippingPlanes,i=null;if(null!==t){let e=t.length;i=Array(e);for(let s=0;s!==e;++s)i[s]=t[s].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}}class tn extends tr{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new tt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new eI,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}let ta=function(){let e=new ArrayBuffer(4),t=new Float32Array(e),i=new Uint32Array(e),s=new Uint32Array(512),r=new Uint32Array(512);for(let e=0;e<256;++e){let t=e-127;t<-27?(s[e]=0,s[256|e]=32768,r[e]=24,r[256|e]=24):t<-14?(s[e]=1024>>-t-14,s[256|e]=1024>>-t-14|32768,r[e]=-t-1,r[256|e]=-t-1):t<=15?(s[e]=t+15<<10,s[256|e]=t+15<<10|32768,r[e]=13,r[256|e]=13):t<128?(s[e]=31744,s[256|e]=64512,r[e]=24,r[256|e]=24):(s[e]=31744,s[256|e]=64512,r[e]=13,r[256|e]=13)}let n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,i=0;for(;(8388608&t)==0;)t<<=1,i-=8388608;t&=-8388609,i+=947912704,n[e]=t|i}for(let e=1024;e<2048;++e)n[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(o[e]=1024);return{floatView:t,uint32View:i,baseTable:s,shiftTable:r,mantissaTable:n,exponentTable:a,offsetTable:o}}();function to(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=y(e,-65504,65504),ta.floatView[0]=e;let t=ta.uint32View[0],i=t>>23&511;return ta.baseTable[i]+((8388607&t)>>ta.shiftTable[i])}function tl(e){let t=e>>10;return ta.uint32View[0]=ta.mantissaTable[ta.offsetTable[t]+(1023&e)]+ta.exponentTable[t],ta.floatView[0]}let th=new $,tu=new S;class td{constructor(e,t,i=!1){if(Array.isArray(e))throw TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i,this.usage=35044,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=1015,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}get updateRange(){return A("THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let s=0,r=this.itemSize;s<r;s++)this.array[e+s]=t.array[i+s];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)tu.fromBufferAttribute(this,t),tu.applyMatrix3(e),this.setXY(t,tu.x,tu.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)th.fromBufferAttribute(this,t),th.applyMatrix3(e),this.setXYZ(t,th.x,th.y,th.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)th.fromBufferAttribute(this,t),th.applyMatrix4(e),this.setXYZ(t,th.x,th.y,th.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)th.fromBufferAttribute(this,t),th.applyNormalMatrix(e),this.setXYZ(t,th.x,th.y,th.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)th.fromBufferAttribute(this,t),th.transformDirection(e),this.setXYZ(t,th.x,th.y,th.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=b(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=v(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=b(t,this.array)),t}setX(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=b(t,this.array)),t}setY(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=b(t,this.array)),t}setZ(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=b(t,this.array)),t}setW(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,s){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this}setXYZW(e,t,i,s,r){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array),r=v(r,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){let e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class tc extends td{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class tp extends td{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class tm extends td{constructor(e,t,i){super(new Uint16Array(e),t,i),this.isFloat16BufferAttribute=!0}getX(e){let t=tl(this.array[e*this.itemSize]);return this.normalized&&(t=b(t,this.array)),t}setX(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize]=to(t),this}getY(e){let t=tl(this.array[e*this.itemSize+1]);return this.normalized&&(t=b(t,this.array)),t}setY(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+1]=to(t),this}getZ(e){let t=tl(this.array[e*this.itemSize+2]);return this.normalized&&(t=b(t,this.array)),t}setZ(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+2]=to(t),this}getW(e){let t=tl(this.array[e*this.itemSize+3]);return this.normalized&&(t=b(t,this.array)),t}setW(e,t){return this.normalized&&(t=v(t,this.array)),this.array[e*this.itemSize+3]=to(t),this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array)),this.array[e+0]=to(t),this.array[e+1]=to(i),this}setXYZ(e,t,i,s){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array)),this.array[e+0]=to(t),this.array[e+1]=to(i),this.array[e+2]=to(s),this}setXYZW(e,t,i,s,r){return e*=this.itemSize,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array),r=v(r,this.array)),this.array[e+0]=to(t),this.array[e+1]=to(i),this.array[e+2]=to(s),this.array[e+3]=to(r),this}}class tg extends td{constructor(e,t,i){super(new Float32Array(e),t,i)}}let tf=0,ty=new eS,tx=new eY,tb=new $,tv=new Y,tT=new Y,tS=new $;class t_ extends c{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:tf++}),this.uuid=f(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(!function(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}(e)?tc:tp)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){let t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);let i=this.attributes.normal;if(void 0!==i){let t=new _().getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}let s=this.attributes.tangent;return void 0!==s&&(s.transformDirection(e),s.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return ty.makeRotationFromQuaternion(e),this.applyMatrix4(ty),this}rotateX(e){return ty.makeRotationX(e),this.applyMatrix4(ty),this}rotateY(e){return ty.makeRotationY(e),this.applyMatrix4(ty),this}rotateZ(e){return ty.makeRotationZ(e),this.applyMatrix4(ty),this}translate(e,t,i){return ty.makeTranslation(e,t,i),this.applyMatrix4(ty),this}scale(e,t,i){return ty.makeScale(e,t,i),this.applyMatrix4(ty),this}lookAt(e){return tx.lookAt(e),tx.updateMatrix(),this.applyMatrix4(tx.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(tb).negate(),this.translate(tb.x,tb.y,tb.z),this}setFromPoints(e){let t=[];for(let i=0,s=e.length;i<s;i++){let s=e[i];t.push(s.x,s.y,s.z||0)}return this.setAttribute("position",new tg(t,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Y);let e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new $(-1/0,-1/0,-1/0),new $(Infinity,Infinity,Infinity));return}if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){let i=t[e];tv.setFromBufferAttribute(i),this.morphTargetsRelative?(tS.addVectors(this.boundingBox.min,tv.min),this.boundingBox.expandByPoint(tS),tS.addVectors(this.boundingBox.max,tv.max),this.boundingBox.expandByPoint(tS)):(this.boundingBox.expandByPoint(tv.min),this.boundingBox.expandByPoint(tv.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ep);let e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new $,1/0);return}if(e){let i=this.boundingSphere.center;if(tv.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){let i=t[e];tT.setFromBufferAttribute(i),this.morphTargetsRelative?(tS.addVectors(tv.min,tT.min),tv.expandByPoint(tS),tS.addVectors(tv.max,tT.max),tv.expandByPoint(tS)):(tv.expandByPoint(tT.min),tv.expandByPoint(tT.max))}tv.getCenter(i);let s=0;for(let t=0,r=e.count;t<r;t++)tS.fromBufferAttribute(e,t),s=Math.max(s,i.distanceToSquared(tS));if(t)for(let r=0,n=t.length;r<n;r++){let n=t[r],a=this.morphTargetsRelative;for(let t=0,r=n.count;t<r;t++)tS.fromBufferAttribute(n,t),a&&(tb.fromBufferAttribute(e,t),tS.add(tb)),s=Math.max(s,i.distanceToSquared(tS))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){let e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}let i=t.position,s=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new td(new Float32Array(4*i.count),4));let n=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<i.count;e++)a[e]=new $,o[e]=new $;let l=new $,h=new $,u=new $,d=new S,c=new S,p=new S,m=new $,g=new $,f=this.groups;0===f.length&&(f=[{start:0,count:e.count}]);for(let t=0,s=f.length;t<s;++t){let s=f[t],n=s.start,y=s.count;for(let t=n,s=n+y;t<s;t+=3)!function(e,t,s){l.fromBufferAttribute(i,e),h.fromBufferAttribute(i,t),u.fromBufferAttribute(i,s),d.fromBufferAttribute(r,e),c.fromBufferAttribute(r,t),p.fromBufferAttribute(r,s),h.sub(l),u.sub(l),c.sub(d),p.sub(d);let n=1/(c.x*p.y-p.x*c.y);isFinite(n)&&(m.copy(h).multiplyScalar(p.y).addScaledVector(u,-c.y).multiplyScalar(n),g.copy(u).multiplyScalar(c.x).addScaledVector(h,-p.x).multiplyScalar(n),a[e].add(m),a[t].add(m),a[s].add(m),o[e].add(g),o[t].add(g),o[s].add(g))}(e.getX(t+0),e.getX(t+1),e.getX(t+2))}let y=new $,x=new $,b=new $,v=new $;function T(e){b.fromBufferAttribute(s,e),v.copy(b);let t=a[e];y.copy(t),y.sub(b.multiplyScalar(b.dot(t))).normalize(),x.crossVectors(v,t);let i=x.dot(o[e]);n.setXYZW(e,y.x,y.y,y.z,i<0?-1:1)}for(let t=0,i=f.length;t<i;++t){let i=f[t],s=i.start,r=i.count;for(let t=s,i=s+r;t<i;t+=3)T(e.getX(t+0)),T(e.getX(t+1)),T(e.getX(t+2))}}computeVertexNormals(){let e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new td(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);let s=new $,r=new $,n=new $,a=new $,o=new $,l=new $,h=new $,u=new $;if(e)for(let d=0,c=e.count;d<c;d+=3){let c=e.getX(d+0),p=e.getX(d+1),m=e.getX(d+2);s.fromBufferAttribute(t,c),r.fromBufferAttribute(t,p),n.fromBufferAttribute(t,m),h.subVectors(n,r),u.subVectors(s,r),h.cross(u),a.fromBufferAttribute(i,c),o.fromBufferAttribute(i,p),l.fromBufferAttribute(i,m),a.add(h),o.add(h),l.add(h),i.setXYZ(c,a.x,a.y,a.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)s.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),n.fromBufferAttribute(t,e+2),h.subVectors(n,r),u.subVectors(s,r),h.cross(u),i.setXYZ(e+0,h.x,h.y,h.z),i.setXYZ(e+1,h.x,h.y,h.z),i.setXYZ(e+2,h.x,h.y,h.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){let e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)tS.fromBufferAttribute(e,t),tS.normalize(),e.setXYZ(t,tS.x,tS.y,tS.z)}toNonIndexed(){function e(e,t){let i=e.array,s=e.itemSize,r=e.normalized,n=new i.constructor(t.length*s),a=0,o=0;for(let r=0,l=t.length;r<l;r++){a=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*s;for(let e=0;e<s;e++)n[o++]=i[a++]}return new td(n,s,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;let t=new t_,i=this.index.array,s=this.attributes;for(let r in s){let n=e(s[r],i);t.setAttribute(r,n)}let r=this.morphAttributes;for(let s in r){let n=[],a=r[s];for(let t=0,s=a.length;t<s;t++){let s=e(a[t],i);n.push(s)}t.morphAttributes[s]=n}t.morphTargetsRelative=this.morphTargetsRelative;let n=this.groups;for(let e=0,i=n.length;e<i;e++){let i=n[e];t.addGroup(i.start,i.count,i.materialIndex)}return t}toJSON(){let e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){let t=this.parameters;for(let i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};let t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});let i=this.attributes;for(let t in i){let s=i[t];e.data.attributes[t]=s.toJSON(e.data)}let s={},r=!1;for(let t in this.morphAttributes){let i=this.morphAttributes[t],n=[];for(let t=0,s=i.length;t<s;t++){let s=i[t];n.push(s.toJSON(e.data))}n.length>0&&(s[t]=n,r=!0)}r&&(e.data.morphAttributes=s,e.data.morphTargetsRelative=this.morphTargetsRelative);let n=this.groups;n.length>0&&(e.data.groups=JSON.parse(JSON.stringify(n)));let a=this.boundingSphere;return null!==a&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;let t={};this.name=e.name;let i=e.index;null!==i&&this.setIndex(i.clone(t));let s=e.attributes;for(let e in s){let i=s[e];this.setAttribute(e,i.clone(t))}let r=e.morphAttributes;for(let e in r){let i=[],s=r[e];for(let e=0,r=s.length;e<r;e++)i.push(s[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;let n=e.groups;for(let e=0,t=n.length;e<t;e++){let t=n[e];this.addGroup(t.start,t.count,t.materialIndex)}let a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());let o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}let tM=new eS,tw=new eT,tN=new ep,tA=new $,tR=new $,tC=new $,tE=new $,tB=new $,tI=new $,tP=new S,tF=new S,tU=new S,tO=new $,tz=new $,tL=new $,tD=new $,tV=new $;class tk extends eY{constructor(e=new t_,t=new tn){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){let e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){let i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){let t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){let i=this.geometry,s=i.attributes.position,r=i.morphAttributes.position,n=i.morphTargetsRelative;t.fromBufferAttribute(s,e);let a=this.morphTargetInfluences;if(r&&a){tI.set(0,0,0);for(let i=0,s=r.length;i<s;i++){let s=a[i],o=r[i];0!==s&&(tB.fromBufferAttribute(o,e),n?tI.addScaledVector(tB,s):tI.addScaledVector(tB.sub(t),s))}t.add(tI)}return t}raycast(e,t){let i=this.geometry,s=this.material,r=this.matrixWorld;if(void 0!==s){if(null===i.boundingSphere&&i.computeBoundingSphere(),tN.copy(i.boundingSphere),tN.applyMatrix4(r),tw.copy(e.ray).recast(e.near),!1===tN.containsPoint(tw.origin)&&(null===tw.intersectSphere(tN,tA)||tw.origin.distanceToSquared(tA)>(e.far-e.near)**2)||(tM.copy(r).invert(),tw.copy(e.ray).applyMatrix4(tM),null!==i.boundingBox&&!1===tw.intersectsBox(i.boundingBox)))return;this._computeIntersections(e,t,tw)}}_computeIntersections(e,t,i){let s;let r=this.geometry,n=this.material,a=r.index,o=r.attributes.position,l=r.attributes.uv,h=r.attributes.uv1,u=r.attributes.normal,d=r.groups,c=r.drawRange;if(null!==a){if(Array.isArray(n))for(let r=0,o=d.length;r<o;r++){let o=d[r],p=n[o.materialIndex],m=Math.max(o.start,c.start),g=Math.min(a.count,Math.min(o.start+o.count,c.start+c.count));for(let r=m;r<g;r+=3)(s=tG(this,p,e,i,l,h,u,a.getX(r),a.getX(r+1),a.getX(r+2)))&&(s.faceIndex=Math.floor(r/3),s.face.materialIndex=o.materialIndex,t.push(s))}else{let r=Math.max(0,c.start),o=Math.min(a.count,c.start+c.count);for(let d=r;d<o;d+=3)(s=tG(this,n,e,i,l,h,u,a.getX(d),a.getX(d+1),a.getX(d+2)))&&(s.faceIndex=Math.floor(d/3),t.push(s))}}else if(void 0!==o){if(Array.isArray(n))for(let r=0,a=d.length;r<a;r++){let a=d[r],p=n[a.materialIndex],m=Math.max(a.start,c.start),g=Math.min(o.count,Math.min(a.start+a.count,c.start+c.count));for(let r=m;r<g;r+=3)(s=tG(this,p,e,i,l,h,u,r,r+1,r+2))&&(s.faceIndex=Math.floor(r/3),s.face.materialIndex=a.materialIndex,t.push(s))}else{let r=Math.max(0,c.start),a=Math.min(o.count,c.start+c.count);for(let o=r;o<a;o+=3)(s=tG(this,n,e,i,l,h,u,o,o+1,o+2))&&(s.faceIndex=Math.floor(o/3),t.push(s))}}}}function tG(e,t,i,s,r,n,a,o,l,h){e.getVertexPosition(o,tR),e.getVertexPosition(l,tC),e.getVertexPosition(h,tE);let u=function(e,t,i,s,r,n,a,o){if(null===(1===t.side?s.intersectTriangle(a,n,r,!0,o):s.intersectTriangle(r,n,a,0===t.side,o)))return null;tV.copy(o),tV.applyMatrix4(e.matrixWorld);let l=i.ray.origin.distanceTo(tV);return l<i.near||l>i.far?null:{distance:l,point:tV.clone(),object:e}}(e,t,i,s,tR,tC,tE,tD);if(u){r&&(tP.fromBufferAttribute(r,o),tF.fromBufferAttribute(r,l),tU.fromBufferAttribute(r,h),u.uv=e6.getInterpolation(tD,tR,tC,tE,tP,tF,tU,new S)),n&&(tP.fromBufferAttribute(n,o),tF.fromBufferAttribute(n,l),tU.fromBufferAttribute(n,h),u.uv1=e6.getInterpolation(tD,tR,tC,tE,tP,tF,tU,new S)),a&&(tO.fromBufferAttribute(a,o),tz.fromBufferAttribute(a,l),tL.fromBufferAttribute(a,h),u.normal=e6.getInterpolation(tD,tR,tC,tE,tO,tz,tL,new $),u.normal.dot(s.direction)>0&&u.normal.multiplyScalar(-1));let e={a:o,b:l,c:h,normal:new $,materialIndex:0};e6.getNormal(tR,tC,tE,e.normal),u.face=e}return u}class tW extends t_{constructor(e=1,t=1,i=1,s=1,r=1,n=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:s,heightSegments:r,depthSegments:n};let a=this;s=Math.floor(s),r=Math.floor(r);let o=[],l=[],h=[],u=[],d=0,c=0;function p(e,t,i,s,r,n,p,m,g,f,y){let x=n/g,b=p/f,v=n/2,T=p/2,S=m/2,_=g+1,M=f+1,w=0,N=0,A=new $;for(let n=0;n<M;n++){let a=n*b-T;for(let o=0;o<_;o++){let d=o*x-v;A[e]=d*s,A[t]=a*r,A[i]=S,l.push(A.x,A.y,A.z),A[e]=0,A[t]=0,A[i]=m>0?1:-1,h.push(A.x,A.y,A.z),u.push(o/g),u.push(1-n/f),w+=1}}for(let e=0;e<f;e++)for(let t=0;t<g;t++){let i=d+t+_*e,s=d+t+_*(e+1),r=d+(t+1)+_*(e+1),n=d+(t+1)+_*e;o.push(i,s,n),o.push(s,r,n),N+=6}a.addGroup(c,N,y),c+=N,d+=w}p("z","y","x",-1,-1,i,t,e,n=Math.floor(n),r,0),p("z","y","x",1,-1,i,t,-e,n,r,1),p("x","z","y",1,1,e,i,t,s,n,2),p("x","z","y",1,-1,e,i,-t,s,n,3),p("x","y","z",1,-1,e,t,i,s,r,4),p("x","y","z",-1,-1,e,t,-i,s,r,5),this.setIndex(o),this.setAttribute("position",new tg(l,3)),this.setAttribute("normal",new tg(h,3)),this.setAttribute("uv",new tg(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new tW(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function tH(e){let t={};for(let i in e)for(let s in t[i]={},e[i]){let r=e[i][s];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[i][s]=null):t[i][s]=r.clone():Array.isArray(r)?t[i][s]=r.slice():t[i][s]=r}return t}var tj=`
void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
`,t$=`
void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}
`;class tq extends tr{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=tj,this.fragmentShader=t$,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=tH(e.uniforms),this.uniformsGroups=function(e){let t=[];for(let i=0;i<e.length;i++)t.push(e[i].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){let t=super.toJSON(e);for(let i in t.glslVersion=this.glslVersion,t.uniforms={},this.uniforms){let s=this.uniforms[i].value;s&&s.isTexture?t.uniforms[i]={type:"t",value:s.toJSON(e).uuid}:s&&s.isColor?t.uniforms[i]={type:"c",value:s.getHex()}:s&&s.isVector2?t.uniforms[i]={type:"v2",value:s.toArray()}:s&&s.isVector3?t.uniforms[i]={type:"v3",value:s.toArray()}:s&&s.isVector4?t.uniforms[i]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?t.uniforms[i]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?t.uniforms[i]={type:"m4",value:s.toArray()}:t.uniforms[i]={value:s}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;let i={};for(let e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}class tX extends eY{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new eS,this.projectionMatrix=new eS,this.projectionMatrixInverse=new eS,this.coordinateSystem=2e3}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}let tY=new $,tJ=new S,tK=new S;class tQ extends tX{constructor(e=50,t=1,i=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){let t=.5*this.getFilmHeight()/e;this.fov=2*g*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){let e=Math.tan(.5*m*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*g*Math.atan(Math.tan(.5*m*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,i){tY.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(tY.x,tY.y).multiplyScalar(-e/tY.z),tY.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(tY.x,tY.y).multiplyScalar(-e/tY.z)}getViewSize(e,t){return this.getViewBounds(e,tJ,tK),t.subVectors(tK,tJ)}setViewOffset(e,t,i,s,r,n){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=this.near,t=e*Math.tan(.5*m*this.fov)/this.zoom,i=2*t,s=this.aspect*i,r=-.5*s,n=this.view;if(null!==this.view&&this.view.enabled){let e=n.fullWidth,a=n.fullHeight;r+=n.offsetX*s/e,t-=n.offsetY*i/a,s*=n.width/e,i*=n.height/a}let a=this.filmOffset;0!==a&&(r+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+s,t,t-i,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}class tZ extends eY{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;let s=new tQ(-90,1,e,t);s.layers=this.layers,this.add(s);let r=new tQ(-90,1,e,t);r.layers=this.layers,this.add(r);let n=new tQ(-90,1,e,t);n.layers=this.layers,this.add(n);let a=new tQ(-90,1,e,t);a.layers=this.layers,this.add(a);let o=new tQ(-90,1,e,t);o.layers=this.layers,this.add(o);let l=new tQ(-90,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){let e=this.coordinateSystem,t=this.children.concat(),[i,s,r,n,a,o]=t;for(let e of t)this.remove(e);if(2e3===e)i.up.set(0,1,0),i.lookAt(1,0,0),s.up.set(0,1,0),s.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),n.up.set(0,0,1),n.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else if(2001===e)i.up.set(0,-1,0),i.lookAt(-1,0,0),s.up.set(0,-1,0),s.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),n.up.set(0,0,-1),n.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1);else throw Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(let e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();let{renderTarget:i,activeMipmapLevel:s}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());let[r,n,a,o,l,h]=this.children,u=e.getRenderTarget(),d=e.getActiveCubeFace(),c=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;let m=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,s),e.render(t,r),e.setRenderTarget(i,1,s),e.render(t,n),e.setRenderTarget(i,2,s),e.render(t,a),e.setRenderTarget(i,3,s),e.render(t,o),e.setRenderTarget(i,4,s),e.render(t,l),i.texture.generateMipmaps=m,e.setRenderTarget(i,5,s),e.render(t,h),e.setRenderTarget(u,d,c),e.xr.enabled=p,i.texture.needsPMREMUpdate=!0}}class t0 extends V{constructor(e,t,i,s,r,n,a,o,l,h){super(e=void 0!==e?e:[],t=void 0!==t?t:301,i,s,r,n,a,o,l,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class t1 extends W{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;let i={width:e,height:e,depth:1};this.texture=new t0([i,i,i,i,i,i],t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:1006}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;let i={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},s=new tW(5,5,5),r=new tq({name:"CubemapFromEquirect",uniforms:tH(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=t;let n=new tk(s,r),a=t.minFilter;return 1008===t.minFilter&&(t.minFilter=1006),new tZ(1,10,this).update(e,n),t.minFilter=a,n.geometry.dispose(),n.material.dispose(),this}clear(e,t,i,s){let r=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,i,s);e.setRenderTarget(r)}}class t2 extends eY{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new eI,this.environmentIntensity=1,this.environmentRotation=new eI,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){let t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class t3{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=35044,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.version=0,this.uuid=f()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}get updateRange(){return A("THREE.InterleavedBuffer: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let s=0,r=this.stride;s<r;s++)this.array[e+s]=t.array[i+s];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=f()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);let t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=f()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}let t4=new $;class t5{constructor(e,t,i,s=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=s}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)t4.fromBufferAttribute(this,t),t4.applyMatrix4(e),this.setXYZ(t,t4.x,t4.y,t4.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)t4.fromBufferAttribute(this,t),t4.applyNormalMatrix(e),this.setXYZ(t,t4.x,t4.y,t4.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)t4.fromBufferAttribute(this,t),t4.transformDirection(e),this.setXYZ(t,t4.x,t4.y,t4.z);return this}getComponent(e,t){let i=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(i=b(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=v(i,this.array)),this.data.array[e*this.data.stride+this.offset+t]=i,this}setX(e,t){return this.normalized&&(t=v(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=v(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=v(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=v(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=b(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=b(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=b(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=b(t,this.array)),t}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=v(t,this.array),i=v(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,s){return e=e*this.data.stride+this.offset,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this}setXYZW(e,t,i,s,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=v(t,this.array),i=v(i,this.array),s=v(s,this.array),r=v(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this.data.array[e+3]=r,this}clone(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new t5(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized);{console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let t=0;t<this.count;t++){let i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new td(new this.array.constructor(e),this.itemSize,this.normalized)}}toJSON(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized};{console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let t=0;t<this.count;t++){let i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}}}class t6 extends tr{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new tt(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}class t8 extends V{constructor(e=null,t=1,i=1,s,r,n,a,o,l=1003,h=1003,u,d){super(null,n,a,o,l,h,s,r,u,d),this.isDataTexture=!0,this.image={data:e,width:t,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class t7 extends td{constructor(e,t,i,s=1){super(e,t,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=s}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){let e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}let t9=new eS,ie=new eS,it=[],ii=new Y,is=new eS,ir=new tk,ia=new ep;class io extends tk{constructor(e,t,i){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new t7(new Float32Array(16*i),16),this.instanceColor=null,this.morphTexture=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<i;e++)this.setMatrixAt(e,is)}computeBoundingBox(){let e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new Y),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,t9),ii.copy(e.boundingBox).applyMatrix4(t9),this.boundingBox.union(ii)}computeBoundingSphere(){let e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new ep),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,t9),ia.copy(e.boundingSphere).applyMatrix4(t9),this.boundingSphere.union(ia)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,t){let i=t.morphTargetInfluences,s=this.morphTexture.source.data.data,r=e*(i.length+1)+1;for(let e=0;e<i.length;e++)i[e]=s[r+e]}raycast(e,t){let i=this.matrixWorld,s=this.count;if(ir.geometry=this.geometry,ir.material=this.material,void 0!==ir.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),ia.copy(this.boundingSphere),ia.applyMatrix4(i),!1!==e.ray.intersectsSphere(ia)))for(let r=0;r<s;r++){this.getMatrixAt(r,t9),ie.multiplyMatrices(i,t9),ir.matrixWorld=ie,ir.raycast(e,it);for(let e=0,i=it.length;e<i;e++){let i=it[e];i.instanceId=r,i.object=this,t.push(i)}it.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new t7(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,t){let i=t.morphTargetInfluences,s=i.length+1;null===this.morphTexture&&(this.morphTexture=new t8(new Float32Array(s*this.count),s,this.count,1028,1015));let r=this.morphTexture.source.data.data,n=0;for(let e=0;e<i.length;e++)n+=i[e];let a=this.geometry.morphTargetsRelative?1:1-n,o=s*e;r[o]=a,r.set(i,o+1)}updateMorphTargets(){}dispose(){return this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null),this}}let il=new $,ih=new $,iu=new _;class id{constructor(e=new $(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,s){return this.normal.set(e,t,i),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){let s=il.subVectors(i,t).cross(ih.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){let e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){let i=e.delta(il),s=this.normal.dot(i);if(0===s)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;let r=-(e.start.dot(this.normal)+this.constant)/s;return r<0||r>1?null:t.copy(e.start).addScaledVector(i,r)}intersectsLine(e){let t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){let i=t||iu.getNormalMatrix(e),s=this.coplanarPoint(il).applyMatrix4(e),r=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}let ic=new ep,ip=new $;class im{constructor(e=new id,t=new id,i=new id,s=new id,r=new id,n=new id){this.planes=[e,t,i,s,r,n]}set(e,t,i,s,r,n){let a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(s),a[4].copy(r),a[5].copy(n),this}copy(e){let t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=2e3){let i=this.planes,s=e.elements,r=s[0],n=s[1],a=s[2],o=s[3],l=s[4],h=s[5],u=s[6],d=s[7],c=s[8],p=s[9],m=s[10],g=s[11],f=s[12],y=s[13],x=s[14],b=s[15];if(i[0].setComponents(o-r,d-l,g-c,b-f).normalize(),i[1].setComponents(o+r,d+l,g+c,b+f).normalize(),i[2].setComponents(o+n,d+h,g+p,b+y).normalize(),i[3].setComponents(o-n,d-h,g-p,b-y).normalize(),i[4].setComponents(o-a,d-u,g-m,b-x).normalize(),2e3===t)i[5].setComponents(o+a,d+u,g+m,b+x).normalize();else if(2001===t)i[5].setComponents(a,u,m,x).normalize();else throw Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),ic.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{let t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),ic.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(ic)}intersectsSprite(e){return ic.center.set(0,0,0),ic.radius=.7071067811865476,ic.applyMatrix4(e.matrixWorld),this.intersectsSphere(ic)}intersectsSphere(e){let t=this.planes,i=e.center,s=-e.radius;for(let e=0;e<6;e++)if(t[e].distanceToPoint(i)<s)return!1;return!0}intersectsBox(e){let t=this.planes;for(let i=0;i<6;i++){let s=t[i];if(ip.x=s.normal.x>0?e.max.x:e.min.x,ip.y=s.normal.y>0?e.max.y:e.min.y,ip.z=s.normal.z>0?e.max.z:e.min.z,0>s.distanceToPoint(ip))return!1}return!0}containsPoint(e){let t=this.planes;for(let i=0;i<6;i++)if(0>t[i].distanceToPoint(e))return!1;return!0}clone(){return new this.constructor().copy(this)}}class ig extends tr{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new tt(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}class iy extends tr{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new tt(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}class ix extends V{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=1003,this.minFilter=1003,this.generateMipmaps=!1,this.needsUpdate=!0}}class ib extends V{constructor(e,t,i,s,r,n,a,o,l,h=1026){if(1026!==h&&1027!==h)throw Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&1026===h&&(i=1014),void 0===i&&1027===h&&(i=1020),super(null,s,r,n,a,o,h,i,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==a?a:1003,this.minFilter=void 0!==o?o:1003,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){let t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class iv{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,t){let i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){let t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){let t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){let e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;let t=[],i,s=this.getPoint(0),r=0;t.push(0);for(let n=1;n<=e;n++)t.push(r+=(i=this.getPoint(n/e)).distanceTo(s)),s=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){let i;let s=this.getLengths(),r=0,n=s.length;i=t||e*s[n-1];let a=0,o=n-1,l;for(;a<=o;)if((l=s[r=Math.floor(a+(o-a)/2)]-i)<0)a=r+1;else if(l>0)o=r-1;else{o=r;break}if(s[r=o]===i)return r/(n-1);let h=s[r],u=s[r+1];return(r+(i-h)/(u-h))/(n-1)}getTangent(e,t){let i=e-1e-4,s=e+1e-4;i<0&&(i=0),s>1&&(s=1);let r=this.getPoint(i),n=this.getPoint(s),a=t||(r.isVector2?new S:new $);return a.copy(n).sub(r).normalize(),a}getTangentAt(e,t){let i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t){let i=new $,s=[],r=[],n=[],a=new $,o=new eS;for(let t=0;t<=e;t++){let i=t/e;s[t]=this.getTangentAt(i,new $)}r[0]=new $,n[0]=new $;let l=Number.MAX_VALUE,h=Math.abs(s[0].x),u=Math.abs(s[0].y),d=Math.abs(s[0].z);h<=l&&(l=h,i.set(1,0,0)),u<=l&&(l=u,i.set(0,1,0)),d<=l&&i.set(0,0,1),a.crossVectors(s[0],i).normalize(),r[0].crossVectors(s[0],a),n[0].crossVectors(s[0],r[0]);for(let t=1;t<=e;t++){if(r[t]=r[t-1].clone(),n[t]=n[t-1].clone(),a.crossVectors(s[t-1],s[t]),a.length()>Number.EPSILON){a.normalize();let e=Math.acos(y(s[t-1].dot(s[t]),-1,1));r[t].applyMatrix4(o.makeRotationAxis(a,e))}n[t].crossVectors(s[t],r[t])}if(!0===t){let t=Math.acos(y(r[0].dot(r[e]),-1,1));t/=e,s[0].dot(a.crossVectors(r[0],r[e]))>0&&(t=-t);for(let i=1;i<=e;i++)r[i].applyMatrix4(o.makeRotationAxis(s[i],t*i)),n[i].crossVectors(s[i],r[i])}return{tangents:s,normals:r,binormals:n}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){let e={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class iT extends iv{constructor(e=0,t=0,i=1,s=1,r=0,n=2*Math.PI,a=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=s,this.aStartAngle=r,this.aEndAngle=n,this.aClockwise=a,this.aRotation=o}getPoint(e,t=new S){let i=2*Math.PI,s=this.aEndAngle-this.aStartAngle,r=Math.abs(s)<Number.EPSILON;for(;s<0;)s+=i;for(;s>i;)s-=i;s<Number.EPSILON&&(s=r?0:i),!0!==this.aClockwise||r||(s===i?s=-i:s-=i);let n=this.aStartAngle+e*s,a=this.aX+this.xRadius*Math.cos(n),o=this.aY+this.yRadius*Math.sin(n);if(0!==this.aRotation){let e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),i=a-this.aX,s=o-this.aY;a=i*e-s*t+this.aX,o=i*t+s*e+this.aY}return t.set(a,o)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){let e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class iS extends iT{constructor(e,t,i,s,r,n){super(e,t,i,i,s,r,n),this.isArcCurve=!0,this.type="ArcCurve"}}function i_(){let e=0,t=0,i=0,s=0;function r(r,n,a,o){e=r,t=a,i=-3*r+3*n-2*a-o,s=2*r-2*n+a+o}return{initCatmullRom:function(e,t,i,s,n){r(t,i,n*(i-e),n*(s-t))},initNonuniformCatmullRom:function(e,t,i,s,n,a,o){let l=(t-e)/n-(i-e)/(n+a)+(i-t)/a,h=(i-t)/a-(s-t)/(a+o)+(s-i)/o;r(t,i,l*=a,h*=a)},calc:function(r){let n=r*r;return e+t*r+i*n+n*r*s}}}let iM=new $,iw=new i_,iN=new i_,iA=new i_;class iR extends iv{constructor(e=[],t=!1,i="centripetal",s=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=s}getPoint(e,t=new $){let i,s;let r=this.points,n=r.length,a=(n-(this.closed?0:1))*e,o=Math.floor(a),l=a-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/n)+1)*n:0===l&&o===n-1&&(o=n-2,l=1),this.closed||o>0?i=r[(o-1)%n]:(iM.subVectors(r[0],r[1]).add(r[0]),i=iM);let h=r[o%n],u=r[(o+1)%n];if(this.closed||o+2<n?s=r[(o+2)%n]:(iM.subVectors(r[n-1],r[n-2]).add(r[n-1]),s=iM),"centripetal"===this.curveType||"chordal"===this.curveType){let e="chordal"===this.curveType?.5:.25,t=Math.pow(i.distanceToSquared(h),e),r=Math.pow(h.distanceToSquared(u),e),n=Math.pow(u.distanceToSquared(s),e);r<1e-4&&(r=1),t<1e-4&&(t=r),n<1e-4&&(n=r),iw.initNonuniformCatmullRom(i.x,h.x,u.x,s.x,t,r,n),iN.initNonuniformCatmullRom(i.y,h.y,u.y,s.y,t,r,n),iA.initNonuniformCatmullRom(i.z,h.z,u.z,s.z,t,r,n)}else"catmullrom"===this.curveType&&(iw.initCatmullRom(i.x,h.x,u.x,s.x,this.tension),iN.initCatmullRom(i.y,h.y,u.y,s.y,this.tension),iA.initCatmullRom(i.z,h.z,u.z,s.z,this.tension));return t.set(iw.calc(l),iN.calc(l),iA.calc(l)),t}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){let i=e.points[t];this.points.push(i.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){let e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){let i=this.points[t];e.points.push(i.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){let i=e.points[t];this.points.push(new $().fromArray(i))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function iC(e,t,i,s,r){let n=(s-t)*.5,a=(r-i)*.5,o=e*e;return e*o*(2*i-2*s+n+a)+(-3*i+3*s-2*n-a)*o+n*e+i}function iE(e,t,i,s){return function(e,t){let i=1-e;return i*i*t}(e,t)+2*(1-e)*e*i+e*e*s}function iB(e,t,i,s,r){return function(e,t){let i=1-e;return i*i*i*t}(e,t)+function(e,t){let i=1-e;return 3*i*i*e*t}(e,i)+3*(1-e)*e*e*s+e*e*e*r}class iI extends iv{constructor(e=new S,t=new S,i=new S,s=new S){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new S){let i=this.v0,s=this.v1,r=this.v2,n=this.v3;return t.set(iB(e,i.x,s.x,r.x,n.x),iB(e,i.y,s.y,r.y,n.y)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class iP extends iv{constructor(e=new $,t=new $,i=new $,s=new $){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new $){let i=this.v0,s=this.v1,r=this.v2,n=this.v3;return t.set(iB(e,i.x,s.x,r.x,n.x),iB(e,i.y,s.y,r.y,n.y),iB(e,i.z,s.z,r.z,n.z)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class iF extends iv{constructor(e=new S,t=new S){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new S){return 1===e?t.copy(this.v2):(t.copy(this.v2).sub(this.v1),t.multiplyScalar(e).add(this.v1)),t}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new S){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class iU extends iv{constructor(e=new $,t=new $){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new $){return 1===e?t.copy(this.v2):(t.copy(this.v2).sub(this.v1),t.multiplyScalar(e).add(this.v1)),t}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new $){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class iO extends iv{constructor(e=new S,t=new S,i=new S){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new S){let i=this.v0,s=this.v1,r=this.v2;return t.set(iE(e,i.x,s.x,r.x),iE(e,i.y,s.y,r.y)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class iz extends iv{constructor(e=new $,t=new $,i=new $){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new $){let i=this.v0,s=this.v1,r=this.v2;return t.set(iE(e,i.x,s.x,r.x),iE(e,i.y,s.y,r.y),iE(e,i.z,s.z,r.z)),t}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class iL extends iv{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new S){let i=this.points,s=(i.length-1)*e,r=Math.floor(s),n=s-r,a=i[0===r?r:r-1],o=i[r],l=i[r>i.length-2?i.length-1:r+1],h=i[r>i.length-3?i.length-1:r+2];return t.set(iC(n,a.x,o.x,l.x,h.x),iC(n,a.y,o.y,l.y,h.y)),t}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){let i=e.points[t];this.points.push(i.clone())}return this}toJSON(){let e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){let i=this.points[t];e.points.push(i.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){let i=e.points[t];this.points.push(new S().fromArray(i))}return this}}var iD=Object.freeze({__proto__:null,ArcCurve:iS,CatmullRomCurve3:iR,CubicBezierCurve:iI,CubicBezierCurve3:iP,EllipseCurve:iT,LineCurve:iF,LineCurve3:iU,QuadraticBezierCurve:iO,QuadraticBezierCurve3:iz,SplineCurve:iL});class iV extends iv{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){let e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){let i=!0===e.isVector2?"LineCurve":"LineCurve3";this.curves.push(new iD[i](t,e))}return this}getPoint(e,t){let i=e*this.getLength(),s=this.getCurveLengths(),r=0;for(;r<s.length;){if(s[r]>=i){let e=s[r]-i,n=this.curves[r],a=n.getLength(),o=0===a?0:1-e/a;return n.getPointAt(o,t)}r++}return null}getLength(){let e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;let e=[],t=0;for(let i=0,s=this.curves.length;i<s;i++)e.push(t+=this.curves[i].getLength());return this.cacheLengths=e,e}getSpacedPoints(e=40){let t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){let t;let i=[];for(let s=0,r=this.curves;s<r.length;s++){let n=r[s],a=n.isEllipseCurve?2*e:n.isLineCurve||n.isLineCurve3?1:n.isSplineCurve?e*n.points.length:e,o=n.getPoints(a);for(let e=0;e<o.length;e++){let s=o[e];t&&t.equals(s)||(i.push(s),t=s)}}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){let i=e.curves[t];this.curves.push(i.clone())}return this.autoClose=e.autoClose,this}toJSON(){let e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){let i=this.curves[t];e.curves.push(i.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){let i=e.curves[t];this.curves.push(new iD[i.type]().fromJSON(i))}return this}}class ik extends iV{constructor(e){super(),this.type="Path",this.currentPoint=new S,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){let i=new iF(this.currentPoint.clone(),new S(e,t));return this.curves.push(i),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,i,s){let r=new iO(this.currentPoint.clone(),new S(e,t),new S(i,s));return this.curves.push(r),this.currentPoint.set(i,s),this}bezierCurveTo(e,t,i,s,r,n){let a=new iI(this.currentPoint.clone(),new S(e,t),new S(i,s),new S(r,n));return this.curves.push(a),this.currentPoint.set(r,n),this}splineThru(e){let t=new iL([this.currentPoint.clone()].concat(e));return this.curves.push(t),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,i,s,r,n){let a=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(e+a,t+o,i,s,r,n),this}absarc(e,t,i,s,r,n){return this.absellipse(e,t,i,i,s,r,n),this}ellipse(e,t,i,s,r,n,a,o){let l=this.currentPoint.x,h=this.currentPoint.y;return this.absellipse(e+l,t+h,i,s,r,n,a,o),this}absellipse(e,t,i,s,r,n,a,o){let l=new iT(e,t,i,s,r,n,a,o);if(this.curves.length>0){let e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);let h=l.getPoint(1);return this.currentPoint.copy(h),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){let e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class iG extends t_{constructor(e=[new S(0,-.5),new S(.5,0),new S(0,.5)],t=12,i=0,s=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:s},t=Math.floor(t),s=y(s,0,2*Math.PI);let r=[],n=[],a=[],o=[],l=[],h=1/t,u=new $,d=new S,c=new $,p=new $,m=new $,g=0,f=0;for(let t=0;t<=e.length-1;t++)switch(t){case 0:g=e[t+1].x-e[t].x,f=e[t+1].y-e[t].y,c.x=1*f,c.y=-g,c.z=0*f,m.copy(c),c.normalize(),o.push(c.x,c.y,c.z);break;case e.length-1:o.push(m.x,m.y,m.z);break;default:g=e[t+1].x-e[t].x,f=e[t+1].y-e[t].y,c.x=1*f,c.y=-g,c.z=0*f,p.copy(c),c.x+=m.x,c.y+=m.y,c.z+=m.z,c.normalize(),o.push(c.x,c.y,c.z),m.copy(p)}for(let r=0;r<=t;r++){let c=i+r*h*s,p=Math.sin(c),m=Math.cos(c);for(let i=0;i<=e.length-1;i++){u.x=e[i].x*p,u.y=e[i].y,u.z=e[i].x*m,n.push(u.x,u.y,u.z),d.x=r/t,d.y=i/(e.length-1),a.push(d.x,d.y);let s=o[3*i+0]*p,h=o[3*i+1],c=o[3*i+0]*m;l.push(s,h,c)}}for(let i=0;i<t;i++)for(let t=0;t<e.length-1;t++){let s=t+i*e.length,n=s+e.length,a=s+e.length+1,o=s+1;r.push(s,n,o),r.push(a,o,n)}this.setIndex(r),this.setAttribute("position",new tg(n,3)),this.setAttribute("uv",new tg(a,2)),this.setAttribute("normal",new tg(l,3))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new iG(e.points,e.segments,e.phiStart,e.phiLength)}}class iW extends iG{constructor(e=1,t=1,i=4,s=8){let r=new ik;r.absarc(0,-t/2,e,1.5*Math.PI,0),r.absarc(0,t/2,e,0,.5*Math.PI),super(r.getPoints(i),s),this.type="CapsuleGeometry",this.parameters={radius:e,length:t,capSegments:i,radialSegments:s}}static fromJSON(e){return new iW(e.radius,e.length,e.capSegments,e.radialSegments)}}class iH extends t_{constructor(e=1,t=32,i=0,s=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:s},t=Math.max(3,t);let r=[],n=[],a=[],o=[],l=new $,h=new S;n.push(0,0,0),a.push(0,0,1),o.push(.5,.5);for(let r=0,u=3;r<=t;r++,u+=3){let d=i+r/t*s;l.x=e*Math.cos(d),l.y=e*Math.sin(d),n.push(l.x,l.y,l.z),a.push(0,0,1),h.x=(n[u]/e+1)/2,h.y=(n[u+1]/e+1)/2,o.push(h.x,h.y)}for(let e=1;e<=t;e++)r.push(e,e+1,0);this.setIndex(r),this.setAttribute("position",new tg(n,3)),this.setAttribute("normal",new tg(a,3)),this.setAttribute("uv",new tg(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new iH(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class ij extends t_{constructor(e=1,t=1,i=1,s=32,r=1,n=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:s,heightSegments:r,openEnded:n,thetaStart:a,thetaLength:o};let l=this;s=Math.floor(s),r=Math.floor(r);let h=[],u=[],d=[],c=[],p=0,m=[],g=i/2,f=0;function y(i){let r=p,n=new S,m=new $,y=0,x=!0===i?e:t,b=!0===i?1:-1;for(let e=1;e<=s;e++)u.push(0,g*b,0),d.push(0,b,0),c.push(.5,.5),p++;let v=p;for(let e=0;e<=s;e++){let t=e/s*o+a,i=Math.cos(t),r=Math.sin(t);m.x=x*r,m.y=g*b,m.z=x*i,u.push(m.x,m.y,m.z),d.push(0,b,0),n.x=.5*i+.5,n.y=.5*r*b+.5,c.push(n.x,n.y),p++}for(let e=0;e<s;e++){let t=r+e,s=v+e;!0===i?h.push(s,s+1,t):h.push(s+1,s,t),y+=3}l.addGroup(f,y,!0===i?1:2),f+=y}(function(){let n=new $,y=new $,x=0,b=(t-e)/i;for(let l=0;l<=r;l++){let h=[],f=l/r,x=f*(t-e)+e;for(let e=0;e<=s;e++){let t=e/s,r=t*o+a,l=Math.sin(r),m=Math.cos(r);y.x=x*l,y.y=-f*i+g,y.z=x*m,u.push(y.x,y.y,y.z),n.set(l,b,m).normalize(),d.push(n.x,n.y,n.z),c.push(t,1-f),h.push(p++)}m.push(h)}for(let e=0;e<s;e++)for(let t=0;t<r;t++){let i=m[t][e],s=m[t+1][e],r=m[t+1][e+1],n=m[t][e+1];h.push(i,s,n),h.push(s,r,n),x+=6}l.addGroup(f,x,0),f+=x})(),!1===n&&(e>0&&y(!0),t>0&&y(!1)),this.setIndex(h),this.setAttribute("position",new tg(u,3)),this.setAttribute("normal",new tg(d,3)),this.setAttribute("uv",new tg(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ij(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class i$ extends ij{constructor(e=1,t=1,i=32,s=1,r=!1,n=0,a=2*Math.PI){super(0,e,t,i,s,r,n,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:s,openEnded:r,thetaStart:n,thetaLength:a}}static fromJSON(e){return new i$(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class iq extends t_{constructor(e=[],t=[],i=1,s=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:s};let r=[],n=[];function a(e){r.push(e.x,e.y,e.z)}function o(t,i){let s=3*t;i.x=e[s+0],i.y=e[s+1],i.z=e[s+2]}function l(e,t,i,s){s<0&&1===e.x&&(n[t]=e.x-1),0===i.x&&0===i.z&&(n[t]=s/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}(function(e){let i=new $,s=new $,r=new $;for(let n=0;n<t.length;n+=3)o(t[n+0],i),o(t[n+1],s),o(t[n+2],r),function(e,t,i,s){let r=s+1,n=[];for(let s=0;s<=r;s++){n[s]=[];let a=e.clone().lerp(i,s/r),o=t.clone().lerp(i,s/r),l=r-s;for(let e=0;e<=l;e++)0===e&&s===r?n[s][e]=a:n[s][e]=a.clone().lerp(o,e/l)}for(let e=0;e<r;e++)for(let t=0;t<2*(r-e)-1;t++){let i=Math.floor(t/2);t%2==0?(a(n[e][i+1]),a(n[e+1][i]),a(n[e][i])):(a(n[e][i+1]),a(n[e+1][i+1]),a(n[e+1][i]))}}(i,s,r,e)})(s),function(e){let t=new $;for(let i=0;i<r.length;i+=3)t.x=r[i+0],t.y=r[i+1],t.z=r[i+2],t.normalize().multiplyScalar(e),r[i+0]=t.x,r[i+1]=t.y,r[i+2]=t.z}(i),function(){let e=new $;for(let t=0;t<r.length;t+=3){e.x=r[t+0],e.y=r[t+1],e.z=r[t+2];let i=h(e)/2/Math.PI+.5,s=Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))/Math.PI+.5;n.push(i,1-s)}(function(){let e=new $,t=new $,i=new $,s=new $,a=new S,o=new S,u=new S;for(let d=0,c=0;d<r.length;d+=9,c+=6){e.set(r[d+0],r[d+1],r[d+2]),t.set(r[d+3],r[d+4],r[d+5]),i.set(r[d+6],r[d+7],r[d+8]),a.set(n[c+0],n[c+1]),o.set(n[c+2],n[c+3]),u.set(n[c+4],n[c+5]),s.copy(e).add(t).add(i).divideScalar(3);let p=h(s);l(a,c+0,e,p),l(o,c+2,t,p),l(u,c+4,i,p)}})(),function(){for(let e=0;e<n.length;e+=6){let t=n[e+0],i=n[e+2],s=n[e+4],r=Math.max(t,i,s),a=Math.min(t,i,s);r>.9&&a<.1&&(t<.2&&(n[e+0]+=1),i<.2&&(n[e+2]+=1),s<.2&&(n[e+4]+=1))}}()}(),this.setAttribute("position",new tg(r,3)),this.setAttribute("normal",new tg(r.slice(),3)),this.setAttribute("uv",new tg(n,2)),0===s?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new iq(e.vertices,e.indices,e.radius,e.details)}}class iX extends iq{constructor(e=1,t=0){let i=(1+Math.sqrt(5))/2,s=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-s,-i,0,-s,i,0,s,-i,0,s,i,-s,-i,0,-s,i,0,s,-i,0,s,i,0,-i,0,-s,i,0,-s,-i,0,s,i,0,s],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new iX(e.radius,e.detail)}}class iY extends ik{constructor(e){super(e),this.uuid=f(),this.type="Shape",this.holes=[]}getPointsHoles(e){let t=[];for(let i=0,s=this.holes.length;i<s;i++)t[i]=this.holes[i].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){let i=e.holes[t];this.holes.push(i.clone())}return this}toJSON(){let e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,i=this.holes.length;t<i;t++){let i=this.holes[t];e.holes.push(i.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){let i=e.holes[t];this.holes.push(new ik().fromJSON(i))}return this}}let iJ=function(e,t,i=2){let s,r,n,a,o,l,h;let u=t&&t.length,d=u?t[0]*i:e.length,c=iK(e,0,d,i,!0),p=[];if(!c||c.next===c.prev)return p;if(u&&(c=function(e,t,i,s){let r,n,a,o,l;let h=[];for(r=0,n=t.length;r<n;r++)a=t[r]*s,o=r<n-1?t[r+1]*s:e.length,(l=iK(e,a,o,s,!1))===l.next&&(l.steiner=!0),h.push(function(e){let t=e,i=e;do(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next;while(t!==e);return i}(l));for(h.sort(iZ),r=0;r<h.length;r++)i=function(e,t){let i=function(e,t){let i=t,s=-1/0,r,n=e.x,a=e.y;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){let e=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>s&&(s=e,r=i.x<i.next.x?i:i.next,e===n))return r}i=i.next}while(i!==t);if(!r)return null;let o=r,l=r.x,h=r.y,u=1/0,d;i=r;do{var c,p;n>=i.x&&i.x>=l&&n!==i.x&&i1(a<h?n:s,a,l,h,a<h?s:n,a,i.x,i.y)&&(d=Math.abs(a-i.y)/(n-i.x),i8(i,e)&&(d<u||d===u&&(i.x>r.x||i.x===r.x&&(c=r,p=i,0>i2(c.prev,c,p.prev)&&0>i2(p.next,c,c.next))))&&(r=i,u=d)),i=i.next}while(i!==o);return r}(e,t);if(!i)return t;let s=i7(i,e);return iQ(s,s.next),iQ(i,i.next)}(h[r],i);return i}(e,t,c,i)),e.length>80*i){s=n=e[0],r=a=e[1];for(let t=i;t<d;t+=i)o=e[t],l=e[t+1],o<s&&(s=o),l<r&&(r=l),o>n&&(n=o),l>a&&(a=l);h=0!==(h=Math.max(n-s,a-r))?32767/h:0}return function e(t,i,s,r,n,a,o){if(!t)return;!o&&a&&function(e,t,i,s){let r=e;do 0===r.z&&(r.z=i0(r.x,r.y,t,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,i,s,r,n,a,o,l,h=1;do{for(i=e,e=null,n=null,a=0;i;){for(a++,s=i,o=0,t=0;t<h&&(o++,s=s.nextZ);t++);for(l=h;o>0||l>0&&s;)0!==o&&(0===l||!s||i.z<=s.z)?(r=i,i=i.nextZ,o--):(r=s,s=s.nextZ,l--),n?n.nextZ=r:e=r,r.prevZ=n,n=r;i=s}n.nextZ=null,h*=2}while(a>1)}(r)}(t,r,n,a);let l=t,h,u;for(;t.prev!==t.next;){if(h=t.prev,u=t.next,a?function(e,t,i,s){let r=e.prev,n=e.next;if(i2(r,e,n)>=0)return!1;let a=r.x,o=e.x,l=n.x,h=r.y,u=e.y,d=n.y,c=a<o?a<l?a:l:o<l?o:l,p=h<u?h<d?h:d:u<d?u:d,m=a>o?a>l?a:l:o>l?o:l,g=h>u?h>d?h:d:u>d?u:d,f=i0(c,p,t,i,s),y=i0(m,g,t,i,s),x=e.prevZ,b=e.nextZ;for(;x&&x.z>=f&&b&&b.z<=y;){if(x.x>=c&&x.x<=m&&x.y>=p&&x.y<=g&&x!==r&&x!==n&&i1(a,h,o,u,l,d,x.x,x.y)&&i2(x.prev,x,x.next)>=0||(x=x.prevZ,b.x>=c&&b.x<=m&&b.y>=p&&b.y<=g&&b!==r&&b!==n&&i1(a,h,o,u,l,d,b.x,b.y)&&i2(b.prev,b,b.next)>=0))return!1;b=b.nextZ}for(;x&&x.z>=f;){if(x.x>=c&&x.x<=m&&x.y>=p&&x.y<=g&&x!==r&&x!==n&&i1(a,h,o,u,l,d,x.x,x.y)&&i2(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;b&&b.z<=y;){if(b.x>=c&&b.x<=m&&b.y>=p&&b.y<=g&&b!==r&&b!==n&&i1(a,h,o,u,l,d,b.x,b.y)&&i2(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}(t,r,n,a):function(e){let t=e.prev,i=e.next;if(i2(t,e,i)>=0)return!1;let s=t.x,r=e.x,n=i.x,a=t.y,o=e.y,l=i.y,h=s<r?s<n?s:n:r<n?r:n,u=a<o?a<l?a:l:o<l?o:l,d=s>r?s>n?s:n:r>n?r:n,c=a>o?a>l?a:l:o>l?o:l,p=i.next;for(;p!==t;){if(p.x>=h&&p.x<=d&&p.y>=u&&p.y<=c&&i1(s,a,r,o,n,l,p.x,p.y)&&i2(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}(t)){i.push(h.i/s|0),i.push(t.i/s|0),i.push(u.i/s|0),se(t),t=u.next,l=u.next;continue}if((t=u)===l){o?1===o?e(t=function(e,t,i){let s=e;do{let r=s.prev,n=s.next.next;!i3(r,n)&&i4(r,s,s.next,n)&&i8(r,n)&&i8(n,r)&&(t.push(r.i/i|0),t.push(s.i/i|0),t.push(n.i/i|0),se(s),se(s.next),s=e=n),s=s.next}while(s!==e);return iQ(s)}(iQ(t),i,s),i,s,r,n,a,2):2===o&&function(t,i,s,r,n,a){let o=t;do{let t=o.next.next;for(;t!==o.prev;){var l,h;if(o.i!==t.i&&(l=o,h=t,l.next.i!==h.i&&l.prev.i!==h.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&i4(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(l,h)&&(i8(l,h)&&i8(h,l)&&function(e,t){let i=e,s=!1,r=(e.x+t.x)/2,n=(e.y+t.y)/2;do i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next;while(i!==e);return s}(l,h)&&(i2(l.prev,l,h.prev)||i2(l,h.prev,h))||i3(l,h)&&i2(l.prev,l,l.next)>0&&i2(h.prev,h,h.next)>0))){let l=i7(o,t);o=iQ(o,o.next),l=iQ(l,l.next),e(o,i,s,r,n,a,0),e(l,i,s,r,n,a,0);return}t=t.next}o=o.next}while(o!==t)}(t,i,s,r,n,a):e(iQ(t),i,s,r,n,a,1);break}}}(c,p,i,s,r,h,0),p};function iK(e,t,i,s,r){let n,a;if(r===function(e,t,i,s){let r=0;for(let n=t,a=i-s;n<i;n+=s)r+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return r}(e,t,i,s)>0)for(n=t;n<i;n+=s)a=i9(n,e[n],e[n+1],a);else for(n=i-s;n>=t;n-=s)a=i9(n,e[n],e[n+1],a);return a&&i3(a,a.next)&&(se(a),a=a.next),a}function iQ(e,t){if(!e)return e;t||(t=e);let i=e,s;do if(s=!1,!i.steiner&&(i3(i,i.next)||0===i2(i.prev,i,i.next))){if(se(i),(i=t=i.prev)===i.next)break;s=!0}else i=i.next;while(s||i!==t);return t}function iZ(e,t){return e.x-t.x}function i0(e,t,i,s,r){return(e=((e=((e=((e=((e=(e-i)*r|0)|e<<8)&16711935)|e<<4)&252645135)|e<<2)&858993459)|e<<1)&1431655765)|(t=((t=((t=((t=((t=(t-s)*r|0)|t<<8)&16711935)|t<<4)&252645135)|t<<2)&858993459)|t<<1)&1431655765)<<1}function i1(e,t,i,s,r,n,a,o){return(r-a)*(t-o)>=(e-a)*(n-o)&&(e-a)*(s-o)>=(i-a)*(t-o)&&(i-a)*(n-o)>=(r-a)*(s-o)}function i2(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function i3(e,t){return e.x===t.x&&e.y===t.y}function i4(e,t,i,s){let r=i6(i2(e,t,i)),n=i6(i2(e,t,s)),a=i6(i2(i,s,e)),o=i6(i2(i,s,t));return!!(r!==n&&a!==o||0===r&&i5(e,i,t)||0===n&&i5(e,s,t)||0===a&&i5(i,e,s)||0===o&&i5(i,t,s))}function i5(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function i6(e){return e>0?1:e<0?-1:0}function i8(e,t){return 0>i2(e.prev,e,e.next)?i2(e,t,e.next)>=0&&i2(e,e.prev,t)>=0:0>i2(e,t,e.prev)||0>i2(e,e.next,t)}function i7(e,t){let i=new st(e.i,e.x,e.y),s=new st(t.i,t.x,t.y),r=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function i9(e,t,i,s){let r=new st(e,t,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function se(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function st(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class si{static area(e){let t=e.length,i=0;for(let s=t-1,r=0;r<t;s=r++)i+=e[s].x*e[r].y-e[r].x*e[s].y;return .5*i}static isClockWise(e){return 0>si.area(e)}static triangulateShape(e,t){let i=[],s=[],r=[];ss(e),sr(i,e);let n=e.length;t.forEach(ss);for(let e=0;e<t.length;e++)s.push(n),n+=t[e].length,sr(i,t[e]);let a=iJ(i,s);for(let e=0;e<a.length;e+=3)r.push(a.slice(e,e+3));return r}}function ss(e){let t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function sr(e,t){for(let i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y)}class sn extends t_{constructor(e=new iY([new S(.5,.5),new S(-.5,.5),new S(-.5,-.5),new S(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];let i=this,s=[],r=[];for(let n=0,a=e.length;n<a;n++)!function(e){let n,a,o,l;let h=[],u=void 0!==t.curveSegments?t.curveSegments:12,d=void 0!==t.steps?t.steps:1,c=void 0!==t.depth?t.depth:1,p=void 0===t.bevelEnabled||t.bevelEnabled,m=void 0!==t.bevelThickness?t.bevelThickness:.2,g=void 0!==t.bevelSize?t.bevelSize:m-.1,f=void 0!==t.bevelOffset?t.bevelOffset:0,y=void 0!==t.bevelSegments?t.bevelSegments:3,x=t.extrudePath,b=void 0!==t.UVGenerator?t.UVGenerator:sa,v,T=!1;x&&(v=x.getSpacedPoints(d),T=!0,p=!1,n=x.computeFrenetFrames(d,!1),a=new $,o=new $,l=new $),p||(y=0,m=0,g=0,f=0);let _=e.extractPoints(u),M=_.shape,w=_.holes;if(!si.isClockWise(M)){M=M.reverse();for(let e=0,t=w.length;e<t;e++){let t=w[e];si.isClockWise(t)&&(w[e]=t.reverse())}}let N=si.triangulateShape(M,w),A=M;for(let e=0,t=w.length;e<t;e++){let t=w[e];M=M.concat(t)}function R(e,t,i){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().addScaledVector(t,i)}let C=M.length,E=N.length;function B(e,t,i){let s,r,n;let a=e.x-t.x,o=e.y-t.y,l=i.x-e.x,h=i.y-e.y,u=a*a+o*o;if(Math.abs(a*h-o*l)>Number.EPSILON){let d=Math.sqrt(u),c=Math.sqrt(l*l+h*h),p=t.x-o/d,m=t.y+a/d,g=((i.x-h/c-p)*h-(i.y+l/c-m)*l)/(a*h-o*l),f=(s=p+a*g-e.x)*s+(r=m+o*g-e.y)*r;if(f<=2)return new S(s,r);n=Math.sqrt(f/2)}else{let e=!1;a>Number.EPSILON?l>Number.EPSILON&&(e=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(o)===Math.sign(h)&&(e=!0),e?(s=-o,r=a,n=Math.sqrt(u)):(s=a,r=o,n=Math.sqrt(u/2))}return new S(s/n,r/n)}let I=[];for(let e=0,t=A.length,i=t-1,s=e+1;e<t;e++,i++,s++)i===t&&(i=0),s===t&&(s=0),I[e]=B(A[e],A[i],A[s]);let P=[],F,U=I.concat();for(let e=0,t=w.length;e<t;e++){let t=w[e];F=[];for(let e=0,i=t.length,s=i-1,r=e+1;e<i;e++,s++,r++)s===i&&(s=0),r===i&&(r=0),F[e]=B(t[e],t[s],t[r]);P.push(F),U=U.concat(F)}for(let e=0;e<y;e++){let t=e/y,i=m*Math.cos(t*Math.PI/2),s=g*Math.sin(t*Math.PI/2)+f;for(let e=0,t=A.length;e<t;e++){let t=R(A[e],I[e],s);L(t.x,t.y,-i)}for(let e=0,t=w.length;e<t;e++){let t=w[e];F=P[e];for(let e=0,r=t.length;e<r;e++){let r=R(t[e],F[e],s);L(r.x,r.y,-i)}}}let O=g+f;for(let e=0;e<C;e++){let t=p?R(M[e],U[e],O):M[e];T?(o.copy(n.normals[0]).multiplyScalar(t.x),a.copy(n.binormals[0]).multiplyScalar(t.y),l.copy(v[0]).add(o).add(a),L(l.x,l.y,l.z)):L(t.x,t.y,0)}for(let e=1;e<=d;e++)for(let t=0;t<C;t++){let i=p?R(M[t],U[t],O):M[t];T?(o.copy(n.normals[e]).multiplyScalar(i.x),a.copy(n.binormals[e]).multiplyScalar(i.y),l.copy(v[e]).add(o).add(a),L(l.x,l.y,l.z)):L(i.x,i.y,c/d*e)}for(let e=y-1;e>=0;e--){let t=e/y,i=m*Math.cos(t*Math.PI/2),s=g*Math.sin(t*Math.PI/2)+f;for(let e=0,t=A.length;e<t;e++){let t=R(A[e],I[e],s);L(t.x,t.y,c+i)}for(let e=0,t=w.length;e<t;e++){let t=w[e];F=P[e];for(let e=0,r=t.length;e<r;e++){let r=R(t[e],F[e],s);T?L(r.x,r.y+v[d-1].y,v[d-1].x+i):L(r.x,r.y,c+i)}}}function z(e,t){let r=e.length;for(;--r>=0;){let n=r,a=r-1;a<0&&(a=e.length-1);for(let e=0,r=d+2*y;e<r;e++){let r=C*e,o=C*(e+1);!function(e,t,r,n){V(e),V(t),V(n),V(t),V(r),V(n);let a=s.length/3,o=b.generateSideWallUV(i,s,a-6,a-3,a-2,a-1);k(o[0]),k(o[1]),k(o[3]),k(o[1]),k(o[2]),k(o[3])}(t+n+r,t+a+r,t+a+o,t+n+o)}}}function L(e,t,i){h.push(e),h.push(t),h.push(i)}function D(e,t,r){V(e),V(t),V(r);let n=s.length/3,a=b.generateTopUV(i,s,n-3,n-2,n-1);k(a[0]),k(a[1]),k(a[2])}function V(e){s.push(h[3*e+0]),s.push(h[3*e+1]),s.push(h[3*e+2])}function k(e){r.push(e.x),r.push(e.y)}(function(){let e=s.length/3;if(p){let e=0*C;for(let t=0;t<E;t++){let i=N[t];D(i[2]+e,i[1]+e,i[0]+e)}e=C*(d+2*y);for(let t=0;t<E;t++){let i=N[t];D(i[0]+e,i[1]+e,i[2]+e)}}else{for(let e=0;e<E;e++){let t=N[e];D(t[2],t[1],t[0])}for(let e=0;e<E;e++){let t=N[e];D(t[0]+C*d,t[1]+C*d,t[2]+C*d)}}i.addGroup(e,s.length/3-e,0)})(),function(){let e=s.length/3,t=0;z(A,0),t+=A.length;for(let e=0,i=w.length;e<i;e++){let i=w[e];z(i,t),t+=i.length}i.addGroup(e,s.length/3-e,1)}()}(e[n]);this.setAttribute("position",new tg(s,3)),this.setAttribute("uv",new tg(r,2)),this.computeVertexNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){let e=super.toJSON();return function(e,t,i){if(i.shapes=[],Array.isArray(e))for(let t=0,s=e.length;t<s;t++){let s=e[t];i.shapes.push(s.uuid)}else i.shapes.push(e.uuid);return i.options=Object.assign({},t),void 0!==t.extrudePath&&(i.options.extrudePath=t.extrudePath.toJSON()),i}(this.parameters.shapes,this.parameters.options,e)}static fromJSON(e,t){let i=[];for(let s=0,r=e.shapes.length;s<r;s++){let r=t[e.shapes[s]];i.push(r)}let s=e.options.extrudePath;return void 0!==s&&(e.options.extrudePath=new iD[s.type]().fromJSON(s)),new sn(i,e.options)}}let sa={generateTopUV:function(e,t,i,s,r){let n=t[3*i],a=t[3*i+1],o=t[3*s],l=t[3*s+1],h=t[3*r],u=t[3*r+1];return[new S(n,a),new S(o,l),new S(h,u)]},generateSideWallUV:function(e,t,i,s,r,n){let a=t[3*i],o=t[3*i+1],l=t[3*i+2],h=t[3*s],u=t[3*s+1],d=t[3*s+2],c=t[3*r],p=t[3*r+1],m=t[3*r+2],g=t[3*n],f=t[3*n+1],y=t[3*n+2];return Math.abs(o-u)<Math.abs(a-h)?[new S(a,1-l),new S(h,1-d),new S(c,1-m),new S(g,1-y)]:[new S(o,1-l),new S(u,1-d),new S(p,1-m),new S(f,1-y)]}};class so extends iq{constructor(e=1,t=0){let i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new so(e.radius,e.detail)}}class sl extends iq{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new sl(e.radius,e.detail)}}class sh extends t_{constructor(e=1,t=1,i=1,s=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s};let r=e/2,n=t/2,a=Math.floor(i),o=Math.floor(s),l=a+1,h=o+1,u=e/a,d=t/o,c=[],p=[],m=[],g=[];for(let e=0;e<h;e++){let t=e*d-n;for(let i=0;i<l;i++){let s=i*u-r;p.push(s,-t,0),m.push(0,0,1),g.push(i/a),g.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){let i=t+l*e,s=t+l*(e+1),r=t+1+l*(e+1),n=t+1+l*e;c.push(i,s,n),c.push(s,r,n)}this.setIndex(c),this.setAttribute("position",new tg(p,3)),this.setAttribute("normal",new tg(m,3)),this.setAttribute("uv",new tg(g,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sh(e.width,e.height,e.widthSegments,e.heightSegments)}}class su extends t_{constructor(e=.5,t=1,i=32,s=1,r=0,n=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:s,thetaStart:r,thetaLength:n},i=Math.max(3,i);let a=[],o=[],l=[],h=[],u=e,d=(t-e)/(s=Math.max(1,s)),c=new $,p=new S;for(let e=0;e<=s;e++){for(let e=0;e<=i;e++){let s=r+e/i*n;c.x=u*Math.cos(s),c.y=u*Math.sin(s),o.push(c.x,c.y,c.z),l.push(0,0,1),p.x=(c.x/t+1)/2,p.y=(c.y/t+1)/2,h.push(p.x,p.y)}u+=d}for(let e=0;e<s;e++){let t=e*(i+1);for(let e=0;e<i;e++){let s=e+t,r=s+i+1,n=s+i+2,o=s+1;a.push(s,r,o),a.push(r,n,o)}}this.setIndex(a),this.setAttribute("position",new tg(o,3)),this.setAttribute("normal",new tg(l,3)),this.setAttribute("uv",new tg(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new su(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class sd extends t_{constructor(e=new iY([new S(0,.5),new S(-.5,-.5),new S(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};let i=[],s=[],r=[],n=[],a=0,o=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(a,o,t),a+=o,o=0;function l(e){let a=s.length/3,l=e.extractPoints(t),h=l.shape,u=l.holes;!1===si.isClockWise(h)&&(h=h.reverse());for(let e=0,t=u.length;e<t;e++){let t=u[e];!0===si.isClockWise(t)&&(u[e]=t.reverse())}let d=si.triangulateShape(h,u);for(let e=0,t=u.length;e<t;e++){let t=u[e];h=h.concat(t)}for(let e=0,t=h.length;e<t;e++){let t=h[e];s.push(t.x,t.y,0),r.push(0,0,1),n.push(t.x,t.y)}for(let e=0,t=d.length;e<t;e++){let t=d[e],s=t[0]+a,r=t[1]+a,n=t[2]+a;i.push(s,r,n),o+=3}}this.setIndex(i),this.setAttribute("position",new tg(s,3)),this.setAttribute("normal",new tg(r,3)),this.setAttribute("uv",new tg(n,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){let e=super.toJSON();return function(e,t){if(t.shapes=[],Array.isArray(e))for(let i=0,s=e.length;i<s;i++){let s=e[i];t.shapes.push(s.uuid)}else t.shapes.push(e.uuid);return t}(this.parameters.shapes,e)}static fromJSON(e,t){let i=[];for(let s=0,r=e.shapes.length;s<r;s++){let r=t[e.shapes[s]];i.push(r)}return new sd(i,e.curveSegments)}}class sc extends t_{constructor(e=1,t=32,i=16,s=0,r=2*Math.PI,n=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:s,phiLength:r,thetaStart:n,thetaLength:a},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));let o=Math.min(n+a,Math.PI),l=0,h=[],u=new $,d=new $,c=[],p=[],m=[],g=[];for(let c=0;c<=i;c++){let f=[],y=c/i,x=0;0===c&&0===n?x=.5/t:c===i&&o===Math.PI&&(x=-.5/t);for(let i=0;i<=t;i++){let o=i/t;u.x=-e*Math.cos(s+o*r)*Math.sin(n+y*a),u.y=e*Math.cos(n+y*a),u.z=e*Math.sin(s+o*r)*Math.sin(n+y*a),p.push(u.x,u.y,u.z),d.copy(u).normalize(),m.push(d.x,d.y,d.z),g.push(o+x,1-y),f.push(l++)}h.push(f)}for(let e=0;e<i;e++)for(let s=0;s<t;s++){let t=h[e][s+1],r=h[e][s],a=h[e+1][s],l=h[e+1][s+1];(0!==e||n>0)&&c.push(t,r,l),(e!==i-1||o<Math.PI)&&c.push(r,a,l)}this.setIndex(c),this.setAttribute("position",new tg(p,3)),this.setAttribute("normal",new tg(m,3)),this.setAttribute("uv",new tg(g,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sc(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class sp extends iq{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new sp(e.radius,e.detail)}}class sm extends t_{constructor(e=1,t=.4,i=12,s=48,r=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:s,arc:r},i=Math.floor(i),s=Math.floor(s);let n=[],a=[],o=[],l=[],h=new $,u=new $,d=new $;for(let n=0;n<=i;n++)for(let c=0;c<=s;c++){let p=c/s*r,m=n/i*Math.PI*2;u.x=(e+t*Math.cos(m))*Math.cos(p),u.y=(e+t*Math.cos(m))*Math.sin(p),u.z=t*Math.sin(m),a.push(u.x,u.y,u.z),h.x=e*Math.cos(p),h.y=e*Math.sin(p),d.subVectors(u,h).normalize(),o.push(d.x,d.y,d.z),l.push(c/s),l.push(n/i)}for(let e=1;e<=i;e++)for(let t=1;t<=s;t++){let i=(s+1)*e+t-1,r=(s+1)*(e-1)+t-1,a=(s+1)*(e-1)+t,o=(s+1)*e+t;n.push(i,r,o),n.push(r,a,o)}this.setIndex(n),this.setAttribute("position",new tg(a,3)),this.setAttribute("normal",new tg(o,3)),this.setAttribute("uv",new tg(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sm(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class sg extends t_{constructor(e=1,t=.4,i=64,s=8,r=2,n=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:s,p:r,q:n},i=Math.floor(i),s=Math.floor(s);let a=[],o=[],l=[],h=[],u=new $,d=new $,c=new $,p=new $,m=new $,g=new $,f=new $;for(let a=0;a<=i;++a){let x=a/i*r*Math.PI*2;y(x,r,n,e,c),y(x+.01,r,n,e,p),g.subVectors(p,c),f.addVectors(p,c),m.crossVectors(g,f),f.crossVectors(m,g),m.normalize(),f.normalize();for(let e=0;e<=s;++e){let r=e/s*Math.PI*2,n=-t*Math.cos(r),p=t*Math.sin(r);u.x=c.x+(n*f.x+p*m.x),u.y=c.y+(n*f.y+p*m.y),u.z=c.z+(n*f.z+p*m.z),o.push(u.x,u.y,u.z),d.subVectors(u,c).normalize(),l.push(d.x,d.y,d.z),h.push(a/i),h.push(e/s)}}for(let e=1;e<=i;e++)for(let t=1;t<=s;t++){let i=(s+1)*(e-1)+(t-1),r=(s+1)*e+(t-1),n=(s+1)*e+t,o=(s+1)*(e-1)+t;a.push(i,r,o),a.push(r,n,o)}function y(e,t,i,s,r){let n=i/t*e,a=Math.cos(n);r.x=s*(2+a)*.5*Math.cos(e),r.y=s*(2+a)*Math.sin(e)*.5,r.z=s*Math.sin(n)*.5}this.setIndex(a),this.setAttribute("position",new tg(o,3)),this.setAttribute("normal",new tg(l,3)),this.setAttribute("uv",new tg(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sg(e.radius,e.tube,e.tubularSegments,e.radialSegments,e.p,e.q)}}class sf extends t_{constructor(e=new iz(new $(-1,-1,0),new $(-1,1,0),new $(1,1,0)),t=64,i=1,s=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:s,closed:r};let n=e.computeFrenetFrames(t,r);this.tangents=n.tangents,this.normals=n.normals,this.binormals=n.binormals;let a=new $,o=new $,l=new S,h=new $,u=[],d=[],c=[],p=[];function m(r){h=e.getPointAt(r/t,h);let l=n.normals[r],c=n.binormals[r];for(let e=0;e<=s;e++){let t=e/s*Math.PI*2,r=Math.sin(t),n=-Math.cos(t);o.x=n*l.x+r*c.x,o.y=n*l.y+r*c.y,o.z=n*l.z+r*c.z,o.normalize(),d.push(o.x,o.y,o.z),a.x=h.x+i*o.x,a.y=h.y+i*o.y,a.z=h.z+i*o.z,u.push(a.x,a.y,a.z)}}(function(){for(let e=0;e<t;e++)m(e);m(!1===r?t:0),function(){for(let e=0;e<=t;e++)for(let i=0;i<=s;i++)l.x=e/t,l.y=i/s,c.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=s;t++){let i=(s+1)*(e-1)+(t-1),r=(s+1)*e+(t-1),n=(s+1)*e+t,a=(s+1)*(e-1)+t;p.push(i,r,a),p.push(r,n,a)}}()})(),this.setIndex(p),this.setAttribute("position",new tg(u,3)),this.setAttribute("normal",new tg(d,3)),this.setAttribute("uv",new tg(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){let e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new sf(new iD[e.path.type]().fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class sy extends tr{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new tt(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class sx extends tq{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class sb extends tr{constructor(e){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new tt(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new tt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new eI,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class sv extends sb{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new S(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return y(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new tt(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new tt(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new tt(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class sT extends tr{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new tt(16777215),this.specular=new tt(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new tt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new eI,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class sS extends tr{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new tt(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new tt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class s_ extends tr{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class sM extends tr{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new tt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new tt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new eI,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class sw extends tr{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class sN extends tr{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class sA extends tr{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new tt(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new S(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}}class sR extends ig{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}function sC(e,t=!1){let i="{";for(let{property:s,childNode:r}of(!0===e.isNode&&(i+=e.id,e=e.getSelf()),sE(e)))i+=","+s.slice(0,-4)+":"+r.getCacheKey(t);return i+"}"}function*sE(e,t=!1){for(let i in e){if(!0===i.startsWith("_"))continue;let s=e[i];if(!0===Array.isArray(s))for(let e=0;e<s.length;e++){let r=s[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:i,index:e,childNode:r})}else if(s&&!0===s.isNode)yield{property:i,childNode:s};else if("object"==typeof s)for(let e in s){let r=s[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:i,index:e,childNode:r})}}}function sB(e){if(null==e)return null;let t=typeof e;if(!0===e.isNode)return"node";if("number"===t)return"float";if("boolean"===t)return"bool";if("string"===t)return"string";if("function"===t)return"shader";if(!0===e.isVector2)return"vec2";if(!0===e.isVector3)return"vec3";else if(!0===e.isVector4)return"vec4";else if(!0===e.isMatrix3)return"mat3";else if(!0===e.isMatrix4)return"mat4";else if(!0===e.isColor)return"color";else if(e instanceof ArrayBuffer)return"ArrayBuffer";return null}function sI(e,...t){let i=e?e.slice(-4):void 0;if(1===t.length&&("vec2"===i?t=[t[0],t[0]]:"vec3"===i?t=[t[0],t[0],t[0]]:"vec4"===i&&(t=[t[0],t[0],t[0],t[0]])),"color"===e)return new tt(...t);if("vec2"===i)return new S(...t);if("vec3"===i)return new $(...t);if("vec4"===i)return new k(...t);if("mat3"===i)return new _(...t);if("mat4"===i)return new eS(...t);if("bool"===e)return t[0]||!1;else if("float"===e||"int"===e||"uint"===e)return t[0]||0;else if("string"===e)return t[0]||"";else if("ArrayBuffer"===e)return sF(t[0]);return null}function sP(e){let t="",i=new Uint8Array(e);for(let e=0;e<i.length;e++)t+=String.fromCharCode(i[e]);return btoa(t)}function sF(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0)).buffer}let sU={VERTEX:"vertex"},sO={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},sz=["setup","analyze","generate"],sL=["fragment","vertex","compute"],sD=["x","y","z","w"],sV=new Map,sk=0;class sG extends c{constructor(e=null){super(),this.nodeType=e,this.updateType=sO.NONE,this.updateBeforeType=sO.NONE,this.updateAfterType=sO.NONE,this.uuid=T.generateUUID(),this.version=0,this._cacheKey=null,this._cacheKeyVersion=0,this.global=!1,this.isNode=!0,Object.defineProperty(this,"id",{value:sk++})}set needsUpdate(e){!0===e&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this.getSelf()),this}onFrameUpdate(e){return this.onUpdate(e,sO.FRAME)}onRenderUpdate(e){return this.onUpdate(e,sO.RENDER)}onObjectUpdate(e){return this.onUpdate(e,sO.OBJECT)}onReference(e){return this.updateReference=e.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(let{childNode:e}of sE(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){for(let t of(e(this),this.getChildren()))t.traverse(e)}getCacheKey(e=!1){return(!0===(e=e||this.version!==this._cacheKeyVersion)||null===this._cacheKey)&&(this._cacheKey=sC(this,e),this._cacheKeyVersion=this.version),this._cacheKey}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){let t=this.getNodeType(e);return e.getElementType(t)}getNodeType(e){let t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){let t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){let t=e.getNodeProperties(this),i=0;for(let e of this.getChildren())t["node"+i++]=e;return null}analyze(e){if(1===e.increaseUsage(this))for(let t of Object.values(e.getNodeProperties(this)))t&&!0===t.isNode&&t.build(e)}generate(e,t){let{outputNode:i}=e.getNodeProperties(this);if(i&&!0===i.isNode)return i.build(e,t)}updateBefore(){console.warn("Abstract function.")}updateAfter(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e,t=null){let i=this.getShared(e);if(this!==i)return i.build(e,t);e.addNode(this),e.addChain(this);let s=null,r=e.getBuildStage();if("setup"===r){this.updateReference(e);let t=e.getNodeProperties(this);if(!0!==t.initialized)for(let i of(e.stack.nodes.length,t.initialized=!0,t.outputNode=this.setup(e),null!==t.outputNode&&e.stack.nodes.length,Object.values(t)))i&&!0===i.isNode&&i.build(e)}else if("analyze"===r)this.analyze(e);else if("generate"===r){if(1===this.generate.length){let i=this.getNodeType(e),r=e.getDataFromNode(this);void 0===(s=r.snippet)&&(s=this.generate(e)||"",r.snippet=s),s=e.format(s,i,t)}else s=this.generate(e,t)||""}return e.removeChain(this),s}getSerializeChildren(){return sE(this)}serialize(e){let t=this.getSerializeChildren(),i={};for(let{property:s,index:r,childNode:n}of t)void 0!==r?(void 0===i[s]&&(i[s]=Number.isInteger(r)?[]:{}),i[s][r]=n.toJSON(e.meta).uuid):i[s]=n.toJSON(e.meta).uuid;Object.keys(i).length>0&&(e.inputNodes=i)}deserialize(e){if(void 0!==e.inputNodes){let t=e.meta.nodes;for(let i in e.inputNodes)if(Array.isArray(e.inputNodes[i])){let s=[];for(let r of e.inputNodes[i])s.push(t[r]);this[i]=s}else if("object"==typeof e.inputNodes[i]){let s={};for(let r in e.inputNodes[i]){let n=e.inputNodes[i][r];s[r]=t[n]}this[i]=s}else{let s=e.inputNodes[i];this[i]=t[s]}}}toJSON(e){let{uuid:t,type:i}=this,s=void 0===e||"string"==typeof e;s&&(e={textures:{},images:{},nodes:{}});let r=e.nodes[t];function n(e){let t=[];for(let i in e){let s=e[i];delete s.metadata,t.push(s)}return t}if(void 0===r&&(r={uuid:t,type:i,meta:e,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},!0!==s&&(e.nodes[r.uuid]=r),this.serialize(r),delete r.meta),s){let t=n(e.textures),i=n(e.images),s=n(e.nodes);t.length>0&&(r.textures=t),i.length>0&&(r.images=i),s.length>0&&(r.nodes=s)}return r}}function sW(e,t){let i="Node",s=e+i;if("function"!=typeof t)throw Error(`TSL.Node: Node class ${e} is not a class`);if(sV.has(s)){console.warn(`TSL.Node: Redefinition of node class ${s}`);return}if(e.slice(-i.length)===i){console.warn(`TSL.Node: Node class ${s} should not have '${i}' suffix.`);return}return sV.set(s,t),t.type=s,s}sG.type=sW("",sG);class sH extends sG{constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){let t=this.node.build(e),i=this.indexNode.build(e,"uint");return`${t}[ ${i} ]`}}sH.type=sW("ArrayElement",sH);class sj extends sG{constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){let t=this.node.getNodeType(e),i=null;for(let s of this.convertTo.split("|"))(null===i||e.getTypeLength(t)===e.getTypeLength(s))&&(i=s);return i}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){let i=this.node,s=this.getNodeType(e),r=i.build(e,s);return e.format(r,s,t)}}sj.type=sW("Convert",sj);class s$ extends sG{constructor(e){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if("generate"===e.getBuildStage()){let i=e.getVectorType(this.getNodeType(e,t)),s=e.getDataFromNode(this);if(void 0!==s.propertyName)return e.format(s.propertyName,i,t);if("void"!==i&&"void"!==t&&this.hasDependencies(e)){let r=super.build(e,i),n=e.getVarFromNode(this,null,i),a=e.getPropertyName(n);return e.addLineFlowCode(`${a} = ${r}`),s.snippet=r,s.propertyName=a,e.format(s.propertyName,i,t)}}return super.build(e,t)}}s$.type=sW("Temp",s$);class sq extends s${constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,i)=>t+e.getTypeLength(i.getNodeType(e)),0))}generate(e,t){let i=this.getNodeType(e),s=this.nodes,r=e.getComponentType(i),n=[];for(let t of s){let i=t.build(e),s=e.getComponentType(t.getNodeType(e));s!==r&&(i=e.format(i,s,r)),n.push(i)}let a=`${e.getType(i)}( ${n.join(", ")} )`;return e.format(a,i,t)}}sq.type=sW("Join",sq);let sX=sD.join("");class sY extends sG{constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(let t of this.components)e=Math.max(sD.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){let i=this.node,s=e.getTypeLength(i.getNodeType(e)),r=null;if(s>1){let n=null;this.getVectorLength()>=s&&(n=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));let a=i.build(e,n);r=this.components.length===s&&this.components===sX.slice(0,this.components.length)?e.format(a,n,t):e.format(`${a}.${this.components}`,this.getNodeType(e),t)}else r=i.build(e,t);return r}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}sY.type=sW("Split",sY);class sJ extends s${constructor(e,t,i){super(),this.sourceNode=e,this.components=t,this.targetNode=i}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){let{sourceNode:t,components:i,targetNode:s}=this,r=this.getNodeType(e),n=e.getTypeFromLength(i.length),a=s.build(e,n),o=t.build(e,r),l=e.getTypeLength(r),h=[];for(let e=0;e<l;e++){let t=sD[e];t===i[0]?(h.push(a),e+=i.length-1):h.push(o+"."+t)}return`${e.getType(r)}( ${h.join(", ")} )`}}sJ.type=sW("Set",sJ);class sK extends s${constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){let{components:t,sourceNode:i}=this,s=this.getNodeType(e),r=i.build(e),n=e.getVarFromNode(this),a=e.getPropertyName(n);e.addLineFlowCode(a+" = "+r);let o=e.getTypeLength(s),l=[],h=0;for(let e=0;e<o;e++){let i=sD[e];i===t[h]?(l.push("1.0 - "+a+"."+i),h++):l.push(a+"."+i)}return`${e.getType(s)}( ${l.join(", ")} )`}}sK.type=sW("Flip",sK);class sQ extends sG{constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?sB(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=sB(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=sP(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?sI(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}}sQ.type=sW("Input",sQ);class sZ extends sQ{constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){let i=this.getNodeType(e);return e.format(this.generateConst(e),i,t)}}sZ.type=sW("Const",sZ);let s0=null,s1=new Map;function s2(e,t){if(s1.has(e)){console.warn(`Redefinition of method chaining ${e}`);return}if("function"!=typeof t)throw Error(`Node element ${e} is not a function`);s1.set(e,t)}let s3=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),s4=e=>s3(e).split("").sort().join(""),s5={setup:(e,t)=>e(rx(t.shift()),...t),get(e,t,i){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>(s0.assign(i,...e),i);if(s1.has(t)){let s=s1.get(t);return e.isStackNode?(...e)=>i.add(s(...e)):(...e)=>s(i,...e)}if("self"===t)return e;if(t.endsWith("Assign")&&s1.has(t.slice(0,t.length-6))){let s=s1.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>i.assign(e[0],s(...e)):(...e)=>i.assign(s(i,...e))}else if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return ry(new sY(i,t=s3(t)));else if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=s4(t.slice(3).toLowerCase()),i=>ry(new sJ(e,t,i));else if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(t))return t=s4(t.slice(4).toLowerCase()),()=>ry(new sK(ry(e),t));else if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),ry(new sY(e,t));else if(!0===/^\d+$/.test(t))return ry(new sH(i,new sZ(Number(t),"uint")))}return Reflect.get(e,t,i)},set:(e,t,i,s)=>"string"==typeof t&&void 0===e[t]&&(!0===/^[xyzwrgbastpq]{1,4}$/.test(t)||"width"===t||"height"===t||"depth"===t||!0===/^\d+$/.test(t))?(s[t].assign(i),!0):Reflect.set(e,t,i,s)},s6=new WeakMap,s8=new WeakMap,s7=function(e,t=null){let i=sB(e);if("node"===i){let t=s6.get(e);return void 0===t&&(t=new Proxy(e,s5),s6.set(e,t),s6.set(t,t)),t}return null===t&&("float"===i||"boolean"===i)||i&&"shader"!==i&&"string"!==i?ry(rd(e,t)):"shader"===i?rS(e):e},s9=function(e,t=null){for(let i in e)e[i]=ry(e[i],t);return e},re=function(e,t=null){let i=e.length;for(let s=0;s<i;s++)e[s]=ry(e[s],t);return e},rt=function(e,t=null,i=null,s=null){let r=e=>ry(null!==s?Object.assign(e,s):e);return null===t?(...t)=>r(new e(...rb(t))):null!==i?(i=ry(i),(...s)=>r(new e(t,...rb(s),i))):(...i)=>r(new e(t,...rb(i)))},ri=function(e,...t){return ry(new e(...rb(t)))};class rs extends sG{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}call(e){let{shaderNode:t,inputNodes:i}=this,s=e.getNodeProperties(t);if(s.onceOutput)return s.onceOutput;let r=null;if(t.layout){let s=s8.get(e.constructor);void 0===s&&(s=new WeakMap,s8.set(e.constructor,s));let n=s.get(t);void 0===n&&(n=ry(e.buildFunctionNode(t)),s.set(t,n)),null!==e.currentFunctionNode&&e.currentFunctionNode.includes.push(n),r=ry(n.call(i))}else{let s=t.jsFunc;r=ry(null!==i?s(i,e):s(e))}return t.once&&(s.onceOutput=r),r}getOutputNode(e){let t=e.getNodeProperties(this);return null===t.outputNode&&(t.outputNode=this.setupOutput(e)),t.outputNode}setup(e){return this.getOutputNode(e)}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}generate(e,t){return this.getOutputNode(e).build(e,t)}}class rr extends sG{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1}setLayout(e){return this.layout=e,this}call(e=null){return rx(e),ry(new rs(this,e))}setup(){return this.call()}}let rn=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],ra=new Map;for(let e of[!1,!0])ra.set(e,new sZ(e));let ro=new Map;for(let e of[0,1,2,3])ro.set(e,new sZ(e,"uint"));let rl=new Map([...ro].map(e=>new sZ(e.value,"int")));for(let e of[-1,-2])rl.set(e,new sZ(e,"int"));let rh=new Map([...rl].map(e=>new sZ(e.value)));for(let e of rn)rh.set(e,new sZ(e));for(let e of rn)rh.set(-e,new sZ(-e));let ru=new Map([...ra,...rh]),rd=(e,t)=>ru.has(e)?ru.get(e):!0===e.isNode?e:new sZ(e,t),rc=e=>{try{return e.getNodeType()}catch(e){return}},rp=function(e,t=null){return(...i)=>{if((0===i.length||!["bool","float","int","uint"].includes(e)&&i.every(e=>"object"!=typeof e))&&(i=[sI(e,...i)]),1===i.length&&null!==t&&t.has(i[0]))return ry(t.get(i[0]));if(1===i.length){let t=rd(i[0],e);return rc(t)===e?ry(t):ry(new sj(t,e))}return ry(new sq(i.map(e=>rd(e)),e))}},rm=e=>"object"==typeof e&&null!==e?e.value:e,rg=e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null;function rf(e,t){return new Proxy(new rr(e,t),s5)}let ry=(e,t=null)=>s7(e,t),rx=(e,t=null)=>new s9(e,t),rb=(e,t=null)=>new re(e,t),rv=(...e)=>new rt(...e),rT=(...e)=>new ri(...e),rS=(e,t)=>{let i=new rf(e,t),s=(...e)=>{let t;return rx(e),t=e[0]&&e[0].isNode?[...e]:e[0],i.call(t)};return s.shaderNode=i,s.setLayout=e=>(i.setLayout(e),s),s.once=()=>(i.once=!0,s),s};s2("toGlobal",e=>(e.global=!0,e));let r_=e=>{s0=e},rM=()=>s0,rw=(...e)=>s0.If(...e);s2("append",function(e){return s0&&s0.add(e),e});let rN=new rp("color"),rA=new rp("float",rh),rR=new rp("int",rl),rC=new rp("uint",ro),rE=new rp("bool",ra),rB=new rp("vec2"),rI=new rp("ivec2"),rP=new rp("uvec2"),rF=new rp("bvec2"),rU=new rp("vec3"),rO=new rp("ivec3"),rz=new rp("uvec3"),rL=new rp("bvec3"),rD=new rp("vec4"),rV=new rp("ivec4"),rk=new rp("uvec4"),rG=new rp("bvec4"),rW=new rp("mat2"),rH=new rp("mat3"),rj=new rp("mat4");s2("toColor",rN),s2("toFloat",rA),s2("toInt",rR),s2("toUint",rC),s2("toBool",rE),s2("toVec2",rB),s2("toIVec2",rI),s2("toUVec2",rP),s2("toBVec2",rF),s2("toVec3",rU),s2("toIVec3",rO),s2("toUVec3",rz),s2("toBVec3",rL),s2("toVec4",rD),s2("toIVec4",rV),s2("toUVec4",rk),s2("toBVec4",rG),s2("toMat2",rW),s2("toMat3",rH),s2("toMat4",rj),s2("element",rv(sH)),s2("convert",(e,t)=>ry(new sj(ry(e),t)));class r$ extends sG{constructor(e,t=!1){super("string"),this.name=e,this.version=0,this.shared=t,this.isUniformGroup=!0}set needsUpdate(e){!0===e&&this.version++}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}}r$.type=sW("UniformGroup",r$);let rq=e=>new r$(e,!0),rX=rq("frame"),rY=rq("render"),rJ=new r$("object");class rK extends sQ{constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=rJ}label(e){return this.name=e,this}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){let i=this.getSelf();return e=e.bind(i),super.onUpdate(t=>{let s=e(t,i);void 0!==s&&(this.value=s)},t)}generate(e,t){let i=this.getNodeType(e),s=this.getUniformHash(e),r=e.getNodeFromHash(s);void 0===r&&(e.setHashNode(this,s),r=this);let n=r.getInputType(e),a=e.getUniformFromNode(r,n,e.shaderStage,this.name||e.context.label),o=e.getPropertyName(a);return void 0!==e.context.label&&delete e.context.label,e.format(o,i,t)}}rK.type=sW("Uniform",rK);let rQ=(e,t)=>{let i=rg(t||e);return ry(new rK(e&&!0===e.isNode?e.node&&e.node.value||e.value:e,i))};class rZ extends sG{constructor(e,t=null,i=!1){super(e),this.name=t,this.varying=i,this.isPropertyNode=!0}getHash(e){return this.name||super.getHash(e)}isGlobal(){return!0}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name)).needsInterpolation=!0:t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}rZ.type=sW("Property",rZ);let r0=(e,t)=>ry(new rZ(e,t)),r1=(e,t)=>ry(new rZ(e,t,!0)),r2=rT(rZ,"vec4","DiffuseColor"),r3=rT(rZ,"vec3","EmissiveColor"),r4=rT(rZ,"float","Roughness"),r5=rT(rZ,"float","Metalness"),r6=rT(rZ,"float","Clearcoat"),r8=rT(rZ,"float","ClearcoatRoughness"),r7=rT(rZ,"vec3","Sheen"),r9=rT(rZ,"float","SheenRoughness"),ne=rT(rZ,"float","Iridescence"),nt=rT(rZ,"float","IridescenceIOR"),ni=rT(rZ,"float","IridescenceThickness"),ns=rT(rZ,"float","AlphaT"),nr=rT(rZ,"float","Anisotropy"),nn=rT(rZ,"vec3","AnisotropyT"),na=rT(rZ,"vec3","AnisotropyB"),no=rT(rZ,"color","SpecularColor"),nl=rT(rZ,"float","SpecularF90"),nh=rT(rZ,"float","Shininess"),nu=rT(rZ,"vec4","Output"),nd=rT(rZ,"float","dashSize"),nc=rT(rZ,"float","gapSize"),np=rT(rZ,"float","IOR"),nm=rT(rZ,"float","Transmission"),ng=rT(rZ,"float","Thickness"),nf=rT(rZ,"float","AttenuationDistance"),ny=rT(rZ,"color","AttenuationColor"),nx=rT(rZ,"float","Dispersion");class nb extends s${constructor(e,t){super(),this.targetNode=e,this.sourceNode=t}hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){let{targetNode:t}=this;if(!1===e.isAvailable("swizzleAssign")&&t.isSplitNode&&t.components.length>1){let i=e.getTypeLength(t.node.getNodeType(e));return sD.join("").slice(0,i)!==t.components}return!1}generate(e,t){let i;let{targetNode:s,sourceNode:r}=this,n=this.needsSplitAssign(e),a=s.getNodeType(e),o=s.context({assign:!0}).build(e),l=r.build(e,a),h=r.getNodeType(e),u=e.getDataFromNode(this);if(!0===u.initialized)"void"!==t&&(i=o);else if(n){let r=e.getVarFromNode(this,null,a),n=e.getPropertyName(r);e.addLineFlowCode(`${n} = ${l}`);let h=s.node.context({assign:!0}).build(e);for(let t=0;t<s.components.length;t++){let i=s.components[t];e.addLineFlowCode(`${h}.${i} = ${n}[ ${t} ]`)}"void"!==t&&(i=o)}else i=`${o} = ${l}`,("void"===t||"void"===h)&&(e.addLineFlowCode(i),"void"!==t&&(i=o));return u.initialized=!0,e.format(i,a,t)}}nb.type=sW("Assign",nb),s2("assign",rv(nb));class nv extends s${constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){let t=[],i=this.functionNode,s=i.getInputs(e),r=this.parameters;if(Array.isArray(r))for(let i=0;i<r.length;i++){let n=s[i],a=r[i];t.push(a.build(e,n.type))}else for(let i of s){let s=r[i.name];if(void 0!==s)t.push(s.build(e,i.type));else throw Error(`FunctionCallNode: Input '${i.name}' not found in FunctionNode.`)}let n=i.build(e,"property");return`${n}( ${t.join(", ")} )`}}nv.type=sW("FunctionCall",nv),s2("call",(e,...t)=>(t=t.length>1||t[0]&&!0===t[0].isNode?rb(t):rx(t[0]),ry(new nv(ry(e),t))));class nT extends s${constructor(e,t,i,...s){if(super(),s.length>0){let r=new nT(e,t,i);for(let t=0;t<s.length-1;t++)r=new nT(e,r,s[t]);t=r,i=s[s.length-1]}this.op=e,this.aNode=t,this.bNode=i}getNodeType(e,t){let i=this.op,s=this.aNode,r=this.bNode,n=s.getNodeType(e),a=void 0!==r?r.getNodeType(e):null;if("void"===n||"void"===a)return"void";if("%"===i)return n;if("~"===i||"&"===i||"|"===i||"^"===i||">>"===i||"<<"===i)return e.getIntegerType(n);if("!"===i||"=="===i||"&&"===i||"||"===i||"^^"===i)return"bool";if("<"===i||">"===i||"<="===i||">="===i){let i=t?e.getTypeLength(t):Math.max(e.getTypeLength(n),e.getTypeLength(a));return i>1?`bvec${i}`:"bool"}return"float"===n&&e.isMatrix(a)?a:e.isMatrix(n)&&e.isVector(a)?e.getVectorFromMatrix(n):e.isVector(n)&&e.isMatrix(a)?e.getVectorFromMatrix(a):e.getTypeLength(a)>e.getTypeLength(n)?a:n}generate(e,t){let i=this.op,s=this.aNode,r=this.bNode,n=this.getNodeType(e,t),a=null,o=null;"void"!==n?(a=s.getNodeType(e),o=void 0!==r?r.getNodeType(e):null,"<"===i||">"===i||"<="===i||">="===i||"=="===i?e.isVector(a)?o=a:a!==o&&(a=o="float"):">>"===i||"<<"===i?(a=n,o=e.changeComponentType(o,"uint")):e.isMatrix(a)&&e.isVector(o)?o=e.getVectorFromMatrix(a):a=e.isVector(a)&&e.isMatrix(o)?e.getVectorFromMatrix(o):o=n):a=o=n;let l=s.build(e,a),h=void 0!==r?r.build(e,o):null,u=e.getTypeLength(t),d=e.getFunctionOperator(i);if("void"!==t){if("<"===i&&u>1)return e.useComparisonMethod?e.format(`${e.getMethod("lessThan",t)}( ${l}, ${h} )`,n,t):e.format(`( ${l} < ${h} )`,n,t);if("<="===i&&u>1)return e.useComparisonMethod?e.format(`${e.getMethod("lessThanEqual",t)}( ${l}, ${h} )`,n,t):e.format(`( ${l} <= ${h} )`,n,t);if(">"===i&&u>1)return e.useComparisonMethod?e.format(`${e.getMethod("greaterThan",t)}( ${l}, ${h} )`,n,t):e.format(`( ${l} > ${h} )`,n,t);if(">="===i&&u>1)return e.useComparisonMethod?e.format(`${e.getMethod("greaterThanEqual",t)}( ${l}, ${h} )`,n,t):e.format(`( ${l} >= ${h} )`,n,t);else if("!"===i||"~"===i)return e.format(`(${i}${l})`,a,t);else if(d)return e.format(`${d}( ${l}, ${h} )`,n,t);else return e.format(`( ${l} ${i} ${h} )`,n,t)}if("void"!==a)return d?e.format(`${d}( ${l}, ${h} )`,n,t):e.format(`${l} ${i} ${h}`,n,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}nT.type=sW("Operator",nT);let nS=rv(nT,"+"),n_=rv(nT,"-"),nM=rv(nT,"*"),nw=rv(nT,"/"),nN=rv(nT,"%"),nA=rv(nT,"=="),nR=rv(nT,"!="),nC=rv(nT,"<"),nE=rv(nT,">"),nB=rv(nT,"<="),nI=rv(nT,">="),nP=rv(nT,"&&"),nF=rv(nT,"||"),nU=rv(nT,"!"),nO=rv(nT,"^^"),nz=rv(nT,"&"),nL=rv(nT,"~"),nD=rv(nT,"|"),nV=rv(nT,"^"),nk=rv(nT,"<<"),nG=rv(nT,">>");s2("add",nS),s2("sub",n_),s2("mul",nM),s2("div",nw),s2("modInt",nN),s2("equal",nA),s2("notEqual",nR),s2("lessThan",nC),s2("greaterThan",nE),s2("lessThanEqual",nB),s2("greaterThanEqual",nI),s2("and",nP),s2("or",nF),s2("not",nU),s2("xor",nO),s2("bitAnd",nz),s2("bitNot",nL),s2("bitOr",nD),s2("bitXor",nV),s2("shiftLeft",nk),s2("shiftRight",nG),s2("remainder",(...e)=>(console.warn("TSL.OperatorNode: .remainder() has been renamed to .modInt()."),nN(...e)));class nW extends s${constructor(e,t,i=null,s=null){super(),this.method=e,this.aNode=t,this.bNode=i,this.cNode=s}getInputType(e){let t=this.aNode.getNodeType(e),i=this.bNode?this.bNode.getNodeType(e):null,s=this.cNode?this.cNode.getNodeType(e):null,r=e.isMatrix(t)?0:e.getTypeLength(t),n=e.isMatrix(i)?0:e.getTypeLength(i),a=e.isMatrix(s)?0:e.getTypeLength(s);if(r>n&&r>a);else if(n>a)return i;else if(a>r)return s;return t}getNodeType(e){let t=this.method;return t===nW.LENGTH||t===nW.DISTANCE||t===nW.DOT?"float":t===nW.CROSS?"vec3":t===nW.ALL?"bool":t===nW.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):t===nW.MOD?this.aNode.getNodeType(e):this.getInputType(e)}generate(e,t){let i=this.method,s=this.getNodeType(e),r=this.getInputType(e),n=this.aNode,a=this.bNode,o=this.cNode,l=!0===e.renderer.isWebGLRenderer;if(i===nW.TRANSFORM_DIRECTION){let i=n,s=a;return e.isMatrix(i.getNodeType(e))?s=rD(rU(s),0):i=rD(rU(i),0),n5(nM(i,s).xyz).build(e,t)}if(i===nW.NEGATE)return e.format("( - "+n.build(e,r)+" )",s,t);if(i===nW.ONE_MINUS)return n_(1,n).build(e,t);{if(i===nW.RECIPROCAL)return nw(1,n).build(e,t);if(i===nW.DIFFERENCE)return as(n_(n,a)).build(e,t);let h=[];return i===nW.CROSS||i===nW.MOD?h.push(n.build(e,s),a.build(e,s)):l&&i===nW.STEP?h.push(n.build(e,1===e.getTypeLength(n.getNodeType(e))?"float":r),a.build(e,r)):l&&(i===nW.MIN||i===nW.MAX)||i===nW.MOD?h.push(n.build(e,r),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":r)):i===nW.REFRACT?h.push(n.build(e,r),a.build(e,r),o.build(e,"float")):i===nW.MIX?h.push(n.build(e,r),a.build(e,r),o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":r)):(h.push(n.build(e,r)),null!==a&&h.push(a.build(e,r)),null!==o&&h.push(o.build(e,r))),e.format(`${e.getMethod(i,s)}( ${h.join(", ")} )`,s,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}nW.ALL="all",nW.ANY="any",nW.EQUALS="equals",nW.RADIANS="radians",nW.DEGREES="degrees",nW.EXP="exp",nW.EXP2="exp2",nW.LOG="log",nW.LOG2="log2",nW.SQRT="sqrt",nW.INVERSE_SQRT="inversesqrt",nW.FLOOR="floor",nW.CEIL="ceil",nW.NORMALIZE="normalize",nW.FRACT="fract",nW.SIN="sin",nW.COS="cos",nW.TAN="tan",nW.ASIN="asin",nW.ACOS="acos",nW.ATAN="atan",nW.ABS="abs",nW.SIGN="sign",nW.LENGTH="length",nW.NEGATE="negate",nW.ONE_MINUS="oneMinus",nW.DFDX="dFdx",nW.DFDY="dFdy",nW.ROUND="round",nW.RECIPROCAL="reciprocal",nW.TRUNC="trunc",nW.FWIDTH="fwidth",nW.BITCAST="bitcast",nW.TRANSPOSE="transpose",nW.ATAN2="atan2",nW.MIN="min",nW.MAX="max",nW.MOD="mod",nW.STEP="step",nW.REFLECT="reflect",nW.DISTANCE="distance",nW.DIFFERENCE="difference",nW.DOT="dot",nW.CROSS="cross",nW.POW="pow",nW.TRANSFORM_DIRECTION="transformDirection",nW.MIX="mix",nW.CLAMP="clamp",nW.REFRACT="refract",nW.SMOOTHSTEP="smoothstep",nW.FACEFORWARD="faceforward",nW.type=sW("Math",nW);let nH=rA(1e-6),nj=rA(Math.PI),n$=rv(nW,nW.ALL),nq=rv(nW,nW.ANY),nX=rv(nW,nW.EQUALS),nY=rv(nW,nW.RADIANS),nJ=rv(nW,nW.DEGREES),nK=rv(nW,nW.EXP),nQ=rv(nW,nW.EXP2),nZ=rv(nW,nW.LOG),n0=rv(nW,nW.LOG2),n1=rv(nW,nW.SQRT),n2=rv(nW,nW.INVERSE_SQRT),n3=rv(nW,nW.FLOOR),n4=rv(nW,nW.CEIL),n5=rv(nW,nW.NORMALIZE),n6=rv(nW,nW.FRACT),n8=rv(nW,nW.SIN),n7=rv(nW,nW.COS),n9=rv(nW,nW.TAN),ae=rv(nW,nW.ASIN),at=rv(nW,nW.ACOS),ai=rv(nW,nW.ATAN),as=rv(nW,nW.ABS),ar=rv(nW,nW.SIGN),an=rv(nW,nW.LENGTH),aa=rv(nW,nW.NEGATE),ao=rv(nW,nW.ONE_MINUS),al=rv(nW,nW.DFDX),ah=rv(nW,nW.DFDY),au=rv(nW,nW.ROUND),ad=rv(nW,nW.RECIPROCAL),ac=rv(nW,nW.TRUNC),ap=rv(nW,nW.FWIDTH);nW.BITCAST;let am=rv(nW,nW.TRANSPOSE),ag=rv(nW,nW.ATAN2),af=rv(nW,nW.MIN),ay=rv(nW,nW.MAX),ax=rv(nW,nW.MOD),ab=rv(nW,nW.STEP),av=rv(nW,nW.REFLECT),aT=rv(nW,nW.DISTANCE),aS=rv(nW,nW.DIFFERENCE),a_=rv(nW,nW.DOT),aM=rv(nW,nW.CROSS),aw=rv(nW,nW.POW),aN=rv(nW,nW.POW,2),aA=rv(nW,nW.POW,3),aR=rv(nW,nW.POW,4),aC=rv(nW,nW.TRANSFORM_DIRECTION),aE=rv(nW,nW.MIX),aB=(e,t=0,i=1)=>ry(new nW(nW.CLAMP,ry(e),ry(t),ry(i))),aI=rv(nW,nW.REFRACT),aP=rv(nW,nW.SMOOTHSTEP),aF=rv(nW,nW.FACEFORWARD),aU=rS(([e])=>n6(n8(ax(a_(e.xy,rB(12.9898,78.233)),nj)).mul(43758.5453)));s2("all",n$),s2("any",nq),s2("equals",nX),s2("radians",nY),s2("degrees",nJ),s2("exp",nK),s2("exp2",nQ),s2("log",nZ),s2("log2",n0),s2("sqrt",n1),s2("inverseSqrt",n2),s2("floor",n3),s2("ceil",n4),s2("normalize",n5),s2("fract",n6),s2("sin",n8),s2("cos",n7),s2("tan",n9),s2("asin",ae),s2("acos",at),s2("atan",ai),s2("abs",as),s2("sign",ar),s2("length",an),s2("lengthSq",e=>a_(e,e)),s2("negate",aa),s2("oneMinus",ao),s2("dFdx",al),s2("dFdy",ah),s2("round",au),s2("reciprocal",ad),s2("trunc",ac),s2("fwidth",ap),s2("atan2",ag),s2("min",af),s2("max",ay),s2("mod",ax),s2("step",ab),s2("reflect",av),s2("distance",aT),s2("dot",a_),s2("cross",aM),s2("pow",aw),s2("pow2",aN),s2("pow3",aA),s2("pow4",aR),s2("transformDirection",aC),s2("mix",(e,t,i)=>aE(t,i,e)),s2("clamp",aB),s2("refract",aI),s2("smoothstep",(e,t,i)=>aP(t,i,e)),s2("faceForward",aF),s2("difference",aS),s2("saturate",e=>aB(e)),s2("cbrt",e=>nM(ar(e),aw(as(e),1/3))),s2("transpose",am),s2("rand",aU);class aO extends sG{constructor(e,t,i=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=i}getNodeType(e){let t=this.ifNode.getNodeType(e);if(null!==this.elseNode){let i=this.elseNode.getNodeType(e);if(e.getTypeLength(i)>e.getTypeLength(t))return i}return t}setup(e){let t=e.getNodeProperties(this);t.condNode=this.condNode.cache(),t.ifNode=this.ifNode.cache(),t.elseNode=this.elseNode?this.elseNode.cache():null}generate(e,t){let i=this.getNodeType(e),s=e.getDataFromNode(this);if(void 0!==s.nodeProperty)return s.nodeProperty;let{condNode:r,ifNode:n,elseNode:a}=e.getNodeProperties(this),o="void"!==t,l=o?r0(i).build(e):"";s.nodeProperty=l;let h=r.build(e,"bool");e.addFlowCode(`
${e.tab}if ( ${h} ) {

`).addFlowTab();let u=n.build(e,i);if(u&&(u=o?l+" = "+u+";":"return "+u+";"),e.removeFlowTab().addFlowCode(e.tab+"	"+u+"\n\n"+e.tab+"}"),null!==a){e.addFlowCode(" else {\n\n").addFlowTab();let t=a.build(e,i);t&&(t=o?l+" = "+t+";":"return "+t+";"),e.removeFlowTab().addFlowCode(e.tab+"	"+t+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return e.format(l,i,t)}}aO.type=sW("Conditional",aO);let az=rv(aO);s2("select",az),s2("cond",(...e)=>(console.warn("TSL.ConditionalNode: cond() has been renamed to select()."),az(...e)));class aL extends sG{constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}analyze(e){this.node.build(e)}setup(e){let t=e.getContext();e.setContext({...e.context,...this.value});let i=this.node.build(e);return e.setContext(t),i}generate(e,t){let i=e.getContext();e.setContext({...e.context,...this.value});let s=this.node.build(e,t);return e.setContext(i),s}}aL.type=sW("Context",aL);let aD=rv(aL);s2("context",aD),s2("label",(e,t)=>aD(e,{label:t}));class aV extends sG{constructor(e,t=null){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){let{node:t,name:i}=this,s=e.getVarFromNode(this,i,e.getVectorType(this.getNodeType(e))),r=e.getPropertyName(s),n=t.build(e,s.type);return e.addLineFlowCode(`${r} = ${n}`),r}}aV.type=sW("Var",aV);let ak=rv(aV);s2("temp",ak),s2("toVar",(...e)=>ak(...e).append());class aG extends sG{constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){let t=e.getNodeProperties(this),i=t.varying;if(void 0===i){let s=this.name,r=this.getNodeType(e);t.varying=i=e.getVaryingFromNode(this,s,r),t.node=this.node}return i.needsInterpolation||(i.needsInterpolation="fragment"===e.shaderStage),i}setup(e){this.setupVarying(e)}analyze(e){return this.setupVarying(e),this.node.analyze(e)}generate(e){let t=e.getNodeProperties(this),i=this.setupVarying(e);if(void 0===t.propertyName){let s=this.getNodeType(e),r=e.getPropertyName(i,sU.VERTEX);e.flowNodeFromShaderStage(sU.VERTEX,this.node,s,r),t.propertyName=r}return e.getPropertyName(i)}}aG.type=sW("Varying",aG);let aW=rv(aG);s2("varying",aW);let aH=e=>{let t=null;return e===o?t="Linear":e===a&&(t="sRGB"),t},aj=(e,t)=>aH(e)+"To"+aH(t);class a$ extends s${constructor(e,t=null,i=null){super("vec4"),this.colorNode=e,this.target=t,this.source=i}setup(e){let{renderer:t,context:i}=e,s=this.source||i.outputColorSpace||t.outputColorSpace,r=this.target||i.outputColorSpace||t.outputColorSpace,n=this.colorNode;if(s===r)return n;let a=aj(s,r),o=null,l=t.nodes.library.getColorSpaceFunction(a);return null!==l?o=rD(l(n.rgb),n.a):(console.error("ColorSpaceNode: Unsupported Color Space configuration.",a),o=n),o}}a$.type=sW("ColorSpace",a$);let aq=(e,t=null)=>ry(new a$(ry(e),o,t));s2("toOutputColorSpace",(e,t=null)=>ry(new a$(ry(e),t,o))),s2("toWorkingColorSpace",aq);let aX=class extends sH{constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){let t=super.generate(e),i=this.referenceNode.getNodeType(),s=this.getNodeType();return e.format(t,i,s)}};class aY extends sG{constructor(e,t,i=null,s=null){super(),this.property=e,this.uniformType=t,this.object=i,this.count=s,this.properties=e.split("."),this.reference=i,this.node=null,this.updateType=sO.OBJECT}element(e){return ry(new aX(this,ry(e)))}setNodeType(e){this.node=rQ(null,e).getSelf()}getNodeType(e){return null===this.node&&this.updateValue(),this.node.getNodeType(e)}getValueFromReference(e=this.reference){let{properties:t}=this,i=e[t[0]];for(let e=1;e<t.length;e++)i=i[t[e]];return i}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);let e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}aY.type=sW("ReferenceBase",aY);class aJ extends aY{constructor(e,t,i=null){super(e,t,i),this.renderer=i}updateReference(e){return this.reference=null!==this.renderer?this.renderer:e.renderer,this.reference}}aJ.type=sW("RendererReference",aJ);class aK extends s${constructor(e,t=aZ,i=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=i}getCacheKey(){let e=super.getCacheKey();return"{toneMapping:"+this.toneMapping+",nodes:"+e+"}"}setup(e){let t=this.colorNode||e.context.color,i=this.toneMapping;if(0===i)return t;let s=null,r=e.renderer.nodes.library.getToneMappingFunction(i);return null!==r?s=rD(r(t.rgb,this.exposureNode),t.a):(console.error("ToneMappingNode: Unsupported Tone Mapping configuration.",i),s=t),s}}aK.type=sW("ToneMapping",aK);let aQ=(e,t,i)=>ry(new aK(e,ry(t),ry(i))),aZ=ry(new aJ("toneMappingExposure","float",void 0));s2("toneMapping",(e,t,i)=>aQ(t,i,e));class a0 extends sQ{constructor(e,t=null,i=0,s=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=i,this.bufferOffset=s,this.usage=35044,this.instanced=!1,this.attribute=null,this.global=!0,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(0===this.bufferStride&&0===this.bufferOffset){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;let t=this.getNodeType(e),i=this.value,s=e.getTypeLength(t),r=this.bufferStride||s,n=this.bufferOffset,a=!0===i.isInterleavedBuffer?i:new t3(i,r),o=new t5(a,s,n);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){let t=this.getNodeType(e),i=e.getBufferAttributeFromNode(this,t),s=e.getPropertyName(i),r=null;return"vertex"===e.shaderStage||"compute"===e.shaderStage?(this.name=s,r=s):r=aW(this).build(e,t),r}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}}a0.type=sW("BufferAttribute",a0);let a1=(e,t,i,s)=>ry(new a0(e,t,i,s)),a2=(e,t,i,s)=>a1(e,t,i,s).setUsage(35048),a3=(e,t,i,s)=>a1(e,t,i,s).setInstanced(!0),a4=(e,t,i,s)=>a2(e,t,i,s).setInstanced(!0);s2("toAttribute",e=>a1(e.value));class a5 extends sG{constructor(e,t,i=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=i,this.dispatchCount=0,this.version=1,this.updateBeforeType=sO.OBJECT,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}updateDispatchCount(){let{count:e,workgroupSize:t}=this,i=t[0];for(let e=1;e<t.length;e++)i*=t[e];this.dispatchCount=Math.ceil(e/i)}onInit(){}updateBefore({renderer:e}){e.compute(this)}generate(e){let{shaderStage:t}=e;if("compute"===t){let t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t)}}}a5.type=sW("Compute",a5),s2("compute",(e,t,i)=>ry(new a5(ry(e),t,i)));class a6 extends sG{constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){return this.node.getNodeType(e)}build(e,...t){let i=e.getCache(),s=e.getCacheFromNode(this,parent);e.setCache(s);let r=this.node.build(e,...t);return e.setCache(i),r}}a6.type=sW("Cache",a6);let a8=(e,...t)=>ry(new a6(ry(e),...t));s2("cache",a8);class a7 extends sG{constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){let t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t),this.outputNode.build(e)}}a7.type=sW("Bypass",a7),s2("bypass",rv(a7));class a9 extends sG{constructor(e,t,i,s=rA(0),r=rA(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=i,this.outLowNode=s,this.outHighNode=r,this.doClamp=!0}setup(){let{node:e,inLowNode:t,inHighNode:i,outLowNode:s,outHighNode:r,doClamp:n}=this,a=e.sub(t).div(i.sub(t));return!0===n&&(a=a.clamp()),a.mul(r.sub(s)).add(s)}}a9.type=sW("Remap",a9);let oe=rv(a9,null,null,{doClamp:!1}),ot=rv(a9);s2("remap",oe),s2("remapClamp",ot);class oi extends sG{constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){let i=this.getNodeType(e),s=this.snippet;if("void"!==i)return e.format(`( ${s} )`,i,t);e.addLineFlowCode(s)}}oi.type=sW("Expression",oi);let os=rv(oi);s2("discard",e=>(e?az(e,os("discard")):os("discard")).append());class or extends s${constructor(e,t,i){super("vec4"),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=i,this.isRenderOutput=!0}setup({context:e}){let t=this.colorNode||e.color,i=(null!==this.toneMapping?this.toneMapping:e.toneMapping)||0,s=(null!==this.outputColorSpace?this.outputColorSpace:e.outputColorSpace)||o;return 0!==i&&(t=t.toneMapping(i)),s===a&&(t=t.toOutputColorSpace(s)),t}}or.type=sW("RenderOutput",or),s2("renderOutput",(e,t=null,i=null)=>ry(new or(ry(e),t,i)));class on extends sG{constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(null===t){let i=this.getAttributeName(e);if(e.hasGeometryAttribute(i)){let s=e.geometry.getAttribute(i);t=e.getTypeFromAttribute(s)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){let t=this.getAttributeName(e),i=this.getNodeType(e);if(!0!==e.hasGeometryAttribute(t))return console.warn(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(i);{let s=e.geometry.getAttribute(t),r=e.getTypeFromAttribute(s),n=e.getAttribute(t,r);return"vertex"===e.shaderStage?e.format(n.name,r,i):aW(this).build(e,i)}}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}}on.type=sW("Attribute",on);let oa=(e,t)=>ry(new on(e,t)),oo=e=>oa("uv"+(e>0?e:""),"vec2");class ol extends sG{constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){let i=this.textureNode.build(e,"property"),s=this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${i}, ${s} )`,this.getNodeType(e),t)}}ol.type=sW("TextureSize",ol);let oh=rv(ol);class ou extends rK{constructor(e){super(0),this._textureNode=e,this.updateType=sO.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){let e=this.texture,t=e.images,i=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(i&&void 0!==i.width){let{width:e,height:t}=i;this.value=Math.log2(Math.max(e,t))}}}ou.type=sW("MaxMipLevel",ou);let od=rv(ou);class oc extends rK{constructor(e,t=null,i=null,s=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=i,this.biasNode=s,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=sO.NONE,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(null===t)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":1014===this.value.type?"uvec4":1013===this.value.type?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return oo(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return null===this._matrixUniform&&(this._matrixUniform=rQ(this.value.matrix)),this._matrixUniform.mul(rU(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?sO.FRAME:sO.NONE,this}setupUV(e,t){let i=this.value;return e.isFlipY()&&(!0===i.isRenderTargetTexture||!0===i.isFramebufferTexture||!0===i.isDepthTexture)&&(t=t.setY(t.y.oneMinus())),t}setup(e){let t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;let i=this.uvNode;(null===i||!0===e.context.forceUVContext)&&e.context.getUV&&(i=e.context.getUV(this)),i||(i=this.getDefaultUV()),!0===this.updateMatrix&&(i=this.getTransformedUV(i)),i=this.setupUV(e,i);let s=this.levelNode;null===s&&e.context.getTextureLevel&&(s=e.context.getTextureLevel(this)),t.uvNode=i,t.levelNode=s,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,i,s,r,n,a,o){let l=this.value;return s?e.generateTextureLevel(l,t,i,s,n):r?e.generateTextureBias(l,t,i,r,n):o?e.generateTextureGrad(l,t,i,o,n):a?e.generateTextureCompare(l,t,i,a,n):!1===this.sampler?e.generateTextureLoad(l,t,i,n):e.generateTexture(l,t,i,n)}generate(e,t){let i=e.getNodeProperties(this),s=this.value;if(!s||!0!==s.isTexture)throw Error("TextureNode: Need a three.js texture.");let r=super.generate(e,"property");if("sampler"===t)return r+"_sampler";if(e.isReference(t))return r;{let n=e.getDataFromNode(this),a=n.propertyName;if(void 0===a){let{uvNode:t,levelNode:s,biasNode:o,compareNode:l,depthNode:h,gradNode:u}=i,d=this.generateUV(e,t),c=s?s.build(e,"float"):null,p=o?o.build(e,"float"):null,m=h?h.build(e,"int"):null,g=l?l.build(e,"float"):null,f=u?[u[0].build(e,"vec2"),u[1].build(e,"vec2")]:null,y=e.getVarFromNode(this);a=e.getPropertyName(y);let x=this.generateSnippet(e,r,d,c,p,m,g,f);e.addLineFlowCode(`${a} = ${x}`),n.snippet=x,n.propertyName=a}let o=a,l=this.getNodeType(e);return e.needsToWorkingColorSpace(s)&&(o=aq(os(o,l),s.colorSpace).setup(e).build(e,l)),e.format(o,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){let t=this.clone();return t.uvNode=ry(e),t.referenceNode=this.getSelf(),ry(t)}blur(e){let t=this.clone();return t.biasNode=ry(e).mul(od(t)),t.referenceNode=this.getSelf(),ry(t)}level(e){let t=this.clone();return t.levelNode=ry(e),t.referenceNode=this.getSelf(),ry(t)}size(e){return oh(this,e)}bias(e){let t=this.clone();return t.biasNode=ry(e),t.referenceNode=this.getSelf(),ry(t)}compare(e){let t=this.clone();return t.compareNode=ry(e),t.referenceNode=this.getSelf(),ry(t)}grad(e,t){let i=this.clone();return i.gradNode=[ry(e),ry(t)],i.referenceNode=this.getSelf(),ry(i)}depth(e){let t=this.clone();return t.depthNode=ry(e),t.referenceNode=this.getSelf(),ry(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){let e=this.value,t=this._matrixUniform;null!==t&&(t.value=e.matrix),!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){let e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e}}oc.type=sW("Texture",oc);let op=rv(oc),om=(...e)=>op(...e).setSampler(!1),og=rq("camera").onRenderUpdate(()=>{og.needsUpdate=!0}),of=rQ("float").label("cameraNear").setGroup(og).onRenderUpdate(({camera:e})=>e.near),oy=rQ("float").label("cameraFar").setGroup(og).onRenderUpdate(({camera:e})=>e.far),ox=rQ("float").label("cameraLogDepth").setGroup(og).onRenderUpdate(({camera:e})=>2/(Math.log(e.far+1)/Math.LN2)),ob=rQ("mat4").label("cameraProjectionMatrix").setGroup(og).onRenderUpdate(({camera:e})=>e.projectionMatrix),ov=rQ("mat4").label("cameraViewMatrix").setGroup(og).onRenderUpdate(({camera:e})=>e.matrixWorldInverse),oT=rQ(new $).label("cameraPosition").setGroup(og).onRenderUpdate(({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld));class oS extends sG{constructor(e=oS.VIEW_MATRIX,t=null){super(),this.scope=e,this.object3d=t,this.updateType=sO.OBJECT,this._uniformNode=new rK(null)}getNodeType(){let e=this.scope;return e===oS.WORLD_MATRIX||e===oS.VIEW_MATRIX?"mat4":e===oS.NORMAL_MATRIX?"mat3":e===oS.POSITION||e===oS.VIEW_POSITION||e===oS.DIRECTION||e===oS.SCALE?"vec3":void 0}update(e){let t=this.object3d,i=this._uniformNode,s=this.scope;if(s===oS.VIEW_MATRIX)i.value=t.modelViewMatrix;else if(s===oS.NORMAL_MATRIX)i.value=t.normalMatrix;else if(s===oS.WORLD_MATRIX)i.value=t.matrixWorld;else if(s===oS.POSITION)i.value=i.value||new $,i.value.setFromMatrixPosition(t.matrixWorld);else if(s===oS.SCALE)i.value=i.value||new $,i.value.setFromMatrixScale(t.matrixWorld);else if(s===oS.DIRECTION)i.value=i.value||new $,t.getWorldDirection(i.value);else if(s===oS.VIEW_POSITION){let s=e.camera;i.value=i.value||new $,i.value.setFromMatrixPosition(t.matrixWorld),i.value.applyMatrix4(s.matrixWorldInverse)}}generate(e){let t=this.scope;return t===oS.WORLD_MATRIX||t===oS.VIEW_MATRIX?this._uniformNode.nodeType="mat4":t===oS.NORMAL_MATRIX?this._uniformNode.nodeType="mat3":(t===oS.POSITION||t===oS.VIEW_POSITION||t===oS.DIRECTION||t===oS.SCALE)&&(this._uniformNode.nodeType="vec3"),this._uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}oS.VIEW_MATRIX="viewMatrix",oS.NORMAL_MATRIX="normalMatrix",oS.WORLD_MATRIX="worldMatrix",oS.POSITION="position",oS.SCALE="scale",oS.VIEW_POSITION="viewPosition",oS.DIRECTION="direction",oS.type=sW("Object3D",oS),oS.DIRECTION,oS.VIEW_MATRIX,oS.NORMAL_MATRIX,oS.WORLD_MATRIX;let o_=rv(oS,oS.POSITION);oS.SCALE;let oM=rv(oS,oS.VIEW_POSITION);class ow extends oS{constructor(e=ow.VIEW_MATRIX){super(e)}update(e){this.object3d=e.object,super.update(e)}}ow.type=sW("Model",ow),ow.DIRECTION;let oN=rT(ow,ow.VIEW_MATRIX).label("modelViewMatrix").toVar("ModelViewMatrix"),oA=rT(ow,ow.NORMAL_MATRIX),oR=rT(ow,ow.WORLD_MATRIX);ow.POSITION,ow.SCALE,ow.VIEW_POSITION;let oC=rQ(new eS).onObjectUpdate(({object:e},t)=>t.value.copy(e.matrixWorld).invert()),oE=oa("position","vec3"),oB=oE.varying("positionLocal"),oI=oE.varying("positionPrevious"),oP=oR.mul(oB).xyz.varying("v_positionWorld"),oF=oB.transformDirection(oR).varying("v_positionWorldDirection").normalize().toVar("positionWorldDirection"),oU=oN.mul(oB).xyz.varying("v_positionView"),oO=oU.negate().varying("v_positionViewDirection").normalize().toVar("positionViewDirection");class oz extends sG{constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){let{renderer:t,material:i}=e;return 2e3===t.coordinateSystem&&1===i.side?"false":e.getFrontFacing()}}oz.type=sW("FrontFacing",oz);let oL=rA(rT(oz)).mul(2).sub(1),oD=oa("normal","vec3"),oV=rS(e=>!1===e.geometry.hasAttribute("normal")?(console.warn('TSL.NormalNode: Vertex attribute "normal" not found on geometry.'),rU(0,1,0)):oD,"vec3").once()().toVar("normalLocal"),ok=oU.dFdx().cross(oU.dFdy()).normalize().toVar("normalFlat"),oG=null,oW=rS(e=>!0===e.material.flatShading?ok:oG||(oG=aW(oA.mul(oV),"v_normalView").normalize()),"vec3").once()().toVar("normalView"),oH=aW(oW.transformDirection(ov),"v_normalWorld").normalize().toVar("normalWorld"),oj=rS(e=>e.context.setupNormal(),"vec3").once()().mul(oL).toVar("transformedNormalView"),o$=oj.transformDirection(ov).normalize().toVar("transformedNormalWorld"),oq=rS(e=>e.context.setupClearcoatNormal(),"vec3").once()().mul(oL).toVar("transformedClearcoatNormalView"),oX=rQ(0).onReference(({material:e})=>e).onRenderUpdate(({material:e})=>e.refractionRatio),oY=oO.negate().reflect(oj),oJ=oO.negate().refract(oj,oX),oK=oY.transformDirection(ov).toVar("reflectVector"),oQ=oJ.transformDirection(ov).toVar("reflectVector");class oZ extends oc{constructor(e,t=null,i=null,s=null){super(e,t,i,s),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){let e=this.value;return 301===e.mapping?oK:302===e.mapping?oQ:(console.error('THREE.CubeTextureNode: Mapping "%s" not supported.',e.mapping),rU(0,0,0))}setUpdateMatrix(){}setupUV(e,t){let i=this.value;return 2001!==e.renderer.coordinateSystem&&i.isRenderTargetTexture?t:rU(t.x.negate(),t.yz)}generateUV(e,t){return t.build(e,"vec3")}}oZ.type=sW("CubeTexture",oZ);let o0=rv(oZ);class o1 extends rK{constructor(e,t,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=i}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}}o1.type=sW("Buffer",o1);let o2=(e,t,i)=>ry(new o1(e,t,i));class o3 extends sH{constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){let t=super.generate(e),i=this.getNodeType();return e.format(t,"vec4",i)}}class o4 extends o1{constructor(e,t=null){super(null,"vec4"),this.array=e,this.elementType=t,this._elementType=null,this._elementLength=0,this.updateType=sO.RENDER,this.isArrayBufferNode=!0}getElementType(){return this.elementType||this._elementType}getElementLength(){return this._elementLength}update(){let{array:e,value:t}=this,i=this.getElementLength(),s=this.getElementType();if(1===i)for(let i=0;i<e.length;i++)t[4*i]=e[i];else if("color"===s)for(let i=0;i<e.length;i++){let s=4*i,r=e[i];t[s]=r.r,t[s+1]=r.g,t[s+2]=r.b||0}else for(let i=0;i<e.length;i++){let s=4*i,r=e[i];t[s]=r.x,t[s+1]=r.y,t[s+2]=r.z||0,t[s+3]=r.w||0}}setup(e){let t=this.array.length;this._elementType=null===this.elementType?sB(this.array[0]):this.elementType,this._elementLength=e.getTypeLength(this._elementType);let i=Float32Array;return"i"===this._elementType.charAt(0)?i=Int32Array:"u"===this._elementType.charAt(0)&&(i=Uint32Array),this.value=new i(4*t),this.bufferCount=t,this.bufferType=e.changeComponentType("vec4",e.getComponentType(this._elementType)),super.setup(e)}element(e){return ry(new o3(this,ry(e)))}}o4.type=sW("UniformArray",o4);let o5=(e,t)=>ry(new o4(e,t));class o6 extends sH{constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){let t=super.generate(e),i=this.referenceNode.getNodeType(),s=this.getNodeType();return e.format(t,i,s)}}class o8 extends sG{constructor(e,t,i=null,s=null){super(),this.property=e,this.uniformType=t,this.object=i,this.count=s,this.properties=e.split("."),this.reference=i,this.node=null,this.updateType=sO.OBJECT}element(e){return ry(new o6(this,ry(e)))}setNodeType(e){let t=null;t=null!==this.count?o2(null,e,this.count):Array.isArray(this.getValueFromReference())?o5(null,e):"texture"===e?op(null):"cubeTexture"===e?o0(null):rQ(null,e),this.node=t.getSelf()}getNodeType(e){return null===this.node&&this.updateValue(),this.node.getNodeType(e)}getValueFromReference(e=this.reference){let{properties:t}=this,i=e[t[0]];for(let e=1;e<t.length;e++)i=i[t[e]];return i}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);let e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}o8.type=sW("Reference",o8);let o7=(e,t,i)=>ry(new o8(e,t,i)),o9=(e,t,i,s)=>ry(new o8(e,t,s,i));class le extends o8{constructor(e,t,i=null){super(e,t,i),this.material=i,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}}le.type=sW("MaterialReference",le);let lt=(e,t,i)=>ry(new le(e,t,i)),li=rS(e=>(!1===e.geometry.hasAttribute("tangent")&&e.geometry.computeTangents(),oa("tangent","vec4")))(),ls=li.xyz.toVar("tangentLocal"),lr=oN.mul(rD(ls,0)).xyz.varying("v_tangentView").normalize().toVar("tangentView"),ln=aW(oW.cross(lr).mul(li.w).xyz,"v_bitangentView").normalize().toVar("bitangentView"),la=rH(lr,ln,oW),lo=aE(na.cross(oO).cross(na).normalize(),oj,nr.mul(r4.oneMinus()).oneMinus().pow2().pow2()).normalize(),ll=rS(e=>{let{eye_pos:t,surf_norm:i,mapN:s,uv:r}=e,n=t.dFdx(),a=t.dFdy(),o=r.dFdx(),l=r.dFdy(),h=a.cross(i),u=i.cross(n),d=h.mul(o.x).add(u.mul(l.x)),c=h.mul(o.y).add(u.mul(l.y)),p=d.dot(d).max(c.dot(c)),m=oL.mul(p.inverseSqrt());return nS(d.mul(s.x,m),c.mul(s.y,m),i.mul(s.z)).normalize()});class lh extends s${constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=0}setup(e){let{normalMapType:t,scaleNode:i}=this,s=this.node.mul(2).sub(1);null!==i&&(s=rU(s.xy.mul(i),s.z));let r=null;return 1===t?r=oA.mul(s).normalize():0===t&&(r=!0===e.hasGeometryAttribute("tangent")?la.mul(s).normalize():ll({eye_pos:oU,surf_norm:oW,mapN:s,uv:oo()})),r}}lh.type=sW("NormalMap",lh);let lu=rv(lh),ld=rS(({textureNode:e,bumpScale:t})=>{let i=t=>e.cache().context({getUV:e=>t(e.uvNode||oo()),forceUVContext:!0}),s=rA(i(e=>e));return rB(rA(i(e=>e.add(e.dFdx()))).sub(s),rA(i(e=>e.add(e.dFdy()))).sub(s)).mul(t)}),lc=rS(e=>{let{surf_pos:t,surf_norm:i,dHdxy:s}=e,r=t.dFdx().normalize(),n=t.dFdy().normalize().cross(i),a=i.cross(r),o=r.dot(n).mul(oL),l=o.sign().mul(s.x.mul(n).add(s.y.mul(a)));return o.abs().mul(i).sub(l).normalize()});class lp extends s${constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){let e=null!==this.scaleNode?this.scaleNode:1;return lc({surf_pos:oU,surf_norm:oW,dHdxy:ld({textureNode:this.textureNode,bumpScale:e})})}}let lm=rv(lp),lg=new Map;class lf extends sG{constructor(e){super(),this.scope=e}getCache(e,t){let i=lg.get(e);return void 0===i&&(i=lt(e,t),lg.set(e,i)),i}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){let t=e.context.material,i=this.scope,s=null;if(i===lf.COLOR){let e=void 0!==t.color?this.getColor(i):rU();s=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(i===lf.OPACITY){let e=this.getFloat(i);s=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(i===lf.SPECULAR_STRENGTH)s=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture("specular").r:rA(1);else if(i===lf.SPECULAR_INTENSITY){let e=this.getFloat(i);s=t.specularMap?e.mul(this.getTexture(i).a):e}else if(i===lf.SPECULAR_COLOR){let e=this.getColor(i);s=t.specularColorMap&&!0===t.specularColorMap.isTexture?e.mul(this.getTexture(i).rgb):e}else if(i===lf.ROUGHNESS){let e=this.getFloat(i);s=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(i).g):e}else if(i===lf.METALNESS){let e=this.getFloat(i);s=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(i).b):e}else if(i===lf.EMISSIVE){let e=this.getFloat("emissiveIntensity"),r=this.getColor(i).mul(e);s=t.emissiveMap&&!0===t.emissiveMap.isTexture?r.mul(this.getTexture(i)):r}else if(i===lf.NORMAL)s=t.normalMap?lu(this.getTexture("normal"),this.getCache("normalScale","vec2")):t.bumpMap?lm(this.getTexture("bump").r,this.getFloat("bumpScale")):oW;else if(i===lf.CLEARCOAT){let e=this.getFloat(i);s=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===lf.CLEARCOAT_ROUGHNESS){let e=this.getFloat(i);s=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===lf.CLEARCOAT_NORMAL)s=t.clearcoatNormalMap?lu(this.getTexture(i),this.getCache(i+"Scale","vec2")):oW;else if(i===lf.SHEEN){let e=this.getColor("sheenColor").mul(this.getFloat("sheen"));s=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(i===lf.SHEEN_ROUGHNESS){let e=this.getFloat(i);s=(s=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(i).a):e).clamp(.07,1)}else if(i===lf.ANISOTROPY){if(t.anisotropyMap&&!0===t.anisotropyMap.isTexture){let e=this.getTexture(i);s=rW(l0.x,l0.y,l0.y.negate(),l0.x).mul(e.rg.mul(2).sub(rB(1)).normalize().mul(e.b))}else s=l0}else if(i===lf.IRIDESCENCE_THICKNESS){let e=o7("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){let r=o7("0","float",t.iridescenceThicknessRange);s=e.sub(r).mul(this.getTexture(i).g).add(r)}else s=e}else if(i===lf.TRANSMISSION){let e=this.getFloat(i);s=t.transmissionMap?e.mul(this.getTexture(i).r):e}else if(i===lf.THICKNESS){let e=this.getFloat(i);s=t.thicknessMap?e.mul(this.getTexture(i).g):e}else if(i===lf.IOR)s=this.getFloat(i);else if(i===lf.LIGHT_MAP)s=this.getTexture(i).rgb.mul(this.getFloat("lightMapIntensity"));else if(i===lf.AO_MAP)s=this.getTexture(i).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else{let t=this.getNodeType(e);s=this.getCache(i,t)}return s}}lf.ALPHA_TEST="alphaTest",lf.COLOR="color",lf.OPACITY="opacity",lf.SHININESS="shininess",lf.SPECULAR="specular",lf.SPECULAR_STRENGTH="specularStrength",lf.SPECULAR_INTENSITY="specularIntensity",lf.SPECULAR_COLOR="specularColor",lf.REFLECTIVITY="reflectivity",lf.ROUGHNESS="roughness",lf.METALNESS="metalness",lf.NORMAL="normal",lf.CLEARCOAT="clearcoat",lf.CLEARCOAT_ROUGHNESS="clearcoatRoughness",lf.CLEARCOAT_NORMAL="clearcoatNormal",lf.EMISSIVE="emissive",lf.ROTATION="rotation",lf.SHEEN="sheen",lf.SHEEN_ROUGHNESS="sheenRoughness",lf.ANISOTROPY="anisotropy",lf.IRIDESCENCE="iridescence",lf.IRIDESCENCE_IOR="iridescenceIOR",lf.IRIDESCENCE_THICKNESS="iridescenceThickness",lf.IOR="ior",lf.TRANSMISSION="transmission",lf.THICKNESS="thickness",lf.ATTENUATION_DISTANCE="attenuationDistance",lf.ATTENUATION_COLOR="attenuationColor",lf.LINE_SCALE="scale",lf.LINE_DASH_SIZE="dashSize",lf.LINE_GAP_SIZE="gapSize",lf.LINE_WIDTH="linewidth",lf.LINE_DASH_OFFSET="dashOffset",lf.POINT_WIDTH="pointWidth",lf.DISPERSION="dispersion",lf.LIGHT_MAP="light",lf.AO_MAP="ao",lf.type=sW("Material",lf);let ly=rT(lf,lf.ALPHA_TEST),lx=rT(lf,lf.COLOR),lb=rT(lf,lf.SHININESS),lv=rT(lf,lf.EMISSIVE),lT=rT(lf,lf.OPACITY),lS=rT(lf,lf.SPECULAR),l_=rT(lf,lf.SPECULAR_INTENSITY),lM=rT(lf,lf.SPECULAR_COLOR),lw=rT(lf,lf.SPECULAR_STRENGTH),lN=rT(lf,lf.REFLECTIVITY),lA=rT(lf,lf.ROUGHNESS),lR=rT(lf,lf.METALNESS),lC=rT(lf,lf.NORMAL).context({getUV:null}),lE=rT(lf,lf.CLEARCOAT),lB=rT(lf,lf.CLEARCOAT_ROUGHNESS),lI=rT(lf,lf.CLEARCOAT_NORMAL).context({getUV:null}),lP=rT(lf,lf.ROTATION),lF=rT(lf,lf.SHEEN),lU=rT(lf,lf.SHEEN_ROUGHNESS),lO=rT(lf,lf.ANISOTROPY),lz=rT(lf,lf.IRIDESCENCE),lL=rT(lf,lf.IRIDESCENCE_IOR),lD=rT(lf,lf.IRIDESCENCE_THICKNESS),lV=rT(lf,lf.TRANSMISSION),lk=rT(lf,lf.THICKNESS),lG=rT(lf,lf.IOR),lW=rT(lf,lf.ATTENUATION_DISTANCE),lH=rT(lf,lf.ATTENUATION_COLOR),lj=rT(lf,lf.LINE_SCALE),l$=rT(lf,lf.LINE_DASH_SIZE),lq=rT(lf,lf.LINE_GAP_SIZE),lX=rT(lf,lf.LINE_WIDTH),lY=rT(lf,lf.LINE_DASH_OFFSET),lJ=rT(lf,lf.POINT_WIDTH),lK=rT(lf,lf.DISPERSION),lQ=rT(lf,lf.LIGHT_MAP),lZ=rT(lf,lf.AO_MAP);lf.REFRACTION_RATIO;let l0=rQ(new S).onReference(function(e){return e.material}).onRenderUpdate(function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))});class l1 extends s${constructor(e=null){super("vec4"),this.positionNode=e}setup(e){if("fragment"===e.shaderStage)return aW(e.context.mvp);let t=this.positionNode||oB;return ob.mul(oN).mul(t)}}l1.type=sW("ModelViewProjection",l1);let l2=rv(l1);class l3 extends sG{constructor(e){super("uint"),this.scope=e,this.isInstanceIndexNode=!0}generate(e){let t;let i=this.getNodeType(e),s=this.scope;if(s===l3.VERTEX)t=e.getVertexIndex();else if(s===l3.INSTANCE)t=e.getInstanceIndex();else if(s===l3.DRAW)t=e.getDrawIndex();else if(s===l3.INVOCATION_LOCAL)t=e.getInvocationLocalIndex();else throw Error("THREE.IndexNode: Unknown scope: "+s);return"vertex"===e.shaderStage||"compute"===e.shaderStage?t:aW(this).build(e,i)}}l3.VERTEX="vertex",l3.INSTANCE="instance",l3.INVOCATION_LOCAL="invocationLocal",l3.DRAW="draw",l3.type=sW("Index",l3);let l4=rT(l3,l3.VERTEX),l5=rT(l3,l3.INSTANCE);l3.INVOCATION_LOCAL;let l6=rT(l3,l3.DRAW);class l8 extends t3{constructor(e,t,i=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){let t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){let t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}class l7 extends sG{constructor(e){super("void"),this.instanceMesh=e,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=sO.FRAME,this.buffer=null,this.bufferColor=null}setup(e){let t=this.instanceMatrixNode,i=this.instanceColorNode,s=this.instanceMesh;if(null===t){let e=s.instanceMatrix;if(s.count<=1e3)t=o2(e.array,"mat4",s.count).element(l5);else{let i=new l8(e.array,16,1);this.buffer=i;let s=35048===e.usage?a4:a3;t=rj(s(i,"vec4",16,0),s(i,"vec4",16,4),s(i,"vec4",16,8),s(i,"vec4",16,12))}this.instanceMatrixNode=t}let r=s.instanceColor;if(r&&null===i){let e=new t7(r.array,3),t=35048===r.usage?a4:a3;this.bufferColor=e,i=rU(t(e,"vec3",3,0)),this.instanceColorNode=i}let n=t.mul(oB).xyz;if(oB.assign(n),e.hasGeometryAttribute("normal")){let e=rH(t),i=oV.div(rU(e[0].dot(e[0]),e[1].dot(e[1]),e[2].dot(e[2]))),s=e.mul(i).xyz;oV.assign(s)}null!==this.instanceColorNode&&r1("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){35048!==this.instanceMesh.instanceMatrix.usage&&null!=this.buffer&&this.instanceMesh.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMesh.instanceMatrix.version),this.instanceMesh.instanceColor&&35048!==this.instanceMesh.instanceColor.usage&&null!=this.bufferColor&&this.instanceMesh.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceMesh.instanceColor.version)}}l7.type=sW("Instance",l7);let l9=rv(l7);class he extends sG{constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){null===this.batchingIdNode&&(null===e.getDrawIndex()?this.batchingIdNode=l5:this.batchingIdNode=l6);let t=rS(([e])=>{let t=oh(om(this.batchMesh._indirectTexture),0),i=rR(e).modInt(rR(t)),s=rR(e).div(rR(t));return om(this.batchMesh._indirectTexture,rI(i,s)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]})(rR(this.batchingIdNode)),i=this.batchMesh._matricesTexture,s=oh(om(i),0),r=rA(t).mul(4).toInt().toVar(),n=r.modInt(s),a=r.div(rR(s)),o=rj(om(i,rI(n,a)),om(i,rI(n.add(1),a)),om(i,rI(n.add(2),a)),om(i,rI(n.add(3),a))),l=this.batchMesh._colorsTexture;if(null!==l){let e=rS(([e])=>{let t=oh(om(l),0).x;return om(l,rI(e.modInt(t),e.div(t))).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]})(t);r1("vec3","vBatchColor").assign(e)}let h=rH(o);oB.assign(o.mul(oB));let u=oV.div(rU(h[0].dot(h[0]),h[1].dot(h[1]),h[2].dot(h[2]))),d=h.mul(u).xyz;oV.assign(d),e.hasGeometryAttribute("tangent")&&ls.mulAssign(h)}}he.type=sW("Batch",he);let ht=rv(he),hi=new WeakMap;class hs extends sG{constructor(e,t=!1){let i,s,r;super("void"),this.skinnedMesh=e,this.useReference=t,this.updateType=sO.OBJECT,this.skinIndexNode=oa("skinIndex","uvec4"),this.skinWeightNode=oa("skinWeight","vec4"),t?(i=o7("bindMatrix","mat4"),s=o7("bindMatrixInverse","mat4"),r=o9("skeleton.boneMatrices","mat4",e.skeleton.bones.length)):(i=rQ(e.bindMatrix,"mat4"),s=rQ(e.bindMatrixInverse,"mat4"),r=o2(e.skeleton.boneMatrices,"mat4",e.skeleton.bones.length)),this.bindMatrixNode=i,this.bindMatrixInverseNode=s,this.boneMatricesNode=r,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=oB){let{skinIndexNode:i,skinWeightNode:s,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=e.element(i.x),o=e.element(i.y),l=e.element(i.z),h=e.element(i.w),u=r.mul(t),d=nS(a.mul(s.x).mul(u),o.mul(s.y).mul(u),l.mul(s.z).mul(u),h.mul(s.w).mul(u));return n.mul(d).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=oV){let{skinIndexNode:i,skinWeightNode:s,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=e.element(i.x),o=e.element(i.y),l=e.element(i.z),h=e.element(i.w),u=nS(s.x.mul(a),s.y.mul(o),s.z.mul(l),s.w.mul(h));return(u=n.mul(u).mul(r)).transformDirection(t).xyz}getPreviousSkinnedPosition(e){let t=e.object;return null===this.previousBoneMatricesNode&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=o9("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,oI)}needsPreviousBoneMatrices(e){let t=e.renderer.getMRT();return t&&t.has("velocity")}setup(e){this.needsPreviousBoneMatrices(e)&&oI.assign(this.getPreviousSkinnedPosition(e));let t=this.getSkinnedPosition();if(oB.assign(t),e.hasGeometryAttribute("normal")){let t=this.getSkinnedNormal();oV.assign(t),e.hasGeometryAttribute("tangent")&&ls.assign(t)}}generate(e,t){if("void"!==t)return oB.build(e,t)}update(e){let t=(this.useReference?e.object:this.skinnedMesh).skeleton;hi.get(t)!==e.frameId&&(hi.set(t,e.frameId),null!==this.previousBoneMatricesNode&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}}hs.type=sW("Skinning",hs);let hr=e=>ry(new hs(e,!0));class hn extends sG{constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt()+e)}getProperties(e){let t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;let i={};for(let e=0,t=this.params.length-1;e<t;e++){let t=this.params[e],s=!0!==t.isNode&&t.name||this.getVarName(e),r=!0!==t.isNode&&t.type||"int";i[s]=os(s,r)}let s=e.addStack();return t.returnsNode=this.params[this.params.length-1](i,s,e),t.stackNode=s,e.removeStack(),t}getNodeType(e){let{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){let t=this.getProperties(e),i=this.params,s=t.stackNode;for(let t=0,s=i.length-1;t<s;t++){let s=i[t],r=null,n=null,a=null,o=null,l=null,h=null;s.isNode?(o="int",a=this.getVarName(t),r="0",n=s.build(e,o),l="<"):(o=s.type||"int",a=s.name||this.getVarName(t),r=s.start,n=s.end,l=s.condition,h=s.update,"number"==typeof r?r=r.toString():r&&r.isNode&&(r=r.build(e,o)),"number"==typeof n?n=n.toString():n&&n.isNode&&(n=n.build(e,o)),void 0!==r&&void 0===n?(r+=" - 1",n="0",l=">="):void 0!==n&&void 0===r&&(r="0",l="<"),void 0===l&&(l=Number(r)>Number(n)?">=":"<"));let u={start:r,end:n},d=u.start,c=u.end,p="",m="",g="";h||(h="int"===o||"uint"===o?l.includes("<")?"++":"--":l.includes("<")?"+= 1.":"-= 1."),p+=e.getVar(o,a)+" = "+d,m+=a+" "+l+" "+c,g+=a+" "+h;let f=`for ( ${p}; ${m}; ${g} )`;e.addFlowCode((0===t?"\n":"")+e.tab+f+" {\n\n").addFlowTab()}let r=s.build(e,"void"),n=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+r);for(let t=0,i=this.params.length-1;t<i;t++)e.addFlowCode((0===t?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),n}}hn.type=sW("Loop",hn);let ha=(...e)=>ry(new hn(rb(e,"int"))).append(),ho=()=>os("break").append(),hl=new WeakMap,hh=new k,hu=rS(({bufferMap:e,influence:t,stride:i,width:s,depth:r,offset:n})=>{let a=rR(l4).mul(i).add(n),o=a.div(s);return om(e,rI(a.sub(o.mul(s)),o)).depth(r).mul(t)});class hd extends sG{constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=rQ(1),this.updateType=sO.OBJECT}setup(e){let{geometry:t}=e,i=void 0!==t.morphAttributes.position,s=t.hasAttribute("normal")&&void 0!==t.morphAttributes.normal,r=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,n=void 0!==r?r.length:0,{texture:a,stride:o,size:l}=function(e){let t=void 0!==e.morphAttributes.position,i=void 0!==e.morphAttributes.normal,s=void 0!==e.morphAttributes.color,r=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,n=void 0!==r?r.length:0,a=hl.get(e);if(void 0===a||a.count!==n){void 0!==a&&a.texture.dispose();let r=e.morphAttributes.position||[],o=e.morphAttributes.normal||[],l=e.morphAttributes.color||[],h=0;!0===t&&(h=1),!0===i&&(h=2),!0===s&&(h=3);let u=e.attributes.position.count*h,d=1;u>4096&&(d=Math.ceil(u/4096),u=4096);let c=new Float32Array(u*d*4*n),p=new H(c,u,d,n);p.type=1015,p.needsUpdate=!0;let m=4*h;for(let e=0;e<n;e++){let n=r[e],a=o[e],h=l[e],p=u*d*4*e;for(let e=0;e<n.count;e++){let r=e*m;!0===t&&(hh.fromBufferAttribute(n,e),c[p+r+0]=hh.x,c[p+r+1]=hh.y,c[p+r+2]=hh.z,c[p+r+3]=0),!0===i&&(hh.fromBufferAttribute(a,e),c[p+r+4]=hh.x,c[p+r+5]=hh.y,c[p+r+6]=hh.z,c[p+r+7]=0),!0===s&&(hh.fromBufferAttribute(h,e),c[p+r+8]=hh.x,c[p+r+9]=hh.y,c[p+r+10]=hh.z,c[p+r+11]=4===h.itemSize?hh.w:1)}}a={count:n,texture:p,stride:h,size:new S(u,d)},hl.set(e,a),e.addEventListener("dispose",function t(){p.dispose(),hl.delete(e),e.removeEventListener("dispose",t)})}return a}(t);!0===i&&oB.mulAssign(this.morphBaseInfluence),!0===s&&oV.mulAssign(this.morphBaseInfluence);let h=rR(l.width);ha(n,({i:e})=>{let t=rA(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?t.assign(om(this.mesh.morphTexture,rI(rR(e).add(1),rR(l5))).r):t.assign(o7("morphTargetInfluences","float").element(e).toVar()),!0===i&&oB.addAssign(hu({bufferMap:a,influence:t,stride:o,width:h,depth:e,offset:rR(0)})),!0===s&&oV.addAssign(hu({bufferMap:a,influence:t,stride:o,width:h,depth:e,offset:rR(1)}))})}update(){let e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((e,t)=>e+t,0)}}hd.type=sW("Morph",hd);let hc=rv(hd),hp=e=>e.sort((e,t)=>e.id-t.id),hm=(e,t)=>{for(let i of t)if(i.isAnalyticLightNode&&i.light.id===e)return i;return null};class hg extends sG{constructor(e=[]){super("vec3"),this.totalDiffuseNode=rU().toVar("totalDiffuse"),this.totalSpecularNode=rU().toVar("totalSpecular"),this.outgoingLightNode=rU().toVar("outgoingLight"),this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this.global=!0}getHash(e){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(e);let t=[];for(let e of this._lightNodes)t.push(e.getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){for(let t of e.getDataFromNode(this).nodes)t.build(e)}setupLightsNode(e){let t=[],i=this._lightNodes,s=hp(this._lights),r=e.renderer.nodes.library;for(let e of s)if(e.isNode)t.push(ry(e));else{let s=null;if(null!==i&&(s=hm(e.id,i)),null===s){let i=r.getLightNodeClass(e.constructor);if(void 0===i){console.warn(`LightsNode.setupNodeLights: Light node not found for ${e.constructor.name}`);continue}t.push(ry(new i(e)))}}this._lightNodes=t}setup(e){null===this._lightNodes&&this.setupLightsNode(e);let t=e.context,i=t.lightingModel,s=this.outgoingLightNode;if(i){let{_lightNodes:r,totalDiffuseNode:n,totalSpecularNode:a}=this;t.outgoingLight=s;let o=e.addStack();for(let s of(e.getDataFromNode(this).nodes=o.nodes,i.start(t,o,e),r))s.build(e);i.indirect(t,o,e);let{backdrop:l,backdropAlpha:h}=t,{directDiffuse:u,directSpecular:d,indirectDiffuse:c,indirectSpecular:p}=t.reflectedLight,m=u.add(c);null!==l&&(m=null!==h?rU(h.mix(m,l)):rU(l),t.material.transparent=!0),n.assign(m),a.assign(d.add(p)),s.assign(n.add(a)),i.finish(t,o,e),s=s.bypass(e.removeStack())}return s}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}}hg.type=sW("Lights",hg);let hf=rv(hg);class hy extends sG{constructor(){super("vec3"),this.isLightingNode=!0}generate(){console.warn("Abstract function.")}}hy.type=sW("Lighting",hy);class hx extends hy{constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}}hx.type=sW("AO",hx);class hb extends aL{constructor(e,t=null,i=null,s=null){super(e),this.lightingModel=t,this.backdropNode=i,this.backdropAlphaNode=s,this._value=null}getContext(){let{backdropNode:e,backdropAlphaNode:t}=this,i=rU().toVar("directDiffuse"),s=rU().toVar("directSpecular"),r=rU().toVar("indirectDiffuse"),n=rU().toVar("indirectSpecular");return{radiance:rU().toVar("radiance"),irradiance:rU().toVar("irradiance"),iblIrradiance:rU().toVar("iblIrradiance"),ambientOcclusion:rA(1).toVar("ambientOcclusion"),reflectedLight:{directDiffuse:i,directSpecular:s,indirectDiffuse:r,indirectSpecular:n},backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}hb.type=sW("LightingContext",hb);let hv=rv(hb);class hT extends hy{constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}}hT.type=sW("Irradiance",hT);class hS extends sG{constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===hS.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=sO.NONE;return(this.scope===hS.RESOLUTION||this.scope===hS.VIEWPORT)&&(e=sO.RENDER),this.updateType=e,e}update({renderer:e}){this.scope===hS.VIEWPORT?e.getViewport(n):e.getDrawingBufferSize(r)}setup(){let e=this.scope;return e===hS.RESOLUTION?rQ(r||(r=new S)):e===hS.VIEWPORT?rQ(n||(n=new k)):rB(h_.div(hM))}generate(e){if(this.scope===hS.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){let i=e.getNodeProperties(hM).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${i}.y - ${t}.y )`}return t}return super.generate(e)}}hS.COORDINATE="coordinate",hS.RESOLUTION="resolution",hS.VIEWPORT="viewport",hS.UV="uv",hS.type=sW("Viewport",hS);let h_=rT(hS,hS.COORDINATE),hM=rT(hS,hS.RESOLUTION),hw=rT(hS,hS.VIEWPORT),hN=rT(hS,hS.UV),hA=new S;class hR extends oc{constructor(e=hN,t=null,i=null){null===i&&((i=new ix).minFilter=1008),super(i,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=sO.FRAME}updateBefore(e){let t=e.renderer;t.getDrawingBufferSize(hA);let i=this.value;(i.image.width!==hA.width||i.image.height!==hA.height)&&(i.image.width=hA.width,i.image.height=hA.height,i.needsUpdate=!0);let s=i.generateMipmaps;i.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(i),i.generateMipmaps=s}clone(){let e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}}hR.type=sW("ViewportTexture",hR);let hC=rv(hR,null,null,{generateMipmaps:!0}),hE=null;class hB extends hR{constructor(e=hN,t=null){null===hE&&(hE=new ib),super(e,t,hE)}}hB.type=sW("ViewportDepthTexture",hB);let hI=rv(hB);class hP extends sG{constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){let{scope:t}=this;return t===hP.DEPTH_BASE?e.getFragDepth():super.generate(e)}setup({camera:e}){let{scope:t}=this,i=this.valueNode,s=null;return t===hP.DEPTH_BASE?null!==i&&(s=hz().assign(i)):t===hP.DEPTH?s=e.isPerspectiveCamera?hU(oU.z,of,oy):hF(oU.z,of,oy):t===hP.LINEAR_DEPTH&&(s=null!==i?e.isPerspectiveCamera?hF(hO(i,of,oy),of,oy):i:hF(oU.z,of,oy)),s}}hP.DEPTH_BASE="depthBase",hP.DEPTH="depth",hP.LINEAR_DEPTH="linearDepth",hP.type=sW("ViewportDepth",hP);let hF=(e,t,i)=>e.add(t).div(t.sub(i)),hU=(e,t,i)=>t.add(e).mul(i).div(i.sub(t).mul(e)),hO=(e,t,i)=>t.mul(i).div(i.sub(t).mul(e).sub(i)),hz=rv(hP,hP.DEPTH_BASE),hL=rT(hP,hP.DEPTH);hP.LINEAR_DEPTH,hI(),hL.assign=e=>hz(e);class hD extends sG{constructor(e=hD.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);let t=e.clippingContext,{localClipIntersection:i,localClippingCount:s,globalClippingCount:r}=t,n=r+s,a=i?n-s:n;return this.scope===hD.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(t.planes,n,a):this.setupDefault(t.planes,n,a)}setupAlphaToCoverage(e,t,i){return rS(()=>{let s;let r=o5(e),n=r0("float","distanceToPlane"),a=r0("float","distanceToGradient"),o=r0("float","clipOpacity");if(o.assign(1),ha(i,({i:e})=>{s=r.element(e),n.assign(oU.dot(s.xyz).negate().add(s.w)),a.assign(n.fwidth().div(2)),o.mulAssign(aP(a.negate(),a,n)),o.equal(0).discard()}),i<t){let e=r0("float","unionclipOpacity");e.assign(1),ha({start:i,end:t},({i:t})=>{s=r.element(t),n.assign(oU.dot(s.xyz).negate().add(s.w)),a.assign(n.fwidth().div(2)),e.mulAssign(aP(a.negate(),a,n).oneMinus())}),o.mulAssign(e.oneMinus())}r2.a.mulAssign(o),r2.a.equal(0).discard()})()}setupDefault(e,t,i){return rS(()=>{let s;let r=o5(e);if(ha(i,({i:e})=>{s=r.element(e),oU.dot(s.xyz).greaterThan(s.w).discard()}),i<t){let e=r0("bool","clipped");e.assign(!0),ha({start:i,end:t},({i:t})=>{s=r.element(t),e.assign(oU.dot(s.xyz).greaterThan(s.w).and(e))}),e.discard()}})()}}hD.ALPHA_TO_COVERAGE="alphaToCoverage",hD.DEFAULT="default",hD.type=sW("Clipping",hD);let hV=()=>ry(new hD),hk=()=>ry(new hD(hD.ALPHA_TO_COVERAGE)),hG=new Map;class hW extends tr{constructor(){super(),this.isNodeMaterial=!0,this.type=this.constructor.type,this.forceSinglePass=!1,this.fog=!0,this.lights=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.depthNode=null,this.shadowNode=null,this.shadowPositionNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null}customProgramCacheKey(){return this.type+sC(this)}build(e){this.setup(e)}setup(e){let t;e.context.setupNormal=()=>this.setupNormal(e),e.addStack(),e.stack.outputNode=this.vertexNode||this.setupPosition(e),e.addFlow("vertex",e.removeStack()),e.addStack();let i=this.setupClipping(e);if(!0===this.depthWrite&&this.setupDepth(e),null===this.fragmentNode){this.setupDiffuseColor(e),this.setupVariants(e);let s=this.setupLighting(e);null!==i&&e.stack.add(i);let r=rD(s,r2.a).max(0);if(t=this.setupOutput(e,r),nu.assign(t),null!==this.outputNode&&(t=this.outputNode),null!==e.renderer.getRenderTarget()){let i=e.renderer.getMRT(),s=this.mrtNode;null!==i?(t=i,null!==s&&(t=i.merge(s))):null!==s&&(t=s)}}else{let i=this.fragmentNode;!0!==i.isOutputStructNode&&(i=rD(i)),t=this.setupOutput(e,i)}e.stack.outputNode=t,e.addFlow("fragment",e.removeStack())}setupClipping(e){if(null===e.clippingContext)return null;let{globalClippingCount:t,localClippingCount:i}=e.clippingContext,s=null;return(t||i)&&(this.alphaToCoverage?s=hk():e.stack.add(hV())),s}setupDepth(e){let{renderer:t}=e,i=this.depthNode;if(null===i){let e=t.getMRT();e&&e.has("depth")?i=e.get("depth"):!0===t.logarithmicDepthBuffer&&(i=l2().w.add(1).log2().mul(ox).mul(.5))}null!==i&&hL.assign(i).append()}setupPosition(e){let{object:t}=e,i=t.geometry;if(e.addStack(),(i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color)&&hc(t).append(),!0===t.isSkinnedMesh&&hr(t).append(),this.displacementMap){let e=lt("displacementMap","texture"),t=lt("displacementScale","float"),i=lt("displacementBias","float");oB.addAssign(oV.normalize().mul(e.x.mul(t).add(i)))}t.isBatchedMesh&&ht(t).append(),t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&l9(t).append(),null!==this.positionNode&&oB.assign(this.positionNode);let s=l2();return e.context.vertex=e.removeStack(),e.context.mvp=s,s}setupDiffuseColor({object:e,geometry:t}){let i=this.colorNode?rD(this.colorNode):lx;!0===this.vertexColors&&t.hasAttribute("color")&&(i=rD(i.xyz.mul(oa("color","vec3")),i.a)),e.instanceColor&&(i=r1("vec3","vInstanceColor").mul(i)),e.isBatchedMesh&&e._colorsTexture&&(i=r1("vec3","vBatchColor").mul(i)),r2.assign(i);let s=this.opacityNode?rA(this.opacityNode):lT;if(r2.a.assign(r2.a.mul(s)),null!==this.alphaTestNode||this.alphaTest>0){let e=null!==this.alphaTestNode?rA(this.alphaTestNode):ly;r2.a.lessThanEqual(e).discard()}!1===this.transparent&&1===this.blending&&!1===this.alphaToCoverage&&r2.a.assign(1)}setupVariants(){}setupOutgoingLight(){return!0===this.lights?rU(0):r2.rgb}setupNormal(){return this.normalNode?rU(this.normalNode):lC}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?lt("envMap","cubeTexture"):lt("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new hT(lQ)),t}setupLights(e){let t=[],i=this.setupEnvironment(e);i&&i.isLightingNode&&t.push(i);let s=this.setupLightMap(e);if(s&&s.isLightingNode&&t.push(s),null!==this.aoNode||e.material.aoMap){let e=null!==this.aoNode?this.aoNode:lZ;t.push(new hx(e))}let r=this.lightsNode||e.lightsNode;return t.length>0&&(r=hf([...r.getLights(),...t])),r}setupLightingModel(){}setupLighting(e){let{material:t}=e,{backdropNode:i,backdropAlphaNode:s,emissiveNode:r}=this,n=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null,a=this.setupOutgoingLight(e);return n&&n.getScope().getLights().length>0?a=hv(n,this.setupLightingModel(e),i,s):null!==i&&(a=rU(null!==s?aE(a,i,s):i)),(r&&!0===r.isNode||t.emissive&&!0===t.emissive.isColor)&&(r3.assign(rU(r||lv)),a=a.add(r3)),a}setupOutput(e,t){if(!0===this.fog){let i=e.fogNode;i&&(t=rD(i.mix(t.rgb,i.colorNode),t.a))}return t}setDefaultValues(e){for(let t in e){let i=e[t];void 0===this[t]&&(this[t]=i,i&&i.clone&&(this[t]=i.clone()))}let t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(let e in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,e)&&void 0!==t[e].get&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){let t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});let i=tr.prototype.toJSON.call(this,e),s=sE(this);for(let{property:t,childNode:r}of(i.inputNodes={},s))i.inputNodes[t]=r.toJSON(e).uuid;function r(e){let t=[];for(let i in e){let s=e[i];delete s.metadata,t.push(s)}return t}if(t){let t=r(e.textures),s=r(e.images),n=r(e.nodes);t.length>0&&(i.textures=t),s.length>0&&(i.images=s),n.length>0&&(i.nodes=n)}return i}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.positionNode=e.positionNode,this.depthNode=e.depthNode,this.shadowNode=e.shadowNode,this.shadowPositionNode=e.shadowPositionNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}}function hH(e,t){let i="NodeMaterial",s=e+i;if("function"!=typeof t)throw Error(`THREE.Node: NodeMaterial class "${e}" is not a class.`);if(hG.has(s)){console.warn(`THREE.Node: Redefinition of NodeMaterial class "${s}".`);return}if(e.slice(-i.length)===i){console.warn(`THREE.NodeMaterial: NodeMaterial class ${s} should not have '${i}' suffix.`);return}return hG.set(s,t),t.type=s,s}hW.type=hH("",hW);let hj=new iy;class h$ extends hW{constructor(e={}){super(),this.lights=!1,this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.pointWidth=1,this.pointColorNode=null,this.pointWidthNode=null,this.setDefaultValues(hj),this.setupShaders(),this.setValues(e)}setup(e){this.setupShaders(),super.setup(e)}setupShaders(){let e=this.alphaToCoverage,t=this.useColor;this.vertexNode=rS(()=>{aW(rB(),"vUv").assign(oo());let e=oa("instancePosition").xyz,t=r0("vec4","mvPos");t.assign(oN.mul(rD(e,1)));let i=hw.z.div(hw.w),s=ob.mul(t),r=r0("vec2","offset");return r.assign(oE.xy),r.mulAssign(this.pointWidthNode?this.pointWidthNode:lJ),r.assign(r.div(hw.z)),r.y.assign(r.y.mul(i)),r.assign(r.mul(s.w)),s.assign(s.add(rD(r,0,0))),s})(),this.fragmentNode=rS(()=>{let i;let s=aW(rB(),"vUv"),r=r0("float","alpha");r.assign(1);let n=s.x,a=s.y,o=n.mul(n).add(a.mul(a));if(e){let e=r0("float","dlen");e.assign(o.fwidth()),r.assign(aP(e.oneMinus(),e.add(1),o).oneMinus())}else o.greaterThan(1).discard();return i=this.pointColorNode?this.pointColorNode:t?oa("instanceColor").mul(lx):lx,r.mulAssign(lT),rD(i,r)})()}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.needsUpdate=!0)}}h$.type=hH("InstancedPoints",h$);let hq=new ig;class hX extends hW{constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.lights=!1,this.setDefaultValues(hq),this.setValues(e)}}hX.type=hH("LineBasic",hX);let hY=new sR;class hJ extends hW{constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.lights=!1,this.setDefaultValues(hY),this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){let e=this.offsetNode,t=this.dashScaleNode?rA(this.dashScaleNode):lj,i=this.dashSizeNode?rA(this.dashSizeNode):l$,s=this.dashSizeNode?rA(this.dashGapNode):lq;nd.assign(i),nc.assign(s);let r=aW(oa("lineDistance").mul(t));(e?r.add(e):r).mod(nd.add(nc)).greaterThan(nd).discard()}}hJ.type=hH("LineDashed",hJ);let hK=new sR;class hQ extends hW{constructor(e={}){super(),this.lights=!1,this.setDefaultValues(hK),this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.useDash=e.dashed,this.useWorldUnits=!1,this.dashOffset=0,this.lineWidth=1,this.lineColorNode=null,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setup(e){this.setupShaders(),super.setup(e)}setupShaders(){let e=this.alphaToCoverage,t=this.useColor,i=this.dashed,s=this.worldUnits,r=rS(({start:e,end:t})=>{let i=ob.element(2).element(2),s=ob.element(3).element(2).mul(-.5).div(i).sub(e.z).div(t.z.sub(e.z));return rD(aE(e.xyz,t.xyz,s),t.w)});this.vertexNode=rS(()=>{r1("vec2","vUv").assign(oo());let e=oa("instanceStart"),t=oa("instanceEnd"),n=r0("vec4","start"),a=r0("vec4","end");n.assign(oN.mul(rD(e,1))),a.assign(oN.mul(rD(t,1))),s&&(r1("vec3","worldStart").assign(n.xyz),r1("vec3","worldEnd").assign(a.xyz));let o=hw.z.div(hw.w);rw(ob.element(2).element(3).equal(-1),()=>{rw(n.z.lessThan(0).and(a.z.greaterThan(0)),()=>{a.assign(r({start:n,end:a}))}).ElseIf(a.z.lessThan(0).and(n.z.greaterThanEqual(0)),()=>{n.assign(r({start:a,end:n}))})});let l=ob.mul(n),h=ob.mul(a),u=l.xyz.div(l.w),d=h.xyz.div(h.w),c=d.xy.sub(u.xy).toVar();c.x.assign(c.x.mul(o)),c.assign(c.normalize());let p=rD().toVar();if(s){let e=a.xyz.sub(n.xyz).normalize(),t=aE(n.xyz,a.xyz,.5).normalize(),s=e.cross(t).normalize(),r=e.cross(s),o=r1("vec4","worldPos");o.assign(oE.y.lessThan(.5).select(n,a));let l=lX.mul(.5);o.addAssign(rD(oE.x.lessThan(0).select(s.mul(l),s.mul(l).negate()),0)),i||(o.addAssign(rD(oE.y.lessThan(.5).select(e.mul(l).negate(),e.mul(l)),0)),o.addAssign(rD(r.mul(l),0)),rw(oE.y.greaterThan(1).or(oE.y.lessThan(0)),()=>{o.subAssign(rD(r.mul(2).mul(l),0))})),p.assign(ob.mul(o));let h=rU().toVar();h.assign(oE.y.lessThan(.5).select(u,d)),p.z.assign(h.z.mul(p.w))}else{let e=r0("vec2","offset");e.assign(rB(c.y,c.x.negate())),c.x.assign(c.x.div(o)),e.x.assign(e.x.div(o)),e.assign(oE.x.lessThan(0).select(e.negate(),e)),rw(oE.y.lessThan(0),()=>{e.assign(e.sub(c))}).ElseIf(oE.y.greaterThan(1),()=>{e.assign(e.add(c))}),e.assign(e.mul(lX)),e.assign(e.div(hw.w)),p.assign(oE.y.lessThan(.5).select(l,h)),e.assign(e.mul(p.w)),p.assign(p.add(rD(e,0,0)))}return p})();let n=rS(({p1:e,p2:t,p3:i,p4:s})=>{let r=e.sub(i),n=s.sub(i),a=t.sub(e),o=r.dot(n),l=n.dot(a),h=r.dot(a),u=n.dot(n),d=a.dot(a).mul(u).sub(l.mul(l)),c=o.mul(l).sub(h.mul(u)).div(d).clamp(),p=o.add(l.mul(c)).div(u).clamp();return rB(c,p)});this.fragmentNode=rS(()=>{let r;let a=r1("vec2","vUv");if(i){let e=this.offsetNode?rA(this.offsetNodeNode):lY,t=this.dashScaleNode?rA(this.dashScaleNode):lj,i=this.dashSizeNode?rA(this.dashSizeNode):l$,s=this.dashSizeNode?rA(this.dashGapNode):lq;nd.assign(i),nc.assign(s);let r=oa("instanceDistanceStart"),n=oa("instanceDistanceEnd"),o=aW(oE.y.lessThan(.5).select(t.mul(r),lj.mul(n)).add(lY)),l=e?o.add(e):o;a.y.lessThan(-1).or(a.y.greaterThan(1)).discard(),l.mod(nd.add(nc)).greaterThan(nd).discard()}let o=r0("float","alpha");if(o.assign(1),s){let t=r1("vec3","worldStart"),s=r1("vec3","worldEnd"),r=r1("vec4","worldPos").xyz.normalize().mul(1e5),a=s.sub(t),l=n({p1:t,p2:s,p3:rU(0,0,0),p4:r}),h=t.add(a.mul(l.x)),u=r.mul(l.y),d=h.sub(u).length().div(lX);if(!i){if(e){let e=d.fwidth();o.assign(aP(e.negate().add(.5),e.add(.5),d).oneMinus())}else d.greaterThan(.5).discard()}}else if(e){let e=a.x,t=a.y.greaterThan(0).select(a.y.sub(1),a.y.add(1)),i=e.mul(e).add(t.mul(t)),s=r0("float","dlen");s.assign(i.fwidth()),rw(a.y.abs().greaterThan(1),()=>{o.assign(aP(s.oneMinus(),s.add(1),i).oneMinus())})}else rw(a.y.abs().greaterThan(1),()=>{let e=a.x,t=a.y.greaterThan(0).select(a.y.sub(1),a.y.add(1));e.mul(e).add(t.mul(t)).greaterThan(1).discard()});if(this.lineColorNode)r=this.lineColorNode;else if(t){let e=oa("instanceColorStart"),t=oa("instanceColorEnd");r=oE.y.lessThan(.5).select(e,t).mul(lx)}else r=lx;return rD(r,o)})()}get worldUnits(){return this.useWorldUnits}set worldUnits(e){this.useWorldUnits!==e&&(this.useWorldUnits=e,this.needsUpdate=!0)}get dashed(){return this.useDash}set dashed(e){this.useDash!==e&&(this.useDash=e,this.needsUpdate=!0)}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.needsUpdate=!0)}}hQ.type=hH("Line2",hQ);let hZ=e=>ry(e).mul(.5).add(.5),h0=new s_;class h1 extends hW{constructor(e){super(),this.lights=!1,this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(h0),this.setValues(e)}setupDiffuseColor(){let e=this.opacityNode?rA(this.opacityNode):lT;r2.assign(rD(hZ(oj),e))}}h1.type=hH("MeshNormal",h1);class h2 extends s${constructor(e=oF){super("vec2"),this.dirNode=e}setup(){let e=this.dirNode;return rB(e.z.atan2(e.x).mul(1/(2*Math.PI)).add(.5),e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5))}}h2.type=sW("EquirectUV",h2);let h3=rv(h2);class h4 extends t1{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){let i=t.minFilter,s=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;let r=new tW(5,5,5),n=h3(oF),a=new hW;a.colorNode=op(t,n,0),a.side=1,a.blending=0;let o=new tk(r,a),l=new t2;l.add(o),1008===t.minFilter&&(t.minFilter=1006);let h=new tZ(1,10,this),u=e.getMRT();return e.setMRT(null),h.update(e,l),e.setMRT(u),t.minFilter=i,t.currentGenerateMipmaps=s,o.geometry.dispose(),o.material.dispose(),this}}let h5=new WeakMap;class h6 extends s${constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=o0();let t=new t0;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=sO.RENDER}updateBefore(e){let{renderer:t,material:i}=e,s=this.envNode;if(s.isTextureNode||s.isMaterialReferenceNode){let e=s.isTextureNode?s.value:i[s.property];if(e&&e.isTexture){let i=e.mapping;if(303===i||304===i){if(h5.has(e)){let t=h5.get(e);h7(t,e.mapping),this._cubeTexture=t}else{let i=e.image;if(null!=i&&i.height>0){let s=new h4(i.height);s.fromEquirectangularTexture(t,e),h7(s.texture,e.mapping),this._cubeTexture=s.texture,h5.set(e,s.texture),e.addEventListener("dispose",h8)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}}function h8(e){let t=e.target;t.removeEventListener("dispose",h8);let i=h5.get(t);void 0!==i&&(h5.delete(t),i.dispose())}function h7(e,t){303===t?e.mapping=301:304===t&&(e.mapping=302)}h6.type=sW("CubeMap",h6);let h9=rv(h6);class ue extends hy{constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=h9(this.envNode)}}ue.type=sW("BasicEnvironment",ue);class ut extends hy{constructor(e=null){super(),this.lightMapNode=e}setup(e){let t=rA(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}}ut.type=sW("BasicLightMap",ut);class ui{start(){}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}}class us extends ui{constructor(){super()}indirect(e,t,i){let s=e.ambientOcclusion,r=e.reflectedLight,n=i.context.irradianceLightMap;r.indirectDiffuse.assign(rD(0)),n?r.indirectDiffuse.addAssign(n):r.indirectDiffuse.addAssign(rD(1,1,1,0)),r.indirectDiffuse.mulAssign(s),r.indirectDiffuse.mulAssign(r2.rgb)}finish(e,t,i){let s=i.material,r=e.outgoingLight,n=i.context.environment;if(n)switch(s.combine){case 0:r.rgb.assign(aE(r.rgb,r.rgb.mul(n.rgb),lw.mul(lN)));break;case 1:r.rgb.assign(aE(r.rgb,n.rgb,lw.mul(lN)));break;case 2:r.rgb.addAssign(n.rgb.mul(lw.mul(lN)));break;default:console.warn("THREE.BasicLightingModel: Unsupported .combine value:",s.combine)}}}let ur=new tn;class un extends hW{constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(ur),this.setValues(e)}setupNormal(){return oW}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new ue(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new ut(lQ)),t}setupOutgoingLight(){return r2.rgb}setupLightingModel(){return new us}}un.type=hH("MeshBasic",un);let ua=rS(({f0:e,f90:t,dotVH:i})=>{let s=i.mul(-5.55473).sub(6.98316).mul(i).exp2();return e.mul(s.oneMinus()).add(t.mul(s))}),uo=rS(e=>e.diffuseColor.mul(1/Math.PI)),ul=()=>rA(.25),uh=rS(({dotNH:e})=>nh.mul(rA(.5)).add(1).mul(rA(1/Math.PI)).mul(e.pow(nh))),uu=rS(({lightDirection:e})=>{let t=e.add(oO).normalize(),i=oj.dot(t).clamp(),s=ua({f0:no,f90:1,dotVH:oO.dot(t).clamp()}),r=ul(),n=uh({dotNH:i});return s.mul(r).mul(n)});class ud extends us{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:i}){let s=oj.dot(e).clamp().mul(t);i.directDiffuse.addAssign(s.mul(uo({diffuseColor:r2.rgb}))),!0===this.specular&&i.directSpecular.addAssign(s.mul(uu({lightDirection:e})).mul(lw))}indirect({ambientOcclusion:e,irradiance:t,reflectedLight:i}){i.indirectDiffuse.addAssign(t.mul(uo({diffuseColor:r2}))),i.indirectDiffuse.mulAssign(e)}}let uc=new sM;class up extends hW{constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(uc),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new ue(t):null}setupLightingModel(){return new ud(!1)}}up.type=hH("MeshLambert",up);let um=new sT;class ug extends hW{constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(um),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new ue(t):null}setupLightingModel(){return new ud}setupVariants(){let e=(this.shininessNode?rA(this.shininessNode):lb).max(1e-4);nh.assign(e);let t=this.specularNode||lS;no.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}ug.type=hH("MeshPhong",ug);let uf=rS(()=>{let e=oW.dFdx().abs().max(oW.dFdy().abs());return e.x.max(e.y).max(e.z)}),uy=rS(e=>{let{roughness:t}=e,i=uf(),s=t.max(.0525);return(s=s.add(i)).min(1)}),ux=rS(({alpha:e,dotNL:t,dotNV:i})=>{let s=e.pow2(),r=t.mul(s.add(s.oneMinus().mul(i.pow2())).sqrt()),n=i.mul(s.add(s.oneMinus().mul(t.pow2())).sqrt());return nw(.5,r.add(n).max(nH))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),ub=rS(({alphaT:e,alphaB:t,dotTV:i,dotBV:s,dotTL:r,dotBL:n,dotNV:a,dotNL:o})=>{let l=o.mul(rU(e.mul(i),t.mul(s),a).length()),h=a.mul(rU(e.mul(r),t.mul(n),o).length());return nw(.5,l.add(h)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),uv=rS(({alpha:e,dotNH:t})=>{let i=e.pow2(),s=t.pow2().mul(i.oneMinus()).oneMinus();return i.div(s.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),uT=rA(1/Math.PI),uS=rS(({alphaT:e,alphaB:t,dotNH:i,dotTH:s,dotBH:r})=>{let n=e.mul(t),a=rU(t.mul(s),e.mul(r),n.mul(i)),o=a.dot(a),l=n.div(o);return uT.mul(n.mul(l.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),u_=rS(e=>{let t,i;let{lightDirection:s,f0:r,f90:n,roughness:a,f:o,USE_IRIDESCENCE:l,USE_ANISOTROPY:h}=e,u=e.normalView||oj,d=a.pow2(),c=s.add(oO).normalize(),p=u.dot(s).clamp(),m=u.dot(oO).clamp(),g=u.dot(c).clamp(),f=ua({f0:r,f90:n,dotVH:oO.dot(c).clamp()});if(rm(l)&&(f=ne.mix(f,o)),rm(h)){let e=nn.dot(s),r=nn.dot(oO),n=nn.dot(c),a=na.dot(s),o=na.dot(oO),l=na.dot(c);t=ub({alphaT:ns,alphaB:d,dotTV:r,dotBV:o,dotTL:e,dotBL:a,dotNV:m,dotNL:p}),i=uS({alphaT:ns,alphaB:d,dotNH:g,dotTH:n,dotBH:l})}else t=ux({alpha:d,dotNL:p,dotNV:m}),i=uv({alpha:d,dotNH:g});return f.mul(t).mul(i)}),uM=rS(({roughness:e,dotNV:t})=>{let i=rD(-1,-.0275,-.572,.022),s=rD(1,.0425,1.04,-.04),r=e.mul(i).add(s),n=r.x.mul(r.x).min(t.mul(-9.28).exp2()).mul(r.x).add(r.y);return rB(-1.04,1.04).mul(n).add(r.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),uw=rS(e=>{let{dotNV:t,specularColor:i,specularF90:s,roughness:r}=e,n=uM({dotNV:t,roughness:r});return i.mul(n.x).add(s.mul(n.y))}),uN=rS(({f:e,f90:t,dotVH:i})=>{let s=i.oneMinus().saturate(),r=s.mul(s),n=s.mul(r,r).clamp(0,.9999);return e.sub(rU(t).mul(n)).div(n.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),uA=rS(({roughness:e,dotNH:t})=>{let i=e.pow2(),s=rA(1).div(i),r=t.pow2().oneMinus().max(.0078125);return rA(2).add(s).mul(r.pow(s.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),uR=rS(({dotNV:e,dotNL:t})=>rA(1).div(rA(4).mul(t.add(e).sub(t.mul(e))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),uC=rS(({lightDirection:e})=>{let t=e.add(oO).normalize(),i=oj.dot(e).clamp(),s=oj.dot(oO).clamp(),r=uA({roughness:r9,dotNH:oj.dot(t).clamp()}),n=uR({dotNV:s,dotNL:i});return r7.mul(r).mul(n)}),uE=rS(({N:e,V:t,roughness:i})=>{let s=rB(i,e.dot(t).saturate().oneMinus().sqrt());return s.assign(s.mul(.984375).add(.0078125)),s}).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),uB=rS(({f:e})=>{let t=e.length();return ay(t.mul(t).add(e.z).div(t.add(1)),0)}).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),uI=rS(({v1:e,v2:t})=>{let i=e.dot(t),s=i.abs().toVar(),r=s.mul(.0145206).add(.4965155).mul(s).add(.8543985).toVar(),n=s.add(4.1616724).mul(s).add(3.417594).toVar(),a=r.div(n),o=i.greaterThan(0).select(a,ay(i.mul(i).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(a));return e.cross(t).mul(o)}).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),uP=rS(({N:e,V:t,P:i,mInv:s,p0:r,p1:n,p2:a,p3:o})=>{let l=n.sub(r).toVar(),h=o.sub(r).toVar(),u=l.cross(h),d=rU().toVar();return rw(u.dot(i.sub(r)).greaterThanEqual(0),()=>{let l=t.sub(e.mul(t.dot(e))).normalize(),h=e.cross(l).negate(),u=s.mul(rH(l,h,e).transpose()).toVar(),c=u.mul(r.sub(i)).normalize().toVar(),p=u.mul(n.sub(i)).normalize().toVar(),m=u.mul(a.sub(i)).normalize().toVar(),g=u.mul(o.sub(i)).normalize().toVar(),f=rU(0).toVar();f.addAssign(uI({v1:c,v2:p})),f.addAssign(uI({v1:p,v2:m})),f.addAssign(uI({v1:m,v2:g})),f.addAssign(uI({v1:g,v2:c})),d.assign(rU(uB({f:f})))}),d}).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),uF=1/6,uU=e=>nM(uF,nM(e,nM(e,e.negate().add(3)).sub(3)).add(1)),uO=e=>nM(uF,nM(e,nM(e,nM(3,e).sub(6))).add(4)),uz=e=>nM(uF,nM(e,nM(e,nM(-3,e).add(3)).add(3)).add(1)),uL=e=>nM(uF,aw(e,3)),uD=e=>uU(e).add(uO(e)),uV=e=>uz(e).add(uL(e)),uk=e=>nS(-1,uO(e).div(uU(e).add(uO(e)))),uG=e=>nS(1,uL(e).div(uz(e).add(uL(e)))),uW=(e,t,i)=>{let s=nM(e.uvNode,t.zw).add(.5),r=n3(s),n=n6(s),a=uD(n.x),o=uV(n.x),l=uk(n.x),h=uG(n.x),u=uk(n.y),d=uG(n.y),c=rB(r.x.add(l),r.y.add(u)).sub(.5).mul(t.xy),p=rB(r.x.add(h),r.y.add(u)).sub(.5).mul(t.xy),m=rB(r.x.add(l),r.y.add(d)).sub(.5).mul(t.xy),g=rB(r.x.add(h),r.y.add(d)).sub(.5).mul(t.xy),f=uD(n.y).mul(nS(a.mul(e.uv(c).level(i)),o.mul(e.uv(p).level(i)))),y=uV(n.y).mul(nS(a.mul(e.uv(m).level(i)),o.mul(e.uv(g).level(i))));return f.add(y)},uH=rS(([e,t=rA(3)])=>{let i=rB(e.size(rR(t))),s=rB(e.size(rR(t.add(1)))),r=nw(1,i),n=nw(1,s),a=uW(e,rD(r,i),n3(t)),o=uW(e,rD(n,s),n4(t));return n6(t).mix(a,o)}),uj=rS(([e,t,i,s,r])=>{let n=rU(aI(t.negate(),n5(e),nw(1,s))),a=rU(an(r[0].xyz),an(r[1].xyz),an(r[2].xyz));return n5(n).mul(i.mul(a))}).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),u$=rS(([e,t])=>e.mul(aB(t.mul(2).sub(2),0,1))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),uq=hC(),uX=rS(([e,t,i])=>uH(uq.uv(e),n0(rA(hM.x)).mul(u$(t,i)))),uY=rS(([e,t,i])=>(rw(i.notEqual(0),()=>nK(nZ(t).negate().div(i).negate().mul(e))),rU(1))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),uJ=rS(([e,t,i,s,r,n,a,o,l,h,u,d,c,p,m])=>{let g,f;if(m){g=rD().toVar(),f=rU().toVar();let r=u.sub(1).mul(m.mul(.025)),n=rU(u.sub(r),u,u.add(r));ha({start:0,end:3},({i:r})=>{let u=n.element(r),m=uj(e,t,d,u,o),y=a.add(m),x=h.mul(l.mul(rD(y,1))),b=rB(x.xy.div(x.w)).toVar();b.addAssign(1),b.divAssign(2),b.assign(rB(b.x,b.y.oneMinus()));let v=uX(b,i,u);g.element(r).assign(v.element(r)),g.a.addAssign(v.a),f.element(r).assign(s.element(r).mul(uY(an(m),c,p).element(r)))}),g.a.divAssign(3)}else{let r=uj(e,t,d,u,o),n=a.add(r),m=h.mul(l.mul(rD(n,1))),y=rB(m.xy.div(m.w)).toVar();y.addAssign(1),y.divAssign(2),y.assign(rB(y.x,y.y.oneMinus())),g=uX(y,i,u),f=s.mul(uY(an(r),c,p))}let y=f.rgb.mul(g.rgb),x=rU(uw({dotNV:e.dot(t).clamp(),specularColor:r,specularF90:n,roughness:i})),b=f.r.add(f.g,f.b).div(3);return rD(x.oneMinus().mul(y),g.a.oneMinus().mul(b).oneMinus())}),uK=rH(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),uQ=e=>{let t=e.sqrt();return rU(1).add(t).div(rU(1).sub(t))},uZ=(e,t)=>e.sub(t).div(e.add(t)).pow2(),u0=(e,t)=>{let i=e.mul(2*Math.PI*1e-9),s=rU(54856e-17,44201e-17,52481e-17),r=rU(1681e3,1795300,2208400),n=rU(43278e5,93046e5,66121e5),a=rA(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(i.mul(2239900).add(t.x).cos()).mul(i.pow2().mul(-45282e5).exp()),o=s.mul(n.mul(2*Math.PI).sqrt()).mul(r.mul(i).add(t).cos()).mul(i.pow2().negate().mul(n).exp());return o=rU(o.x.add(a),o.y,o.z).div(10685e-11),uK.mul(o)},u1=rS(({outsideIOR:e,eta2:t,cosTheta1:i,thinFilmThickness:s,baseF0:r})=>{let n=aE(e,t,aP(0,.03,s)),a=e.div(n).pow2().mul(rA(1).sub(i.pow2())),o=rA(1).sub(a).sqrt(),l=ua({f0:uZ(n,e),f90:1,dotVH:i}),h=l.oneMinus(),u=n.lessThan(e).select(Math.PI,0),d=rA(Math.PI).sub(u),c=uQ(r.clamp(0,.9999)),p=ua({f0:uZ(c,n.toVec3()),f90:1,dotVH:o}),m=rU(c.x.lessThan(n).select(Math.PI,0),c.y.lessThan(n).select(Math.PI,0),c.z.lessThan(n).select(Math.PI,0)),g=n.mul(s,o,2),f=rU(d).add(m),y=l.mul(p).clamp(1e-5,.9999),x=y.sqrt(),b=h.pow2().mul(p).div(rU(1).sub(y)),v=l.add(b),T=b.sub(h);for(let e=1;e<=2;++e){T=T.mul(x);let t=u0(rA(e).mul(g),rA(e).mul(f)).mul(2);v=v.add(T.mul(t))}return v.max(rU(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),u2=rS(({normal:e,viewDir:t,roughness:i})=>{let s=e.dot(t).saturate(),r=i.pow2(),n=az(i.lessThan(.25),rA(-339.2).mul(r).add(rA(161.4).mul(i)).sub(25.9),rA(-8.48).mul(r).add(rA(14.3).mul(i)).sub(9.95)),a=az(i.lessThan(.25),rA(44).mul(r).sub(rA(23.7).mul(i)).add(3.26),rA(1.97).mul(r).sub(rA(3.27).mul(i)).add(.72));return az(i.lessThan(.25),0,rA(.1).mul(i).sub(.025)).add(n.mul(s).add(a).exp()).mul(1/Math.PI).saturate()}),u3=rU(.04),u4=rA(1);class u5 extends ui{constructor(e=!1,t=!1,i=!1,s=!1,r=!1,n=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=i,this.anisotropy=s,this.transmission=r,this.dispersion=n,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(!0===this.clearcoat&&(this.clearcoatRadiance=rU().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=rU().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=rU().toVar("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=rU().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=rU().toVar("sheenSpecularIndirect")),!0===this.iridescence){let e=oj.dot(oO).clamp();this.iridescenceFresnel=u1({outsideIOR:rA(1),eta2:nt,cosTheta1:e,thinFilmThickness:ni,baseF0:no}),this.iridescenceF0=uN({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(!0===this.transmission){let t=oT.sub(oP).normalize();e.backdrop=uJ(o$,t,r4,r2,no,nl,oP,oR,ov,ob,np,ng,ny,nf,this.dispersion?nx:null),e.backdropAlpha=nm,r2.a.mulAssign(aE(1,e.backdrop.a,nm))}}computeMultiscattering(e,t,i){let s=uM({roughness:r4,dotNV:oj.dot(oO).clamp()}),r=(this.iridescenceF0?ne.mix(no,this.iridescenceF0):no).mul(s.x).add(i.mul(s.y)),n=s.x.add(s.y).oneMinus(),a=no.add(no.oneMinus().mul(.047619)),o=r.mul(a).div(n.mul(a).oneMinus());e.addAssign(r),t.addAssign(o.mul(n))}direct({lightDirection:e,lightColor:t,reflectedLight:i}){let s=oj.dot(e).clamp().mul(t);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(s.mul(uC({lightDirection:e}))),!0===this.clearcoat){let i=oq.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(i.mul(u_({lightDirection:e,f0:u3,f90:u4,roughness:r8,normalView:oq})))}i.directDiffuse.addAssign(s.mul(uo({diffuseColor:r2.rgb}))),i.directSpecular.addAssign(s.mul(u_({lightDirection:e,f0:no,f90:1,roughness:r4,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:i,halfHeight:s,reflectedLight:r,ltc_1:n,ltc_2:a}){let o=t.add(i).sub(s),l=t.sub(i).sub(s),h=t.sub(i).add(s),u=t.add(i).add(s),d=oU.toVar(),c=uE({N:oj,V:oO,roughness:r4}),p=n.uv(c).toVar(),m=a.uv(c).toVar(),g=rH(rU(p.x,0,p.y),rU(0,1,0),rU(p.z,0,p.w)).toVar(),f=no.mul(m.x).add(no.oneMinus().mul(m.y)).toVar();r.directSpecular.addAssign(e.mul(f).mul(uP({N:oj,V:oO,P:d,mInv:g,p0:o,p1:l,p2:h,p3:u}))),r.directDiffuse.addAssign(e.mul(r2).mul(uP({N:oj,V:oO,P:d,mInv:rH(1,0,0,0,1,0,0,0,1),p0:o,p1:l,p2:h,p3:u})))}indirect(e,t,i){this.indirectDiffuse(e,t,i),this.indirectSpecular(e,t,i),this.ambientOcclusion(e,t,i)}indirectDiffuse({irradiance:e,reflectedLight:t}){t.indirectDiffuse.addAssign(e.mul(uo({diffuseColor:r2})))}indirectSpecular({radiance:e,iblIrradiance:t,reflectedLight:i}){if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(t.mul(r7,u2({normal:oj,viewDir:oO,roughness:r9}))),!0===this.clearcoat){let e=uw({dotNV:oq.dot(oO).clamp(),specularColor:u3,specularF90:u4,roughness:r8});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(e))}let s=rU().toVar("singleScattering"),r=rU().toVar("multiScattering"),n=t.mul(1/Math.PI);this.computeMultiscattering(s,r,nl);let a=s.add(r),o=r2.mul(a.r.max(a.g).max(a.b).oneMinus());i.indirectSpecular.addAssign(e.mul(s)),i.indirectSpecular.addAssign(r.mul(n)),i.indirectDiffuse.addAssign(o.mul(n))}ambientOcclusion({ambientOcclusion:e,reflectedLight:t}){let i=oj.dot(oO).clamp().add(e),s=r4.mul(-16).oneMinus().negate().exp2(),r=e.sub(i.pow(s).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(e),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(e),t.indirectDiffuse.mulAssign(e),t.indirectSpecular.mulAssign(r)}finish(e){let{outgoingLight:t}=e;if(!0===this.clearcoat){let e=ua({dotVH:oq.dot(oO).clamp(),f0:u3,f90:u4}),i=t.mul(r6.mul(e).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(r6));t.assign(i)}if(!0===this.sheen){let e=r7.r.max(r7.g).max(r7.b).mul(.157).oneMinus(),i=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(i)}}}let u6=rA(1),u8=rA(-2),u7=rA(.8),u9=rA(-1),de=rA(.4),dt=rA(2),di=rA(.305),ds=rA(3),dr=rA(.21),dn=rA(4),da=rA(4),dl=rA(16),dh=rS(([e])=>{let t=rU(as(e)).toVar(),i=rA(-1).toVar();return rw(t.x.greaterThan(t.z),()=>{rw(t.x.greaterThan(t.y),()=>{i.assign(az(e.x.greaterThan(0),0,3))}).Else(()=>{i.assign(az(e.y.greaterThan(0),1,4))})}).Else(()=>{rw(t.z.greaterThan(t.y),()=>{i.assign(az(e.z.greaterThan(0),2,5))}).Else(()=>{i.assign(az(e.y.greaterThan(0),1,4))})}),i}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),du=rS(([e,t])=>{let i=rB().toVar();return rw(t.equal(0),()=>{i.assign(rB(e.z,e.y).div(as(e.x)))}).ElseIf(t.equal(1),()=>{i.assign(rB(e.x.negate(),e.z.negate()).div(as(e.y)))}).ElseIf(t.equal(2),()=>{i.assign(rB(e.x.negate(),e.y).div(as(e.z)))}).ElseIf(t.equal(3),()=>{i.assign(rB(e.z.negate(),e.y).div(as(e.x)))}).ElseIf(t.equal(4),()=>{i.assign(rB(e.x.negate(),e.z).div(as(e.y)))}).Else(()=>{i.assign(rB(e.x,e.y).div(as(e.z)))}),nM(.5,i.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),dd=rS(([e])=>{let t=rA(0).toVar();return rw(e.greaterThanEqual(u7),()=>{t.assign(u6.sub(e).mul(u9.sub(u8)).div(u6.sub(u7)).add(u8))}).ElseIf(e.greaterThanEqual(de),()=>{t.assign(u7.sub(e).mul(dt.sub(u9)).div(u7.sub(de)).add(u9))}).ElseIf(e.greaterThanEqual(di),()=>{t.assign(de.sub(e).mul(ds.sub(dt)).div(de.sub(di)).add(dt))}).ElseIf(e.greaterThanEqual(dr),()=>{t.assign(di.sub(e).mul(dn.sub(ds)).div(di.sub(dr)).add(ds))}).Else(()=>{t.assign(rA(-2).mul(n0(nM(1.16,e))))}),t}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),dc=rS(([e,t])=>{let i=e.toVar();i.assign(nM(2,i).sub(1));let s=rU(i,1).toVar();return rw(t.equal(0),()=>{s.assign(s.zyx)}).ElseIf(t.equal(1),()=>{s.assign(s.xzy),s.xz.mulAssign(-1)}).ElseIf(t.equal(2),()=>{s.x.mulAssign(-1)}).ElseIf(t.equal(3),()=>{s.assign(s.zyx),s.xz.mulAssign(-1)}).ElseIf(t.equal(4),()=>{s.assign(s.xzy),s.xy.mulAssign(-1)}).ElseIf(t.equal(5),()=>{s.z.mulAssign(-1)}),s}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),dp=rS(([e,t,i,s,r,n])=>{let a=rA(i),o=rU(t),l=aB(dd(a),u8,n),h=n6(l),u=n3(l),d=rU(dm(e,o,u,s,r,n)).toVar();return rw(h.notEqual(0),()=>{let t=rU(dm(e,o,u.add(1),s,r,n)).toVar();d.assign(aE(d,t,h))}),d}),dm=rS(([e,t,i,s,r,n])=>{let a=rA(i).toVar(),o=rU(t),l=rA(dh(o)).toVar(),h=rA(ay(da.sub(a),0)).toVar();a.assign(ay(a,da));let u=rA(nQ(a)).toVar(),d=rB(du(o,l).mul(u.sub(2)).add(1)).toVar();return rw(l.greaterThan(2),()=>{d.y.addAssign(u),l.subAssign(3)}),d.x.addAssign(l.mul(u)),d.x.addAssign(h.mul(nM(3,dl))),d.y.addAssign(nM(4,nQ(n).sub(u))),d.x.mulAssign(s),d.y.mulAssign(r),e.uv(d).grad(rB(),rB())}),dg=rS(({envMap:e,mipInt:t,outputDirection:i,theta:s,axis:r,CUBEUV_TEXEL_WIDTH:n,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:o})=>{let l=n7(s);return dm(e,i.mul(l).add(r.cross(i).mul(n8(s))).add(r.mul(r.dot(i).mul(l.oneMinus()))),t,n,a,o)}),df=rS(({n:e,latitudinal:t,poleAxis:i,outputDirection:s,weights:r,samples:n,dTheta:a,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})=>{let c=rU(az(t,i,aM(i,s))).toVar();rw(n$(c.equals(rU(0))),()=>{c.assign(rU(s.z,0,s.x.negate()))}),c.assign(n5(c));let p=rU().toVar();return p.addAssign(r.element(rR(0)).mul(dg({theta:0,axis:c,outputDirection:s,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),ha({start:rR(1),end:e},({i:e})=>{rw(e.greaterThanEqual(n),()=>{ho()});let t=rA(a.mul(rA(e))).toVar();p.addAssign(r.element(e).mul(dg({theta:t.mul(-1),axis:c,outputDirection:s,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),p.addAssign(r.element(e).mul(dg({theta:t,axis:c,outputDirection:s,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})))}),rD(p,1)}),dy=null,dx=new WeakMap;class db extends s${constructor(e,t=null,i=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=i,this._generator=null;let s=new V;s.isRenderTargetTexture=!0,this._texture=op(s),this._width=rQ(0),this._height=rQ(0),this._maxMip=rQ(0),this.updateBeforeType=sO.RENDER}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){let t=function(e){let t=Math.log2(e)-2;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:1/e,maxMip:t}}(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(){let e=this._pmrem,t=e?e.pmremVersion:-1,i=this._value;t!==i.pmremVersion&&null!==(e=!0===i.isPMREMTexture?i:function(e){let t=dx.get(e);if((void 0!==t?t.pmremVersion:-1)!==e.pmremVersion){let i=e.image;if(e.isCubeTexture){if(!function(e){if(null==e)return!1;let t=0;for(let i=0;i<6;i++)void 0!==e[i]&&t++;return 6===t}(i))return null;t=dy.fromCubemap(e,t)}else{if(!(null!=i&&i.height>0))return null;t=dy.fromEquirectangular(e,t)}t.pmremVersion=e.pmremVersion,dx.set(e,t)}return t.texture}(i))&&(this._pmrem=e,this.updateFromTexture(e))}setup(e){null===dy&&(dy=e.createPMREMGenerator()),this.updateBefore(e);let t=this.uvNode;null===t&&e.context.getUV&&(t=e.context.getUV(this));let i=this.value;2e3===e.renderer.coordinateSystem&&!0!==i.isPMREMTexture&&!0===i.isRenderTargetTexture&&(t=rU(t.x.negate(),t.yz));let s=this.levelNode;return null===s&&e.context.getTextureLevel&&(s=e.context.getTextureLevel(this)),dp(this._texture,t,s,this._width,this._height,this._maxMip)}}db.type=sW("PMREM",db);let dv=rv(db),dT=new WeakMap;class dS extends hy{constructor(e=null){super(),this.envNode=e}setup(e){let{material:t}=e,i=this.envNode;if(i.isTextureNode||i.isMaterialReferenceNode){let e=i.isTextureNode?i.value:t[i.property],s=dT.get(e);void 0===s&&(s=dv(e),dT.set(e,s)),i=s}let s=t.envMap?o7("envMapIntensity","float",e.material):o7("environmentIntensity","float",e.scene),r=!0===t.useAnisotropy||t.anisotropy>0?lo:oj,n=i.context(d_(r4,r)).mul(s),a=i.context(dM(o$)).mul(Math.PI).mul(s),o=a8(n),l=a8(a);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(l);let h=e.context.lightingModel.clearcoatRadiance;if(h){let e=a8(i.context(d_(r8,oq)).mul(s));h.addAssign(e)}}}dS.type=sW("Environment",dS);let d_=(e,t)=>{let i=null;return{getUV:()=>(null===i&&(i=oO.negate().reflect(t),i=(i=e.mul(e).mix(i,t).normalize()).transformDirection(ov)),i),getTextureLevel:()=>e}},dM=e=>({getUV:()=>e,getTextureLevel:()=>rA(1)}),dw=new sb;class dN extends hW{constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(dw),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return null===t&&e.environmentNode&&(t=e.environmentNode),t?new dS(t):null}setupLightingModel(){return new u5}setupSpecular(){let e=aE(rU(.04),r2.rgb,r5);no.assign(e),nl.assign(1)}setupVariants(){let e=this.metalnessNode?rA(this.metalnessNode):lR;r5.assign(e);let t=this.roughnessNode?rA(this.roughnessNode):lA;t=uy({roughness:t}),r4.assign(t),this.setupSpecular(),r2.assign(rD(r2.rgb.mul(e.oneMinus()),r2.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}dN.type=hH("MeshStandard",dN);let dA=new sv;class dR extends dN{constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(dA),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}get useAnisotropy(){return this.anisotropy>0||null!==this.anisotropyNode}get useTransmission(){return this.transmission>0||null!==this.transmissionNode}get useDispersion(){return this.dispersion>0||null!==this.dispersionNode}setupSpecular(){let e=this.iorNode?rA(this.iorNode):lG;np.assign(e),no.assign(aE(af(aN(np.sub(1).div(np.add(1))).mul(lM),rU(1)).mul(l_),r2.rgb,r5)),nl.assign(aE(l_,1,r5))}setupLightingModel(){return new u5(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){let e=this.clearcoatNode?rA(this.clearcoatNode):lE,t=this.clearcoatRoughnessNode?rA(this.clearcoatRoughnessNode):lB;r6.assign(e),r8.assign(uy({roughness:t}))}if(this.useSheen){let e=this.sheenNode?rU(this.sheenNode):lF,t=this.sheenRoughnessNode?rA(this.sheenRoughnessNode):lU;r7.assign(e),r9.assign(t)}if(this.useIridescence){let e=this.iridescenceNode?rA(this.iridescenceNode):lz,t=this.iridescenceIORNode?rA(this.iridescenceIORNode):lL,i=this.iridescenceThicknessNode?rA(this.iridescenceThicknessNode):lD;ne.assign(e),nt.assign(t),ni.assign(i)}if(this.useAnisotropy){let e=(this.anisotropyNode?rB(this.anisotropyNode):lO).toVar();nr.assign(e.length()),rw(nr.equal(0),()=>{e.assign(rB(1,0))}).Else(()=>{e.divAssign(rB(nr)),nr.assign(nr.saturate())}),ns.assign(nr.pow2().mix(r4.pow2(),1)),nn.assign(la[0].mul(e.x).add(la[1].mul(e.y))),na.assign(la[1].mul(e.x).sub(la[0].mul(e.y)))}if(this.useTransmission){let e=this.transmissionNode?rA(this.transmissionNode):lV,t=this.thicknessNode?rA(this.thicknessNode):lk,i=this.attenuationDistanceNode?rA(this.attenuationDistanceNode):lW,s=this.attenuationColorNode?rU(this.attenuationColorNode):lH;if(nm.assign(e),ng.assign(t),nf.assign(i),ny.assign(s),this.useDispersion){let e=this.dispersionNode?rA(this.dispersionNode):lK;nx.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?rU(this.clearcoatNormalNode):lI}setup(e){e.context.setupClearcoatNormal=()=>this.setupClearcoatNormal(e),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}}dR.type=hH("MeshPhysical",dR);class dC extends u5{constructor(e,t,i,s){super(e,t,i),this.useSSS=s}direct({lightDirection:e,lightColor:t,reflectedLight:i},s,r){if(!0===this.useSSS){let{thicknessColorNode:s,thicknessDistortionNode:n,thicknessAmbientNode:a,thicknessAttenuationNode:o,thicknessPowerNode:l,thicknessScaleNode:h}=r.material,u=e.add(oj.mul(n)).normalize(),d=rU(rA(oO.dot(u.negate()).saturate().pow(l).mul(h)).add(a).mul(s));i.directDiffuse.addAssign(d.mul(o.mul(t)))}super.direct({lightDirection:e,lightColor:t,reflectedLight:i},s,r)}}class dE extends dR{constructor(e){super(e),this.thicknessColorNode=null,this.thicknessDistortionNode=rA(.1),this.thicknessAmbientNode=rA(0),this.thicknessAttenuationNode=rA(.1),this.thicknessPowerNode=rA(2),this.thicknessScaleNode=rA(10)}get useSSS(){return null!==this.thicknessColorNode}setupLightingModel(){return new dC(this.useClearcoat,this.useSheen,this.useIridescence,this.useSSS)}copy(e){return this.thicknessColorNode=e.thicknessColorNode,this.thicknessDistortionNode=e.thicknessDistortionNode,this.thicknessAmbientNode=e.thicknessAmbientNode,this.thicknessAttenuationNode=e.thicknessAttenuationNode,this.thicknessPowerNode=e.thicknessPowerNode,this.thicknessScaleNode=e.thicknessScaleNode,super.copy(e)}}dE.type=hH("MeshSSS",dE);let dB=rS(({normal:e,lightDirection:t,builder:i})=>{let s=rB(e.dot(t).mul(.5).add(.5),0);if(i.material.gradientMap)return rU(lt("gradientMap","texture").context({getUV:()=>s}).r);{let e=s.fwidth().mul(.5);return aE(rU(.7),rU(1),aP(rA(.7).sub(e.x),rA(.7).add(e.x),s.x))}});class dI extends ui{direct({lightDirection:e,lightColor:t,reflectedLight:i},s,r){let n=dB({normal:oD,lightDirection:e,builder:r}).mul(t);i.directDiffuse.addAssign(n.mul(uo({diffuseColor:r2.rgb})))}indirect({ambientOcclusion:e,irradiance:t,reflectedLight:i}){i.indirectDiffuse.addAssign(t.mul(uo({diffuseColor:r2}))),i.indirectDiffuse.mulAssign(e)}}let dP=new sS;class dF extends hW{constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(dP),this.setValues(e)}setupLightingModel(){return new dI}}dF.type=hH("MeshToon",dF);class dU extends s${constructor(){super("vec2")}setup(){let e=rU(oO.z,0,oO.x.negate()).normalize(),t=oO.cross(e);return rB(e.dot(oj),t.dot(oj)).mul(.495).add(.5)}}dU.type=sW("MatcapUV",dU);let dO=rT(dU),dz=new sA;class dL extends hW{constructor(e){super(),this.lights=!1,this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(dz),this.setValues(e)}setupVariants(e){let t;t=e.material.matcap?lt("matcap","texture").context({getUV:()=>dO}):rU(aE(.2,.8,dO.y)),r2.rgb.mulAssign(t.rgb)}}dL.type=hH("MeshMatcap",dL);let dD=new iy;class dV extends hW{constructor(e){super(),this.isPointsNodeMaterial=!0,this.lights=!1,this.transparent=!0,this.sizeNode=null,this.setDefaultValues(dD),this.setValues(e)}copy(e){return this.sizeNode=e.sizeNode,super.copy(e)}}dV.type=hH("Points",dV);class dk extends s${constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){let{rotationNode:t,positionNode:i}=this;if("vec2"===this.getNodeType(e)){let e=t.cos(),s=t.sin();return rW(e,s,s.negate(),e).mul(i)}{let e=rj(rD(1,0,0,0),rD(0,n7(t.x),n8(t.x).negate(),0),rD(0,n8(t.x),n7(t.x),0),rD(0,0,0,1)),s=rj(rD(n7(t.y),0,n8(t.y),0),rD(0,1,0,0),rD(n8(t.y).negate(),0,n7(t.y),0),rD(0,0,0,1)),r=rj(rD(n7(t.z),n8(t.z).negate(),0,0),rD(n8(t.z),n7(t.z),0,0),rD(0,0,1,0),rD(0,0,0,1));return e.mul(s).mul(r).mul(rD(i,1)).xyz}}}dk.type=sW("Rotate",dk);let dG=rv(dk),dW=new t6;class dH extends hW{constructor(e){super(),this.isSpriteNodeMaterial=!0,this.lights=!1,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.setDefaultValues(dW),this.setValues(e)}setupPosition({object:e,context:t}){let{positionNode:i,rotationNode:s,scaleNode:r}=this,n=oN.mul(rU(i||0)),a=rB(oR[0].xyz.length(),oR[1].xyz.length());null!==r&&(a=a.mul(r));let o=oB.xy;e.center&&!0===e.center.isVector2&&(o=o.sub(rQ(e.center).sub(.5)));let l=dG(o=o.mul(a),rA(s||lP));n=rD(n.xy.add(l),n.zw);let h=ob.mul(n);return t.vertex=oB,h}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}}dH.type=hH("Sprite",dH);class dj extends ui{constructor(){super(),this.shadowNode=rA(1).toVar("shadowMask")}direct({shadowMask:e}){this.shadowNode.mulAssign(e)}finish(e){r2.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(r2.rgb)}}let d$=new sy;class dq extends hW{constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.setDefaultValues(d$),this.setValues(e)}setupLightingModel(){return new dj}}dq.type=hH("Shadow",dq);let dX=rS(({texture:e,uv:t})=>{let i=rU().temp();return rw(t.x.lessThan(1e-4),()=>{i.assign(rU(1,0,0))}).ElseIf(t.y.lessThan(1e-4),()=>{i.assign(rU(0,1,0))}).ElseIf(t.z.lessThan(1e-4),()=>{i.assign(rU(0,0,1))}).ElseIf(t.x.greaterThan(.9999),()=>{i.assign(rU(-1,0,0))}).ElseIf(t.y.greaterThan(.9999),()=>{i.assign(rU(0,-1,0))}).ElseIf(t.z.greaterThan(.9999),()=>{i.assign(rU(0,0,-1))}).Else(()=>{let s=e.uv(t.add(rU(-.01,0,0))).r.sub(e.uv(t.add(rU(.01,0,0))).r),r=e.uv(t.add(rU(0,-.01,0))).r.sub(e.uv(t.add(rU(0,.01,0))).r),n=e.uv(t.add(rU(0,0,-.01))).r.sub(e.uv(t.add(rU(0,0,.01))).r);i.assign(rU(s,r,n))}),i.normalize()});class dY extends oc{constructor(e,t=null,i=null){super(e,t,i),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return rU(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){return t}generateUV(e,t){return t.build(e,"vec3")}normal(e){return dX({texture:this,uv:e})}}dY.type=sW("Texture3D",dY);let dJ=rv(dY);class dK extends hW{constructor(e={}){super(),this.lights=!1,this.isVolumeNodeMaterial=!0,this.testNode=null,this.setValues(e)}setup(e){let t=dJ(this.map,null,0),i=rS(({orig:e,dir:t})=>{let i=rU(-.5),s=rU(.5),r=t.reciprocal(),n=i.sub(e).mul(r),a=s.sub(e).mul(r),o=af(n,a),l=ay(n,a);return rB(ay(o.x,ay(o.y,o.z)),af(l.x,af(l.y,l.z)))});this.fragmentNode=rS(()=>{let e=aW(rU(oC.mul(rD(oT,1)))),s=aW(oE.sub(e)).normalize(),r=r0("vec2","bounds").assign(i({orig:e,dir:s}));r.x.greaterThan(r.y).discard(),r.assign(rB(ay(r.x,0),r.y));let n=r0("vec3","p").assign(e.add(r.x.mul(s))),a=r0("vec3","inc").assign(rU(s.abs().reciprocal())),o=r0("float","delta").assign(af(a.x,af(a.y,a.z)));o.divAssign(lt("steps","float"));let l=r0("vec4","ac").assign(rD(lt("base","color"),0));return ha({type:"float",start:r.x,end:r.y,update:"+= delta"},()=>{let e=r0("float","d").assign(t.uv(n.add(.5)).r);null!==this.testNode?this.testNode({map:t,mapValue:e,probe:n,finalColor:l}).append():(l.a.assign(1),ho()),n.addAssign(s.mul(o))}),l.a.equal(0).discard(),rD(l)})(),super.setup(e)}}function dQ(e,t,i){return e&&(i||e.constructor!==t)?"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e):e}dK.type=hH("Volume",dK);class dZ{constructor(e,t,i,s){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==s?s:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){let t=this.parameterPositions,i=this._cachedIndex,s=t[i],r=t[i-1];e:{t:{let n;i:{s:if(!(e<s)){for(let n=i+2;;){if(void 0===s){if(e<r)break s;return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===n)break;if(r=s,e<(s=t[++i]))break t}n=t.length;break i}if(!(e>=r)){let a=t[1];e<a&&(i=2,r=a);for(let n=i-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(i===n)break;if(s=r,e>=(r=t[--i-1]))break t}n=i,i=0;break i}break e}for(;i<n;){let s=i+n>>>1;e<t[s]?n=s:i=s+1}if(s=t[i],void 0===(r=t[i-1]))return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===s)return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,r,s)}return this.interpolate_(i,r,e,s)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){let t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=e*s;for(let e=0;e!==s;++e)t[e]=i[r+e];return t}interpolate_(){throw Error("call to abstract method")}intervalChanged_(){}}class d0 extends dZ{constructor(e,t,i,s){super(e,t,i,s),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,t,i){let s=this.parameterPositions,r=e-2,n=e+1,a=s[r],o=s[n];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=e,a=2*t-i;break;case 2402:r=s.length-2,a=t+s[r]-s[r+1];break;default:r=e,a=i}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:n=e,o=2*i-t;break;case 2402:n=1,o=i+s[1]-s[0];break;default:n=e-1,o=t}let l=(i-t)*.5,h=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(o-i),this._offsetPrev=r*h,this._offsetNext=n*h}interpolate_(e,t,i,s){let r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,h=this._offsetPrev,u=this._offsetNext,d=this._weightPrev,c=this._weightNext,p=(i-t)/(s-t),m=p*p,g=m*p,f=-d*g+2*d*m-d*p,y=(1+d)*g+(-1.5-2*d)*m+(-.5+d)*p+1,x=(-1-c)*g+(1.5+c)*m+.5*p,b=c*g-c*m;for(let e=0;e!==a;++e)r[e]=f*n[h+e]+y*n[l+e]+x*n[o+e]+b*n[u+e];return r}}class d1 extends dZ{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e,t,i,s){let r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,h=(i-t)/(s-t),u=1-h;for(let e=0;e!==a;++e)r[e]=n[l+e]*u+n[o+e]*h;return r}}class d2 extends dZ{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e){return this.copySampleValue_(e-1)}}class d3{constructor(e,t,i,s){if(void 0===e)throw Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=dQ(t,this.TimeBufferType),this.values=dQ(i,this.ValueBufferType),this.setInterpolation(s||this.DefaultInterpolation)}static toJSON(e){let t;let i=e.constructor;if(i.toJSON!==this.toJSON)t=i.toJSON(e);else{t={name:e.name,times:dQ(e.times,Array),values:dQ(e.values,Array)};let i=e.getInterpolation();i!==e.DefaultInterpolation&&(t.interpolation=i)}return t.type=e.ValueTypeName,t}InterpolantFactoryMethodDiscrete(e){return new d2(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new d1(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new d0(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){let t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw Error(t)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){let t=this.times;for(let i=0,s=t.length;i!==s;++i)t[i]+=e}return this}scale(e){if(1!==e){let t=this.times;for(let i=0,s=t.length;i!==s;++i)t[i]*=e}return this}trim(e,t){let i=this.times,s=i.length,r=0,n=s-1;for(;r!==s&&i[r]<e;)++r;for(;-1!==n&&i[n]>t;)--n;if(++n,0!==r||n!==s){r>=n&&(r=(n=Math.max(n,1))-1);let e=this.getValueSize();this.times=i.slice(r,n),this.values=this.values.slice(r*e,n*e)}return this}validate(){let e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);let i=this.times,s=this.values,r=i.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let n=null;for(let t=0;t!==r;t++){let s=i[t];if("number"==typeof s&&isNaN(s)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,s),e=!1;break}if(null!==n&&n>s){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,s,n),e=!1;break}n=s}if(void 0!==s&&ArrayBuffer.isView(s)&&!(s instanceof DataView))for(let t=0,i=s.length;t!==i;++t){let i=s[t];if(isNaN(i)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,i),e=!1;break}}return e}optimize(){let e=this.times.slice(),t=this.values.slice(),i=this.getValueSize(),s=2302===this.getInterpolation(),r=e.length-1,n=1;for(let a=1;a<r;++a){let r=!1,o=e[a];if(o!==e[a+1]&&(1!==a||o!==e[0])){if(s)r=!0;else{let e=a*i,s=e-i,n=e+i;for(let a=0;a!==i;++a){let i=t[e+a];if(i!==t[s+a]||i!==t[n+a]){r=!0;break}}}}if(r){if(a!==n){e[n]=e[a];let s=a*i,r=n*i;for(let e=0;e!==i;++e)t[r+e]=t[s+e]}++n}}if(r>0){e[n]=e[r];for(let e=r*i,s=n*i,a=0;a!==i;++a)t[s+a]=t[e+a];++n}return n!==e.length?(this.times=e.slice(0,n),this.values=t.slice(0,n*i)):(this.times=e,this.values=t),this}clone(){let e=this.times.slice(),t=this.values.slice(),i=new this.constructor(this.name,e,t);return i.createInterpolant=this.createInterpolant,i}}d3.prototype.TimeBufferType=Float32Array,d3.prototype.ValueBufferType=Float32Array,d3.prototype.DefaultInterpolation=2301;class d4 extends d3{constructor(e,t,i){super(e,t,i)}}d4.prototype.ValueTypeName="bool",d4.prototype.ValueBufferType=Array,d4.prototype.DefaultInterpolation=2300,d4.prototype.InterpolantFactoryMethodLinear=void 0,d4.prototype.InterpolantFactoryMethodSmooth=void 0;class d5 extends d3{}d5.prototype.ValueTypeName="color";class d6 extends d3{}d6.prototype.ValueTypeName="number";class d8 extends dZ{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e,t,i,s){let r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(i-t)/(s-t),l=e*a;for(let e=l+a;l!==e;l+=4)j.slerpFlat(r,0,n,l-a,n,l,o);return r}}class d7 extends d3{InterpolantFactoryMethodLinear(e){return new d8(this.times,this.values,this.getValueSize(),e)}}d7.prototype.ValueTypeName="quaternion",d7.prototype.InterpolantFactoryMethodSmooth=void 0;class d9 extends d3{constructor(e,t,i){super(e,t,i)}}d9.prototype.ValueTypeName="string",d9.prototype.ValueBufferType=Array,d9.prototype.DefaultInterpolation=2300,d9.prototype.InterpolantFactoryMethodLinear=void 0,d9.prototype.InterpolantFactoryMethodSmooth=void 0;class ce extends d3{}ce.prototype.ValueTypeName="vector";let ct={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]}};class ci{constructor(e,t,i){let s;let r=this,n=!1,a=0,o=0,l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===n&&void 0!==r.onStart&&r.onStart(e,a,o),n=!0},this.itemEnd=function(e){a++,void 0!==r.onProgress&&r.onProgress(e,a,o),a===o&&(n=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(e){void 0!==r.onError&&r.onError(e)},this.resolveURL=function(e){return s?s(e):e},this.setURLModifier=function(e){return s=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){let t=l.indexOf(e);return -1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){let i=l[t],s=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return s}return null}}}let cs=new ci;class cr{constructor(e){this.manager=void 0!==e?e:cs,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){let i=this;return new Promise(function(s,r){i.load(e,s,t,r)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}cr.DEFAULT_MATERIAL_NAME="__DEFAULT";let cn={};class ca extends Error{constructor(e,t){super(e),this.response=t}}class co extends cr{constructor(e){super(e)}load(e,t,i,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let r=ct.get(e);if(void 0!==r)return this.manager.itemStart(e),setTimeout(()=>{t&&t(r),this.manager.itemEnd(e)},0),r;if(void 0!==cn[e]){cn[e].push({onLoad:t,onProgress:i,onError:s});return}cn[e]=[],cn[e].push({onLoad:t,onProgress:i,onError:s});let n=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,o=this.responseType;fetch(n).then(t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;let i=cn[e],s=t.body.getReader(),r=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),n=r?parseInt(r):0,a=0!==n,o=0;return new Response(new ReadableStream({start(e){(function t(){s.read().then(({done:s,value:r})=>{if(s)e.close();else{let s=new ProgressEvent("progress",{lengthComputable:a,loaded:o+=r.byteLength,total:n});for(let e=0,t=i.length;e<t;e++){let t=i[e];t.onProgress&&t.onProgress(s)}e.enqueue(r),t()}},t=>{e.error(t)})})()}}))}throw new ca(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)}).then(e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(e=>new DOMParser().parseFromString(e,a));case"json":return e.json();default:if(void 0===a)return e.text();{let t=/charset="?([^;"\s]*)"?/i.exec(a),i=new TextDecoder(t&&t[1]?t[1].toLowerCase():void 0);return e.arrayBuffer().then(e=>i.decode(e))}}}).then(t=>{ct.add(e,t);let i=cn[e];delete cn[e];for(let e=0,s=i.length;e<s;e++){let s=i[e];s.onLoad&&s.onLoad(t)}}).catch(t=>{let i=cn[e];if(void 0===i)throw this.manager.itemError(e),t;delete cn[e];for(let e=0,s=i.length;e<s;e++){let s=i[e];s.onError&&s.onError(t)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class cl extends eY{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new tt(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){let t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}class ch extends cl{constructor(e,t,i){super(e,i),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(eY.DEFAULT_UP),this.updateMatrix(),this.groundColor=new tt(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}}let cu=new eS,cd=new $,cc=new $;class cp{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new S(512,512),this.map=null,this.mapPass=null,this.matrix=new eS,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new im,this._frameExtents=new S(1,1),this._viewportCount=1,this._viewports=[new k(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){let t=this.camera,i=this.matrix;cd.setFromMatrixPosition(e.matrixWorld),t.position.copy(cd),cc.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(cc),t.updateMatrixWorld(),cu.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(cu),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(cu)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){let e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),(512!==this.mapSize.x||512!==this.mapSize.y)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class cm extends cp{constructor(){super(new tQ(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){let t=this.camera,i=2*g*e.angle*this.focus,s=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;(i!==t.fov||s!==t.aspect||r!==t.far)&&(t.fov=i,t.aspect=s,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class cg extends cl{constructor(e,t,i=0,s=Math.PI/3,r=0,n=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(eY.DEFAULT_UP),this.updateMatrix(),this.target=new eY,this.distance=i,this.angle=s,this.penumbra=r,this.decay=n,this.map=null,this.shadow=new cm}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}let cf=new eS,cy=new $,cx=new $;class cb extends cp{constructor(){super(new tQ(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new S(4,2),this._viewportCount=6,this._viewports=[new k(2,1,1,1),new k(0,1,1,1),new k(3,1,1,1),new k(1,1,1,1),new k(3,0,1,1),new k(1,0,1,1)],this._cubeDirections=[new $(1,0,0),new $(-1,0,0),new $(0,0,1),new $(0,0,-1),new $(0,1,0),new $(0,-1,0)],this._cubeUps=[new $(0,1,0),new $(0,1,0),new $(0,1,0),new $(0,1,0),new $(0,0,1),new $(0,0,-1)]}updateMatrices(e,t=0){let i=this.camera,s=this.matrix,r=e.distance||i.far;r!==i.far&&(i.far=r,i.updateProjectionMatrix()),cy.setFromMatrixPosition(e.matrixWorld),i.position.copy(cy),cx.copy(i.position),cx.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(cx),i.updateMatrixWorld(),s.makeTranslation(-cy.x,-cy.y,-cy.z),cf.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(cf)}}class cv extends cl{constructor(e,t,i=0,s=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=s,this.shadow=new cb}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class cT extends tX{constructor(e=-1,t=1,i=1,s=-1,r=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=s,this.near=r,this.far=n,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,s,r,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2,r=i-e,n=i+e,a=s+t,o=s-t;if(null!==this.view&&this.view.enabled){let e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,n=r+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(r,n,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class cS extends cp{constructor(){super(new cT(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class c_ extends cl{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(eY.DEFAULT_UP),this.updateMatrix(),this.target=new eY,this.shadow=new cS}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class cM extends cl{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class cw extends cl{constructor(e,t,i=10,s=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=i,this.height=s}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){let t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class cN{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new $)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){let i=e.x,s=e.y,r=e.z,n=this.coefficients;return t.copy(n[0]).multiplyScalar(.282095),t.addScaledVector(n[1],.488603*s),t.addScaledVector(n[2],.488603*r),t.addScaledVector(n[3],.488603*i),t.addScaledVector(n[4],i*s*1.092548),t.addScaledVector(n[5],s*r*1.092548),t.addScaledVector(n[6],.315392*(3*r*r-1)),t.addScaledVector(n[7],i*r*1.092548),t.addScaledVector(n[8],.546274*(i*i-s*s)),t}getIrradianceAt(e,t){let i=e.x,s=e.y,r=e.z,n=this.coefficients;return t.copy(n[0]).multiplyScalar(.886227),t.addScaledVector(n[1],1.023328*s),t.addScaledVector(n[2],1.023328*r),t.addScaledVector(n[3],1.023328*i),t.addScaledVector(n[4],.858086*i*s),t.addScaledVector(n[5],.858086*s*r),t.addScaledVector(n[6],.743125*r*r-.247708),t.addScaledVector(n[7],.858086*i*r),t.addScaledVector(n[8],.429043*(i*i-s*s)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(e.coefficients[i],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let i=0;i<9;i++)this.coefficients[i].lerp(e.coefficients[i],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(e,t=0){let i=this.coefficients;for(let s=0;s<9;s++)i[s].fromArray(e,t+3*s);return this}toArray(e=[],t=0){let i=this.coefficients;for(let s=0;s<9;s++)i[s].toArray(e,t+3*s);return e}static getBasisAt(e,t){let i=e.x,s=e.y,r=e.z;t[0]=.282095,t[1]=.488603*s,t[2]=.488603*r,t[3]=.488603*i,t[4]=1.092548*i*s,t[5]=1.092548*s*r,t[6]=.315392*(3*r*r-1),t[7]=1.092548*i*r,t[8]=.546274*(i*i-s*s)}}class cA extends cl{constructor(e=new cN,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){let t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}class cR extends cr{constructor(e){super(e),this.textures={}}load(e,t,i,s){let r=this,n=new co(r.manager);n.setPath(r.path),n.setRequestHeader(r.requestHeader),n.setWithCredentials(r.withCredentials),n.load(e,function(i){try{t(r.parse(JSON.parse(i)))}catch(t){s?s(t):console.error(t),r.manager.itemError(e)}},i,s)}parse(e){let t=this.textures;function i(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}let s=cR.createMaterialFromType(e.type);if(void 0!==e.uuid&&(s.uuid=e.uuid),void 0!==e.name&&(s.name=e.name),void 0!==e.color&&void 0!==s.color&&s.color.setHex(e.color),void 0!==e.roughness&&(s.roughness=e.roughness),void 0!==e.metalness&&(s.metalness=e.metalness),void 0!==e.sheen&&(s.sheen=e.sheen),void 0!==e.sheenColor&&(s.sheenColor=new tt().setHex(e.sheenColor)),void 0!==e.sheenRoughness&&(s.sheenRoughness=e.sheenRoughness),void 0!==e.emissive&&void 0!==s.emissive&&s.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==s.specular&&s.specular.setHex(e.specular),void 0!==e.specularIntensity&&(s.specularIntensity=e.specularIntensity),void 0!==e.specularColor&&void 0!==s.specularColor&&s.specularColor.setHex(e.specularColor),void 0!==e.shininess&&(s.shininess=e.shininess),void 0!==e.clearcoat&&(s.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(s.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.dispersion&&(s.dispersion=e.dispersion),void 0!==e.iridescence&&(s.iridescence=e.iridescence),void 0!==e.iridescenceIOR&&(s.iridescenceIOR=e.iridescenceIOR),void 0!==e.iridescenceThicknessRange&&(s.iridescenceThicknessRange=e.iridescenceThicknessRange),void 0!==e.transmission&&(s.transmission=e.transmission),void 0!==e.thickness&&(s.thickness=e.thickness),void 0!==e.attenuationDistance&&(s.attenuationDistance=e.attenuationDistance),void 0!==e.attenuationColor&&void 0!==s.attenuationColor&&s.attenuationColor.setHex(e.attenuationColor),void 0!==e.anisotropy&&(s.anisotropy=e.anisotropy),void 0!==e.anisotropyRotation&&(s.anisotropyRotation=e.anisotropyRotation),void 0!==e.fog&&(s.fog=e.fog),void 0!==e.flatShading&&(s.flatShading=e.flatShading),void 0!==e.blending&&(s.blending=e.blending),void 0!==e.combine&&(s.combine=e.combine),void 0!==e.side&&(s.side=e.side),void 0!==e.shadowSide&&(s.shadowSide=e.shadowSide),void 0!==e.opacity&&(s.opacity=e.opacity),void 0!==e.transparent&&(s.transparent=e.transparent),void 0!==e.alphaTest&&(s.alphaTest=e.alphaTest),void 0!==e.alphaHash&&(s.alphaHash=e.alphaHash),void 0!==e.depthFunc&&(s.depthFunc=e.depthFunc),void 0!==e.depthTest&&(s.depthTest=e.depthTest),void 0!==e.depthWrite&&(s.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(s.colorWrite=e.colorWrite),void 0!==e.blendSrc&&(s.blendSrc=e.blendSrc),void 0!==e.blendDst&&(s.blendDst=e.blendDst),void 0!==e.blendEquation&&(s.blendEquation=e.blendEquation),void 0!==e.blendSrcAlpha&&(s.blendSrcAlpha=e.blendSrcAlpha),void 0!==e.blendDstAlpha&&(s.blendDstAlpha=e.blendDstAlpha),void 0!==e.blendEquationAlpha&&(s.blendEquationAlpha=e.blendEquationAlpha),void 0!==e.blendColor&&void 0!==s.blendColor&&s.blendColor.setHex(e.blendColor),void 0!==e.blendAlpha&&(s.blendAlpha=e.blendAlpha),void 0!==e.stencilWriteMask&&(s.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(s.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(s.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(s.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(s.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(s.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(s.stencilZPass=e.stencilZPass),void 0!==e.stencilWrite&&(s.stencilWrite=e.stencilWrite),void 0!==e.wireframe&&(s.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(s.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(s.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(s.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(s.rotation=e.rotation),void 0!==e.linewidth&&(s.linewidth=e.linewidth),void 0!==e.dashSize&&(s.dashSize=e.dashSize),void 0!==e.gapSize&&(s.gapSize=e.gapSize),void 0!==e.scale&&(s.scale=e.scale),void 0!==e.polygonOffset&&(s.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(s.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(s.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.dithering&&(s.dithering=e.dithering),void 0!==e.alphaToCoverage&&(s.alphaToCoverage=e.alphaToCoverage),void 0!==e.premultipliedAlpha&&(s.premultipliedAlpha=e.premultipliedAlpha),void 0!==e.forceSinglePass&&(s.forceSinglePass=e.forceSinglePass),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.toneMapped&&(s.toneMapped=e.toneMapped),void 0!==e.userData&&(s.userData=e.userData),void 0!==e.vertexColors&&("number"==typeof e.vertexColors?s.vertexColors=e.vertexColors>0:s.vertexColors=e.vertexColors),void 0!==e.uniforms)for(let t in e.uniforms){let r=e.uniforms[t];switch(s.uniforms[t]={},r.type){case"t":s.uniforms[t].value=i(r.value);break;case"c":s.uniforms[t].value=new tt().setHex(r.value);break;case"v2":s.uniforms[t].value=new S().fromArray(r.value);break;case"v3":s.uniforms[t].value=new $().fromArray(r.value);break;case"v4":s.uniforms[t].value=new k().fromArray(r.value);break;case"m3":s.uniforms[t].value=new _().fromArray(r.value);break;case"m4":s.uniforms[t].value=new eS().fromArray(r.value);break;default:s.uniforms[t].value=r.value}}if(void 0!==e.defines&&(s.defines=e.defines),void 0!==e.vertexShader&&(s.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(s.fragmentShader=e.fragmentShader),void 0!==e.glslVersion&&(s.glslVersion=e.glslVersion),void 0!==e.extensions)for(let t in e.extensions)s.extensions[t]=e.extensions[t];if(void 0!==e.lights&&(s.lights=e.lights),void 0!==e.clipping&&(s.clipping=e.clipping),void 0!==e.size&&(s.size=e.size),void 0!==e.sizeAttenuation&&(s.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(s.map=i(e.map)),void 0!==e.matcap&&(s.matcap=i(e.matcap)),void 0!==e.alphaMap&&(s.alphaMap=i(e.alphaMap)),void 0!==e.bumpMap&&(s.bumpMap=i(e.bumpMap)),void 0!==e.bumpScale&&(s.bumpScale=e.bumpScale),void 0!==e.normalMap&&(s.normalMap=i(e.normalMap)),void 0!==e.normalMapType&&(s.normalMapType=e.normalMapType),void 0!==e.normalScale){let t=e.normalScale;!1===Array.isArray(t)&&(t=[t,t]),s.normalScale=new S().fromArray(t)}return void 0!==e.displacementMap&&(s.displacementMap=i(e.displacementMap)),void 0!==e.displacementScale&&(s.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(s.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(s.roughnessMap=i(e.roughnessMap)),void 0!==e.metalnessMap&&(s.metalnessMap=i(e.metalnessMap)),void 0!==e.emissiveMap&&(s.emissiveMap=i(e.emissiveMap)),void 0!==e.emissiveIntensity&&(s.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(s.specularMap=i(e.specularMap)),void 0!==e.specularIntensityMap&&(s.specularIntensityMap=i(e.specularIntensityMap)),void 0!==e.specularColorMap&&(s.specularColorMap=i(e.specularColorMap)),void 0!==e.envMap&&(s.envMap=i(e.envMap)),void 0!==e.envMapRotation&&s.envMapRotation.fromArray(e.envMapRotation),void 0!==e.envMapIntensity&&(s.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(s.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(s.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(s.lightMap=i(e.lightMap)),void 0!==e.lightMapIntensity&&(s.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(s.aoMap=i(e.aoMap)),void 0!==e.aoMapIntensity&&(s.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(s.gradientMap=i(e.gradientMap)),void 0!==e.clearcoatMap&&(s.clearcoatMap=i(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(s.clearcoatRoughnessMap=i(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(s.clearcoatNormalMap=i(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(s.clearcoatNormalScale=new S().fromArray(e.clearcoatNormalScale)),void 0!==e.iridescenceMap&&(s.iridescenceMap=i(e.iridescenceMap)),void 0!==e.iridescenceThicknessMap&&(s.iridescenceThicknessMap=i(e.iridescenceThicknessMap)),void 0!==e.transmissionMap&&(s.transmissionMap=i(e.transmissionMap)),void 0!==e.thicknessMap&&(s.thicknessMap=i(e.thicknessMap)),void 0!==e.anisotropyMap&&(s.anisotropyMap=i(e.anisotropyMap)),void 0!==e.sheenColorMap&&(s.sheenColorMap=i(e.sheenColorMap)),void 0!==e.sheenRoughnessMap&&(s.sheenRoughnessMap=i(e.sheenRoughnessMap)),s}setTextures(e){return this.textures=e,this}static createMaterialFromType(e){return new({ShadowMaterial:sy,SpriteMaterial:t6,RawShaderMaterial:sx,ShaderMaterial:tq,PointsMaterial:iy,MeshPhysicalMaterial:sv,MeshStandardMaterial:sb,MeshPhongMaterial:sT,MeshToonMaterial:sS,MeshNormalMaterial:s_,MeshLambertMaterial:sM,MeshDepthMaterial:sw,MeshDistanceMaterial:sN,MeshBasicMaterial:tn,MeshMatcapMaterial:sA,LineDashedMaterial:sR,LineBasicMaterial:ig,Material:tr})[e]}}let cC=new eS,cE=new eS,cB=new eS;class cI{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new tQ,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new tQ,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){let t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){let i,s;t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep,cB.copy(e.projectionMatrix);let r=t.eyeSep/2,n=r*t.near/t.focus,a=t.near*Math.tan(m*t.fov*.5)/t.zoom;cE.elements[12]=-r,cC.elements[12]=r,i=-a*t.aspect+n,s=a*t.aspect+n,cB.elements[0]=2*t.near/(s-i),cB.elements[8]=(s+i)/(s-i),this.cameraL.projectionMatrix.copy(cB),i=-a*t.aspect-n,s=a*t.aspect-n,cB.elements[0]=2*t.near/(s-i),cB.elements[8]=(s+i)/(s-i),this.cameraR.projectionMatrix.copy(cB)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(cE),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(cC)}}let cP="\\[\\]\\.:\\/",cF=RegExp("["+cP+"]","g"),cU="[^"+cP+"]",cO="[^"+cP.replace("\\.","")+"]",cz=/((?:WC+[\/:])*)/.source.replace("WC",cU),cL=RegExp("^"+cz+/(WCOD+)?/.source.replace("WCOD",cO)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",cU)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",cU)+"$"),cD=["material","materials","bones","map"];class cV{constructor(e,t,i){let s=i||ck.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,s)}getValue(e,t){this.bind();let i=this._targetGroup.nCachedObjects_,s=this._bindings[i];void 0!==s&&s.getValue(e,t)}setValue(e,t){let i=this._bindings;for(let s=this._targetGroup.nCachedObjects_,r=i.length;s!==r;++s)i[s].setValue(e,t)}bind(){let e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){let e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}class ck{constructor(e,t,i){this.path=t,this.parsedPath=i||ck.parseTrackName(t),this.node=ck.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new ck.Composite(e,t,i):new ck(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(cF,"")}static parseTrackName(e){let t=cL.exec(e);if(null===t)throw Error("PropertyBinding: Cannot parse trackName: "+e);let i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},s=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==s&&-1!==s){let e=i.nodeName.substring(s+1);-1!==cD.indexOf(e)&&(i.nodeName=i.nodeName.substring(0,s),i.objectName=e)}if(null===i.propertyName||0===i.propertyName.length)throw Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){let i=e.skeleton.getBoneByName(t);if(void 0!==i)return i}if(e.children){let i=function(e){for(let s=0;s<e.length;s++){let r=e[s];if(r.name===t||r.uuid===t)return r;let n=i(r.children);if(n)return n}return null},s=i(e.children);if(s)return s}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){let i=this.resolvedProperty;for(let s=0,r=i.length;s!==r;++s)e[t++]=i[s]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){let i=this.resolvedProperty;for(let s=0,r=i.length;s!==r;++s)i[s]=e[t++]}_setValue_array_setNeedsUpdate(e,t){let i=this.resolvedProperty;for(let s=0,r=i.length;s!==r;++s)i[s]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){let i=this.resolvedProperty;for(let s=0,r=i.length;s!==r;++s)i[s]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node,t=this.parsedPath,i=t.objectName,s=t.propertyName,r=t.propertyIndex;if(e||(e=ck.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e){console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");return}if(i){let s=t.objectIndex;switch(i){case"materials":if(!e.material){console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.materials){console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);return}e=e.material.materials;break;case"bones":if(!e.skeleton){console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);return}e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===s){s=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material){console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.map){console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);return}e=e.material.map;break;default:if(void 0===e[i]){console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);return}e=e[i]}if(void 0!==s){if(void 0===e[s]){console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);return}e=e[s]}}let n=e[s];if(void 0===n){console.error("THREE.PropertyBinding: Trying to update property for track: "+t.nodeName+"."+s+" but it wasn't found.",e);return}let a=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===s){if(!e.geometry){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);return}if(!e.geometry.morphAttributes){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);return}void 0!==e.morphTargetDictionary[r]&&(r=e.morphTargetDictionary[r])}o=this.BindingType.ArrayElement,this.resolvedProperty=n,this.propertyIndex=r}else void 0!==n.fromArray&&void 0!==n.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=n):Array.isArray(n)?(o=this.BindingType.EntireArray,this.resolvedProperty=n):this.propertyName=s;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}ck.Composite=cV,ck.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},ck.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},ck.prototype.GetterByBindingType=[ck.prototype._getValue_direct,ck.prototype._getValue_array,ck.prototype._getValue_arrayElement,ck.prototype._getValue_toArray],ck.prototype.SetterByBindingTypeAndVersioning=[[ck.prototype._setValue_direct,ck.prototype._setValue_direct_setNeedsUpdate,ck.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[ck.prototype._setValue_array,ck.prototype._setValue_array_setNeedsUpdate,ck.prototype._setValue_array_setMatrixWorldNeedsUpdate],[ck.prototype._setValue_arrayElement,ck.prototype._setValue_arrayElement_setNeedsUpdate,ck.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[ck.prototype._setValue_fromArray,ck.prototype._setValue_fromArray_setNeedsUpdate,ck.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1);class cG{constructor(e,t){this.nodes=e,this.info=t,this.animationLoop=null,this.requestId=null,this._init()}_init(){let e=(t,i)=>{this.requestId=self.requestAnimationFrame(e),!0===this.info.autoReset&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this.animationLoop&&this.animationLoop(t,i)};e()}dispose(){self.cancelAnimationFrame(this.requestId),this.requestId=null}setAnimationLoop(e){this.animationLoop=e}}class cW{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let i=0;i<e.length;i++)if(void 0===(t=t.get(e[i])))return;return t.get(e[e.length-1])}set(e,t){let i=this.weakMap;for(let t=0;t<e.length;t++){let s=e[t];!1===i.has(s)&&i.set(s,new WeakMap),i=i.get(s)}return i.set(e[e.length-1],t)}delete(e){let t=this.weakMap;for(let i=0;i<e.length;i++)if(void 0===(t=t.get(e[i])))return!1;return t.delete(e[e.length-1])}}let cH=new id;class cj{constructor(){this.version=0,this.globalClippingCount=0,this.localClippingCount=0,this.localClippingEnabled=!1,this.localClipIntersection=!1,this.planes=[],this.parentVersion=0,this.viewNormalMatrix=new _,this.cacheKey=""}projectPlanes(e,t){let i=e.length,s=this.planes;for(let r=0;r<i;r++){cH.copy(e[r]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);let i=s[t+r],n=cH.normal;i.x=-n.x,i.y=-n.y,i.z=-n.z,i.w=cH.constant}}updateGlobal(e,t){let i=e.clippingPlanes;this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix);let s=!1;if(Array.isArray(i)&&0!==i.length){let e=i.length;if(e!==this.globalClippingCount){let t=[];for(let i=0;i<e;i++)t.push(new k);this.globalClippingCount=e,this.planes=t,s=!0}this.projectPlanes(i,0)}else 0!==this.globalClippingCount&&(this.globalClippingCount=0,this.planes=[],s=!0);e.localClippingEnabled!==this.localClippingEnabled&&(this.localClippingEnabled=e.localClippingEnabled,s=!0),s&&(this.version++,this.cacheKey=`${this.globalClippingCount}:${void 0!==this.localClippingEnabled&&this.localClippingEnabled}:`)}update(e,t){let i=!1;if(this!==e&&e.version!==this.parentVersion&&(this.globalClippingCount=t.isShadowNodeMaterial?0:e.globalClippingCount,this.localClippingEnabled=e.localClippingEnabled,this.planes=Array.from(e.planes),this.parentVersion=e.version,this.viewMatrix=e.viewMatrix,this.viewNormalMatrix=e.viewNormalMatrix,i=!0),this.localClippingEnabled){let e=t.clippingPlanes;if(Array.isArray(e)&&0!==e.length){let t=e.length,s=this.planes,r=this.globalClippingCount;if(i||t!==this.localClippingCount){s.length=r+t;for(let e=0;e<t;e++)s[r+e]=new k;this.localClippingCount=t,i=!0}this.projectPlanes(e,r)}else 0!==this.localClippingCount&&(this.localClippingCount=0,i=!0);this.localClipIntersection!==t.clipIntersection&&(this.localClipIntersection=t.clipIntersection,i=!0)}i&&(this.version+=e.version,this.cacheKey=e.cacheKey+`:${this.localClippingCount}:${void 0!==this.localClipIntersection&&this.localClipIntersection}`)}}let c$=0;class cq{constructor(e,t,i,s,r,n,a,o,l){this._nodes=e,this._geometries=t,this.id=c$++,this.renderer=i,this.object=s,this.material=r,this.scene=n,this.camera=a,this.lightsNode=o,this.context=l,this.geometry=s.geometry,this.version=r.version,this.drawRange=null,this.attributes=null,this.pipeline=null,this.vertexBuffers=null,this.updateClipping(l.clippingContext),this.clippingContextVersion=this.clippingContext.version,this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.material.addEventListener("dispose",this.onMaterialDispose)}updateClipping(e){let t=this.material,i=this.clippingContext;Array.isArray(t.clippingPlanes)?(i!==e&&i||(i=new cj,this.clippingContext=i),i.update(e,t)):this.clippingContext!==e&&(this.clippingContext=e)}get clippingNeedsUpdate(){return this.clippingContext.version!==this.clippingContextVersion&&(this.clippingContextVersion=this.clippingContext.version,!0)}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getIndex(){return this._geometries.getIndex(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}getAttributes(){if(null!==this.attributes)return this.attributes;let e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,i=[],s=new Set;for(let r of e){let e=r.node&&r.node.attribute?r.node.attribute:t.getAttribute(r.name);if(void 0===e)continue;i.push(e);let n=e.isInterleavedBufferAttribute?e.data:e;s.add(n)}return this.attributes=i,this.vertexBuffers=Array.from(s.values()),i}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getMaterialCacheKey(){let{object:e,material:t}=this,i=t.customProgramCacheKey();for(let e of function(e){let t=Object.keys(e),i=Object.getPrototypeOf(e);for(;i;){let e=Object.getOwnPropertyDescriptors(i);for(let i in e)if(void 0!==e[i]){let s=e[i];s&&"function"==typeof s.get&&t.push(i)}i=Object.getPrototypeOf(i)}return t}(t)){let s;if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;let r=t[e];if(null!==r){let e=typeof r;"number"===e?s=0!==r?"1":"0":"object"===e?(s="{",r.isTexture&&(s+=r.mapping),s+="}"):s=String(r)}else s=String(r);i+=s+","}return i+=this.clippingContext.cacheKey+",",e.skeleton&&(i+=e.skeleton.bones.length+","),e.morphTargetInfluences&&(i+=e.morphTargetInfluences.length+","),e.isBatchedMesh&&(i+=e._matricesTexture.uuid+",",null!==e._colorsTexture&&(i+=e._colorsTexture.uuid+",")),e.count>1&&(i+=e.count+","+e.uuid+","),i}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){return this.object.receiveShadow+","+this._nodes.getCacheKey(this.scene,this.lightsNode)}getCacheKey(){return this.getMaterialCacheKey()+","+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.onDispose()}}class cX{constructor(e,t,i,s,r,n){this.renderer=e,this.nodes=t,this.geometries=i,this.pipelines=s,this.bindings=r,this.info=n,this.chainMaps={}}get(e,t,i,s,r,n,a){let o=this.getChainMap(a),l=[e,t,n,r],h=o.get(l);return void 0===h?(h=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,i,s,r,n,a),o.set(l,h)):(h.updateClipping(n.clippingContext),(h.version!==t.version||h.needsUpdate)&&(h.initialCacheKey!==h.getCacheKey()?(h.dispose(),h=this.get(e,t,i,s,r,n,a)):h.version=t.version)),h}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new cW)}dispose(){this.chainMaps={}}createRenderObject(e,t,i,s,r,n,a,o,l,h){let u=this.getChainMap(h),d=new cq(e,t,i,s,r,n,a,o,l);return d.onDispose=()=>{this.pipelines.delete(d),this.bindings.delete(d),this.nodes.delete(d),u.delete(d.getChainArray())},d}}class cY{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}}let cJ={VERTEX:1,INDEX:2,STORAGE:4};class cK extends cY{constructor(e){super(),this.backend=e}delete(e){let t=super.delete(e);return void 0!==t&&this.backend.destroyAttribute(e),t}update(e,t){let i=this.get(e);if(void 0===i.version)t===cJ.VERTEX?this.backend.createAttribute(e):t===cJ.INDEX?this.backend.createIndexAttribute(e):t===cJ.STORAGE&&this.backend.createStorageAttribute(e),i.version=this._getBufferAttribute(e).version;else{let t=this._getBufferAttribute(e);(i.version<t.version||35048===t.usage)&&(this.backend.updateAttribute(e),i.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}function cQ(e){return null!==e.index?e.index.version:e.attributes.position.version}function cZ(e){let t=[],i=e.index,s=e.attributes.position;if(null!==i){let e=i.array;for(let i=0,s=e.length;i<s;i+=3){let s=e[i+0],r=e[i+1],n=e[i+2];t.push(s,r,r,n,n,s)}}else{let e=s.array;for(let i=0,s=e.length/3-1;i<s;i+=3){let e=i+0,s=i+1,r=i+2;t.push(e,s,s,r,r,e)}}let r=new(!function(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}(t)?tc:tp)(t,1);return r.version=cQ(e),r}class c0 extends cY{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){let t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){let t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;let i=()=>{this.info.memory.geometries--;let s=t.index,r=e.getAttributes();for(let e of(null!==s&&this.attributes.delete(s),r))this.attributes.delete(e);let n=this.wireframes.get(t);void 0!==n&&this.attributes.delete(n),t.removeEventListener("dispose",i)};t.addEventListener("dispose",i)}updateAttributes(e){for(let t of e.getAttributes())t.isStorageBufferAttribute||t.isStorageInstancedBufferAttribute?this.updateAttribute(t,cJ.STORAGE):this.updateAttribute(t,cJ.VERTEX);let t=this.getIndex(e);null!==t&&this.updateAttribute(t,cJ.INDEX)}updateAttribute(e,t){let i=this.info.render.calls;e.isInterleavedBufferAttribute?void 0===this.attributeCall.get(e)?(this.attributes.update(e,t),this.attributeCall.set(e,i)):this.attributeCall.get(e.data)!==i&&(this.attributes.update(e,t),this.attributeCall.set(e.data,i),this.attributeCall.set(e,i)):this.attributeCall.get(e)!==i&&(this.attributes.update(e,t),this.attributeCall.set(e,i))}getIndex(e){let{geometry:t,material:i}=e,s=t.index;if(!0===i.wireframe){let e=this.wireframes,i=e.get(t);void 0===i?(i=cZ(t),e.set(t,i)):i.version!==cQ(t)&&(this.attributes.delete(i),i=cZ(t),e.set(t,i)),s=i}return s}}class c1{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0,previousFrameCalls:0,timestampCalls:0},this.compute={calls:0,frameCalls:0,timestamp:0,previousFrameCalls:0,timestampCalls:0},this.memory={geometries:0,textures:0}}update(e,t,i){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=t/3*i:e.isPoints?this.render.points+=i*t:e.isLineSegments?this.render.lines+=t/2*i:e.isLine?this.render.lines+=i*(t-1):console.error("THREE.WebGPUInfo: Unknown object type.")}updateTimestamp(e,t){0===this[e].timestampCalls&&(this[e].timestamp=0),this[e].timestamp+=t,this[e].timestampCalls++,this[e].timestampCalls>=this[e].previousFrameCalls&&(this[e].timestampCalls=0)}reset(){let e=this.render.frameCalls;this.render.previousFrameCalls=e;let t=this.compute.frameCalls;this.compute.previousFrameCalls=t,this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}}class c2{constructor(e){this.cacheKey=e,this.usedTimes=0}}class c3 extends c2{constructor(e,t,i){super(e),this.vertexProgram=t,this.fragmentProgram=i}}class c4 extends c2{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let c5=0;class c6{constructor(e,t,i=null,s=null){this.id=c5++,this.code=e,this.stage=t,this.transforms=i,this.attributes=s,this.usedTimes=0}}class c8 extends cY{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){let{backend:i}=this,s=this.get(e);if(this._needsComputeUpdate(e)){let r=s.pipeline;r&&(r.usedTimes--,r.computeProgram.usedTimes--);let n=this.nodes.getForCompute(e),a=this.programs.compute.get(n.computeShader);void 0===a&&(r&&0===r.computeProgram.usedTimes&&this._releaseProgram(r.computeProgram),a=new c6(n.computeShader,"compute",n.transforms,n.nodeAttributes),this.programs.compute.set(n.computeShader,a),i.createProgram(a));let o=this._getComputeCacheKey(e,a),l=this.caches.get(o);void 0===l&&(r&&0===r.usedTimes&&this._releasePipeline(r),l=this._getComputePipeline(e,a,o,t)),l.usedTimes++,a.usedTimes++,s.version=e.version,s.pipeline=l}return s.pipeline}getForRender(e,t=null){let{backend:i}=this,s=this.get(e);if(this._needsRenderUpdate(e)){let r=s.pipeline;r&&(r.usedTimes--,r.vertexProgram.usedTimes--,r.fragmentProgram.usedTimes--);let n=e.getNodeBuilderState(),a=this.programs.vertex.get(n.vertexShader);void 0===a&&(r&&0===r.vertexProgram.usedTimes&&this._releaseProgram(r.vertexProgram),a=new c6(n.vertexShader,"vertex"),this.programs.vertex.set(n.vertexShader,a),i.createProgram(a));let o=this.programs.fragment.get(n.fragmentShader);void 0===o&&(r&&0===r.fragmentProgram.usedTimes&&this._releaseProgram(r.fragmentProgram),o=new c6(n.fragmentShader,"fragment"),this.programs.fragment.set(n.fragmentShader,o),i.createProgram(o));let l=this._getRenderCacheKey(e,a,o),h=this.caches.get(l);void 0===h?(r&&0===r.usedTimes&&this._releasePipeline(r),h=this._getRenderPipeline(e,a,o,l,t)):e.pipeline=h,h.usedTimes++,a.usedTimes++,o.usedTimes++,s.pipeline=h}return s.pipeline}delete(e){let t=this.get(e).pipeline;return t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,i,s){i=i||this._getComputeCacheKey(e,t);let r=this.caches.get(i);return void 0===r&&(r=new c4(i,t),this.caches.set(i,r),this.backend.createComputePipeline(r,s)),r}_getRenderPipeline(e,t,i,s,r){s=s||this._getRenderCacheKey(e,t,i);let n=this.caches.get(s);return void 0===n&&(n=new c3(s,t,i),this.caches.set(s,n),e.pipeline=n,this.backend.createRenderPipeline(e,r)),n}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,i){return t.id+","+i.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){let t=e.code,i=e.stage;this.programs[i].delete(t)}_needsComputeUpdate(e){let t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}}class c7 extends cY{constructor(e,t,i,s,r,n){super(),this.backend=e,this.textures=i,this.pipelines=r,this.attributes=s,this.nodes=t,this.info=n,this.pipelines.bindings=this}getForRender(e){let t=e.getBindings();for(let e of t){let i=this.get(e);void 0===i.bindGroup&&(this._init(e),this.backend.createBindings(e,t),i.bindGroup=e)}return t}getForCompute(e){let t=this.nodes.getForCompute(e).bindings;for(let e of t){let i=this.get(e);void 0===i.bindGroup&&(this._init(e),this.backend.createBindings(e,t),i.bindGroup=e)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(let t of e)this._update(t,e)}_init(e){for(let t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){let e=t.attribute;this.attributes.update(e,cJ.STORAGE)}}_update(e,t){let{backend:i}=this,s=!1;for(let t of e.bindings)if(!t.isNodeUniformsGroup||this.nodes.updateGroup(t)){if(t.isUniformBuffer)t.update()&&i.updateBinding(t);else if(t.isSampler)t.update();else if(t.isSampledTexture){t.needsBindingsUpdate(this.textures.get(t.texture).generation)&&(s=!0);let e=t.update(),r=t.texture;e&&this.textures.updateTexture(r);let n=i.get(r);if(!0===i.isWebGPUBackend&&void 0===n.texture&&void 0===n.externalTexture&&(console.error("Bindings._update: binding should be available:",t,e,r,t.textureNode.value,s),this.textures.updateTexture(r),s=!0),!0===r.isStorageTexture){let e=this.get(r);!0===t.store?e.needsMipmap=!0:!0===r.generateMipmaps&&this.textures.needsMipmaps(r)&&!0===e.needsMipmap&&(this.backend.generateMipmaps(r),e.needsMipmap=!1)}}}!0===s&&this.backend.updateBindings(e,t)}}class c9{constructor(e,t,i=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=i}}class pe{constructor(e,t,i){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=i.getSelf()}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class pt{constructor(e,t){this.isNodeVar=!0,this.name=e,this.type=t}}class pi extends pt{constructor(e,t){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0}}class ps{constructor(e,t,i=""){this.name=e,this.type=t,this.code=i,Object.defineProperty(this,"isNodeCode",{value:!0})}}let pr=0;class pn{constructor(e=null){this.id=pr++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return void 0===t&&null!==this.parent&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}}class pa extends rZ{constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}pa.type=sW("Parameter",pa);class po extends sG{constructor(e="",t=[],i=""){super("code"),this.isCodeNode=!0,this.code=e,this.language=i,this.includes=t}isGlobal(){return!0}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){for(let t of this.getIncludes(e))t.build(e);let t=e.getCodeFromNode(this,this.getNodeType(e));return t.code=this.code,t.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}po.type=sW("Code",po);class pl extends po{constructor(e="",t=[],i=""){super(e,t,i)}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){let t=e.getDataFromNode(this),i=t.nodeFunction;return void 0===i&&(i=e.parser.parseFunction(this.code),t.nodeFunction=i),i}generate(e,t){super.generate(e);let i=this.getNodeFunction(e),s=i.name,r=i.type,n=e.getCodeFromNode(this,r);""!==s&&(n.name=s);let a=e.getPropertyName(n),o=this.getNodeFunction(e).getCode(a);return(n.code=o+"\n","property"===t)?a:e.format(`${a}()`,r,t)}}pl.type=sW("Function",pl);class ph{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class pu extends ph{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}}class pd extends ph{constructor(e,t=new S){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class pc extends ph{constructor(e,t=new $){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class pp extends ph{constructor(e,t=new k){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class pm extends ph{constructor(e,t=new tt){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class pg extends ph{constructor(e,t=new _){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class pf extends ph{constructor(e,t=new eS){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class py extends pu{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class px extends pd{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class pb extends pc{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class pv extends pp{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class pT extends pm{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class pS extends pg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class p_ extends pf{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class pM extends sG{constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}add(e){return this.nodes.push(e),this}If(e,t){let i=new rf(t);return this._currentCond=az(e,i),this.add(this._currentCond)}ElseIf(e,t){let i=az(e,new rf(t));return this._currentCond.elseNode=i,this._currentCond=i,this}Else(e){return this._currentCond.elseNode=new rf(e),this}build(e,...t){let i=rM();for(let t of(r_(this),this.nodes))t.build(e,"void");return r_(i),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}else(...e){return console.warn("TSL.StackNode: .else() has been renamed to .Else()."),this.Else(...e)}elseif(...e){return console.warn("TSL.StackNode: .elseif() has been renamed to .ElseIf()."),this.ElseIf(...e)}}pM.type=sW("Stack",pM);let pw=rv(pM),pN=[.125,.215,.35,.446,.526,.582],pA=new cT(-1,1,1,-1,0,1),pR=new tQ(90,1),pC=new tt,pE=null,pB=0,pI=0,pP=(1+Math.sqrt(5))/2,pF=1/pP,pU=[new $(-pP,pF,0),new $(pP,pF,0),new $(-pF,0,pP),new $(pF,0,pP),new $(0,pP,-pF),new $(0,pP,pF),new $(-1,1,-1),new $(1,1,-1),new $(-1,1,1),new $(1,1,1)],pO=[3,1,5,0,4,2],pz=dc(oo(),oa("faceIndex")).normalize(),pL=rU(pz.x,pz.y.negate(),pz.z);class pD{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}fromScene(e,t=0,i=.1,s=100){pE=this._renderer.getRenderTarget(),pB=this._renderer.getActiveCubeFace(),pI=this._renderer.getActiveMipmapLevel(),this._setSize(256);let r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(e,i,s,r),t>0&&this._blur(r,0,0,t),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=pW(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=pH(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(pE,pB,pI),e.scissorTest=!1,pk(e,0,0,e.width,e.height)}_fromTexture(e,t){301===e.mapping||302===e.mapping?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),pE=this._renderer.getRenderTarget(),pB=this._renderer.getActiveCubeFace(),pI=this._renderer.getActiveMipmapLevel();let i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){let e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:1006,minFilter:1006,generateMipmaps:!1,type:1016,format:1023,colorSpace:o},s=pV(e,t,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=pV(e,t,i);let{_lodMax:s}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(e){let t=[],i=[],s=[],r=[],n=e,a=e-4+1+pN.length;for(let o=0;o<a;o++){let a=Math.pow(2,n);i.push(a);let l=1/a;o>e-4?l=pN[o-e+4-1]:0===o&&(l=0),s.push(l);let h=1/(a-2),u=-h,d=1+h,c=[u,u,d,u,d,d,u,u,d,d,u,d],p=new Float32Array(108),m=new Float32Array(72),g=new Float32Array(36);for(let e=0;e<6;e++){let t=e%3*2/3-1,i=e>2?0:-1,s=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0],r=pO[e];p.set(s,18*r),m.set(c,12*r);let n=[r,r,r,r,r,r];g.set(n,6*r)}let f=new t_;f.setAttribute("position",new td(p,3)),f.setAttribute("uv",new td(m,2)),f.setAttribute("faceIndex",new td(g,1)),t.push(f),r.push(new tk(f,null)),n>4&&n--}return{lodPlanes:t,sizeLods:i,sigmas:s,lodMeshes:r}}(s)),this._blurMaterial=function(e,t,i){let s=o5(Array(20).fill(0)),r=rQ(new $(0,1,0)),n=rQ(0),a=rA(20),o=rQ(0),l=rQ(1),h=op(null),u=rQ(0),d={n:a,latitudinal:o,weights:s,poleAxis:r,outputDirection:pL,dTheta:n,samples:l,envMap:h,mipInt:u,CUBEUV_TEXEL_WIDTH:rA(1/t),CUBEUV_TEXEL_HEIGHT:rA(1/i),CUBEUV_MAX_MIP:rA(e)},c=pG("blur");return c.uniforms=d,c.fragmentNode=df({...d,latitudinal:o.equal(1)}),c}(s,e,t)}return s}_compileMaterial(e){let t=this._lodMeshes[0];t.material=e,this._renderer.compile(t,pA)}_sceneToCubeUV(e,t,i,s){pR.near=t,pR.far=i;let r=[-1,1,-1,-1,-1,-1],n=[1,1,1,-1,-1,-1],a=this._renderer,o=a.autoClear;a.getClearColor(pC),a.autoClear=!1;let l=this._backgroundBox;if(null===l){let e=new tn({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1});l=new tk(new tW,e)}let h=!1,u=e.background;u?u.isColor&&(l.material.color.copy(u),e.background=null,h=!0):(l.material.color.copy(pC),h=!0),a.setRenderTarget(s),a.clear(),h&&a.render(l,pR);for(let t=0;t<6;t++){let i=t%3;0===i?(pR.up.set(0,r[t],0),pR.lookAt(n[t],0,0)):1===i?(pR.up.set(0,0,r[t]),pR.lookAt(0,n[t],0)):(pR.up.set(0,r[t],0),pR.lookAt(0,0,n[t]));let o=this._cubeSize;pk(s,i*o,t>2?o:0,o,o),a.render(e,pR)}a.autoClear=o,e.background=u}_textureToCubeUV(e,t){let i=this._renderer,s=301===e.mapping||302===e.mapping;s?null===this._cubemapMaterial&&(this._cubemapMaterial=pW(e)):null===this._equirectMaterial&&(this._equirectMaterial=pH(e));let r=s?this._cubemapMaterial:this._equirectMaterial;r.fragmentNode.value=e;let n=this._lodMeshes[0];n.material=r;let a=this._cubeSize;pk(t,0,0,3*a,2*a),i.setRenderTarget(t),i.render(n,pA)}_applyPMREM(e){let t=this._renderer,i=t.autoClear;t.autoClear=!1;let s=this._lodPlanes.length;for(let t=1;t<s;t++){let i=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),r=pU[(s-t-1)%pU.length];this._blur(e,t-1,t,i,r)}t.autoClear=i}_blur(e,t,i,s,r){let n=this._pingPongRenderTarget;this._halfBlur(e,n,t,i,s,"latitudinal",r),this._halfBlur(n,e,i,i,s,"longitudinal",r)}_halfBlur(e,t,i,s,r,n,a){let o=this._renderer,l=this._blurMaterial;"latitudinal"!==n&&"longitudinal"!==n&&console.error("blur direction must be either latitudinal or longitudinal!");let h=this._lodMeshes[s];h.material=l;let u=l.uniforms,d=this._sizeLods[i]-1,c=isFinite(r)?Math.PI/(2*d):2*Math.PI/39,p=r/c,m=isFinite(r)?1+Math.floor(3*p):20;m>20&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${m} samples when the maximum is set to 20`);let g=[],f=0;for(let e=0;e<20;++e){let t=e/p,i=Math.exp(-t*t/2);g.push(i),0===e?f+=i:e<m&&(f+=2*i)}for(let e=0;e<g.length;e++)g[e]=g[e]/f;e.texture.frame=(e.texture.frame||0)+1,u.envMap.value=e.texture,u.samples.value=m,u.weights.array=g,u.latitudinal.value="latitudinal"===n?1:0,a&&(u.poleAxis.value=a);let{_lodMax:y}=this;u.dTheta.value=c,u.mipInt.value=y-i;let x=this._sizeLods[s],b=4*(this._cubeSize-x);pk(t,3*x*(s>y-4?s-y+4:0),b,3*x,2*x),o.setRenderTarget(t),o.render(h,pA)}}function pV(e,t,i){let s=new G(e,t,i);return s.texture.mapping=306,s.texture.name="PMREM.cubeUv",s.texture.isPMREMTexture=!0,s.scissorTest=!0,s}function pk(e,t,i,s,r){e.viewport.set(t,i,s,r),e.scissor.set(t,i,s,r)}function pG(e){let t=new hW;return t.depthTest=!1,t.depthWrite=!1,t.blending=0,t.name=`PMREM_${e}`,t}function pW(e){let t=pG("cubemap");return t.fragmentNode=o0(e,pL),t}function pH(e){let t=pG("equirect");return t.fragmentNode=op(e,h3(pL),0),t}let pj=0;class p${constructor(e="",t=[],i=0,s=[]){this.name=e,this.bindings=t,this.index=i,this.bindingsReference=s,this.id=pj++}}let pq=new WeakMap,pX=new Map([[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),pY=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),pJ=e=>(e=Number(e))+(e%1?"":".0");class pK{constructor(e,t,i){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=i,this.scene=null,this.camera=null,this.nodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.flow={code:""},this.chaining=[],this.stack=pw(),this.stacks=[],this.tab="	",this.instanceBindGroups=!0,this.currentFunctionNode=null,this.context={material:this.material},this.cache=new pn,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null,this.useComparisonMethod=!1}getBindGroupsCache(){let e=pq.get(this.renderer);return void 0===e&&(e=new cW,pq.set(this.renderer,e)),e}createRenderTarget(e,t,i){return new G(e,t,i)}createCubeRenderTarget(e,t){return new h4(e,t)}createPMREMGenerator(){return new pD(this.renderer)}includes(e){return this.nodes.includes(e)}_getBindGroup(e,t){let i;let s=this.getBindGroupsCache(),r=[],n=!0;for(let e of t)r.push(e),n=n&&!0!==e.groupNode.shared;return n?void 0===(i=s.get(r))&&(i=new p$(e,r,this.bindingsIndexes[e].group,r),s.set(r,i)):i=new p$(e,r,this.bindingsIndexes[e].group,r),i}getBindGroupArray(e,t){let i=this.bindings[t],s=i[e];return void 0===s&&(void 0===this.bindingsIndexes[e]&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),i[e]=s=[]),s}getBindings(){let e=this.bindGroups;if(null===e){let t={},i=this.bindings;for(let e of sL)for(let s in i[e]){let r=i[e][s];(t[s]||(t[s]=[])).push(...r)}for(let i in e=[],t){let s=t[i],r=this._getBindGroup(i,s);e.push(r)}this.bindGroups=e}return e}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}buildUpdateNodes(){for(let e of this.nodes){let t=e.getUpdateType(),i=e.getUpdateBeforeType(),s=e.getUpdateAfterType();t!==sO.NONE&&this.updateNodes.push(e.getSelf()),i!==sO.NONE&&this.updateBeforeNodes.push(e),s!==sO.NONE&&this.updateAfterNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return 1006===e.magFilter||1007===e.magFilter||1005===e.magFilter||1008===e.magFilter||1006===e.minFilter||1007===e.minFilter||1005===e.minFilter||1008===e.minFilter}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return this.context,this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){let i=this.getDataFromNode(e);return void 0===i.cache&&(i.cache=new pn(t?this.getCache():null)),i.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getDrawIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}increaseUsage(e){let t=this.getDataFromNode(e);return t.usageCount=void 0===t.usageCount?1:t.usageCount+1,t.usageCount}generateTexture(){console.warn("Abstract function.")}generateTextureLod(){console.warn("Abstract function.")}generateConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new tt:"vec2"===e?t=new S:"vec3"===e?t=new $:"vec4"===e&&(t=new k)),"float"===e)return pJ(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${pJ(t.r)}, ${pJ(t.g)}, ${pJ(t.b)} )`;let i=this.getTypeLength(e),s=this.getComponentType(e),r=e=>this.generateConst(s,e);if(2===i)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)} )`;if(3===i)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)} )`;if(4===i)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)}, ${r(t.w)} )`;if(i>4&&t&&(t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(r).join(", ")} )`;if(i>4)return`${this.getType(e)}()`;throw Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){let i=this.attributes;for(let t of i)if(t.name===e)return t;let s=new c9(e,t);return i.push(s),s}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"texture"===e||"cubeTexture"===e||"storageTexture"===e||"depthTexture"===e||"texture3D"===e}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){let t=e.type;if(e.isDataTexture){if(1013===t)return"int";if(1014===t)return"uint"}return"float"}getElementType(e){return"mat2"===e?"vec2":"mat3"===e?"vec3":"mat4"===e?"vec4":this.getComponentType(e)}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;let t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e||"cubeTexture"===e||"storageTexture"===e||"texture3D"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;let i=pX.get(e);return("float"===t?"":t[0])+i}getTypeFromArray(e){return pY.get(e.constructor)}getTypeFromAttribute(e){let t,i=e;e.isInterleavedBufferAttribute&&(i=e.data);let s=i.array,r=e.itemSize,n=e.normalized;return e instanceof tm||!0===n||(t=this.getTypeFromArray(s)),this.getTypeFromLength(r,t)}getTypeLength(e){let t=this.getVectorType(e),i=/vec([2-4])/.exec(t);return null!==i?Number(i[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat2/.test(e)?4:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){let t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=pw(this.stack),this.stacks.push(rM()||this.stack),r_(this.stack),this.stack}removeStack(){let e=this.stack;return this.stack=e.parent,r_(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,i=null){let s=(i=null===i?e.isGlobal(this)?this.globalCache:this.cache:i).getData(e);return void 0===s&&(s={},i.setData(e,s)),void 0===s[t]&&(s[t]={}),s[t]}getNodeProperties(e,t="any"){let i=this.getDataFromNode(e,t);return i.properties||(i.properties={outputNode:null})}getBufferAttributeFromNode(e,t){let i=this.getDataFromNode(e),s=i.bufferAttribute;return void 0===s&&(s=new c9("nodeAttribute"+this.uniforms.index++,t,e),this.bufferAttributes.push(s),i.bufferAttribute=s),s}getStructTypeFromNode(e,t=this.shaderStage){let i=this.getDataFromNode(e,t);if(void 0===i.structType){let s=this.structs.index++;e.name=`StructType${s}`,this.structs[t].push(e),i.structType=e}return e}getUniformFromNode(e,t,i=this.shaderStage,s=null){let r=this.getDataFromNode(e,i,this.globalCache),n=r.uniform;if(void 0===n){let a=this.uniforms.index++;n=new pe(s||"nodeUniform"+a,t,e),this.uniforms[i].push(n),r.uniform=n}return n}getVarFromNode(e,t=null,i=e.getNodeType(this),s=this.shaderStage){let r=this.getDataFromNode(e,s),n=r.variable;if(void 0===n){let e=this.vars[s]||(this.vars[s]=[]);null===t&&(t="nodeVar"+e.length),n=new pt(t,i),e.push(n),r.variable=n}return n}getVaryingFromNode(e,t=null,i=e.getNodeType(this)){let s=this.getDataFromNode(e,"any"),r=s.varying;if(void 0===r){let e=this.varyings,n=e.length;null===t&&(t="nodeVarying"+n),r=new pi(t,i),e.push(r),s.varying=r}return r}getCodeFromNode(e,t,i=this.shaderStage){let s=this.getDataFromNode(e),r=s.code;if(void 0===r){let e=this.codes[i]||(this.codes[i]=[]);r=new ps("nodeCode"+e.length,t),e.push(r),s.code=r}return r}addLineFlowCode(e){return""===e||(e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="	",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){let t=e.getNodeType(this),i=this.flowChildNode(e,t);return this.flowsData.set(e,i),i}buildFunctionNode(e){let t=new pl,i=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=i,t}flowShaderNode(e){let t=e.layout,i={[Symbol.iterator](){let e=0,t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(let e of t.inputs)i[e.name]=new pa(e.type,e.name);e.layout=null;let s=e.call(i),r=this.flowStagesNode(s,t.type);return e.layout=t,r}flowStagesNode(e,t=null){let i=this.flow,s=this.vars,r=this.cache,n=this.buildStage,a=this.stack,o={code:""};for(let i of(this.flow=o,this.vars={},this.cache=new pn,this.stack=pw(),sz))this.setBuildStage(i),o.result=e.build(this,t);return o.vars=this.getVars(this.shaderStage),this.flow=i,this.vars=s,this.cache=r,this.stack=a,this.setBuildStage(n),o}getFunctionOperator(){return null}flowChildNode(e,t=null){let i=this.flow,s={code:""};return this.flow=s,s.result=e.build(this,t),this.flow=i,s}flowNodeFromShaderStage(e,t,i=null,s=null){let r=this.shaderStage;this.setShaderStage(e);let n=this.flowChildNode(t,i);return null!==s&&(n.code+=`${this.tab+s} = ${n.result};
`),this.flowCode[e]=this.flowCode[e]+n.code,this.setShaderStage(r),n}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t){return`${this.getType(e)} ${t}`}getVars(e){let t="",i=this.vars[e];if(void 0!==i)for(let e of i)t+=`${this.getVar(e.type,e.name)}; `;return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){let t=this.codes[e],i="";if(void 0!==t)for(let e of t)i+=e.code+"\n";return i}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}build(){let{object:e,material:t,renderer:i}=this;if(null!==t){let e=i.nodes.library.fromMaterial(t);null===e&&(console.error(`NodeMaterial: Material "${t.type}" is not compatible.`),e=new hW),e.build(this)}else this.addFlow("compute",e);for(let e of sz)for(let t of(this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex),sL))for(let i of(this.setShaderStage(t),this.flowNodes[t]))"generate"===e?this.flowNode(i):i.build(this);return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t||"int"===t||"uint"===t)return new py(e);if("vec2"===t||"ivec2"===t||"uvec2"===t)return new px(e);if("vec3"===t||"ivec3"===t||"uvec3"===t)return new pb(e);if("vec4"===t||"ivec4"===t||"uvec4"===t)return new pv(e);if("color"===t)return new pT(e);if("mat3"===t)return new pS(e);if("mat4"===t)return new p_(e);throw Error(`Uniform "${t}" not declared.`)}createNodeMaterial(e="NodeMaterial"){throw Error(`THREE.NodeBuilder: createNodeMaterial() was deprecated. Use new ${e}() instead.`)}format(e,t,i){if(t=this.getVectorType(t),i=this.getVectorType(i),t===i||null===i||this.isReference(i))return e;let s=this.getTypeLength(t),r=this.getTypeLength(i);return 16===s&&9===r?`${this.getType(i)}(${e}[0].xyz, ${e}[1].xyz, ${e}[2].xyz)`:9===s&&4===r?`${this.getType(i)}(${e}[0].xy, ${e}[1].xy)`:s>4||r>4||0===r?e:s===r?`${this.getType(i)}( ${e} )`:s>r?this.format(`${e}.${"xyz".slice(0,r)}`,this.getTypeFromLength(r,this.getComponentType(t)),i):4===r&&s>1?`${this.getType(i)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===s?`${this.getType(i)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===s&&r>1&&t!==this.getComponentType(i)&&(e=`${this.getType(this.getComponentType(i))}( ${e} )`),`${this.getType(i)}( ${e} )`)}getSignature(){return`// Three.js r168 - Node System
`}}class pQ{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.startTime=null,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let i=e.get(t);return void 0===i&&(i={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,i)),i}updateBeforeNode(e){let t=e.getUpdateBeforeType(),i=e.updateReference(this);if(t===sO.FRAME){let{frameMap:t}=this._getMaps(this.updateBeforeMap,i);t.get(i)!==this.frameId&&!1!==e.updateBefore(this)&&t.set(i,this.frameId)}else if(t===sO.RENDER){let{renderMap:t}=this._getMaps(this.updateBeforeMap,i);t.get(i)!==this.renderId&&!1!==e.updateBefore(this)&&t.set(i,this.renderId)}else t===sO.OBJECT&&e.updateBefore(this)}updateAfterNode(e){let t=e.getUpdateAfterType(),i=e.updateReference(this);if(t===sO.FRAME){let{frameMap:t}=this._getMaps(this.updateAfterMap,i);t.get(i)!==this.frameId&&!1!==e.updateAfter(this)&&t.set(i,this.frameId)}else if(t===sO.RENDER){let{renderMap:t}=this._getMaps(this.updateAfterMap,i);t.get(i)!==this.renderId&&!1!==e.updateAfter(this)&&t.set(i,this.renderId)}else t===sO.OBJECT&&e.updateAfter(this)}updateNode(e){let t=e.getUpdateType(),i=e.updateReference(this);if(t===sO.FRAME){let{frameMap:t}=this._getMaps(this.updateMap,i);t.get(i)!==this.frameId&&!1!==e.update(this)&&t.set(i,this.frameId)}else if(t===sO.RENDER){let{renderMap:t}=this._getMaps(this.updateMap,i);t.get(i)!==this.renderId&&!1!==e.update(this)&&t.set(i,this.renderId)}else t===sO.OBJECT&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class pZ{constructor(e,t,i=null,s="",r=!1){this.type=e,this.name=t,this.count=i,this.qualifier=s,this.isConst=r}}pZ.isNodeFunctionInput=!0;class p0 extends sG{constructor(e){super(),this.types=e,this.isStructTypeNode=!0}getMemberTypes(){return this.types}}p0.type=sW("StructType",p0);class p1 extends sG{constructor(...e){super(),this.members=e,this.isOutputStructNode=!0}setup(e){super.setup(e);let t=this.members,i=[];for(let s=0;s<t.length;s++)i.push(t[s].getNodeType(e));this.nodeType=e.getStructTypeFromNode(new p0(i)).name}generate(e,t){let i=e.getOutputStructName(),s=this.members,r=""!==i?i+".":"";for(let i=0;i<s.length;i++){let n=s[i].build(e,t);e.addLineFlowCode(`${r}m${i} = ${n}`)}return i}}function p2(e,t){for(let i=0;i<e.length;i++)if(e[i].name===t)return i;return -1}p1.type=sW("OutputStruct",p1);class p3 extends p1{constructor(e){super(),this.outputNodes=e,this.isMRTNode=!0}has(e){return void 0!==this.outputNodes[e]}get(e){return this.outputNodes[e]}merge(e){return p4({...this.outputNodes,...e.outputNodes})}setup(e){let t=this.outputNodes,i=e.renderer.getRenderTarget(),s=[],r=i.textures;for(let e in t)s[p2(r,e)]=rD(t[e]);return this.members=s,super.setup(e)}}p3.type=sW("MRT",p3);let p4=rv(p3);class p5 extends sG{constructor(e=[],...t){super(),this.functionNodes=e,this.parametersNodes=t,this._candidateFnCall=null,this.global=!0}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(e){let t=this.parametersNodes,i=this._candidateFnCall;if(null===i){let s=null,r=-1;for(let i of this.functionNodes){let n=i.shaderNode.layout;if(null===n)throw Error("FunctionOverloadingNode: FunctionNode must be a layout.");let a=n.inputs;if(t.length===a.length){let n=0;for(let i=0;i<t.length;i++){let s=t[i],r=a[i];s.getNodeType(e)===r.type?n++:n=0}n>r&&(s=i,r=n)}}this._candidateFnCall=i=s(...t)}return i}}p5.type=sW("FunctionOverloading",p5);let p6=rv(p5),p8=e=>(...t)=>p6(e,...t);class p7 extends rK{constructor(e=p7.LOCAL,t=1,i=0){super(i),this.scope=e,this.scale=t,this.updateType=sO.FRAME}update(e){let t=this.scope,i=this.scale;t===p7.LOCAL?this.value+=e.deltaTime*i:t===p7.DELTA?this.value=e.deltaTime*i:t===p7.FRAME?this.value=e.frameId:this.value=e.time*i}serialize(e){super.serialize(e),e.scope=this.scope,e.scale=this.scale}deserialize(e){super.deserialize(e),this.scope=e.scope,this.scale=e.scale}}p7.LOCAL="local",p7.GLOBAL="global",p7.DELTA="delta",p7.FRAME="frame",p7.type=sW("Timer",p7);let p9=(e,t=0)=>ry(new p7(p7.LOCAL,e,t));class me extends sG{constructor(e=me.SINE,t=p9()){super(),this.method=e,this.timeNode=t}getNodeType(e){return this.timeNode.getNodeType(e)}setup(){let e=this.method,t=ry(this.timeNode),i=null;return e===me.SINE?i=t.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5):e===me.SQUARE?i=t.fract().round():e===me.TRIANGLE?i=t.add(.5).fract().mul(2).sub(1).abs():e===me.SAWTOOTH&&(i=t.fract()),i}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}me.SINE="sine",me.SQUARE="square",me.TRIANGLE="triangle",me.SAWTOOTH="sawtooth",me.type=sW("Osc",me),me.SINE,me.SQUARE,me.TRIANGLE,me.SAWTOOTH;class mt extends sG{constructor(e,t=oo(),i=rA(0)){super("vec2"),this.countNode=e,this.uvNode=t,this.frameNode=i}setup(){let{frameNode:e,uvNode:t,countNode:i}=this,{width:s,height:r}=i,n=e.mod(s.mul(r)).floor(),a=n.mod(s),o=r.sub(n.add(1).div(s).ceil()),l=i.reciprocal(),h=rB(a,o);return t.add(h).mul(l)}}mt.type=sW("SpriteSheetUV",mt);class mi extends sH{constructor(e,t){super(e,t),this.isStorageArrayElementNode=!0}set storageBufferNode(e){this.node=e}get storageBufferNode(){return this.node}setup(e){return!1!==e.isAvailable("storageBuffer")||this.node.instanceIndex||!0!==this.node.bufferObject||e.setupPBO(this.node),super.setup(e)}generate(e,t){let i;let s=e.context.assign;if(!1===e.isAvailable("storageBuffer")){let{node:t}=this;i=t.instanceIndex||!0!==this.node.bufferObject||!0===s?t.build(e):e.generatePBO(this)}else i=super.generate(e);if(!0!==s){let s=this.getNodeType(e);i=e.format(i,s,t)}return i}}mi.type=sW("StorageArrayElement",mi);let ms=rv(mi);class mr extends sG{constructor(e,t=null,i=null,s=rA(1),r=oB,n=oV){super("vec4"),this.textureXNode=e,this.textureYNode=t,this.textureZNode=i,this.scaleNode=s,this.positionNode=r,this.normalNode=n}setup(){let{textureXNode:e,textureYNode:t,textureZNode:i,scaleNode:s,positionNode:r,normalNode:n}=this,a=n.abs().normalize();a=a.div(a.dot(rU(1)));let o=r.yz.mul(s),l=r.zx.mul(s),h=r.xy.mul(s),u=e.value,d=null!==t?t.value:u,c=null!==i?i.value:u;return nS(op(u,o).mul(a.x),op(d,l).mul(a.y),op(c,h).mul(a.z))}}mr.type=sW("TriplanarTextures",mr);let mn=new id,ma=new $,mo=new $,ml=new $,mh=new eS,mu=new $(0,0,-1),md=new k,mc=new $,mp=new $,mm=new k,mg=new S,mf=new G,my=hN.flipX(),mx=!1;class mb extends oc{constructor(e={}){super(mf.texture,my);let{target:t=new eY,resolution:i=1,generateMipmaps:s=!1,bounces:r=!0}=e;this.target=t,this.resolution=i,this.generateMipmaps=s,this.bounces=r,this.updateBeforeType=r?sO.RENDER:sO.FRAME,this.virtualCameras=new WeakMap,this.renderTargets=new WeakMap}_updateResolution(e,t){let i=this.resolution;t.getDrawingBufferSize(mg),e.setSize(Math.round(mg.width*i),Math.round(mg.height*i))}setup(e){return this._updateResolution(mf,e.renderer),super.setup(e)}getTextureNode(){return this.textureNode}getVirtualCamera(e){let t=this.virtualCameras.get(e);return void 0===t&&(t=e.clone(),this.virtualCameras.set(e,t)),t}getRenderTarget(e){let t=this.renderTargets.get(e);return void 0===t&&(t=new G(0,0,{type:1016}),!0===this.generateMipmaps&&(t.texture.minFilter=1008,t.texture.generateMipmaps=!0),this.renderTargets.set(e,t)),t}updateBefore(e){if(!1===this.bounces&&mx)return!1;mx=!0;let{scene:t,camera:i,renderer:s,material:r}=e,{target:n}=this,a=this.getVirtualCamera(i),o=this.getRenderTarget(a);if(s.getDrawingBufferSize(mg),this._updateResolution(o,s),mo.setFromMatrixPosition(n.matrixWorld),ml.setFromMatrixPosition(i.matrixWorld),mh.extractRotation(n.matrixWorld),ma.set(0,0,1),ma.applyMatrix4(mh),mc.subVectors(mo,ml),mc.dot(ma)>0)return;mc.reflect(ma).negate(),mc.add(mo),mh.extractRotation(i.matrixWorld),mu.set(0,0,-1),mu.applyMatrix4(mh),mu.add(ml),mp.subVectors(mo,mu),mp.reflect(ma).negate(),mp.add(mo),a.coordinateSystem=i.coordinateSystem,a.position.copy(mc),a.up.set(0,1,0),a.up.applyMatrix4(mh),a.up.reflect(ma),a.lookAt(mp),a.near=i.near,a.far=i.far,a.updateMatrixWorld(),a.projectionMatrix.copy(i.projectionMatrix),mn.setFromNormalAndCoplanarPoint(ma,mo),mn.applyMatrix4(a.matrixWorldInverse),md.set(mn.normal.x,mn.normal.y,mn.normal.z,mn.constant);let l=a.projectionMatrix;mm.x=(Math.sign(md.x)+l.elements[8])/l.elements[0],mm.y=(Math.sign(md.y)+l.elements[9])/l.elements[5],mm.z=-1,mm.w=(1+l.elements[10])/l.elements[14],md.multiplyScalar(1/md.dot(mm)),l.elements[2]=md.x,l.elements[6]=md.y,l.elements[10]=md.z-0,l.elements[14]=md.w,this.value=o.texture,r.visible=!1;let h=s.getRenderTarget(),u=s.getMRT();s.setMRT(null),s.setRenderTarget(o),s.render(t,a),s.setMRT(u),s.setRenderTarget(h),r.visible=!0,mx=!1}}mb.type=sW("Reflector",mb);let mv=new cT(-1,1,1,-1,0,1);class mT extends t_{constructor(e=!1){super(),this.setAttribute("position",new tg([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new tg(!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0],2))}}let mS=new mT;class m_ extends tk{constructor(e=null){super(mS,e),this.camera=mv,this.isQuadMesh=!0}renderAsync(e){return e.renderAsync(this,mv)}render(e){e.render(this,mv)}}let mM=new S;class mw extends oc{constructor(e,t=null,i=null,s={type:1016}){let r=new G(t,i,s);super(r.texture,oo()),this.node=e,this.width=t,this.height=i,this.renderTarget=r,this.textureNeedsUpdate=!0,this.autoUpdate=!0,this.updateMap=new WeakMap,this._rttNode=null,this._quadMesh=new m_(new hW),this.updateBeforeType=sO.RENDER}get autoSize(){return null===this.width}setup(e){return this._rttNode=this.node.context(e.getSharedContext()),this._quadMesh.material.name="RTT",this._quadMesh.material.needsUpdate=!0,super.setup(e)}setSize(e,t){this.width=e,this.height=t;let i=e*this.pixelRatio,s=t*this.pixelRatio;this.renderTarget.setSize(i,s),this.textureNeedsUpdate=!0}setPixelRatio(e){this.pixelRatio=e,this.setSize(this.width,this.height)}updateBefore({renderer:e}){if(!1===this.textureNeedsUpdate&&!1===this.autoUpdate)return;if(this.textureNeedsUpdate=!1,!0===this.autoSize){this.pixelRatio=e.getPixelRatio();let t=e.getSize(mM);this.setSize(t.width,t.height)}this._quadMesh.material.fragmentNode=this._rttNode;let t=e.getRenderTarget();e.setRenderTarget(this.renderTarget),this._quadMesh.render(e),e.setRenderTarget(t)}clone(){let e=new oc(this.value,this.uvNode,this.levelNode);return e.sampler=this.sampler,e.referenceNode=this,e}}mw.type=sW("RTT",mw);let mN=(e,...t)=>ry(new mw(ry(e),...t)),mA=(e,...t)=>e.isTextureNode?e:mN(e,...t);class mR extends on{constructor(e=0){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){let e=this.index;return"color"+(e>0?e:"")}generate(e){let t=this.getAttributeName(e);return!0===e.hasGeometryAttribute(t)?super.generate(e):e.generateConst(this.nodeType,new k(1,1,1,1))}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}mR.type=sW("VertexColor",mR);class mC extends sG{constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}}mC.type=sW("PointUV",mC);class mE extends sG{constructor(e=mE.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){let t;let i=this.scope,s=null!==this.scene?this.scene:e.scene;return i===mE.BACKGROUND_BLURRINESS?t=o7("backgroundBlurriness","float",s):i===mE.BACKGROUND_INTENSITY?t=o7("backgroundIntensity","float",s):console.error("THREE.SceneNode: Unknown scope:",i),t}}mE.BACKGROUND_BLURRINESS="backgroundBlurriness",mE.BACKGROUND_INTENSITY="backgroundIntensity",mE.type=sW("Scene",mE);let mB=rT(mE,mE.BACKGROUND_BLURRINESS),mI=rT(mE,mE.BACKGROUND_INTENSITY),mP={PointList:"point-list",LineList:"line-list",LineStrip:"line-strip",TriangleList:"triangle-list",TriangleStrip:"triangle-strip"},mF={Never:"never",Less:"less",Equal:"equal",LessEqual:"less-equal",Greater:"greater",NotEqual:"not-equal",GreaterEqual:"greater-equal",Always:"always"},mU={Store:"store"},mO={Load:"load",Clear:"clear"},mz={CCW:"ccw"},mL={None:"none",Front:"front",Back:"back"},mD={Uint16:"uint16",Uint32:"uint32"},mV={R8Unorm:"r8unorm",R8Snorm:"r8snorm",R8Uint:"r8uint",R8Sint:"r8sint",R16Uint:"r16uint",R16Sint:"r16sint",R16Float:"r16float",RG8Unorm:"rg8unorm",RG8Snorm:"rg8snorm",RG8Uint:"rg8uint",RG8Sint:"rg8sint",R32Uint:"r32uint",R32Sint:"r32sint",R32Float:"r32float",RG16Uint:"rg16uint",RG16Sint:"rg16sint",RG16Float:"rg16float",RGBA8Unorm:"rgba8unorm",RGBA8UnormSRGB:"rgba8unorm-srgb",RGBA8Snorm:"rgba8snorm",RGBA8Uint:"rgba8uint",RGBA8Sint:"rgba8sint",BGRA8Unorm:"bgra8unorm",BGRA8UnormSRGB:"bgra8unorm-srgb",RGB9E5UFloat:"rgb9e5ufloat",RGB10A2Unorm:"rgb10a2unorm",RG11B10uFloat:"rgb10a2unorm",RG32Uint:"rg32uint",RG32Sint:"rg32sint",RG32Float:"rg32float",RGBA16Uint:"rgba16uint",RGBA16Sint:"rgba16sint",RGBA16Float:"rgba16float",RGBA32Uint:"rgba32uint",RGBA32Sint:"rgba32sint",RGBA32Float:"rgba32float",Stencil8:"stencil8",Depth16Unorm:"depth16unorm",Depth24Plus:"depth24plus",Depth24PlusStencil8:"depth24plus-stencil8",Depth32Float:"depth32float",Depth32FloatStencil8:"depth32float-stencil8",BC1RGBAUnorm:"bc1-rgba-unorm",BC1RGBAUnormSRGB:"bc1-rgba-unorm-srgb",BC2RGBAUnorm:"bc2-rgba-unorm",BC2RGBAUnormSRGB:"bc2-rgba-unorm-srgb",BC3RGBAUnorm:"bc3-rgba-unorm",BC3RGBAUnormSRGB:"bc3-rgba-unorm-srgb",BC4RUnorm:"bc4-r-unorm",BC4RSnorm:"bc4-r-snorm",BC5RGUnorm:"bc5-rg-unorm",BC5RGSnorm:"bc5-rg-snorm",BC6HRGBUFloat:"bc6h-rgb-ufloat",BC6HRGBFloat:"bc6h-rgb-float",BC7RGBAUnorm:"bc7-rgba-unorm",BC7RGBAUnormSRGB:"bc7-rgba-srgb",ETC2RGB8Unorm:"etc2-rgb8unorm",ETC2RGB8UnormSRGB:"etc2-rgb8unorm-srgb",ETC2RGB8A1Unorm:"etc2-rgb8a1unorm",ETC2RGB8A1UnormSRGB:"etc2-rgb8a1unorm-srgb",ETC2RGBA8Unorm:"etc2-rgba8unorm",ETC2RGBA8UnormSRGB:"etc2-rgba8unorm-srgb",EACR11Unorm:"eac-r11unorm",EACR11Snorm:"eac-r11snorm",EACRG11Unorm:"eac-rg11unorm",EACRG11Snorm:"eac-rg11snorm",ASTC4x4Unorm:"astc-4x4-unorm",ASTC4x4UnormSRGB:"astc-4x4-unorm-srgb",ASTC5x4Unorm:"astc-5x4-unorm",ASTC5x4UnormSRGB:"astc-5x4-unorm-srgb",ASTC5x5Unorm:"astc-5x5-unorm",ASTC5x5UnormSRGB:"astc-5x5-unorm-srgb",ASTC6x5Unorm:"astc-6x5-unorm",ASTC6x5UnormSRGB:"astc-6x5-unorm-srgb",ASTC6x6Unorm:"astc-6x6-unorm",ASTC6x6UnormSRGB:"astc-6x6-unorm-srgb",ASTC8x5Unorm:"astc-8x5-unorm",ASTC8x5UnormSRGB:"astc-8x5-unorm-srgb",ASTC8x6Unorm:"astc-8x6-unorm",ASTC8x6UnormSRGB:"astc-8x6-unorm-srgb",ASTC8x8Unorm:"astc-8x8-unorm",ASTC8x8UnormSRGB:"astc-8x8-unorm-srgb",ASTC10x5Unorm:"astc-10x5-unorm",ASTC10x5UnormSRGB:"astc-10x5-unorm-srgb",ASTC10x6Unorm:"astc-10x6-unorm",ASTC10x6UnormSRGB:"astc-10x6-unorm-srgb",ASTC10x8Unorm:"astc-10x8-unorm",ASTC10x8UnormSRGB:"astc-10x8-unorm-srgb",ASTC10x10Unorm:"astc-10x10-unorm",ASTC10x10UnormSRGB:"astc-10x10-unorm-srgb",ASTC12x10Unorm:"astc-12x10-unorm",ASTC12x10UnormSRGB:"astc-12x10-unorm-srgb",ASTC12x12Unorm:"astc-12x12-unorm",ASTC12x12UnormSRGB:"astc-12x12-unorm-srgb"},mk={ClampToEdge:"clamp-to-edge",Repeat:"repeat",MirrorRepeat:"mirror-repeat"},mG={Linear:"linear",Nearest:"nearest"},mW={Zero:"zero",One:"one",Src:"src",OneMinusSrc:"one-minus-src",SrcAlpha:"src-alpha",OneMinusSrcAlpha:"one-minus-src-alpha",Dst:"dst",OneMinusDstColor:"one-minus-dst",DstAlpha:"dst-alpha",OneMinusDstAlpha:"one-minus-dst-alpha",SrcAlphaSaturated:"src-alpha-saturated",Constant:"constant",OneMinusConstant:"one-minus-constant"},mH={Add:"add",Subtract:"subtract",ReverseSubtract:"reverse-subtract",Min:"min",Max:"max"},mj={None:0,All:15},m$={Keep:"keep",Zero:"zero",Replace:"replace",Invert:"invert",IncrementClamp:"increment-clamp",DecrementClamp:"decrement-clamp",IncrementWrap:"increment-wrap",DecrementWrap:"decrement-wrap"},mq={Storage:"storage",ReadOnlyStorage:"read-only-storage"},mX={WriteOnly:"write-only",ReadOnly:"read-only"},mY={Float:"float",UnfilterableFloat:"unfilterable-float",Depth:"depth",SInt:"sint",UInt:"uint"},mJ={TwoD:"2d",ThreeD:"3d"},mK={TwoD:"2d",TwoDArray:"2d-array",Cube:"cube",ThreeD:"3d"},mQ={All:"all"},mZ={Vertex:"vertex",Instance:"instance"},m0={DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups"};class m1 extends o1{constructor(e,t,i=0){super(e,t,i),this.isStorageBufferNode=!0,this.access=mq.Storage,this.bufferObject=!1,this.bufferCount=i,this._attribute=null,this._varying=null,this.global=!0,!0!==e.isStorageBufferAttribute&&!0!==e.isStorageInstancedBufferAttribute&&(e.isInstancedBufferAttribute?e.isStorageInstancedBufferAttribute=!0:e.isStorageBufferAttribute=!0)}getHash(e){if(0===this.bufferCount){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getInputType(){return"storageBuffer"}element(e){return ms(this,e)}setBufferObject(e){return this.bufferObject=e,this}setAccess(e){return this.access=e,this}toReadOnly(){return this.setAccess(mq.ReadOnlyStorage)}generate(e){if(e.isAvailable("storageBuffer"))return super.generate(e);let t=this.getNodeType(e);null===this._attribute&&(this._attribute=a1(this.value),this._varying=aW(this._attribute));let i=this._varying.build(e,t);return e.registerTransform(i,this._attribute),i}}m1.type=sW("StorageBuffer",m1);let m2=(e,t,i)=>ry(new m1(e,t,i));class m3 extends oc{constructor(e,t,i=null){super(e,t),this.storeNode=i,this.isStorageTextureNode=!0,this.access=mX.WriteOnly}getInputType(){return"storageTexture"}setup(e){super.setup(e),e.getNodeProperties(this).storeNode=this.storeNode}setAccess(e){return this.access=e,this}generate(e,t){return null!==this.storeNode?this.generateStore(e):super.generate(e,t)}toReadOnly(){return this.setAccess(mX.ReadOnly)}toWriteOnly(){return this.setAccess(mX.WriteOnly)}generateStore(e){let{uvNode:t,storeNode:i}=e.getNodeProperties(this),s=super.generate(e,"property"),r=t.build(e,"uvec2"),n=i.build(e,"vec4"),a=e.generateTextureStore(e,s,r,n);e.addLineFlowCode(a)}}m3.type=sW("StorageTexture",m3);let m4=rv(m3),m5=(e,t,i)=>{let s=m4(e,t,i);return null!==i&&s.append(),s};class m6 extends o8{constructor(e,t,i=null){super(e,t,i),this.userData=i}update(e){this.reference=null!==this.userData?this.userData:e.object.userData,super.update(e)}}m6.type=sW("UserData",m6);class m8 extends s${constructor(e,t){super(),this.sourceNode=e,this.stepsNode=t}setup(){let{sourceNode:e,stepsNode:t}=this;return e.mul(t).floor().div(t)}}m8.type=sW("Posterize",m8);let m7=null;class m9 extends hR{constructor(e=hN,t=null){null===m7&&(m7=new ix),super(e,t,m7)}updateReference(){return this}}m9.type=sW("ViewportSharedTexture",m9);let ge=new S;class gt extends oc{constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return e.object.isQuadMesh&&this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}gt.type=sW("PassTexture",gt);class gi extends gt{constructor(e,t,i=!1){super(e,null),this.textureName=t,this.previousTexture=i}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){return new this.constructor(this.passNode,this.textureName,this.previousTexture)}}gi.type=sW("PassMultipleTexture",gi);class gs extends s${constructor(e,t,i,s={}){super("vec4"),this.scope=e,this.scene=t,this.camera=i,this.options=s,this._pixelRatio=1,this._width=1,this._height=1;let r=new ib;r.isRenderTargetTexture=!0,r.name="depth";let n=new G(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:1016,...s});n.texture.name="output",n.depthTexture=r,this.renderTarget=n,this.updateBeforeType=sO.FRAME,this._textures={output:n.texture,depth:r},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=rQ(0),this._cameraFar=rQ(0),this._mrt=null,this.isPassNode=!0}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}isGlobal(){return!0}getTexture(e){let t=this._textures[e];return void 0===t&&((t=this.renderTarget.texture.clone()).isRenderTargetTexture=!0,t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)),t}getPreviousTexture(e){let t=this._previousTextures[e];return void 0===t&&((t=this.getTexture(e).clone()).isRenderTargetTexture=!0,this._previousTextures[e]=t),t}toggleTexture(e){let t=this._previousTextures[e];if(void 0!==t){let i=this._textures[e],s=this.renderTarget.textures.indexOf(i);this.renderTarget.textures[s]=t,this._textures[e]=t,this._previousTextures[e]=i,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return void 0===t&&(this._textureNodes[e]=t=ry(new gi(this,e)),this._textureNodes[e].updateTexture()),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return void 0===t&&(void 0===this._textureNodes[e]&&this.getTextureNode(e),this._previousTextureNodes[e]=t=ry(new gi(this,e,!0)),this._previousTextureNodes[e].updateTexture()),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(void 0===t){let i=this._cameraNear,s=this._cameraFar;this._viewZNodes[e]=t=hO(this.getTextureNode(e),i,s)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(void 0===t){let i=this._cameraNear,s=this._cameraFar,r=this.getViewZNode(e);this._linearDepthNodes[e]=t=hF(r,i,s)}return t}setup({renderer:e}){return this.renderTarget.samples=void 0===this.options.samples?e.samples:this.options.samples,!0===e.backend.isWebGLBackend&&(this.renderTarget.samples=0),this.renderTarget.depthTexture.isMultisampleRenderTargetTexture=this.renderTarget.samples>1,this.scope===gs.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){let{renderer:t}=e,{scene:i,camera:s}=this;this._pixelRatio=t.getPixelRatio();let r=t.getSize(ge);this.setSize(r.width,r.height);let n=t.getRenderTarget(),a=t.getMRT();for(let e in this._cameraNear.value=s.near,this._cameraFar.value=s.far,this._previousTextures)this.toggleTexture(e);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(i,s),t.setRenderTarget(n),t.setMRT(a)}setSize(e,t){this._width=e,this._height=t;let i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget.setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}gs.COLOR="color",gs.DEPTH="depth",gs.type=sW("Pass",gs);let gr=(e,t)=>ry(new gt(e,t)),gn=new m_,ga=new m_;class go extends s${constructor(e,t=null,i=2){super("vec4"),this.textureNode=e,this.directionNode=t,this.sigma=i,this._invSize=rQ(new S),this._passDirection=rQ(new S),this._horizontalRT=new G,this._horizontalRT.texture.name="GaussianBlurNode.horizontal",this._verticalRT=new G,this._verticalRT.texture.name="GaussianBlurNode.vertical",this._textureNode=gr(this,this._verticalRT.texture),this.updateBeforeType=sO.RENDER,this.resolution=new S(1,1)}setSize(e,t){e=Math.max(Math.round(e*this.resolution.x),1),t=Math.max(Math.round(t*this.resolution.y),1),this._invSize.value.set(1/e,1/t),this._horizontalRT.setSize(e,t),this._verticalRT.setSize(e,t)}updateBefore(e){let{renderer:t}=e,i=this.textureNode,s=i.value,r=t.getRenderTarget(),n=t.getMRT(),a=i.value;gn.material=this._material,ga.material=this._material,this.setSize(s.image.width,s.image.height);let o=s.type;this._horizontalRT.texture.type=o,this._verticalRT.texture.type=o,t.setMRT(null),t.setRenderTarget(this._horizontalRT),this._passDirection.value.set(1,0),gn.render(t),i.value=this._horizontalRT.texture,t.setRenderTarget(this._verticalRT),this._passDirection.value.set(0,1),ga.render(t),t.setRenderTarget(r),t.setMRT(n),i.value=a}getTextureNode(){return this._textureNode}setup(e){let t=this.textureNode;if(!0!==t.isTextureNode)return console.error("GaussianBlurNode requires a TextureNode."),rD();let i=t.uvNode||oo(),s=rB(this.directionNode||1),r=e=>t.uv(e),n=rS(()=>{let e=3+2*this.sigma,t=this._getCoefficients(e),n=this._invSize,a=s.mul(this._passDirection),o=rA(t[0]).toVar(),l=rD(r(i).mul(o)).toVar();for(let s=1;s<e;s++){let e=rA(s),h=rA(t[s]),u=rB(a.mul(n.mul(e))).toVar(),d=rD(r(i.add(u))),c=rD(r(i.sub(u)));l.addAssign(d.add(c).mul(h)),o.addAssign(nM(2,h))}return l.div(o)}),a=this._material||(this._material=new hW);return a.fragmentNode=n().context(e.getSharedContext()),a.name="Gaussian_blur",a.needsUpdate=!0,e.getNodeProperties(this).textureNode=t,this._textureNode}dispose(){this._horizontalRT.dispose(),this._verticalRT.dispose()}_getCoefficients(e){let t=[];for(let i=0;i<e;i++)t.push(.39894*Math.exp(-.5*i*i/(e*e))/e);return t}}go.type=sW("GaussianBlur",go);let gl=new $,gh=(e,t=rU(...I.getLuminanceCoefficients(gl)))=>a_(e,t);class gu extends s${constructor(e){super(),this.textureNode=e,this.updateBeforeType=sO.RENDER,this._invSize=rQ(new S)}updateBefore(){let e=this.textureNode.value;this._invSize.value.set(1/e.image.width,1/e.image.height)}setup(){let{textureNode:e}=this,t=e.uvNode||oo(),i=t=>e.uv(t);return rS(()=>{let e=this._invSize,s=rH(-1,-2,-1,0,0,0,1,2,1),r=rH(-1,0,1,-2,0,2,-1,0,1),n=gh(i(t.add(e.mul(rB(-1,-1)))).xyz),a=gh(i(t.add(e.mul(rB(-1,0)))).xyz),o=gh(i(t.add(e.mul(rB(-1,1)))).xyz),l=gh(i(t.add(e.mul(rB(0,-1)))).xyz),h=gh(i(t.add(e.mul(rB(0,0)))).xyz),u=gh(i(t.add(e.mul(rB(0,1)))).xyz),d=gh(i(t.add(e.mul(rB(1,-1)))).xyz),c=gh(i(t.add(e.mul(rB(1,0)))).xyz),p=gh(i(t.add(e.mul(rB(1,1)))).xyz),m=nS(s[0][0].mul(n),s[1][0].mul(l),s[2][0].mul(d),s[0][1].mul(a),s[1][1].mul(h),s[2][1].mul(c),s[0][2].mul(o),s[1][2].mul(u),s[2][2].mul(p)),g=nS(r[0][0].mul(n),r[1][0].mul(l),r[2][0].mul(d),r[0][1].mul(a),r[1][1].mul(h),r[2][1].mul(c),r[0][2].mul(o),r[1][2].mul(u),r[2][2].mul(p));return rD(rU(m.mul(m).add(g.mul(g)).sqrt()),1)})()}}gu.type=sW("SobelOperator",gu);class gd extends s${constructor(e,t,i,s,r){super(),this.textureNode=e,this.viewZNode=t,this.focusNode=i,this.apertureNode=s,this.maxblurNode=r,this._aspect=rQ(0),this.updateBeforeType=sO.RENDER}updateBefore(){let e=this.textureNode.value;this._aspect.value=e.image.width/e.image.height}setup(){let e=this.textureNode,t=e.uvNode||oo(),i=t=>e.uv(t);return rS(()=>{let e=rB(1,this._aspect),s=rB(aB(this.focusNode.add(this.viewZNode).mul(this.apertureNode),this.maxblurNode.negate(),this.maxblurNode)),r=s.mul(.9),n=s.mul(.7),a=s.mul(.4),o=rD(0);return(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=o.add(i(t))).add(i(t.add(rB(0,.4).mul(e).mul(s))))).add(i(t.add(rB(.15,.37).mul(e).mul(s))))).add(i(t.add(rB(.29,.29).mul(e).mul(s))))).add(i(t.add(rB(-.37,.15).mul(e).mul(s))))).add(i(t.add(rB(.4,0).mul(e).mul(s))))).add(i(t.add(rB(.37,-.15).mul(e).mul(s))))).add(i(t.add(rB(.29,-.29).mul(e).mul(s))))).add(i(t.add(rB(-.15,-.37).mul(e).mul(s))))).add(i(t.add(rB(0,-.4).mul(e).mul(s))))).add(i(t.add(rB(-.15,.37).mul(e).mul(s))))).add(i(t.add(rB(-.29,.29).mul(e).mul(s))))).add(i(t.add(rB(.37,.15).mul(e).mul(s))))).add(i(t.add(rB(-.4,0).mul(e).mul(s))))).add(i(t.add(rB(-.37,-.15).mul(e).mul(s))))).add(i(t.add(rB(-.29,-.29).mul(e).mul(s))))).add(i(t.add(rB(.15,-.37).mul(e).mul(s))))).add(i(t.add(rB(.15,.37).mul(e).mul(r))))).add(i(t.add(rB(-.37,.15).mul(e).mul(r))))).add(i(t.add(rB(.37,-.15).mul(e).mul(r))))).add(i(t.add(rB(-.15,-.37).mul(e).mul(r))))).add(i(t.add(rB(-.15,.37).mul(e).mul(r))))).add(i(t.add(rB(.37,.15).mul(e).mul(r))))).add(i(t.add(rB(-.37,-.15).mul(e).mul(r))))).add(i(t.add(rB(.15,-.37).mul(e).mul(r))))).add(i(t.add(rB(.29,.29).mul(e).mul(n))))).add(i(t.add(rB(.4,0).mul(e).mul(n))))).add(i(t.add(rB(.29,-.29).mul(e).mul(n))))).add(i(t.add(rB(0,-.4).mul(e).mul(n))))).add(i(t.add(rB(-.29,.29).mul(e).mul(n))))).add(i(t.add(rB(-.4,0).mul(e).mul(n))))).add(i(t.add(rB(-.29,-.29).mul(e).mul(n))))).add(i(t.add(rB(0,.4).mul(e).mul(n))))).add(i(t.add(rB(.29,.29).mul(e).mul(a))))).add(i(t.add(rB(.4,0).mul(e).mul(a))))).add(i(t.add(rB(.29,-.29).mul(e).mul(a))))).add(i(t.add(rB(0,-.4).mul(e).mul(a))))).add(i(t.add(rB(-.29,.29).mul(e).mul(a))))).add(i(t.add(rB(-.4,0).mul(e).mul(a))))).add(i(t.add(rB(-.29,-.29).mul(e).mul(a))))).add(i(t.add(rB(0,.4).mul(e).mul(a))))).div(41)).a=1,rD(o)})()}}gd.type=sW("DepthOfField",gd);class gc extends s${constructor(e,t=new S(.5,.5),i=1.57,s=1){super("vec4"),this.inputNode=e,this.center=rQ(t),this.angle=rQ(i),this.scale=rQ(s)}setup(){let e=this.inputNode,t=rS(()=>{let e=n8(this.angle),t=n7(this.angle),i=oo().mul(hM).sub(this.center),s=rB(t.mul(i.x).sub(e.mul(i.y)),e.mul(i.x).add(t.mul(i.y))).mul(this.scale);return n8(s.x).mul(n8(s.y)).mul(4)});return rS(()=>rD(rU(nS(e.r,e.g,e.b).div(3).mul(10).sub(5).add(t())),e.a))()}}gc.type=sW("DotScreen",gc);class gp extends s${constructor(e,t=.005,i=0){super("vec4"),this.textureNode=e,this.amount=rQ(t),this.angle=rQ(i)}setup(){let{textureNode:e}=this,t=e.uvNode||oo(),i=t=>e.uv(t);return rS(()=>{let e=rB(n7(this.angle),n8(this.angle)).mul(this.amount),s=i(t.add(e)),r=i(t),n=i(t.sub(e));return rD(s.r,r.g,n.b,r.a)})()}}gp.type=sW("RGBShift",gp);class gm extends s${constructor(e,t=null,i=null){super(),this.inputNode=e,this.intensityNode=t,this.uvNode=i}setup(){let e=this.uvNode||oo();return rS(()=>{let t=this.inputNode.rgb,i=aU(n6(e.add(p9()))),s=t.add(t.mul(aB(i.add(.1),0,1)));return null!==this.intensityNode&&(s=aE(t,s,this.intensityNode)),rD(s,this.inputNode.a)})()}}gm.type=sW("Film",gm);class gg extends s${constructor(e,t,i,s){super(),this.inputNode=e,this.lutNode=t,this.size=rQ(i),this.intensityNode=s}setup(){let{inputNode:e,lutNode:t}=this,i=e=>t.uv(e);return rS(()=>{let t=rA(1).div(this.size),s=rD(i(rU(rA(.5).div(this.size)).add(e.rgb.mul(rA(1).sub(t)))).rgb,e.a);return rD(aE(e,s,this.intensityNode))})()}}gg.type=sW("Lut3D",gg);let gf=new m_,gy=new tt,gx=new S;class gb extends s${constructor(e,t,i){super(),this.depthNode=e,this.normalNode=t,this.radius=rQ(.25),this.resolution=rQ(new S),this.thickness=rQ(1),this.distanceExponent=rQ(1),this.distanceFallOff=rQ(1),this.scale=rQ(1),this.noiseNode=op(function(e=5){let t=Math.floor(e)%2==0?Math.floor(e)+1:Math.floor(e),i=function(e){let t=Math.floor(e)%2==0?Math.floor(e)+1:Math.floor(e),i=t*t,s=Array(i).fill(0),r=Math.floor(t/2),n=t-1;for(let e=1;e<=i;){if(-1===r&&n===t?(n=t-2,r=0):(n===t&&(n=0),r<0&&(r=t-1)),0!==s[r*t+n]){n-=2,r++;continue}s[r*t+n]=e++,n++,r--}return s}(t),s=i.length,r=new Uint8Array(4*s);for(let e=0;e<s;++e){let t=2*Math.PI*i[e]/s,n=new $(Math.cos(t),Math.sin(t),0).normalize();r[4*e]=(.5*n.x+.5)*255,r[4*e+1]=(.5*n.y+.5)*255,r[4*e+2]=127,r[4*e+3]=255}let n=new t8(r,t,t);return n.wrapS=1e3,n.wrapT=1e3,n.needsUpdate=!0,n}()),this.cameraProjectionMatrix=rQ(i.projectionMatrix),this.cameraProjectionMatrixInverse=rQ(i.projectionMatrixInverse),this.SAMPLES=rQ(16),this._aoRenderTarget=new G,this._aoRenderTarget.texture.name="GTAONode.AO",this._material=null,this._textureNode=gr(this,this._aoRenderTarget.texture),this.updateBeforeType=sO.FRAME}getTextureNode(){return this._textureNode}setSize(e,t){this.resolution.value.set(e,t),this._aoRenderTarget.setSize(e,t)}updateBefore(e){let{renderer:t}=e,i=t.getDrawingBufferSize(gx),s=t.getRenderTarget(),r=t.getMRT();t.getClearColor(gy);let n=t.getClearAlpha();gf.material=this._material,this.setSize(i.width,i.height),t.setMRT(null),t.setClearColor(16777215,1),t.setRenderTarget(this._aoRenderTarget),gf.render(t),t.setRenderTarget(s),t.setMRT(r),t.setClearColor(gy,n)}setup(e){let t=oo(),i=e=>this.depthNode.uv(e).x,s=e=>this.noiseNode.uv(e),r=rS(([e])=>{let t=this.cameraProjectionMatrix.mul(rD(e,1)),s=t.xy.div(t.w).mul(.5).add(.5).toVar(),r=i(s=rB(s.x,s.y.oneMinus()));return rU(s,r)}),n=rS(([e,t])=>{let i=rD(rU(e=rB(e.x,e.y.oneMinus()).mul(2).sub(1),t),1),s=rD(this.cameraProjectionMatrixInverse.mul(i));return s.xyz.div(s.w)}),a=rS(()=>{let e=i(t);e.greaterThanEqual(1).discard();let a=n(t,e),o=this.normalNode.rgb.normalize(),l=this.radius,h=oh(this.noiseNode,0),u=rB(t.x,t.y.oneMinus()),d=s(u=u.mul(this.resolution.div(h))),c=rU(d.xyz.mul(2).sub(1).xy,0).normalize(),p=rU(c.y.mul(-1),c.x,0),m=rH(c,p,rU(0,0,1)),g=this.SAMPLES.lessThan(30).select(3,5),f=nS(this.SAMPLES,g.sub(1)).div(g),y=rA(0).toVar();return ha({start:rR(0),end:g,type:"int",condition:"<"},({i:e})=>{let t=rA(e).div(rA(g)).mul(nj),i=rD(n7(t),n8(t),0,nS(.5,nM(.5,d.w)));i.xyz=n5(m.mul(i.xyz));let s=n5(a.xyz.negate()),h=n5(aM(i.xyz,s)),u=aM(h,s),c=n5(o.sub(h.mul(a_(o,h)))),p=aM(c,h),x=rB(a_(s,p),a_(s,p.negate())).toVar();ha({end:f,type:"int",name:"j",condition:"<"},({j:e})=>{let t=i.xyz.mul(l).mul(i.w).mul(aw(nw(rA(e).add(1),rA(f)),this.distanceExponent)),o=r(a.add(t)),h=n(o.xy,o.z).sub(a);rw(as(h.z).lessThan(this.thickness),()=>{let t=a_(s,n5(h));x.x.addAssign(ay(0,nM(t.sub(x.x),aE(1,rA(2).div(rA(e).add(2)),this.distanceFallOff))))});let u=r(a.sub(t)),d=n(u.xy,u.z).sub(a);rw(as(d.z).lessThan(this.thickness),()=>{let t=a_(s,n5(d));x.y.addAssign(ay(0,nM(t.sub(x.y),aE(1,rA(2).div(rA(e).add(2)),this.distanceFallOff))))})});let b=n1(n_(1,x.mul(x))),v=a_(c,u),T=a_(c,s),S=nM(.5,at(x.y).sub(at(x.x)).add(b.x.mul(x.x).sub(b.y.mul(x.y)))),_=nM(.5,n_(2,x.x.mul(x.x)).sub(x.y.mul(x.y))),M=v.mul(S).add(T.mul(_));y.addAssign(M)}),y.assign(aB(y.div(g),0,1)),y.assign(aw(y,this.scale)),rD(rU(y),1)}),o=this._material||(this._material=new hW);return o.fragmentNode=a().context(e.getSharedContext()),o.name="GTAO",o.needsUpdate=!0,this._textureNode}dispose(){this._aoRenderTarget.dispose()}}gb.type=sW("GTAO",gb);class gv extends s${constructor(e,t,i,s,r){super(),this.textureNode=e,this.depthNode=t,this.normalNode=i,this.noiseNode=s,this.cameraProjectionMatrixInverse=rQ(r.projectionMatrixInverse),this.lumaPhi=rQ(5),this.depthPhi=rQ(5),this.normalPhi=rQ(5),this.radius=rQ(5),this.index=rQ(0),this._resolution=rQ(new S),this._sampleVectors=o5(function(e,t,i){let s=function(e,t,i){let s=[];for(let t=0;t<16;t++){let i=2*Math.PI*2*t/e,r=Math.pow(t/(e-1),1);s.push(new $(Math.cos(i),Math.sin(i),r))}return s}(16,2,1),r=[];for(let e=0;e<16;e++){let t=s[e];r.push(t)}return r}(16,0,0)),this.updateBeforeType=sO.RENDER}updateBefore(){let e=this.textureNode.value;this._resolution.value.set(e.image.width,e.image.height)}setup(){let e=oo(),t=e=>this.textureNode.uv(e),i=e=>this.depthNode.uv(e).x,s=e=>this.normalNode.uv(e),r=e=>this.noiseNode.uv(e),n=rS(([e,t])=>{let i=rD(rU(e=rB(e.x,e.y.oneMinus()).mul(2).sub(1),t),1),s=rD(this.cameraProjectionMatrixInverse.mul(i));return s.xyz.div(s.w)}),a=rS(([e,r,a,o])=>{let l=t(o),h=i(o),u=s(o).rgb.normalize(),d=l.rgb,c=n(o,h),p=aw(ay(a_(r,u).toVar(),0),this.normalPhi).toVar(),m=as(gh(d).sub(gh(e))).toVar(),g=ay(rA(1).sub(m.div(this.lumaPhi)),0).toVar(),f=as(a_(a.sub(c),r)).toVar(),y=ay(rA(1).sub(f.div(this.depthPhi)),0),x=g.mul(y).mul(p);return rD(d.mul(x),x)}),o=rS(([e])=>{let o=i(e),l=s(e).rgb.normalize(),h=t(e);rw(o.greaterThanEqual(1).or(a_(l,l).equal(0)),()=>h);let u=rU(h.rgb),d=n(e,o),c=oh(this.noiseNode,0),p=rB(e.x,e.y.oneMinus()),m=r(p=p.mul(this._resolution.div(c))),g=rB(n8(m.element(this.index.mod(4).mul(2).mul(nj))),n7(m.element(this.index.mod(4).mul(2).mul(nj)))),f=rW(g.x,g.y.negate(),g.x,g.y),y=rA(1).toVar(),x=rU(h.rgb).toVar();return ha({start:rR(0),end:rR(16),type:"int",condition:"<"},({i:t})=>{let i=this._sampleVectors.element(t).toVar(),s=f.mul(i.xy.mul(rA(1).add(i.z.mul(this.radius.sub(1))))).div(this._resolution).toVar(),r=a(u,l,d,e.add(s).toVar());x.addAssign(r.xyz),y.addAssign(r.w)}),rw(y.greaterThan(rA(0)),()=>{x.divAssign(y)}),rD(x,h.a)}).setLayout({name:"denoise",type:"vec4",inputs:[{name:"uv",type:"vec2"}]});return rS(()=>o(e))()}}gv.type=sW("Denoise",gv);class gT extends s${constructor(e){super(),this.textureNode=e,this.updateBeforeType=sO.RENDER,this._invSize=rQ(new S)}updateBefore(){let e=this.textureNode.value;this._invSize.value.set(1/e.image.width,1/e.image.height)}setup(){let e=this.textureNode.bias(-100),t=e.uvNode||oo(),i=t=>e.uv(t),s=(t,i,s)=>e.uv(t.add(i.mul(s))),r=rR(5),n=rS(([e,t])=>{let i=rD(t).toVar(),s=rD(e).toVar(),r=rD(as(s.sub(i))).toVar();return ay(ay(ay(r.r,r.g),r.b),r.a)}),a=rS(([e,t,a,o])=>{let l=i(e).toVar(),h=s(e,rB(0,-1),t.xy).toVar(),u=s(e,rB(1,0),t.xy).toVar(),d=s(e,rB(0,1),t.xy).toVar(),c=s(e,rB(-1,0),t.xy).toVar(),p=n(l,d).toVar(),m=n(l,h).toVar(),g=n(l,u).toVar(),f=n(l,c).toVar();rw(ay(p,ay(m,ay(g,f))).toVar().lessThan(a),()=>l);let y=n_(p.add(m),g.add(f)).toVar();y.mulAssign(o),rw(as(y).lessThan(.3),()=>{let i=rB(g.greaterThan(f).select(1,-1).toVar(),m.greaterThan(p).select(1,-1).toVar()).toVar(),r=n(l,s(e,rB(i.x,i.y),t.xy)).toVar(),a=n(l,s(e,rB(i.x.negate(),i.y.negate()),t.xy)).toVar();y.assign(a.sub(r)),y.mulAssign(o),rw(as(y).lessThan(.3),()=>aE(l,d.add(h).add(u).add(c).mul(.25),.4))});let x=rB().toVar();rw(y.lessThanEqual(0),()=>{d.assign(c),h.assign(u),x.x.assign(0),x.y.assign(t.y)}).Else(()=>{x.x.assign(t.x),x.y.assign(0)});let b=n(l,d).toVar(),v=n(l,h).toVar();rw(b.lessThanEqual(v),()=>{d.assign(h)});let T=rR(0).toVar(),S=rR(0).toVar(),_=rA(0).toVar(),M=rA(0).toVar(),w=rB(e).toVar(),N=rB(e).toVar(),A=rR(0).toVar(),R=rR(0).toVar();ha(r,({i:t})=>{let s=t.add(1).toVar();rw(T.equal(0),()=>{_.addAssign(s),w.assign(e.add(x.mul(_)));let r=i(w.xy),a=n(r,l).toVar(),o=n(r,d).toVar();rw(a.greaterThan(o),()=>{T.assign(1)}),A.assign(t)}),rw(S.equal(0),()=>{M.addAssign(s),N.assign(e.sub(x.mul(M)));let r=i(N.xy),a=n(r,l).toVar(),o=n(r,d).toVar();rw(a.greaterThan(o),()=>{S.assign(1)}),R.assign(t)}),rw(T.equal(1).or(S.equal(1)),()=>{ho()})}),rw(T.equal(0).and(S.equal(0)),()=>l);let C=rA(1).toVar(),E=rA(1).toVar();rw(T.equal(1),()=>{C.assign(rA(A).div(rA(r.sub(1))))}),rw(S.equal(1),()=>{E.assign(rA(R).div(rA(r.sub(1))))});let B=af(C,E);return B.assign(aw(B,.5)),B.assign(rA(1).sub(B)),aE(l,d,B.mul(.5))}).setLayout({name:"FxaaPixelShader",type:"vec4",inputs:[{name:"uv",type:"vec2"},{name:"fxaaQualityRcpFrame",type:"vec2"},{name:"fxaaQualityEdgeThreshold",type:"float"},{name:"fxaaQualityinvEdgeThreshold",type:"float"}]});return rS(()=>{let e=rA(.2),i=rA(1).div(e);return a(t,this._invSize,e,i)})()}}gT.type=sW("FXAA",gT);class gS extends s${constructor(e,t,i,s,r,n){super(),this.textureNodeA=e,this.textureNodeB=t,this.mixTextureNode=i,this.mixRatioNode=s,this.thresholdNode=r,this.useTextureNode=n}setup(){let{textureNodeA:e,textureNodeB:t,mixTextureNode:i,mixRatioNode:s,thresholdNode:r,useTextureNode:n}=this,a=e=>{let t=e.uvNode||oo();return e.uv(t)};return rS(()=>{let o=a(e),l=a(t),h=rD().toVar();return rw(n.equal(rR(1)),()=>{let e=a(i),t=s.mul(r.mul(2).add(1)).sub(r),n=aB(n_(e.r,t).mul(rA(1).div(r)),0,1);h.assign(aE(o,l,n))}).Else(()=>{h.assign(aE(l,o,s))}),h})()}}gS.type=sW("Transition",gS);class g_ extends s${constructor(e,t,i,s,r,n){super(),this.textureNode=e,this.depthNode=t,this.normalNode=i,this.pixelSize=s,this.normalEdgeStrength=r,this.depthEdgeStrength=n,this._resolution=rQ(new k),this.updateBeforeType=sO.RENDER}updateBefore(){let e=this.textureNode.value,t=e.image.width,i=e.image.height;this._resolution.value.set(t,i,1/t,1/i)}setup(){let{textureNode:e,depthNode:t,normalNode:i}=this,s=e.uvNode||oo(),r=t.uvNode||oo(),n=i.uvNode||oo(),a=()=>e.uv(s),o=(e,i)=>t.uv(r.add(rB(e,i).mul(this._resolution.zw))).r,l=(e,t)=>i.uv(n.add(rB(e,t).mul(this._resolution.zw))).rgb.normalize(),h=e=>{let t=r0("float","diff");return t.addAssign(aB(o(1,0).sub(e))),t.addAssign(aB(o(-1,0).sub(e))),t.addAssign(aB(o(0,1).sub(e))),t.addAssign(aB(o(0,-1).sub(e))),n3(aP(.01,.02,t).mul(2)).div(2)},u=(e,t,i,s)=>{let r=o(e,t).sub(i),n=l(e,t),a=rU(1,1,1),h=aB(aP(-.01,.01,a_(s.sub(n),a)),0,1),u=aB(ar(r.mul(.25).add(.0025)),0,1);return rA(1).sub(a_(s,n)).mul(u).mul(h)},d=(e,t)=>{let i=r0("float","indicator");return i.addAssign(u(0,-1,e,t)),i.addAssign(u(0,1,e,t)),i.addAssign(u(-1,0,e,t)),i.addAssign(u(1,0,e,t)),ab(.1,i)};return rS(()=>{let e=a(),t=r0("float","depth"),i=r0("vec3","normal");rw(this.depthEdgeStrength.greaterThan(0).or(this.normalEdgeStrength.greaterThan(0)),()=>{t.assign(o(0,0)),i.assign(l(0,0))});let s=r0("float","dei");rw(this.depthEdgeStrength.greaterThan(0),()=>{s.assign(h(t))});let r=r0("float","nei");rw(this.normalEdgeStrength.greaterThan(0),()=>{r.assign(d(t,i))});let n=s.greaterThan(0).select(rA(1).sub(s.mul(this.depthEdgeStrength)),r.mul(this.normalEdgeStrength).add(1));return e.mul(n)})()}}g_.type=sW("Pixelation",g_);let gM=(e,t,i,s=6,r=.3,n=.4)=>ry(new g_(mA(e),mA(t),mA(i),ry(s),ry(r),ry(n)));class gw extends gs{constructor(e,t,i=6,s=.3,r=.4){super("color",e,t,{minFilter:1003,magFilter:1003}),this.pixelSize=i,this.normalEdgeStrength=s,this.depthEdgeStrength=r,this.isPixelationPassNode=!0,this._mrt=p4({output:nu,normal:oW})}setSize(e,t){let i=this.pixelSize.value?this.pixelSize.value:this.pixelSize;super.setSize(Math.floor(e/i),Math.floor(t/i))}setup(){return gM(super.getTextureNode("output"),super.getTextureNode("depth"),super.getTextureNode("normal"),this.pixelSize,this.normalEdgeStrength,this.depthEdgeStrength)}}gw.type=sW("PixelationPass",gw);let gN=new S;class gA extends gs{constructor(e,t){super(gs.COLOR,e,t),this.isSSAAPassNode=!0,this.sampleLevel=4,this.unbiased=!0,this.clearColor=new tt(0),this.clearAlpha=0,this._currentClearColor=new tt,this.sampleWeight=rQ(1),this.sampleRenderTarget=null,this._quadMesh=new m_}updateBefore(e){let{renderer:t}=e,{scene:i,camera:s}=this;this._pixelRatio=t.getPixelRatio();let r=t.getSize(gN);this.setSize(r.width,r.height),this.sampleRenderTarget.setSize(this.renderTarget.width,this.renderTarget.height),t.getClearColor(this._currentClearColor);let n=t.getClearAlpha(),a=t.getRenderTarget(),o=t.getMRT(),l=t.autoClear;this._cameraNear.value=s.near,this._cameraFar.value=s.far,t.setMRT(this.getMRT()),t.autoClear=!1;let h=gR[Math.max(0,Math.min(this.sampleLevel,5))],u=1/h.length,d=1/32,c={fullWidth:this.renderTarget.width,fullHeight:this.renderTarget.height,offsetX:0,offsetY:0,width:this.renderTarget.width,height:this.renderTarget.height},p=Object.assign({},s.view);p.enabled&&Object.assign(c,p);for(let e=0;e<h.length;e++){let r=h[e];if(s.setViewOffset&&s.setViewOffset(c.fullWidth,c.fullHeight,c.offsetX+.0625*r[0],c.offsetY+.0625*r[1],c.width,c.height),this.sampleWeight.value=u,this.unbiased){let t=-.5+(e+.5)/h.length;this.sampleWeight.value+=d*t}t.setClearColor(this.clearColor,this.clearAlpha),t.setRenderTarget(this.sampleRenderTarget),t.clear(),t.render(i,s),t.setRenderTarget(this.renderTarget),0===e&&(t.setClearColor(0,0),t.clear()),this._quadMesh.render(t)}t.copyTextureToTexture(this.sampleRenderTarget.depthTexture,this.renderTarget.depthTexture),s.setViewOffset&&p.enabled?s.setViewOffset(p.fullWidth,p.fullHeight,p.offsetX,p.offsetY,p.width,p.height):s.clearViewOffset&&s.clearViewOffset(),t.setRenderTarget(a),t.setMRT(o),t.autoClear=l,t.setClearColor(this._currentClearColor,n)}setup(e){let t;null===this.sampleRenderTarget&&(this.sampleRenderTarget=this.renderTarget.clone());let i=this.getMRT();if(null!==i){let e={};for(let t in i.outputNodes){let i=p2(this.sampleRenderTarget.textures,t);i>=0&&(e[t]=op(this.sampleRenderTarget.textures[i]).mul(this.sampleWeight))}t=p4(e)}else t=op(this.sampleRenderTarget.texture).mul(this.sampleWeight);return this._quadMesh.material=new hW,this._quadMesh.material.fragmentNode=t,this._quadMesh.material.transparent=!0,this._quadMesh.material.depthTest=!1,this._quadMesh.material.depthWrite=!1,this._quadMesh.material.premultipliedAlpha=!0,this._quadMesh.material.blending=2,this._quadMesh.material.normals=!1,this._quadMesh.material.name="SSAA",super.setup(e)}dispose(){super.dispose(),null!==this.sampleRenderTarget&&this.sampleRenderTarget.dispose()}}gA.type=sW("SSAAPass",gA);let gR=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]],gC=new S;class gE extends gs{constructor(e,t){super(gs.COLOR,e,t),this.isStereoPassNode=!0,this.stereo=new cI,this.stereo.aspect=.5}updateBefore(e){let{renderer:t}=e,{scene:i,camera:s,stereo:r,renderTarget:n}=this;this._pixelRatio=t.getPixelRatio(),r.cameraL.coordinateSystem=t.coordinateSystem,r.cameraR.coordinateSystem=t.coordinateSystem,r.update(s);let a=t.getSize(gC);this.setSize(a.width,a.height);let o=t.autoClear;t.autoClear=!1;let l=t.getRenderTarget(),h=t.getMRT();for(let e in this._cameraNear.value=s.near,this._cameraFar.value=s.far,this._previousTextures)this.toggleTexture(e);t.setRenderTarget(n),t.setMRT(this._mrt),t.clear(),n.scissorTest=!0,n.scissor.set(0,0,n.width/2,n.height),n.viewport.set(0,0,n.width/2,n.height),t.render(i,r.cameraL),n.scissor.set(n.width/2,0,n.width/2,n.height),n.viewport.set(n.width/2,0,n.width/2,n.height),t.render(i,r.cameraR),n.scissorTest=!1,t.setRenderTarget(l),t.setMRT(h),t.autoClear=o}}gE.type=sW("StereoPass",gE);let gB=new S,gI=new m_;class gP extends gs{constructor(e,t){super(gs.COLOR,e,t),this.isStereoCompositePassNode=!0,this.stereo=new cI;let i={minFilter:1006,magFilter:1003,type:1016};this._renderTargetL=new G(1,1,i),this._renderTargetR=new G(1,1,i),this._mapLeft=op(this._renderTargetL.texture),this._mapRight=op(this._renderTargetR.texture),this._material=null}updateStereoCamera(e){this.stereo.cameraL.coordinateSystem=e,this.stereo.cameraR.coordinateSystem=e,this.stereo.update(this.camera)}setSize(e,t){super.setSize(e,t),this._renderTargetL.setSize(this.renderTarget.width,this.renderTarget.height),this._renderTargetR.setSize(this.renderTarget.width,this.renderTarget.height)}updateBefore(e){let{renderer:t}=e,{scene:i,stereo:s,renderTarget:r}=this;this._pixelRatio=t.getPixelRatio(),this.updateStereoCamera(t.coordinateSystem);let n=t.getSize(gB);this.setSize(n.width,n.height);let a=t.getRenderTarget();t.setRenderTarget(this._renderTargetL),t.render(i,s.cameraL),t.setRenderTarget(this._renderTargetR),t.render(i,s.cameraR),t.setRenderTarget(r),gI.material=this._material,gI.render(t),t.setRenderTarget(a)}dispose(){super.dispose(),this._renderTargetL.dispose(),this._renderTargetR.dispose(),null!==this._material&&this._material.dispose()}}gP.type=sW("StereoCompositePass",gP);class gF extends gP{constructor(e,t){super(e,t),this.isParallaxBarrierPassNode=!0}setup(e){let t=oo(),i=rS(()=>{let e=rD().toVar();return rw(ax(h_.y,2).greaterThan(1),()=>{e.assign(this._mapLeft.uv(t))}).Else(()=>{e.assign(this._mapRight.uv(t))}),e}),s=this._material||(this._material=new hW);return s.fragmentNode=i().context(e.getSharedContext()),s.needsUpdate=!0,super.setup(e)}}gF.type=sW("ParallaxBarrierPass",gF);class gU extends sG{constructor(e=null){super(),this._value=e,this._cache=null,this.inputType=null,this.outpuType=null,this.events=new c,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return null!==this.outputType}set value(e){this._value!==e&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=e,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){let e=this.value;if(e&&null===this._cache&&"URL"===this.inputType&&e.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([e.value]));else if(e&&null!==e.value&&void 0!==e.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof e.value||"Number"===this.inputType&&"number"==typeof e.value||"Vector2"===this.inputType&&e.value.isVector2||"Vector3"===this.inputType&&e.value.isVector3||"Vector4"===this.inputType&&e.value.isVector4||"Color"===this.inputType&&e.value.isColor||"Matrix3"===this.inputType&&e.value.isMatrix3||"Matrix4"===this.inputType&&e.value.isMatrix4))return e.value;return this._cache||e}getNodeType(e){return this.value&&this.value.isNode?this.value.getNodeType(e):"float"}setup(){return this.value&&this.value.isNode?this.value:rA()}serialize(e){super.serialize(e),null!==this.value?"ArrayBuffer"===this.inputType?e.value=sP(this.value):e.value=this.value?this.value.toJSON(e.meta).uuid:null:e.value=null,e.inputType=this.inputType,e.outputType=this.outputType}deserialize(e){super.deserialize(e);let t=null;null!==e.value&&(t="ArrayBuffer"===e.inputType?sF(e.value):"Texture"===e.inputType?e.meta.textures[e.value]:e.meta.nodes[e.value]||null),this.value=t,this.inputType=e.inputType,this.outputType=e.outputType}}gU.type=sW("ScriptableValue",gU);let gO=rv(gU);class gz extends Map{get(e,t=null,...i){if(this.has(e))return super.get(e);if(null!==t){let s=t(...i);return this.set(e,s),s}}}class gL{constructor(e){this.scriptableNode=e}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(e){return this.scriptableNode.getInputLayout(e)}get(e){let t=this.parameters[e];return t?t.getValue():null}}let gD=new gz;class gV extends sG{constructor(e=null,t={}){super(),this.codeNode=e,this.parameters=t,this._local=new gz,this._output=gO(),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(e,t){return this._local.set(e,t)}getLocal(e){return this._local.get(e)}onRefresh(){this._refresh()}getInputLayout(e){for(let t of this.getLayout())if(t.inputType&&(t.id===e||t.name===e))return t}getOutputLayout(e){for(let t of this.getLayout())if(t.outputType&&(t.id===e||t.name===e))return t}setOutput(e,t){let i=this._outputs;return void 0===i[e]?i[e]=gO(t):i[e].value=t,this}getOutput(e){return this._outputs[e]}getParameter(e){return this.parameters[e]}setParameter(e,t){let i=this.parameters;return t&&t.isScriptableNode?(this.deleteParameter(e),i[e]=t,i[e].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):t&&t.isScriptableValueNode?(this.deleteParameter(e),i[e]=t,i[e].events.addEventListener("refresh",this.onRefresh)):void 0===i[e]?(i[e]=gO(t),i[e].events.addEventListener("refresh",this.onRefresh)):i[e].value=t,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(e){let t=this.parameters[e];return t&&(t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(let e of Object.keys(this.parameters))this.deleteParameter(e);return this.needsUpdate=!0,this}call(e,...t){let i=this.getObject()[e];if("function"==typeof i)return i(...t)}async callAsync(e,...t){let i=this.getObject()[e];if("function"==typeof i)return"AsyncFunction"===i.constructor.name?await i(...t):i(...t)}getNodeType(e){return this.getDefaultOutputNode().getNodeType(e)}refresh(e=null){null!==e?this.getOutput(e).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;let e=new gL(this),t=gD.get("THREE"),i=gD.get("TSL"),s=this.getMethod(this.codeNode),r=[e,this._local,gD,()=>this.refresh(),(e,t)=>this.setOutput(e,t),t,i];this._object=s(...r);let n=this._object.layout;if(n&&(!1===n.cache&&this._local.clear(),this._output.outputType=n.outputType||null,Array.isArray(n.elements)))for(let e of n.elements){let t=e.id||e.name;e.inputType&&(void 0===this.getParameter(t)&&this.setParameter(t,null),this.getParameter(t).inputType=e.inputType),e.outputType&&(void 0===this.getOutput(t)&&this.setOutput(t,null),this.getOutput(t).outputType=e.outputType)}return this._object}deserialize(e){for(let t in super.deserialize(e),this.parameters){let e=this.parameters[t];e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){let e=this.getDefaultOutput().value;return e&&e.isNode?e:rA()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;let e="layout, init, main, dispose",t="var "+e+"; var output = {};\n"+this.codeNode.code+"\nreturn { ...output, "+e+" };";return this._method=Function("parameters","local","global","refresh","setOutput","THREE","TSL",t),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}getCacheKey(e){let t=[this.source,this.getDefaultOutputNode().getCacheKey(e)];for(let i in this.parameters)t.push(this.parameters[i].getCacheKey(e));return t.join(",")}set needsUpdate(e){!0===e&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}}gV.type=sW("Scriptable",gV);class gk extends sG{constructor(e,t){super("float"),this.isFogNode=!0,this.colorNode=e,this.factorNode=t}getViewZNode(e){let t;let i=e.context.getViewZ;return void 0!==i&&(t=i(this)),(t||oU.z).negate()}setup(){return this.factorNode}}gk.type=sW("Fog",gk);class gG extends gk{constructor(e,t,i){super(e),this.isFogRangeNode=!0,this.nearNode=t,this.farNode=i}setup(e){let t=this.getViewZNode(e);return aP(this.nearNode,this.farNode,t)}}gG.type=sW("FogRange",gG);let gW=rv(gG);class gH extends gk{constructor(e,t){super(e),this.isFogExp2Node=!0,this.densityNode=t}setup(e){let t=this.getViewZNode(e),i=this.densityNode;return i.mul(i,t,t).negate().exp().oneMinus()}}gH.type=sW("FogExp2",gH);let gj=rv(gH),g$=null,gq=null;class gX extends sG{constructor(e=rA(),t=rA()){super(),this.minNode=e,this.maxNode=t}getVectorLength(e){let t=e.getTypeLength(sB(this.minNode.value)),i=e.getTypeLength(sB(this.maxNode.value));return t>i?t:i}getNodeType(e){return e.object.count>1?e.getTypeFromLength(this.getVectorLength(e)):"float"}setup(e){let t=e.object,i=null;if(t.count>1){let s=this.minNode.value,r=this.maxNode.value,n=e.getTypeLength(sB(s)),a=e.getTypeLength(sB(r));g$=g$||new k,gq=gq||new k,g$.setScalar(0),gq.setScalar(0),1===n?g$.setScalar(s):s.isColor?g$.set(s.r,s.g,s.b):g$.set(s.x,s.y,s.z||0,s.w||0),1===a?gq.setScalar(r):r.isColor?gq.set(r.r,r.g,r.b):gq.set(r.x,r.y,r.z||0,r.w||0);let o=4*t.count,l=new Float32Array(o);for(let e=0;e<o;e++){let t=e%4,i=g$.getComponent(t),s=gq.getComponent(t);l[e]=T.lerp(i,s,Math.random())}let h=this.getNodeType(e);if(t.count<=4096)i=o2(l,"vec4",t.count).element(l5).convert(h);else{let t=new t7(l,4);e.geometry.setAttribute("__range"+this.id,t),i=a3(t).convert(h)}}else i=rA(0);return i}}gX.type=sW("Range",gX);class gY extends sG{constructor(e=gY.TARGET_DIRECTION,t=null){super(),this.scope=e,this.light=t}setup(){let{scope:e,light:t}=this,i=null;return e===gY.TARGET_DIRECTION&&(i=ov.transformDirection(o_(t).sub(o_(t.target)))),i}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}gY.TARGET_DIRECTION="targetDirection",gY.type=sW("Light",gY);let gJ=rv(gY,gY.TARGET_DIRECTION),gK=[rS(({depthTexture:e,shadowCoord:t})=>op(e,t.xy).compare(t.z)),rS(({depthTexture:e,shadowCoord:t,shadow:i})=>{let s=(t,i)=>op(e,t).compare(i),r=o7("mapSize","vec2",i),n=o7("radius","float",i),a=rB(1).div(r),o=a.x.negate().mul(n),l=a.y.negate().mul(n),h=a.x.mul(n),u=a.y.mul(n),d=o.div(2),c=l.div(2),p=h.div(2),m=u.div(2);return nS(s(t.xy.add(rB(o,l)),t.z),s(t.xy.add(rB(0,l)),t.z),s(t.xy.add(rB(h,l)),t.z),s(t.xy.add(rB(d,c)),t.z),s(t.xy.add(rB(0,c)),t.z),s(t.xy.add(rB(p,c)),t.z),s(t.xy.add(rB(o,0)),t.z),s(t.xy.add(rB(d,0)),t.z),s(t.xy,t.z),s(t.xy.add(rB(p,0)),t.z),s(t.xy.add(rB(h,0)),t.z),s(t.xy.add(rB(d,m)),t.z),s(t.xy.add(rB(0,m)),t.z),s(t.xy.add(rB(p,m)),t.z),s(t.xy.add(rB(o,u)),t.z),s(t.xy.add(rB(0,u)),t.z),s(t.xy.add(rB(h,u)),t.z)).mul(1/17)}),rS(({depthTexture:e,shadowCoord:t,shadow:i})=>{let s=(t,i)=>op(e,t).compare(i),r=o7("mapSize","vec2",i),n=rB(1).div(r),a=n.x,o=n.y,l=t.xy,h=n6(l.mul(r).add(.5));return l.subAssign(h.mul(n)),nS(s(l,t.z),s(l.add(rB(a,0)),t.z),s(l.add(rB(0,o)),t.z),s(l.add(n),t.z),aE(s(l.add(rB(a.negate(),0)),t.z),s(l.add(rB(a.mul(2),0)),t.z),h.x),aE(s(l.add(rB(a.negate(),o)),t.z),s(l.add(rB(a.mul(2),o)),t.z),h.x),aE(s(l.add(rB(0,o.negate())),t.z),s(l.add(rB(0,o.mul(2))),t.z),h.y),aE(s(l.add(rB(a,o.negate())),t.z),s(l.add(rB(a,o.mul(2))),t.z),h.y),aE(aE(s(l.add(rB(a.negate(),o.negate())),t.z),s(l.add(rB(a.mul(2),o.negate())),t.z),h.x),aE(s(l.add(rB(a.negate(),o.mul(2))),t.z),s(l.add(rB(a.mul(2),o.mul(2))),t.z),h.x),h.y)).mul(1/9)})],gQ=null;class gZ extends hy{constructor(e=null){super(),this.updateType=sO.FRAME,this.light=e,this.color=new tt,this.colorNode=rQ(this.color),this.baseColorNode=null,this.shadowMap=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0}getCacheKey(){return super.getCacheKey()+"-"+this.light.id+"-"+(this.light.castShadow?"1":"0")}getHash(){return this.light.uuid}setupShadow(e){let{object:t,renderer:i}=e,s=this.shadowColorNode;if(null===s){null===gQ&&((gQ=new hW).fragmentNode=rD(0,0,0,1),gQ.isShadowNodeMaterial=!0,gQ.name="ShadowMaterial");let r=new ib;r.compareFunction=513;let n=this.light.shadow,a=e.createRenderTarget(n.mapSize.width,n.mapSize.height);a.depthTexture=r,n.camera.updateProjectionMatrix();let o=o7("intensity","float",n),l=o7("bias","float",n),h=o7("normalBias","float",n),u=t.material.shadowPositionNode||oP,d=rQ(n.matrix).mul(u.add(oH.mul(h))),c=(d=d.xyz.div(d.w)).z.add(l);2001===i.coordinateSystem&&(c=c.mul(2).sub(1));let p=(d=rU(d.x,d.y.oneMinus(),c)).x.greaterThanEqual(0).and(d.x.lessThanEqual(1)).and(d.y.greaterThanEqual(0)).and(d.y.lessThanEqual(1)).and(d.z.lessThanEqual(1)),m=n.filterNode||gK[i.shadowMap.type]||null;if(null===m)throw Error("THREE.WebGPURenderer: Shadow map type not supported yet.");let g=op(a.texture,d),f=p.select(m({depthTexture:r,shadowCoord:d,shadow:n}),rA(1));this.shadowMap=a,this.shadowNode=f,this.shadowColorNode=s=this.colorNode.mul(aE(1,f.rgb.mix(g,1),o.mul(g.a))),this.baseColorNode=this.colorNode}this.colorNode=s,this.updateBeforeType=sO.RENDER}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):null!==this.shadowNode&&this.disposeShadow()}updateShadow(e){let{shadowMap:t,light:i}=this,{renderer:s,scene:r,camera:n}=e,a=t.depthTexture.version;this._depthVersionCached=a;let o=r.overrideMaterial;r.overrideMaterial=gQ,t.setSize(i.shadow.mapSize.width,i.shadow.mapSize.height),i.shadow.updateMatrices(i),i.shadow.camera.layers.mask=n.layers.mask;let l=s.getRenderTarget(),h=s.getRenderObjectFunction();s.setRenderObjectFunction((e,...t)=>{!0===e.castShadow&&s.renderObject(e,...t)}),s.setRenderTarget(t),s.render(r,i.shadow.camera),s.setRenderTarget(l),s.setRenderObjectFunction(h),r.overrideMaterial=o}disposeShadow(){this.shadowMap.dispose(),this.shadowMap=null,this.shadowNode=null,this.shadowColorNode=null,this.baseColorNode=null,this.updateBeforeType=sO.NONE}updateBefore(e){let t=this.light.shadow;(t.needsUpdate||t.autoUpdate)&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}update(){let{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}gZ.type=sW("AnalyticLight",gZ);let g0=rS(e=>{let{lightDistance:t,cutoffDistance:i,decayExponent:s}=e,r=t.pow(s).max(.01).reciprocal();return i.greaterThan(0).select(r.mul(t.div(i).pow4().oneMinus().clamp().pow2()),r)});class g1 extends gZ{constructor(e=null){super(e),this.cutoffDistanceNode=rQ(0),this.decayExponentNode=rQ(0)}update(e){let{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setup(e){let{colorNode:t,cutoffDistanceNode:i,decayExponentNode:s,light:r}=this,n=e.context.lightingModel,a=oM(r).sub(oU),o=a.normalize(),l=g0({lightDistance:a.length(),cutoffDistance:i,decayExponent:s}),h=t.mul(l),u=e.context.reflectedLight;n.direct({lightDirection:o,lightColor:h,reflectedLight:u},e.stack,e)}}g1.type=sW("PointLight",g1);class g2 extends gZ{constructor(e=null){super(e)}setup(e){super.setup(e);let t=e.context.lightingModel,i=this.colorNode,s=gJ(this.light),r=e.context.reflectedLight;t.direct({lightDirection:s,lightColor:i,reflectedLight:r},e.stack,e)}}g2.type=sW("DirectionalLight",g2);let g3=new eS,g4=new eS,g5=null;class g6 extends gZ{constructor(e=null){super(e),this.halfHeight=rQ(new $),this.halfWidth=rQ(new $)}update(e){super.update(e);let{light:t}=this,i=e.camera.matrixWorldInverse;g4.identity(),g3.copy(t.matrixWorld),g3.premultiply(i),g4.extractRotation(g3),this.halfWidth.value.set(.5*t.width,0,0),this.halfHeight.value.set(0,.5*t.height,0),this.halfWidth.value.applyMatrix4(g4),this.halfHeight.value.applyMatrix4(g4)}setup(e){let t,i;super.setup(e),e.isAvailable("float32Filterable")?(t=op(g5.LTC_FLOAT_1),i=op(g5.LTC_FLOAT_2)):(t=op(g5.LTC_HALF_1),i=op(g5.LTC_HALF_2));let{colorNode:s,light:r}=this,n=e.context.lightingModel,a=oM(r),o=e.context.reflectedLight;n.directRectArea({lightColor:s,lightPosition:a,halfWidth:this.halfWidth,halfHeight:this.halfHeight,reflectedLight:o,ltc_1:t,ltc_2:i},e.stack,e)}static setLTC(e){g5=e}}g6.type=sW("RectAreaLight",g6);class g8 extends gZ{constructor(e=null){super(e),this.coneCosNode=rQ(0),this.penumbraCosNode=rQ(0),this.cutoffDistanceNode=rQ(0),this.decayExponentNode=rQ(0)}update(e){super.update(e);let{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e){let{coneCosNode:t,penumbraCosNode:i}=this;return aP(t,i,e)}setup(e){super.setup(e);let t=e.context.lightingModel,{colorNode:i,cutoffDistanceNode:s,decayExponentNode:r,light:n}=this,a=oM(n).sub(oU),o=a.normalize(),l=o.dot(gJ(n)),h=this.getSpotAttenuation(l),u=g0({lightDistance:a.length(),cutoffDistance:s,decayExponent:r}),d=i.mul(h).mul(u),c=e.context.reflectedLight;t.direct({lightDirection:o,lightColor:d,reflectedLight:c},e.stack,e)}}g8.type=sW("SpotLight",g8);class g7 extends g8{getSpotAttenuation(e){let t=this.light.iesMap;return t&&!0===t.isTexture?op(t,rB(e.acos().mul(1/Math.PI),0),0).r:super.getSpotAttenuation(e)}}g7.type=sW("IESSpotLight",g7);class g9 extends gZ{constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}g9.type=sW("AmbientLight",g9);class fe extends gZ{constructor(e=null){super(e),this.lightPositionNode=o_(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=rQ(new tt)}update(e){let{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){let{colorNode:t,groundColorNode:i,lightDirectionNode:s}=this,r=aE(i,t,oW.dot(s).mul(.5).add(.5));e.context.irradiance.addAssign(r)}}fe.type=sW("HemisphereLight",fe);class ft extends gZ{constructor(e=null){super(e);let t=[];for(let e=0;e<9;e++)t.push(new $);this.lightProbe=o5(t)}update(e){let{light:t}=this;super.update(e);for(let e=0;e<9;e++)this.lightProbe.array[e].copy(t.sh.coefficients[e]).multiplyScalar(t.intensity)}setup(e){let t=fi(oH,this.lightProbe);e.context.irradiance.addAssign(t)}}ft.type=sW("LightProbe",ft);let fi=rS(([e,t])=>{let i=e.x,s=e.y,r=e.z,n=t.element(0).mul(.886227);return n.addAssign(t.element(1).mul(1.023328).mul(s)),n.addAssign(t.element(2).mul(1.023328).mul(r)),n.addAssign(t.element(3).mul(1.023328).mul(i)),n.addAssign(t.element(4).mul(.858086).mul(i).mul(s)),n.addAssign(t.element(5).mul(.858086).mul(s).mul(r)),n.addAssign(t.element(6).mul(r.mul(r).mul(.743125).sub(.247708))),n.addAssign(t.element(7).mul(.858086).mul(i).mul(r)),n.addAssign(t.element(8).mul(.429043).mul(nM(i,i).sub(nM(s,s)))),n});class fs{parseFunction(){console.warn("Abstract function.")}}class fr{constructor(e,t,i="",s=""){this.type=e,this.inputs=t,this.name=i,this.precision=s}getCode(){console.warn("Abstract function.")}}fr.isNodeFunction=!0;let fn=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,fa=/[a-z_0-9]+/ig,fo="#pragma main",fl=e=>{let t=(e=e.trim()).indexOf(fo),i=-1!==t?e.slice(t+fo.length):e,s=i.match(fn);if(null!==s&&5===s.length){let r=s[4],n=[],a=null;for(;null!==(a=fa.exec(r));)n.push(a);let o=[],l=0;for(;l<n.length;){let e="const"===n[l][0];!0===e&&l++;let t=n[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";let i=n[l++][0],s=Number.parseInt(n[l][0]);!1===Number.isNaN(s)?l++:s=null;let r=n[l++][0];o.push(new pZ(i,r,s,t,e))}let h=i.substring(s[0].length),u=void 0!==s[3]?s[3]:"";return{type:s[2],inputs:o,name:u,precision:void 0!==s[1]?s[1]:"",inputsCode:r,blockCode:h,headerCode:-1!==t?e.slice(0,t):""}}throw Error("FunctionNode: Function is not a GLSL code.")};class fh extends fr{constructor(e){let{type:t,inputs:i,name:s,precision:r,inputsCode:n,blockCode:a,headerCode:o}=fl(e);super(t,i,s,r),this.inputsCode=n,this.blockCode=a,this.headerCode=o}getCode(e=this.name){let t;let i=this.blockCode;if(""!==i){let{type:s,inputsCode:r,headerCode:n,precision:a}=this,o=`${s} ${e} ( ${r.trim()} )`;""!==a&&(o=`${a} ${o}`),t=n+o+i}else t="";return t}}class fu extends fs{parseFunction(e){return new fh(e)}}function fd(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function fc(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}class fp{constructor(){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparent=[],this.bundles=[],this.lightsNode=new hg([]),this.lightsArray=[],this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,i,s,r,n){let a=this.renderItems[this.renderItemsIndex];return void 0===a?(a={id:e.id,object:e,geometry:t,material:i,groupOrder:s,renderOrder:e.renderOrder,z:r,group:n},this.renderItems[this.renderItemsIndex]=a):(a.id=e.id,a.object=e,a.geometry=t,a.material=i,a.groupOrder=s,a.renderOrder=e.renderOrder,a.z=r,a.group=n),this.renderItemsIndex++,a}push(e,t,i,s,r,n){let a=this.getNextRenderItem(e,t,i,s,r,n);!0===e.occlusionTest&&this.occlusionQueryCount++,(!0===i.transparent||i.transmission>0?this.transparent:this.opaque).push(a)}unshift(e,t,i,s,r,n){let a=this.getNextRenderItem(e,t,i,s,r,n);(!0===i.transparent?this.transparent:this.opaque).unshift(a)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}getLightsNode(){return this.lightsNode.fromLights(this.lightsArray)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||fd),this.transparent.length>1&&this.transparent.sort(t||fc)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){let t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null}}}class fm{constructor(){this.lists=new cW}get(e,t){let i=this.lists,s=[e,t],r=i.get(s);return void 0===r&&(r=new fp,i.set(s,r)),r}dispose(){this.lists=new cW}}let fg=0;class ff{constructor(){this.id=fg++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new k,this.scissor=!1,this.scissorValue=new k,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.sampleCount=1,this.width=0,this.height=0,this.isRenderContext=!0}getCacheKey(){return fy(this)}}function fy(e){let{textures:t,activeCubeFace:i}=e,s="";for(let e of t)s+=e.id+",";return s+i}class fx{constructor(){this.chainMaps={}}get(e,t,i=null){let s;let r=[e,t];if(null===i)s="default";else{let e=i.texture.format,t=i.textures.length;s=`${t}:${e}:${i.samples}:${i.depthBuffer}:${i.stencilBuffer}`}let n=this.getChainMap(s),a=n.get(r);return void 0===a&&(a=new ff,n.set(r,a)),null!==i&&(a.sampleCount=0===i.samples?1:i.samples),a}getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new cW)}dispose(){this.chainMaps={}}}let fb=new $;class fv extends cY{constructor(e,t,i){super(),this.renderer=e,this.backend=t,this.info=i}updateRenderTarget(e,t=0){let i=this.get(e),s=0===e.samples?1:e.samples,r=i.depthTextureMips||(i.depthTextureMips={}),n=e.textures,a=this.getSize(n[0]),o=a.width>>t,l=a.height>>t,h=e.depthTexture||r[t],u=!1;void 0===h&&((h=new ib).format=e.stencilBuffer?1027:1026,h.type=e.stencilBuffer?1020:1014,h.image.width=o,h.image.height=l,r[t]=h),(i.width!==a.width||a.height!==i.height)&&(u=!0,h.needsUpdate=!0,h.image.width=o,h.image.height=l),i.width=a.width,i.height=a.height,i.textures=n,i.depthTexture=h,i.depth=e.depthBuffer,i.stencil=e.stencilBuffer,i.renderTarget=e,i.sampleCount!==s&&(u=!0,h.needsUpdate=!0,i.sampleCount=s);let d={sampleCount:s};for(let e=0;e<n.length;e++){let t=n[e];u&&(t.needsUpdate=!0),this.updateTexture(t,d)}if(this.updateTexture(h,d),!0!==i.initialized){i.initialized=!0;let t=()=>{e.removeEventListener("dispose",t);for(let e=0;e<n.length;e++)this._destroyTexture(n[e]);this._destroyTexture(h),this.delete(e)};e.addEventListener("dispose",t)}}updateTexture(e,t={}){let i=this.get(e);if(!0===i.initialized&&i.version===e.version)return;let s=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,r=this.backend;if(s&&!0===i.initialized&&(r.destroySampler(e),r.destroyTexture(e)),e.isFramebufferTexture){let t=this.renderer.getRenderTarget();t?e.type=t.texture.type:e.type=1009}let{width:n,height:a,depth:o}=this.getSize(e);if(t.width=n,t.height=a,t.depth=o,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,n,a):1,s||!0===e.isStorageTexture)r.createSampler(e),r.createTexture(e,t),i.generation=e.version;else if(!0!==i.initialized&&r.createSampler(e),e.version>0){let s=e.image;if(void 0===s)console.warn("THREE.Renderer: Texture marked for update but image is undefined.");else if(!1===s.complete)console.warn("THREE.Renderer: Texture marked for update but image is incomplete.");else{if(e.images){let i=[];for(let t of e.images)i.push(t);t.images=i}else t.image=s;(void 0===i.isDefaultTexture||!0===i.isDefaultTexture)&&(r.createTexture(e,t),i.isDefaultTexture=!1,i.generation=e.version),!0===e.source.dataReady&&r.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&r.generateMipmaps(e)}}else r.createDefaultTexture(e),i.isDefaultTexture=!0,i.generation=e.version;if(!0!==i.initialized){i.initialized=!0,i.generation=e.version,this.info.memory.textures++;let t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e),this.info.memory.textures--};e.addEventListener("dispose",t)}i.version=e.version}getSize(e,t=fb){let i=e.images?e.images[0]:e.image;return i?(void 0!==i.image&&(i=i.image),t.width=i.width,t.height=i.height,t.depth=e.isCubeTexture?6:i.depth||1):t.width=t.height=t.depth=1,t}getMipLevels(e,t,i){return e.isCompressedTexture?e.mipmaps.length:Math.floor(Math.log2(Math.max(t,i)))+1}needsMipmaps(e){return!!this.isEnvironmentTexture(e)||!0===e.isCompressedTexture||1003!==e.minFilter&&1006!==e.minFilter}isEnvironmentTexture(e){let t=e.mapping;return 303===t||304===t||301===t||302===t}_destroyTexture(e){this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e)}}class fT extends tt{constructor(e,t,i,s=1){super(e,t,i),this.a=s}set(e,t,i,s=1){return this.a=s,super.set(e,t,i)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}}let fS=rS(([e])=>{let t=e.toUint().mul(747796405).add(2891336453),i=t.shiftRight(t.shiftRight(28).add(4)).bitXor(t).mul(277803737);return i.shiftRight(22).bitXor(i).toFloat().mul(1/4294967296)}),f_=new WeakMap;class fM extends s${constructor(){super("vec2"),this.updateType=sO.OBJECT,this.updateAfterType=sO.OBJECT,this.previousProjectionMatrix=rQ(new eS),this.previousModelViewMatrix=rQ(new eS)}update({camera:e,object:t}){let i=fw(t),s=fw(e);this.previousModelViewMatrix.value.copy(i),this.previousProjectionMatrix.value.copy(s)}updateAfter({camera:e,object:t}){let i=fw(t),s=fw(e);i.copy(t.modelViewMatrix),s.copy(e.projectionMatrix)}setup(){let e=ob.mul(oN).mul(oB),t=this.previousProjectionMatrix.mul(this.previousModelViewMatrix).mul(oI);return n_(e.xy.div(e.w),t.xy.div(t.w))}}function fw(e){let t=f_.get(e);return void 0===t&&(t=new eS,f_.set(e,t)),t}fM.type=sW("Velocity",fM);let fN=rS(([e])=>aE(e.mul(.9478672986).add(.0521327014).pow(2.4),e.mul(.0773993808),e.lessThanEqual(.04045))).setLayout({name:"sRGBToLinear",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),fA=rS(([e])=>aE(e.pow(.41666).mul(1.055).sub(.055),e.mul(12.92),e.lessThanEqual(.0031308))).setLayout({name:"LinearTosRGB",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),fR=rS(([e,t])=>e.mul(t).clamp()).setLayout({name:"LinearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fC=rS(([e,t])=>(e=e.mul(t)).div(e.add(1)).clamp()).setLayout({name:"ReinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fE=rS(([e,t])=>{let i=(e=(e=e.mul(t)).sub(.004).max(0)).mul(e.mul(6.2).add(.5)),s=e.mul(e.mul(6.2).add(1.7)).add(.06);return i.div(s).pow(2.2)}).setLayout({name:"CineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fB=rS(([e])=>{let t=e.mul(e.add(.0245786)).sub(90537e-9),i=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(i)}),fI=rS(([e,t])=>{let i=rH(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),s=rH(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=fB(e=i.mul(e)),(e=s.mul(e)).clamp()}).setLayout({name:"ACESFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fP=rH(rU(1.6605,-.1246,-.0182),rU(-.5876,1.1329,-.1006),rU(-.0728,-.0083,1.1187)),fF=rH(rU(.6274,.0691,.0164),rU(.3293,.9195,.088),rU(.0433,.0113,.8956)),fU=rS(([e])=>{let t=rU(e).toVar(),i=rU(t.mul(t)).toVar(),s=rU(i.mul(i)).toVar();return rA(15.5).mul(s.mul(i)).sub(nM(40.14,s.mul(t))).add(nM(31.96,s).sub(nM(6.868,i.mul(t))).add(nM(.4298,i).add(nM(.1191,t).sub(.00232))))}),fO=rS(([e,t])=>{let i=rU(e).toVar(),s=rH(rU(.856627153315983,.137318972929847,.11189821299995),rU(.0951212405381588,.761241990602591,.0767994186031903),rU(.0482516061458583,.101439036467562,.811302368396859)),r=rH(rU(1.1271005818144368,-.1413297634984383,-.14132976349843826),rU(-.11060664309660323,1.157823702216272,-.11060664309660294),rU(-.016493938717834573,-.016493938717834257,1.2519364065950405)),n=rA(-12.47393),a=rA(4.026069);return i.mulAssign(t),i.assign(fF.mul(i)),i.assign(s.mul(i)),i.assign(ay(i,1e-10)),i.assign(n0(i)),i.assign(i.sub(n).div(a.sub(n))),i.assign(aB(i,0,1)),i.assign(fU(i)),i.assign(r.mul(i)),i.assign(aw(ay(rU(0),i),rU(2.2))),i.assign(fP.mul(i)),i.assign(aB(i,0,1)),i}).setLayout({name:"AgXToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fz=rS(([e,t])=>{let i=rA(.76),s=rA(.15),r=af((e=e.mul(t)).r,af(e.g,e.b)),n=az(r.lessThan(.08),r.sub(nM(6.25,r.mul(r))),.04);e.subAssign(n);let a=ay(e.r,ay(e.g,e.b));rw(a.lessThan(i),()=>e);let o=n_(1,i),l=n_(1,o.mul(o).div(a.add(o.sub(i))));e.mulAssign(l.div(a));let h=n_(1,nw(1,s.mul(a.sub(l)).add(1)));return aE(e,rU(l),h)}).setLayout({name:"NeutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fL=rS(([e,t,i])=>{let s=rA(i).toVar(),r=rA(t).toVar();return az(rE(e).toVar(),r,s)}).setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),fD=rS(([e,t])=>{let i=rE(t).toVar(),s=rA(e).toVar();return az(i,s.negate(),s)}).setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),fV=rS(([e])=>rR(n3(rA(e).toVar()))).setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),fk=rS(([e,t])=>{let i=rA(e).toVar();return t.assign(fV(i)),i.sub(rA(t))}),fG=p8([rS(([e,t,i,s,r,n])=>{let a=rA(n).toVar(),o=rA(r).toVar(),l=rA(s).toVar(),h=rA(i).toVar(),u=rA(t).toVar(),d=rA(e).toVar(),c=rA(n_(1,o)).toVar();return n_(1,a).mul(d.mul(c).add(u.mul(o))).add(a.mul(h.mul(c).add(l.mul(o))))}).setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),rS(([e,t,i,s,r,n])=>{let a=rA(n).toVar(),o=rA(r).toVar(),l=rU(s).toVar(),h=rU(i).toVar(),u=rU(t).toVar(),d=rU(e).toVar(),c=rA(n_(1,o)).toVar();return n_(1,a).mul(d.mul(c).add(u.mul(o))).add(a.mul(h.mul(c).add(l.mul(o))))}).setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]})]),fW=p8([rS(([e,t,i])=>{let s=rA(i).toVar(),r=rA(t).toVar(),n=rC(e).toVar(),a=rC(n.bitAnd(rC(7))).toVar(),o=rA(fL(a.lessThan(rC(4)),r,s)).toVar(),l=rA(nM(2,fL(a.lessThan(rC(4)),s,r))).toVar();return fD(o,rE(a.bitAnd(rC(1)))).add(fD(l,rE(a.bitAnd(rC(2)))))}).setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),rS(([e,t,i,s])=>{let r=rA(s).toVar(),n=rA(i).toVar(),a=rA(t).toVar(),o=rC(e).toVar(),l=rC(o.bitAnd(rC(15))).toVar(),h=rA(fL(l.lessThan(rC(8)),a,n)).toVar(),u=rA(fL(l.lessThan(rC(4)),n,fL(l.equal(rC(12)).or(l.equal(rC(14))),a,r))).toVar();return fD(h,rE(l.bitAnd(rC(1)))).add(fD(u,rE(l.bitAnd(rC(2)))))}).setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]})]),fH=p8([rS(([e,t,i])=>{let s=rA(i).toVar(),r=rA(t).toVar(),n=rz(e).toVar();return rU(fW(n.x,r,s),fW(n.y,r,s),fW(n.z,r,s))}).setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),rS(([e,t,i,s])=>{let r=rA(s).toVar(),n=rA(i).toVar(),a=rA(t).toVar(),o=rz(e).toVar();return rU(fW(o.x,a,n,r),fW(o.y,a,n,r),fW(o.z,a,n,r))}).setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]})]),fj=rS(([e])=>nM(.6616,rA(e).toVar())).setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),f$=rS(([e])=>nM(.982,rA(e).toVar())).setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),fq=p8([fj,rS(([e])=>nM(.6616,rU(e).toVar())).setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),fX=rS(([e,t])=>{let i=rR(t).toVar(),s=rC(e).toVar();return s.shiftLeft(i).bitOr(s.shiftRight(rR(32).sub(i)))}).setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),fY=rS(([e,t,i])=>{e.subAssign(i),e.bitXorAssign(fX(i,rR(4))),i.addAssign(t),t.subAssign(e),t.bitXorAssign(fX(e,rR(6))),e.addAssign(i),i.subAssign(t),i.bitXorAssign(fX(t,rR(8))),t.addAssign(e),e.subAssign(i),e.bitXorAssign(fX(i,rR(16))),i.addAssign(t),t.subAssign(e),t.bitXorAssign(fX(e,rR(19))),e.addAssign(i),i.subAssign(t),i.bitXorAssign(fX(t,rR(4))),t.addAssign(e)}),fJ=rS(([e,t,i])=>{let s=rC(i).toVar(),r=rC(t).toVar(),n=rC(e).toVar();return s.bitXorAssign(r),s.subAssign(fX(r,rR(14))),n.bitXorAssign(s),n.subAssign(fX(s,rR(11))),r.bitXorAssign(n),r.subAssign(fX(n,rR(25))),s.bitXorAssign(r),s.subAssign(fX(r,rR(16))),n.bitXorAssign(s),n.subAssign(fX(s,rR(4))),r.bitXorAssign(n),r.subAssign(fX(n,rR(14))),s.bitXorAssign(r),s.subAssign(fX(r,rR(24))),s}).setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),fK=rS(([e])=>rA(rC(e).toVar()).div(rA(rC(rR(4294967295))))).setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),fQ=rS(([e])=>{let t=rA(e).toVar();return t.mul(t).mul(t).mul(t.mul(t.mul(6).sub(15)).add(10))}).setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),fZ=rS(([e])=>{let t=rR(e).toVar(),i=rC(rC(1)).toVar(),s=rC(rC(rR(3735928559)).add(i.shiftLeft(rC(2))).add(rC(13))).toVar();return fJ(s.add(rC(t)),s,s)}).setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),f0=rS(([e,t])=>{let i=rR(t).toVar(),s=rR(e).toVar(),r=rC(rC(2)).toVar(),n=rC().toVar(),a=rC().toVar(),o=rC().toVar();return n.assign(a.assign(o.assign(rC(rR(3735928559)).add(r.shiftLeft(rC(2))).add(rC(13))))),n.addAssign(rC(s)),a.addAssign(rC(i)),fJ(n,a,o)}).setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),f1=p8([fZ,f0,rS(([e,t,i])=>{let s=rR(i).toVar(),r=rR(t).toVar(),n=rR(e).toVar(),a=rC(rC(3)).toVar(),o=rC().toVar(),l=rC().toVar(),h=rC().toVar();return o.assign(l.assign(h.assign(rC(rR(3735928559)).add(a.shiftLeft(rC(2))).add(rC(13))))),o.addAssign(rC(n)),l.addAssign(rC(r)),h.addAssign(rC(s)),fJ(o,l,h)}).setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),rS(([e,t,i,s])=>{let r=rR(s).toVar(),n=rR(i).toVar(),a=rR(t).toVar(),o=rR(e).toVar(),l=rC(rC(4)).toVar(),h=rC().toVar(),u=rC().toVar(),d=rC().toVar();return h.assign(u.assign(d.assign(rC(rR(3735928559)).add(l.shiftLeft(rC(2))).add(rC(13))))),h.addAssign(rC(o)),u.addAssign(rC(a)),d.addAssign(rC(n)),fY(h,u,d),h.addAssign(rC(r)),fJ(h,u,d)}).setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),rS(([e,t,i,s,r])=>{let n=rR(r).toVar(),a=rR(s).toVar(),o=rR(i).toVar(),l=rR(t).toVar(),h=rR(e).toVar(),u=rC(rC(5)).toVar(),d=rC().toVar(),c=rC().toVar(),p=rC().toVar();return d.assign(c.assign(p.assign(rC(rR(3735928559)).add(u.shiftLeft(rC(2))).add(rC(13))))),d.addAssign(rC(h)),c.addAssign(rC(l)),p.addAssign(rC(o)),fY(d,c,p),d.addAssign(rC(a)),c.addAssign(rC(n)),fJ(d,c,p)}).setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]})]),f2=p8([rS(([e,t])=>{let i=rR(t).toVar(),s=rC(f1(rR(e).toVar(),i)).toVar(),r=rz().toVar();return r.x.assign(s.bitAnd(rR(255))),r.y.assign(s.shiftRight(rR(8)).bitAnd(rR(255))),r.z.assign(s.shiftRight(rR(16)).bitAnd(rR(255))),r}).setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),rS(([e,t,i])=>{let s=rR(i).toVar(),r=rR(t).toVar(),n=rC(f1(rR(e).toVar(),r,s)).toVar(),a=rz().toVar();return a.x.assign(n.bitAnd(rR(255))),a.y.assign(n.shiftRight(rR(8)).bitAnd(rR(255))),a.z.assign(n.shiftRight(rR(16)).bitAnd(rR(255))),a}).setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]})]),f3=rS(([e])=>{let t=rR(fV(rA(e).toVar())).toVar();return rU(fK(f1(t,rR(0))),fK(f1(t,rR(1))),fK(f1(t,rR(2))))}).setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),f4=new fT;class f5 extends cY{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,i){let s=this.renderer,r=this.nodes.getBackgroundNode(e)||e.background,n=!1;if(null===r)s._clearColor.getRGB(f4,o),f4.a=s._clearColor.a;else if(!0===r.isColor)r.getRGB(f4,o),f4.a=1,n=!0;else if(!0===r.isNode){let i=this.get(e);f4.copy(s._clearColor);let n=i.backgroundMesh;if(void 0===n){let e=aD(rD(r).mul(mI),{getUV:()=>oH,getTextureLevel:()=>mB}),t=l2();t=t.setZ(t.w);let s=new hW;s.name="Background.material",s.side=1,s.depthTest=!1,s.depthWrite=!1,s.fog=!1,s.lights=!1,s.vertexNode=t,s.colorNode=e,i.backgroundMeshNode=e,i.backgroundMesh=n=new tk(new sc(1,32,32),s),n.frustumCulled=!1,n.name="Background.mesh",n.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)}}let a=r.getCacheKey();i.backgroundCacheKey!==a&&(i.backgroundMeshNode.node=rD(r).mul(mI),i.backgroundMeshNode.needsUpdate=!0,n.material.needsUpdate=!0,i.backgroundCacheKey=a),t.unshift(n,n.geometry,n.material,0,0,null)}else console.error("THREE.Renderer: Unsupported background configuration.",r);if(!0===s.autoClear||!0===n){f4.multiplyScalar(f4.a);let e=i.clearColorValue;e.r=f4.r,e.g=f4.g,e.b=f4.b,e.a=f4.a,i.depthClearValue=s._clearDepth,i.stencilClearValue=s._clearStencil,i.clearColor=!0===s.autoClearColor,i.clearDepth=!0===s.autoClearDepth,i.clearStencil=!0===s.autoClearStencil}else i.clearColor=!1,i.clearDepth=!1,i.clearStencil=!1}}class f6{constructor(e,t,i,s,r,n,a,o,l=!0,h=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=i,this.transforms=h,this.nodeAttributes=s,this.bindings=r,this.updateNodes=n,this.updateBeforeNodes=a,this.updateAfterNodes=o,this.instanceBindGroups=l,this.usedTimes=0}createBindings(){let e=[];for(let t of this.bindings)if(!0!==(this.instanceBindGroups&&t.bindings[0].groupNode.shared)){let i=new p$(t.name,[],t.index,t);for(let s of(e.push(i),t.bindings))i.bindings.push(s.clone())}else e.push(t);return e}}let f8=new WeakMap;class f7 extends cY{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new pQ,this.nodeBuilderCache=new Map,this.callHashCache=new cW,this.groupsData=new cW}updateGroup(e){let t=e.groupNode,i=t.name;if(i===rJ.name)return!0;if(i===rY.name){let t=this.get(e),i=this.nodeFrame.renderId;return t.renderId!==i&&(t.renderId=i,!0)}if(i===rX.name){let t=this.get(e),i=this.nodeFrame.frameId;return t.frameId!==i&&(t.frameId=i,!0)}let s=[t,e],r=this.groupsData.get(s);return void 0===r&&this.groupsData.set(s,r={}),r.version!==t.version&&(r.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){let t=this.get(e),i=t.nodeBuilderState;if(void 0===i){let{nodeBuilderCache:s}=this,r=this.getForRenderCacheKey(e);if(void 0===(i=s.get(r))){let t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,t.build(),i=this._createNodeBuilderState(t),s.set(r,i)}i.usedTimes++,t.nodeBuilderState=i}return i}delete(e){if(e.isRenderObject){let t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){let t=this.get(e),i=t.nodeBuilderState;if(void 0===i){let s=this.backend.createNodeBuilder(e,this.renderer);s.build(),i=this._createNodeBuilderState(s),t.nodeBuilderState=i}return i}_createNodeBuilderState(e){return new f6(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.instanceBindGroups,e.transforms)}getEnvironmentNode(e){return e.environmentNode||this.get(e).environmentNode||null}getBackgroundNode(e){return e.backgroundNode||this.get(e).backgroundNode||null}getFogNode(e){return e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){let i=[e,t],s=this.renderer.info.calls,r=this.callHashCache.get(i);if(void 0===r||r.callId!==s){let n=this.getEnvironmentNode(e),a=this.getFogNode(e),o=[];t&&o.push(t.getCacheKey(!0)),n&&o.push(n.getCacheKey()),a&&o.push(a.getCacheKey()),r={callId:s,cacheKey:o.join(",")},this.callHashCache.set(i,r)}return r.cacheKey}updateScene(e){this.updateEnvironment(e),this.updateFog(e),this.updateBackground(e)}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){let t=this.get(e),i=e.background;if(i){let s=0===e.backgroundBlurriness&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&0===t.backgroundBlurriness;if(t.background!==i||s){let s=null;!0===i.isCubeTexture||303===i.mapping||304===i.mapping?s=e.backgroundBlurriness>0?dv(i,oH):h9(!0===i.isCubeTexture?o0(i):op(i)):!0===i.isTexture?s=op(i,hN.flipY()).setUpdateMatrix(!0):!0!==i.isColor&&console.error("WebGPUNodes: Unsupported background configuration.",i),t.backgroundNode=s,t.background=i,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}updateFog(e){let t=this.get(e),i=e.fog;if(i){if(t.fog!==i){let e=null;i.isFogExp2?e=gj(o7("color","color",i),o7("density","float",i)):i.isFog?e=gW(o7("color","color",i),o7("near","float",i),o7("far","float",i)):console.error("WebGPUNodes: Unsupported fog configuration.",i),t.fogNode=e,t.fog=i}}else delete t.fogNode,delete t.fog}updateEnvironment(e){let t=this.get(e),i=e.environment;if(i){if(t.environment!==i){let e=null;!0===i.isCubeTexture?e=o0(i):!0===i.isTexture?e=op(i):console.error("Nodes: Unsupported environment configuration.",i),t.environmentNode=e,t.environment=i}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,i=null,s=null,r=null){let n=this.nodeFrame;return n.renderer=e,n.scene=t,n.object=i,n.camera=s,n.material=r,n}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){let e=this.renderer;return e.toneMapping+","+e.currentColorSpace}hasOutputChange(e){return f8.get(e)!==this.getOutputCacheKey()}getOutputNode(e){let t=this.renderer,i=this.getOutputCacheKey(),s=op(e,hN).renderOutput(t.toneMapping,t.currentColorSpace);return f8.set(e,i),s}updateBefore(e){for(let t of e.getNodeBuilderState().updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(t)}updateAfter(e){for(let t of e.getNodeBuilderState().updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(t)}updateForCompute(e){let t=this.getNodeFrame();for(let i of this.getForCompute(e).updateNodes)t.updateNode(i)}updateForRender(e){let t=this.getNodeFrameForRender(e);for(let i of e.getNodeBuilderState().updateNodes)t.updateNode(i)}dispose(){super.dispose(),this.nodeFrame=new pQ,this.nodeBuilderCache=new Map}}class f9{constructor(e,t){this.scene=e,this.camera=t}clone(){return Object.assign(new this.constructor,this)}}class ye{constructor(){this.lists=new cW}get(e,t){let i=this.lists,s=[e,t],r=i.get(s);return void 0===r&&(r=new f9(e,t),i.set(s,r)),r}dispose(){this.lists=new cW}}class yt{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map,this.colorSpaceNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null,i=this.getMaterialNodeClass(e.type);if(null!==i)for(let s in t=new i,e)t[s]=e[s];return t}addColorSpace(e,t){this.addType(e,t,this.colorSpaceNodes)}getColorSpaceFunction(e){return this.colorSpaceNodes.get(e)||null}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t.name,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,i){if(i.has(t)){console.warn(`Redefinition of node ${t}`);return}if("function"!=typeof e)throw Error(`Node class ${e.name} is not a class.`);if("function"==typeof t||"object"==typeof t)throw Error(`Base class ${t} is not a class.`);i.set(t,e)}addClass(e,t,i){if(i.has(t)){console.warn(`Redefinition of node ${t.name}`);return}if("function"!=typeof e)throw Error(`Node class ${e.name} is not a class.`);if("function"!=typeof t)throw Error(`Base class ${t.name} is not a class.`);i.set(t,e)}}let yi=new t2,ys=new S,yr=new k,yn=new im,ya=new eS,yo=new $;class yl{constructor(e,t={}){this.isRenderer=!0;let{logarithmicDepthBuffer:i=!1,alpha:s=!0,antialias:r=!1,samples:n=0,getFallback:o=null}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=n||!0===r?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=s,this.logarithmicDepthBuffer=i,this.outputColorSpace=a,this.toneMapping=0,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=!0,this.stencil=!1,this.clippingPlanes=[],this.info=new c1,this.nodes={library:new yt},this._getFallback=o,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new k(0,0,this._width,this._height),this._scissor=new k(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new m_(new hW),this._quad.material.type="Renderer_output",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;let l=!0===this.alpha?0:1;this._clearColor=new fT(0,0,0,l),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:1},this.xr={enabled:!1},this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,i)=>{await this.compileAsync(e,t);let s=this._renderLists.get(e,t),r=this._renderContexts.get(e,t,this._renderTarget),n=e.overrideMaterial||i.material,{fragmentShader:a,vertexShader:o}=this._objects.get(i,n,e,t,s.lightsNode,r).getNodeBuilderState();return{fragmentShader:a,vertexShader:o}}}}async init(){if(this._initialized)throw Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise(async(e,t)=>{let i=this.backend;try{await i.init(this)}catch(e){if(null!==this._getFallback)try{this.backend=i=this._getFallback(e),await i.init(this)}catch(e){t(e);return}else{t(e);return}}this._nodes=new f7(this,i),this._animation=new cG(this._nodes,this.info),this._attributes=new cK(i),this._background=new f5(this,this._nodes),this._geometries=new c0(this._attributes,this.info),this._textures=new fv(this,i,this.info),this._pipelines=new c8(i,this._nodes),this._bindings=new c7(i,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new cX(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new fm,this._bundles=new ye,this._renderContexts=new fx,this._initialized=!0,e()})),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,i=null){!1===this._initialized&&await this.init();let s=this._nodes.nodeFrame,r=s.renderId,n=this._currentRenderContext,a=this._currentRenderObjectFunction,o=this._compilationPromises,l=!0===e.isScene?e:yi;null===i&&(i=e);let h=this._renderTarget,u=this._renderContexts.get(i,t,h),d=this._activeMipmapLevel,c=[];this._currentRenderContext=u,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=c,s.renderId++,s.update(),u.depth=this.depth,u.stencil=this.stencil,u.clippingContext||(u.clippingContext=new cj),u.clippingContext.updateGlobal(this,t),l.onBeforeRender(this,e,t,h);let p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p),i!==e&&i.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&p.pushLight(e)}),p.finish(),null!==h){this._textures.updateRenderTarget(h,d);let e=this._textures.get(h);u.textures=e.textures,u.depthTexture=e.depthTexture}else u.textures=null,u.depthTexture=null;this._nodes.updateScene(l),this._background.update(l,p,u);let m=p.opaque,g=p.transparent,f=p.lightsNode;!0===this.opaque&&m.length>0&&this._renderObjects(m,t,l,f),!0===this.transparent&&g.length>0&&this._renderObjects(g,t,l,f),s.renderId=r,this._currentRenderContext=n,this._currentRenderObjectFunction=a,this._compilationPromises=o,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(c)}async renderAsync(e,t){!1===this._initialized&&await this.init();let i=this._renderScene(e,t);await this.backend.resolveTimestampAsync(i,"render")}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}_renderBundle(e,t,i){let{object:s,camera:r,renderList:n}=e,a=this._currentRenderContext,o=this._bundles.get(s,r),l=this.backend.get(o);void 0===l.renderContexts&&(l.renderContexts=new Set);let h=!1===l.renderContexts.has(a)||!0===s.needsUpdate;if(l.renderContexts.add(a),h){this.backend.beginBundle(a),(void 0===l.renderObjects||!0===s.needsUpdate)&&(l.renderObjects=[]),this._currentRenderBundle=o;let e=n.opaque;e.length>0&&this._renderObjects(e,r,t,i),this._currentRenderBundle=null,this.backend.finishBundle(a,o),s.needsUpdate=!1}else{let e=l.renderObjects;for(let t=0,i=e.length;t<i;t++){let i=e[t];this._nodes.updateBefore(i),i.object.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,i.object.matrixWorld),i.object.normalMatrix.getNormalMatrix(i.object.modelViewMatrix),this._nodes.updateForRender(i),this._bindings.updateForRender(i),this._nodes.updateAfter(i)}}this.backend.addBundle(a,o)}render(e,t){if(!1===this._initialized)return console.warn("THREE.Renderer: .render() called before the backend is initialized. Try using .renderAsync() instead."),this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){let{currentToneMapping:e,currentColorSpace:t}=this,i=t!==o;if(!1==(0!==e)&&!1===i)return null;let{width:s,height:r}=this.getDrawingBufferSize(ys),{depth:n,stencil:a}=this,l=this._frameBufferTarget;return null===l&&((l=new G(s,r,{depthBuffer:n,stencilBuffer:a,type:1016,format:1023,colorSpace:o,generateMipmaps:!1,minFilter:1006,magFilter:1006,samples:this.samples})).isPostProcessingRenderTarget=!0,this._frameBufferTarget=l),l.depthBuffer=n,l.stencilBuffer=a,l.setSize(s,r),l.viewport.copy(this._viewport),l.scissor.copy(this._scissor),l.viewport.multiplyScalar(this._pixelRatio),l.scissor.multiplyScalar(this._pixelRatio),l.scissorTest=this._scissorTest,l}_renderScene(e,t,i=!0){let s;let r=i?this._getFrameBufferTarget():null,n=this._nodes.nodeFrame,a=n.renderId,o=this._currentRenderContext,l=this._currentRenderObjectFunction,h=!0===e.isScene?e:yi,u=this._renderTarget,d=this._activeCubeFace,c=this._activeMipmapLevel;null!==r?(s=r,this.setRenderTarget(s)):s=u;let p=this._renderContexts.get(e,t,s);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,n.renderId=this.info.calls;let m=this.coordinateSystem;t.coordinateSystem!==m&&(t.coordinateSystem=m,t.updateProjectionMatrix()),!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld();let g=this._viewport,f=this._scissor,y=this._pixelRatio;null!==s&&(g=s.viewport,f=s.scissor,y=1),this.getDrawingBufferSize(ys),yr.set(0,0,ys.width,ys.height);let x=void 0===g.minDepth?0:g.minDepth,b=void 0===g.maxDepth?1:g.maxDepth;p.viewportValue.copy(g).multiplyScalar(y).floor(),p.viewportValue.width>>=c,p.viewportValue.height>>=c,p.viewportValue.minDepth=x,p.viewportValue.maxDepth=b,p.viewport=!1===p.viewportValue.equals(yr),p.scissorValue.copy(f).multiplyScalar(y).floor(),p.scissor=this._scissorTest&&!1===p.scissorValue.equals(yr),p.scissorValue.width>>=c,p.scissorValue.height>>=c,p.clippingContext||(p.clippingContext=new cj),p.clippingContext.updateGlobal(this,t),h.onBeforeRender(this,e,t,s),ya.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),yn.setFromProjectionMatrix(ya,m);let v=this._renderLists.get(e,t);if(v.begin(),this._projectObject(e,t,0,v),v.finish(),!0===this.sortObjects&&v.sort(this._opaqueSort,this._transparentSort),null!==s){this._textures.updateRenderTarget(s,c);let e=this._textures.get(s);p.textures=e.textures,p.depthTexture=e.depthTexture,p.width=e.width,p.height=e.height,p.renderTarget=s,p.depth=s.depthBuffer,p.stencil=s.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=this.domElement.width,p.height=this.domElement.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=c,p.height>>=c,p.activeCubeFace=d,p.activeMipmapLevel=c,p.occlusionQueryCount=v.occlusionQueryCount,this._nodes.updateScene(h),this._background.update(h,v,p),this.backend.beginRender(p);let T=v.opaque,S=v.transparent,_=v.bundles,M=v.lightsNode;if(_.length>0&&this._renderBundles(_,h,M),!0===this.opaque&&T.length>0&&this._renderObjects(T,t,h,M),!0===this.transparent&&S.length>0&&this._renderObjects(S,t,h,M),this.backend.finishRender(p),n.renderId=a,this._currentRenderContext=o,this._currentRenderObjectFunction=l,null!==r){this.setRenderTarget(u,d,c);let e=this._quad;this._nodes.hasOutputChange(s.texture)&&(e.material.fragmentNode=this._nodes.getOutputNode(s.texture),e.material.needsUpdate=!0),this._renderScene(e,e.camera,!1)}return h.onAfterRender(this,e,t,s),p}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio=e,this.setSize(this._width,this._height,!1)}setDrawingBufferSize(e,t,i){this._width=e,this._height=t,this._pixelRatio=i,this.domElement.width=Math.floor(e*i),this.domElement.height=Math.floor(t*i),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setSize(e,t,i=!0){this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===i&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){let t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,i,s){let r=this._scissor;e.isVector4?r.copy(e):r.set(e,t,i,s)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,i,s,r=0,n=1){let a=this._viewport;e.isVector4?a.copy(e):a.set(e,t,i,s),a.minDepth=r,a.maxDepth=n}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){let t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,i=!0){if(!1===this._initialized)return console.warn("THREE.Renderer: .clear() called before the backend is initialized. Try using .clearAsync() instead."),this.clearAsync(e,t,i);let s=this._renderTarget||this._getFrameBufferTarget(),r=null;if(null!==s&&(this._textures.updateRenderTarget(s),r=this._textures.get(s)),this.backend.clear(e,t,i,r),null!==s&&null===this._renderTarget){let e=this._quad;this._nodes.hasOutputChange(s.texture)&&(e.material.fragmentNode=this._nodes.getOutputNode(s.texture),e.material.needsUpdate=!0),this._renderScene(e,e.camera,!1)}}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,i=!0){!1===this._initialized&&await this.init(),this.clear(e,t,i)}clearColorAsync(){return this.clearAsync(!0,!1,!1)}clearDepthAsync(){return this.clearAsync(!1,!0,!1)}clearStencilAsync(){return this.clearAsync(!1,!1,!0)}get currentToneMapping(){return null!==this._renderTarget?0:this.toneMapping}get currentColorSpace(){return null!==this._renderTarget?o:this.outputColorSpace}dispose(){this.info.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,i=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=i}getRenderTarget(){return this._renderTarget}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}async computeAsync(e){!1===this._initialized&&await this.init();let t=this._nodes.nodeFrame,i=t.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,t.renderId=this.info.calls;let s=this.backend,r=this._pipelines,n=this._bindings,a=this._nodes,o=Array.isArray(e)?e:[e];if(void 0===o[0]||!0!==o[0].isComputeNode)throw Error("THREE.Renderer: .compute() expects a ComputeNode.");for(let t of(s.beginCompute(e),o)){if(!1===r.has(t)){let e=()=>{t.removeEventListener("dispose",e),r.delete(t),n.delete(t),a.delete(t)};t.addEventListener("dispose",e),t.onInit({renderer:this})}a.updateForCompute(t),n.updateForCompute(t);let i=n.getForCompute(t),o=r.getForCompute(t,i);s.compute(e,t,i,o)}s.finishCompute(e),await this.backend.resolveTimestampAsync(e,"compute"),t.renderId=i}async hasFeatureAsync(e){return!1===this._initialized&&await this.init(),this.backend.hasFeature(e)}hasFeature(e){return!1===this._initialized?(console.warn("THREE.Renderer: .hasFeature() called before the backend is initialized. Try using .hasFeatureAsync() instead."),!1):this.backend.hasFeature(e)}copyFramebufferToTexture(e){let t=this._currentRenderContext;this._textures.updateTexture(e),this.backend.copyFramebufferToTexture(e,t)}copyTextureToTexture(e,t,i=null,s=null,r=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,i,s,r)}readRenderTargetPixelsAsync(e,t,i,s,r,n=0){return this.backend.copyTextureToBuffer(e.textures[n],t,i,s,r)}_projectObject(e,t,i,s){if(!1===e.visible)return;if(e.layers.test(t.layers)){if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)s.pushLight(e);else if(e.isSprite){if(!e.frustumCulled||yn.intersectsSprite(e)){!0===this.sortObjects&&yo.setFromMatrixPosition(e.matrixWorld).applyMatrix4(ya);let t=e.geometry,r=e.material;r.visible&&s.push(e,t,r,i,yo.z,null)}}else if(e.isLineLoop)console.error("THREE.Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||yn.intersectsObject(e))){let t=e.geometry,r=e.material;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),yo.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(ya)),Array.isArray(r)){let n=t.groups;for(let a=0,o=n.length;a<o;a++){let o=n[a],l=r[o.materialIndex];l&&l.visible&&s.push(e,t,l,i,yo.z,o)}}else r.visible&&s.push(e,t,r,i,yo.z,null)}}if(!0===e.static&&void 0!==this.backend.beginBundle){let i=s;(s=this._renderLists.get(e,t)).begin(),i.pushBundle({object:e,camera:t,renderList:s}),s.finish()}let r=e.children;for(let e=0,n=r.length;e<n;e++)this._projectObject(r[e],t,i,s)}_renderBundles(e,t,i){for(let s of e)this._renderBundle(s,t,i)}_renderObjects(e,t,i,s){for(let r=0,n=e.length;r<n;r++){let{object:n,geometry:a,material:o,group:l}=e[r];if(t.isArrayCamera){let e=t.cameras;for(let t=0,r=e.length;t<r;t++){let r=e[t];if(n.layers.test(r.layers)){let e=r.viewport,t=void 0===e.minDepth?0:e.minDepth,h=void 0===e.maxDepth?1:e.maxDepth,u=this._currentRenderContext.viewportValue;u.copy(e).multiplyScalar(this._pixelRatio).floor(),u.minDepth=t,u.maxDepth=h,this.backend.updateViewport(this._currentRenderContext),this._currentRenderObjectFunction(n,i,r,a,o,l,s)}}}else this._currentRenderObjectFunction(n,i,t,a,o,l,s)}}renderObject(e,t,i,s,r,n,a){let o,l,h;if(e.onBeforeRender(this,t,i,s,r,n),null!==t.overrideMaterial){let e=t.overrideMaterial;r.positionNode&&r.positionNode.isNode&&(o=e.positionNode,e.positionNode=r.positionNode),e.isShadowNodeMaterial&&(e.side=null===r.shadowSide?r.side:r.shadowSide,r.depthNode&&r.depthNode.isNode&&(h=e.depthNode,e.depthNode=r.depthNode),r.shadowNode&&r.shadowNode.isNode&&(l=e.fragmentNode,e.fragmentNode=r.shadowNode),this.localClippingEnabled&&(r.clipShadows?(e.clippingPlanes!==r.clippingPlanes&&(e.clippingPlanes=r.clippingPlanes,e.needsUpdate=!0),e.clipIntersection!==r.clipIntersection&&(e.clipIntersection=r.clipIntersection)):Array.isArray(e.clippingPlanes)&&(e.clippingPlanes=null,e.needsUpdate=!0))),r=e}!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=1,this._handleObjectFunction(e,r,t,i,a,n,"backSide"),r.side=0,this._handleObjectFunction(e,r,t,i,a,n),r.side=2):this._handleObjectFunction(e,r,t,i,a,n),void 0!==o&&(t.overrideMaterial.positionNode=o),void 0!==h&&(t.overrideMaterial.depthNode=h),void 0!==l&&(t.overrideMaterial.fragmentNode=l),e.onAfterRender(this,t,i,s,r,n)}_renderObjectDirect(e,t,i,s,r,n,a){let o=this._objects.get(e,t,i,s,r,this._currentRenderContext,a);o.drawRange=n||e.geometry.drawRange,this._nodes.updateBefore(o),e.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),this._nodes.updateForRender(o),this._geometries.updateForRender(o),this._bindings.updateForRender(o),this._pipelines.updateForRender(o),null!==this._currentRenderBundle&&this.backend.get(this._currentRenderBundle).renderObjects.push(o),this.backend.draw(o,this.info),this._nodes.updateAfter(o)}_createObjectPipeline(e,t,i,s,r,n){let a=this._objects.get(e,t,i,s,r,this._currentRenderContext,n);this._nodes.updateBefore(a),this._nodes.updateForRender(a),this._geometries.updateForRender(a),this._bindings.updateForRender(a),this._pipelines.getForRender(a,this._compilationPromises),this._nodes.updateAfter(a)}get compute(){return this.computeAsync}get compile(){return this.compileAsync}}class yh extends cg{constructor(e,t,i,s,r,n){super(e,t,i,s,r,n),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}class yu extends yt{constructor(){super(),this.addMaterial(ug,sT),this.addMaterial(dN,sb),this.addMaterial(dR,sv),this.addMaterial(dF,sS),this.addMaterial(un,tn),this.addMaterial(up,sM),this.addMaterial(h1,s_),this.addMaterial(dL,sA),this.addMaterial(hX,ig),this.addMaterial(hJ,sR),this.addMaterial(dV,iy),this.addMaterial(dH,t6),this.addMaterial(dq,sy),this.addLight(g1,cv),this.addLight(g2,c_),this.addLight(g6,cw),this.addLight(g8,cg),this.addLight(g9,cM),this.addLight(fe,ch),this.addLight(ft,cA),this.addLight(g7,yh),this.addToneMapping(fR,1),this.addToneMapping(fC,2),this.addToneMapping(fE,3),this.addToneMapping(fI,4),this.addToneMapping(fO,6),this.addToneMapping(fz,7),this.addColorSpace(fA,aj(o,a)),this.addColorSpace(fN,aj(a,o))}}class yd extends yl{constructor(e,t={}){super(e,t),this.isStandardRenderer=!0,this.nodes.library=new yu}}class yc{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}}class yp extends yc{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){var e;return(e=this._buffer.byteLength)+(16-e%16)%16}get buffer(){return this._buffer}update(){return!0}}class ym extends yp{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}let yg=0;class yf extends ym{constructor(e,t){super("UniformBuffer_"+yg++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class yy extends ym{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){let t=this.uniforms.indexOf(e);return -1!==t&&this.uniforms.splice(t,1),this}get values(){return null===this._values&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;return null===e&&(e=new Float32Array(new ArrayBuffer(this.byteLength)),this._buffer=e),e}get byteLength(){let e=0;for(let t=0,i=this.uniforms.length;t<i;t++){let i=this.uniforms[t],{boundary:s,itemSize:r}=i,n=e%16,a=16-n;0!==n&&a-s<0?e+=16-n:n%s!=0&&(e+=n%s),i.offset=e/this.bytesPerElement,e+=r*this.bytesPerElement}return 16*Math.ceil(e/16)}update(){let e=!1;for(let t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isNumberUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void console.error("THREE.WebGPUUniformsGroup: Unsupported uniform type.",e)}updateNumber(e){let t=!1,i=this.values,s=e.getValue(),r=e.offset;return i[r]!==s&&(this.buffer[r]=i[r]=s,t=!0),t}updateVector2(e){let t=!1,i=this.values,s=e.getValue(),r=e.offset;if(i[r+0]!==s.x||i[r+1]!==s.y){let e=this.buffer;e[r+0]=i[r+0]=s.x,e[r+1]=i[r+1]=s.y,t=!0}return t}updateVector3(e){let t=!1,i=this.values,s=e.getValue(),r=e.offset;if(i[r+0]!==s.x||i[r+1]!==s.y||i[r+2]!==s.z){let e=this.buffer;e[r+0]=i[r+0]=s.x,e[r+1]=i[r+1]=s.y,e[r+2]=i[r+2]=s.z,t=!0}return t}updateVector4(e){let t=!1,i=this.values,s=e.getValue(),r=e.offset;if(i[r+0]!==s.x||i[r+1]!==s.y||i[r+2]!==s.z||i[r+4]!==s.w){let e=this.buffer;e[r+0]=i[r+0]=s.x,e[r+1]=i[r+1]=s.y,e[r+2]=i[r+2]=s.z,e[r+3]=i[r+3]=s.w,t=!0}return t}updateColor(e){let t=!1,i=this.values,s=e.getValue(),r=e.offset;if(i[r+0]!==s.r||i[r+1]!==s.g||i[r+2]!==s.b){let e=this.buffer;e[r+0]=i[r+0]=s.r,e[r+1]=i[r+1]=s.g,e[r+2]=i[r+2]=s.b,t=!0}return t}updateMatrix3(e){let t=!1,i=this.values,s=e.getValue().elements,r=e.offset;if(i[r+0]!==s[0]||i[r+1]!==s[1]||i[r+2]!==s[2]||i[r+4]!==s[3]||i[r+5]!==s[4]||i[r+6]!==s[5]||i[r+8]!==s[6]||i[r+9]!==s[7]||i[r+10]!==s[8]){let e=this.buffer;e[r+0]=i[r+0]=s[0],e[r+1]=i[r+1]=s[1],e[r+2]=i[r+2]=s[2],e[r+4]=i[r+4]=s[3],e[r+5]=i[r+5]=s[4],e[r+6]=i[r+6]=s[5],e[r+8]=i[r+8]=s[6],e[r+9]=i[r+9]=s[7],e[r+10]=i[r+10]=s[8],t=!0}return t}updateMatrix4(e){let t=!1,i=this.values,s=e.getValue().elements,r=e.offset;return!1===function(e,t,i){for(let s=0,r=t.length;s<r;s++)if(e[i+s]!==t[s])return!1;return!0}(i,s,r)&&(this.buffer.set(s,r),function(e,t,i){for(let s=0,r=t.length;s<r;s++)e[i+s]=t[s]}(i,s,r),t=!0),t}}let yx=0;class yb extends yy{constructor(e,t){super(e),this.id=yx++,this.groupNode=t,this.isNodeUniformsGroup=!0}getNodes(){let e=[];for(let t of this.uniforms){let i=t.nodeUniform.node;if(!i)throw Error("NodeUniformsGroup: Uniform has no node.");e.push(i)}return e}}let yv=0;class yT extends yc{constructor(e,t){super(e),this.id=yv++,this.texture=t,this.version=t?t.version:0,this.store=!1,this.generation=null,this.isSampledTexture=!0}needsBindingsUpdate(e){let{texture:t}=this;return e!==this.generation?(this.generation=e,!0):t.isVideoTexture}update(){let{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}}class yS extends yT{constructor(e,t,i,s=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=i,this.access=s}needsBindingsUpdate(e){return this.textureNode.value!==this.texture||super.needsBindingsUpdate(e)}update(){let{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class y_ extends yS{constructor(e,t,i,s){super(e,t,i,s),this.isSampledCubeTexture=!0}}class yM extends yS{constructor(e,t,i,s){super(e,t,i,s),this.isSampledTexture3D=!0}}let yw={atan2:"atan",textureDimensions:"textureSize",equals:"equal"},yN={low:"lowp",medium:"mediump",high:"highp"},yA={swizzleAssign:!0,storageBuffer:!1},yR=`
precision highp float;
precision highp int;
precision highp sampler2D;
precision highp sampler3D;
precision highp samplerCube;
precision highp sampler2DArray;

precision highp usampler2D;
precision highp usampler3D;
precision highp usamplerCube;
precision highp usampler2DArray;

precision highp isampler2D;
precision highp isampler3D;
precision highp isamplerCube;
precision highp isampler2DArray;

precision lowp sampler2DShadow;
`;class yC extends pK{constructor(e,t){super(e,t,new fu),this.uniformGroups={},this.transforms=[],this.extensions={},this.instanceBindGroups=!1,this.useComparisonMethod=!0}needsColorSpaceToLinearSRGB(e){return!0===e.isVideoTexture&&""!==e.colorSpace}getMethod(e){return yw[e]||e}getOutputStructName(){return""}buildFunctionCode(e){let t=e.layout,i=this.flowShaderNode(e),s=[];for(let e of t.inputs)s.push(this.getType(e.type)+" "+e.name);return`${this.getType(t.type)} ${t.name}( ${s.join(", ")} ) {

	${i.vars}

${i.code}
	return ${i.result};

}`}setupPBO(e){let t=e.value;if(void 0===t.pbo){let e=t.array,i=t.count*t.itemSize,{itemSize:s}=t,r=t.array.constructor.name.toLowerCase().includes("int"),n=r?1029:1028;2===s?n=r?1031:1030:3===s?n=r?1032:1022:4===s&&(n=r?1033:1023);let a=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(i/s)))),o=Math.ceil(i/s/a);a*o*s<i&&o++;let l=a*o*s,h=new e.constructor(l);h.set(e,0),t.array=h;let u=new t8(t.array,a,o,n,{Float32Array:1015,Uint8Array:1009,Uint16Array:1012,Uint32Array:1014,Int8Array:1010,Int16Array:1011,Int32Array:1013,Uint8ClampedArray:1009}[t.array.constructor.name]||1015);u.needsUpdate=!0,u.isPBOTexture=!0;let d=new oc(u,null,null);d.setPrecision("high"),t.pboNode=d,t.pbo=d.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.label)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&!0!==e.node.isTextureNode&&!0!==e.node.isBufferNode?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){let{node:t,indexNode:i}=e,s=t.value;this.renderer.backend.has(s)&&(this.renderer.backend.get(s).pbo=s.pbo);let r=this.getUniformFromNode(s.pboNode,"texture",this.shaderStage,this.context.label),n=this.getPropertyName(r);this.increaseUsage(i);let a=i.build(this,"uint"),o=this.getDataFromNode(e),l=o.propertyName;if(void 0===l){let i=this.getVarFromNode(e);l=this.getPropertyName(i);let r=this.getDataFromNode(t),h=r.propertySizeName;void 0===h&&(h=l+"Size",this.getVarFromNode(t,h,"uint"),this.addLineFlowCode(`${h} = uint( textureSize( ${n}, 0 ).x )`),r.propertySizeName=h);let{itemSize:u}=s,d="."+sD.join("").slice(0,u),c=`ivec2(${a} % ${h}, ${a} / ${h})`,p=this.generateTextureLoad(null,n,c,null,"0"),m="vec4";1014===s.pbo.type?m="uvec4":1013===s.pbo.type&&(m="ivec4"),this.addLineFlowCode(`${l} = ${m}(${p})${d}`),o.propertyName=l}return l}generateTextureLoad(e,t,i,s,r="0"){return s?`texelFetch( ${t}, ivec3( ${i}, ${s} ), ${r} )`:`texelFetch( ${t}, ${i}, ${r} )`}generateTexture(e,t,i,s){return e.isDepthTexture?`texture( ${t}, ${i} ).x`:(s&&(i=`vec3( ${i}, ${s} )`),`texture( ${t}, ${i} )`)}generateTextureLevel(e,t,i,s){return`textureLod( ${t}, ${i}, ${s} )`}generateTextureBias(e,t,i,s){return`texture( ${t}, ${i}, ${s} )`}generateTextureGrad(e,t,i,s){return`textureGrad( ${t}, ${i}, ${s[0]}, ${s[1]} )`}generateTextureCompare(e,t,i,s,r,n=this.shaderStage){if("fragment"===n)return`texture( ${t}, vec3( ${i}, ${s} ) )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${n} shader.`)}getVars(e){let t=[],i=this.vars[e];if(void 0!==i)for(let e of i)t.push(`${this.getVar(e.type,e.name)};`);return t.join("\n	")}getUniforms(e){let t=this.uniforms[e],i=[],s={};for(let r of t){let t=null,n=!1;if("texture"===r.type){let e=r.node.value,i="";!0===e.isDataTexture&&(1014===e.type?i="u":1013===e.type&&(i="i")),t=e.compareFunction?`sampler2DShadow ${r.name};`:!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?`${i}sampler2DArray ${r.name};`:`${i}sampler2D ${r.name};`}else if("cubeTexture"===r.type)t=`samplerCube ${r.name};`;else if("texture3D"===r.type)t=`sampler3D ${r.name};`;else if("buffer"===r.type){let e=r.node,i=this.getType(e.bufferType),s=e.bufferCount,n=s>0?s:"";t=`${e.name} {
	${i} ${r.name}[${n}];
};
`}else{let i=this.getVectorType(r.type);t=`${i} ${this.getPropertyName(r,e)};`,n=!0}let a=r.node.precision;if(null!==a&&(t=yN[a]+" "+t),n){t="	"+t;let e=r.groupNode.name;(s[e]||(s[e]=[])).push(t)}else t="uniform "+t,i.push(t)}let r="";for(let t in s){let i=s[t];r+=this._getGLSLUniformStruct(e+"_"+t,i.join("\n"))+"\n"}return r+i.join("\n")}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&1013!==e.gpuType){let i=e;e.isInterleavedBufferAttribute&&(i=e.data);let s=i.array;!1==(s instanceof Uint32Array||s instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e||"compute"===e){let e=this.getAttributesArray(),i=0;for(let s of e)t+=`layout( location = ${i++} ) in ${s.type} ${s.name};
`}return t}getStructMembers(e){let t=[],i=e.getMemberTypes();for(let e=0;e<i.length;e++){let s=i[e];t.push(`layout( location = ${e} ) out ${s} m${e};`)}return t.join("\n")}getStructs(e){let t=[],i=this.structs[e];if(0===i.length)return"layout( location = 0 ) out vec4 fragColor;\n";for(let e=0,s=i.length;e<s;e++){let s=i[e],r="\n";r+=this.getStructMembers(s)+"\n",t.push(r)}return t.join("\n\n")}getVaryings(e){let t="",i=this.varyings;if("vertex"===e||"compute"===e)for(let s of i){"compute"===e&&(s.needsInterpolation=!0);let i=s.type,r=i.includes("int")||i.includes("uv")||i.includes("iv")?"flat ":"";t+=`${r}${s.needsInterpolation?"out":"/*out*/"} ${i} ${s.name};
`}else if("fragment"===e){for(let e of i)if(e.needsInterpolation){let i=e.type,s=i.includes("int")||i.includes("uv")||i.includes("iv")?"flat ":"";t+=`${s}in ${i} ${e.name};
`}}return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){let e=this.object.workgroupSize.reduce((e,t)=>e*t,1);return`uint( gl_InstanceID ) % ${e}u`}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,i=this.shaderStage){let s=this.extensions[i]||(this.extensions[i]=new Map);!1===s.has(e)&&s.set(e,{name:e,behavior:t})}getExtensions(e){let t=[];if("vertex"===e){let t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}let i=this.extensions[e];if(void 0!==i)for(let{name:e,behavior:s}of i.values())t.push(`#extension ${e} : ${s}`);return t.join("\n")}isAvailable(e){let t=yA[e];if(void 0===t){if("float32Filterable"===e){let e=this.renderer.backend.extensions;e.has("OES_texture_float_linear")?(e.get("OES_texture_float_linear"),t=!0):t=!1}yA[e]=t}return t}isFlipY(){return!0}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){let e=this.transforms,t="";for(let i=0;i<e.length;i++){let s=e[i],r=this.getPropertyName(s.attributeNode);t+=`${s.varyingName} = ${r};
	`}return t}_getGLSLUniformStruct(e,t){return`
layout( std140 ) uniform ${e} {
${t}
};`}_getGLSLVertexCode(e){return`#version 300 es

${this.getSignature()}

// extensions 
${e.extensions}

// precision
${yR}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// attributes
${e.attributes}

// codes
${e.codes}

void main() {

	// vars
	${e.vars}

	// transforms
	${e.transforms}

	// flow
	${e.flow}

	gl_PointSize = 1.0;

}
`}_getGLSLFragmentCode(e){return`#version 300 es

${this.getSignature()}

// precision
${yR}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// codes
${e.codes}

${e.structs}

void main() {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}buildCode(){let e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};for(let t in e){let i="// code\n\n";i+=this.flowCode[t];let s=this.flowNodes[t],r=s[s.length-1];for(let e of s){let s=this.getFlowData(e),n=e.name;n&&(i.length>0&&(i+="\n"),i+=`	// flow -> ${n}
	`),i+=`${s.code}
	`,e!==r||"compute"===t||(i+="// result\n	","vertex"===t?i+=`gl_Position = ${s.result};`:"fragment"!==t||e.outputNode.isOutputStructNode||(i+=`fragColor = ${s.result};`))}let n=e[t];n.extensions=this.getExtensions(t),n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.vars=this.getVars(t),n.structs=this.getStructs(t),n.codes=this.getCodes(t),n.transforms=this.getTransforms(t),n.flow=i}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,i,s=null){let r=super.getUniformFromNode(e,t,i,s),n=this.getDataFromNode(e,i,this.globalCache),a=n.uniformGPU;if(void 0===a){let s=e.groupNode,o=s.name,l=this.getBindGroupArray(o,i);if("texture"===t)a=new yS(r.name,r.node,s),l.push(a);else if("cubeTexture"===t)a=new y_(r.name,r.node,s),l.push(a);else if("texture3D"===t)a=new yM(r.name,r.node,s),l.push(a);else if("buffer"===t){e.name=`NodeBuffer_${e.id}`,r.name=`buffer${e.id}`;let t=new yf(e,s);t.name=e.name,l.push(t),a=t}else{let e=this.uniformGroups[i]||(this.uniformGroups[i]={}),n=e[o];void 0===n&&(n=new yb(i+"_"+o,s),e[o]=n,l.push(n)),a=this.getNodeUniform(r,t),n.addUniform(a)}n.uniformGPU=a}return r}}let yE=null,yB=null,yI=null;class yP{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null}async init(e){this.renderer=e}begin(){}finish(){}draw(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}createRenderPipeline(){}createComputePipeline(){}destroyPipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}createDefaultTexture(){}createTexture(){}copyTextureToBuffer(){}createAttribute(){}createIndexAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}resolveTimestampAsync(){}hasFeatureAsync(){}hasFeature(){}getInstanceCount(e){let{object:t,geometry:i}=e;return i.isInstancedBufferGeometry?i.instanceCount:t.count>1?t.count:1}getDrawingBufferSize(){return yE=yE||new S,this.renderer.getDrawingBufferSize(yE)}getScissor(){return yB=yB||new k,this.renderer.getScissor(yB)}setScissorTest(){}getClearColor(){let e=this.renderer;return yI=yI||new fT,e.getClearColor(yI),yI.getRGB(yI,this.renderer.currentColorSpace),yI}getDomElement(){let e=this.domElement;return null===e&&("setAttribute"in(e=void 0!==this.parameters.canvas?this.parameters.canvas:function(){let e=w("canvas");return e.style.display="block",e}())&&e.setAttribute("data-engine","three.js r168 webgpu"),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}}let yF=0;class yU{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[1^this.activeBufferIndex]}switchBuffers(){this.activeBufferIndex^=1}}class yO{constructor(e){this.backend=e}createAttribute(e,t){let i;let s=this.backend,{gl:r}=s,n=e.array,a=e.usage||r.STATIC_DRAW,o=e.isInterleavedBufferAttribute?e.data:e,l=s.get(o),h=l.bufferGPU;if(void 0===h&&(h=this._createBuffer(r,t,n,a),l.bufferGPU=h,l.bufferType=t,l.version=o.version),n instanceof Float32Array)i=r.FLOAT;else if(n instanceof Uint16Array)i=e.isFloat16BufferAttribute?r.HALF_FLOAT:r.UNSIGNED_SHORT;else if(n instanceof Int16Array)i=r.SHORT;else if(n instanceof Uint32Array)i=r.UNSIGNED_INT;else if(n instanceof Int32Array)i=r.INT;else if(n instanceof Int8Array)i=r.BYTE;else if(n instanceof Uint8Array)i=r.UNSIGNED_BYTE;else if(n instanceof Uint8ClampedArray)i=r.UNSIGNED_BYTE;else throw Error("THREE.WebGLBackend: Unsupported buffer data format: "+n);let u={bufferGPU:h,bufferType:t,type:i,byteLength:n.byteLength,bytesPerElement:n.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:i===r.INT||i===r.UNSIGNED_INT||1013===e.gpuType,id:yF++};(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(u=new yU(u,this._createBuffer(r,t,n,a))),s.set(e,u)}updateAttribute(e){let t=this.backend,{gl:i}=t,s=e.array,r=e.isInterleavedBufferAttribute?e.data:e,n=t.get(r),a=n.bufferType,o=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(i.bindBuffer(a,n.bufferGPU),0===o.length)i.bufferSubData(a,0,s);else{for(let e=0,t=o.length;e<t;e++){let t=o[e];i.bufferSubData(a,t.start*s.BYTES_PER_ELEMENT,s,t.start,t.count)}r.clearUpdateRanges()}i.bindBuffer(a,null),n.version=r.version}destroyAttribute(e){let t=this.backend,{gl:i}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);let s=t.get(e);i.deleteBuffer(s.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){let t=this.backend,{gl:i}=t,s=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:r}=t.get(s),n=e.array,a=n.byteLength;i.bindBuffer(i.COPY_READ_BUFFER,r);let o=i.createBuffer();i.bindBuffer(i.COPY_WRITE_BUFFER,o),i.bufferData(i.COPY_WRITE_BUFFER,a,i.STREAM_READ),i.copyBufferSubData(i.COPY_READ_BUFFER,i.COPY_WRITE_BUFFER,0,0,a),await t.utils._clientWaitAsync();let l=new e.array.constructor(n.length);return i.getBufferSubData(i.COPY_WRITE_BUFFER,0,l),i.deleteBuffer(o),l.buffer}_createBuffer(e,t,i,s){let r=e.createBuffer();return e.bindBuffer(t,r),e.bufferData(t,i,s),e.bindBuffer(t,null),r}}let yz=!1,yL,yD;class yV{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},!1===yz&&(this._init(this.gl),yz=!0)}_init(e){yL={100:e.FUNC_ADD,101:e.FUNC_SUBTRACT,102:e.FUNC_REVERSE_SUBTRACT},yD={200:e.ZERO,201:e.ONE,202:e.SRC_COLOR,204:e.SRC_ALPHA,210:e.SRC_ALPHA_SATURATE,208:e.DST_COLOR,206:e.DST_ALPHA,203:e.ONE_MINUS_SRC_COLOR,205:e.ONE_MINUS_SRC_ALPHA,209:e.ONE_MINUS_DST_COLOR,207:e.ONE_MINUS_DST_ALPHA}}enable(e){let{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){let{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){let{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){let{gl:t}=this;0!==e?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(1===e?t.cullFace(t.BACK):2===e?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){let{currentLineWidth:t,gl:i}=this;e!==t&&(i.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,i,s,r,n,a,o){let{gl:l}=this;if(0===e){!0===this.currentBlendingEnabled&&(this.disable(l.BLEND),this.currentBlendingEnabled=!1);return}if(!1===this.currentBlendingEnabled&&(this.enable(l.BLEND),this.currentBlendingEnabled=!0),5!==e){if(e!==this.currentBlending||o!==this.currentPremultipledAlpha){if((100!==this.currentBlendEquation||100!==this.currentBlendEquationAlpha)&&(l.blendEquation(l.FUNC_ADD),this.currentBlendEquation=100,this.currentBlendEquationAlpha=100),o)switch(e){case 1:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.ONE,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFuncSeparate(l.ZERO,l.SRC_COLOR,l.ZERO,l.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case 1:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case 2:l.blendFunc(l.SRC_ALPHA,l.ONE);break;case 3:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case 4:l.blendFunc(l.ZERO,l.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=o}return}r=r||t,n=n||i,a=a||s,(t!==this.currentBlendEquation||r!==this.currentBlendEquationAlpha)&&(l.blendEquationSeparate(yL[t],yL[r]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=r),(i!==this.currentBlendSrc||s!==this.currentBlendDst||n!==this.currentBlendSrcAlpha||a!==this.currentBlendDstAlpha)&&(l.blendFuncSeparate(yD[i],yD[s],yD[n],yD[a]),this.currentBlendSrc=i,this.currentBlendDst=s,this.currentBlendSrcAlpha=n,this.currentBlendDstAlpha=a),this.currentBlending=e,this.currentPremultipledAlpha=!1}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){let{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){let{gl:t}=this;switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:default:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL)}this.currentDepthFunc=e}}setStencilTest(e){let{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,i){(this.currentStencilFunc!==e||this.currentStencilRef!==t||this.currentStencilFuncMask!==i)&&(this.gl.stencilFunc(e,t,i),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=i)}setStencilOp(e,t,i){(this.currentStencilFail!==e||this.currentStencilZFail!==t||this.currentStencilZPass!==i)&&(this.gl.stencilOp(e,t,i),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=i)}setMaterial(e,t){let{gl:i}=this;2===e.side?this.disable(i.CULL_FACE):this.enable(i.CULL_FACE);let s=1===e.side;t&&(s=!s),this.setFlipSided(s),1===e.blending&&!1===e.transparent?this.setBlending(0):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);let r=e.stencilWrite;this.setStencilTest(r),r&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?this.enable(i.SAMPLE_ALPHA_TO_COVERAGE):this.disable(i.SAMPLE_ALPHA_TO_COVERAGE)}setPolygonOffset(e,t,i){let{gl:s}=this;e?(this.enable(s.POLYGON_OFFSET_FILL),(this.currentPolygonOffsetFactor!==t||this.currentPolygonOffsetUnits!==i)&&(s.polygonOffset(t,i),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=i)):this.disable(s.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}bindFramebuffer(e,t){let{gl:i,currentBoundFramebuffers:s}=this;return s[e]!==t&&(i.bindFramebuffer(e,t),s[e]=t,e===i.DRAW_FRAMEBUFFER&&(s[i.FRAMEBUFFER]=t),e===i.FRAMEBUFFER&&(s[i.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){let{gl:i}=this,s=[],r=!1;if(null!==e.textures){void 0===(s=this.currentDrawbuffers.get(t))&&(s=[],this.currentDrawbuffers.set(t,s));let n=e.textures;if(s.length!==n.length||s[0]!==i.COLOR_ATTACHMENT0){for(let e=0,t=n.length;e<t;e++)s[e]=i.COLOR_ATTACHMENT0+e;s.length=n.length,r=!0}}else s[0]!==i.BACK&&(s[0]=i.BACK,r=!0);r&&i.drawBuffers(s)}activeTexture(e){let{gl:t,currentTextureSlot:i,maxTextures:s}=this;void 0===e&&(e=t.TEXTURE0+s-1),i!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,i){let{gl:s,currentTextureSlot:r,currentBoundTextures:n,maxTextures:a}=this;void 0===i&&(i=null===r?s.TEXTURE0+a-1:r);let o=n[i];void 0===o&&(o={type:void 0,texture:void 0},n[i]=o),(o.type!==e||o.texture!==t)&&(r!==i&&(s.activeTexture(i),this.currentTextureSlot=i),s.bindTexture(e,t),o.type=e,o.texture=t)}bindBufferBase(e,t,i){let{gl:s}=this,r=`${e}-${t}`;return this.currentBoundBufferBases[r]!==i&&(s.bindBufferBase(e,t,i),this.currentBoundBufferBases[r]=i,!0)}unbindTexture(){let{gl:e,currentTextureSlot:t,currentBoundTextures:i}=this,s=i[t];void 0!==s&&void 0!==s.type&&(e.bindTexture(s.type,null),s.type=void 0,s.texture=void 0)}}class yk{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=""){let i;let{gl:s,extensions:r}=this;if(1009===e)return s.UNSIGNED_BYTE;if(1017===e)return s.UNSIGNED_SHORT_4_4_4_4;if(1018===e)return s.UNSIGNED_SHORT_5_5_5_1;if(35902===e)return s.UNSIGNED_INT_5_9_9_9_REV;if(1010===e)return s.BYTE;if(1011===e)return s.SHORT;if(1012===e)return s.UNSIGNED_SHORT;if(1013===e)return s.INT;if(1014===e)return s.UNSIGNED_INT;if(1015===e)return s.FLOAT;if(1016===e)return s.HALF_FLOAT;if(1021===e)return s.ALPHA;if(1022===e)return s.RGB;if(1023===e)return s.RGBA;if(1024===e)return s.LUMINANCE;if(1025===e)return s.LUMINANCE_ALPHA;if(1026===e)return s.DEPTH_COMPONENT;if(1027===e)return s.DEPTH_STENCIL;if(1028===e)return s.RED;if(1029===e)return s.RED_INTEGER;if(1030===e)return s.RG;if(1031===e)return s.RG_INTEGER;if(1033===e)return s.RGBA_INTEGER;if(33776===e||33777===e||33778===e||33779===e){if(t===a){if(null===(i=r.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(33776===e)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(33777===e)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(33778===e)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(33779===e)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(i=r.get("WEBGL_compressed_texture_s3tc")))return null;if(33776===e)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===e)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===e)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===e)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}}if(35840===e||35841===e||35842===e||35843===e){if(null===(i=r.get("WEBGL_compressed_texture_pvrtc")))return null;if(35840===e)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===e)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===e)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===e)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===e||37492===e||37496===e){if(null===(i=r.get("WEBGL_compressed_texture_etc")))return null;if(36196===e||37492===e)return t===a?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(37496===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(37808===e||37809===e||37810===e||37811===e||37812===e||37813===e||37814===e||37815===e||37816===e||37817===e||37818===e||37819===e||37820===e||37821===e){if(null===(i=r.get("WEBGL_compressed_texture_astc")))return null;if(37808===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===e)return t===a?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(36492===e){if(null===(i=r.get("EXT_texture_compression_bptc")))return null;if(36492===e)return t===a?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(36283===e||36284===e||36285===e||36286===e){if(null===(i=r.get("EXT_texture_compression_rgtc")))return null;if(36492===e)return i.COMPRESSED_RED_RGTC1_EXT;if(36284===e)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(36285===e)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(36286===e)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return 1020===e?s.UNSIGNED_INT_24_8:void 0!==s[e]?s[e]:null}_clientWaitAsync(){let{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((i,s)=>{!function r(){let n=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(n===e.WAIT_FAILED){e.deleteSync(t),s();return}if(n===e.TIMEOUT_EXPIRED){requestAnimationFrame(r);return}e.deleteSync(t),i()}()})}}let yG=!1,yW,yH,yj;class y${constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},!1===yG&&(this._init(this.gl),yG=!0)}_init(e){yW={1e3:e.REPEAT,1001:e.CLAMP_TO_EDGE,1002:e.MIRRORED_REPEAT},yH={1003:e.NEAREST,1004:e.NEAREST_MIPMAP_NEAREST,1005:e.NEAREST_MIPMAP_LINEAR,1006:e.LINEAR,1007:e.LINEAR_MIPMAP_NEAREST,1008:e.LINEAR_MIPMAP_LINEAR},yj={512:e.NEVER,519:e.ALWAYS,513:e.LESS,515:e.LEQUAL,514:e.EQUAL,518:e.GEQUAL,516:e.GREATER,517:e.NOTEQUAL}}filterFallback(e){let{gl:t}=this;return 1003===e||1004===e||1005===e?t.NEAREST:t.LINEAR}getGLTextureType(e){let{gl:t}=this;return!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:!0===e.isData3DTexture?t.TEXTURE_3D:t.TEXTURE_2D}getInternalFormat(e,t,i,s,r=!1){let{gl:n,extensions:o}=this;if(null!==e){if(void 0!==n[e])return n[e];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+e+"'")}let l=t;return t===n.RED&&(i===n.FLOAT&&(l=n.R32F),i===n.HALF_FLOAT&&(l=n.R16F),i===n.UNSIGNED_BYTE&&(l=n.R8),i===n.UNSIGNED_SHORT&&(l=n.R16),i===n.UNSIGNED_INT&&(l=n.R32UI),i===n.BYTE&&(l=n.R8I),i===n.SHORT&&(l=n.R16I),i===n.INT&&(l=n.R32I)),t===n.RED_INTEGER&&(i===n.UNSIGNED_BYTE&&(l=n.R8UI),i===n.UNSIGNED_SHORT&&(l=n.R16UI),i===n.UNSIGNED_INT&&(l=n.R32UI),i===n.BYTE&&(l=n.R8I),i===n.SHORT&&(l=n.R16I),i===n.INT&&(l=n.R32I)),t===n.RG&&(i===n.FLOAT&&(l=n.RG32F),i===n.HALF_FLOAT&&(l=n.RG16F),i===n.UNSIGNED_BYTE&&(l=n.RG8),i===n.UNSIGNED_SHORT&&(l=n.RG16),i===n.UNSIGNED_INT&&(l=n.RG32UI),i===n.BYTE&&(l=n.RG8I),i===n.SHORT&&(l=n.RG16I),i===n.INT&&(l=n.RG32I)),t===n.RG_INTEGER&&(i===n.UNSIGNED_BYTE&&(l=n.RG8UI),i===n.UNSIGNED_SHORT&&(l=n.RG16UI),i===n.UNSIGNED_INT&&(l=n.RG32UI),i===n.BYTE&&(l=n.RG8I),i===n.SHORT&&(l=n.RG16I),i===n.INT&&(l=n.RG32I)),t===n.RGB&&(i===n.FLOAT&&(l=n.RGB32F),i===n.HALF_FLOAT&&(l=n.RGB16F),i===n.UNSIGNED_BYTE&&(l=n.RGB8),i===n.UNSIGNED_SHORT&&(l=n.RGB16),i===n.UNSIGNED_INT&&(l=n.RGB32UI),i===n.BYTE&&(l=n.RGB8I),i===n.SHORT&&(l=n.RGB16I),i===n.INT&&(l=n.RGB32I),i===n.UNSIGNED_BYTE&&(l=s===a&&!1===r?n.SRGB8:n.RGB8),i===n.UNSIGNED_SHORT_5_6_5&&(l=n.RGB565),i===n.UNSIGNED_SHORT_5_5_5_1&&(l=n.RGB5_A1),i===n.UNSIGNED_SHORT_4_4_4_4&&(l=n.RGB4),i===n.UNSIGNED_INT_5_9_9_9_REV&&(l=n.RGB9_E5)),t===n.RGB_INTEGER&&(i===n.UNSIGNED_BYTE&&(l=n.RGB8UI),i===n.UNSIGNED_SHORT&&(l=n.RGB16UI),i===n.UNSIGNED_INT&&(l=n.RGB32UI),i===n.BYTE&&(l=n.RGB8I),i===n.SHORT&&(l=n.RGB16I),i===n.INT&&(l=n.RGB32I)),t===n.RGBA&&(i===n.FLOAT&&(l=n.RGBA32F),i===n.HALF_FLOAT&&(l=n.RGBA16F),i===n.UNSIGNED_BYTE&&(l=n.RGBA8),i===n.UNSIGNED_SHORT&&(l=n.RGBA16),i===n.UNSIGNED_INT&&(l=n.RGBA32UI),i===n.BYTE&&(l=n.RGBA8I),i===n.SHORT&&(l=n.RGBA16I),i===n.INT&&(l=n.RGBA32I),i===n.UNSIGNED_BYTE&&(l=s===a&&!1===r?n.SRGB8_ALPHA8:n.RGBA8),i===n.UNSIGNED_SHORT_4_4_4_4&&(l=n.RGBA4),i===n.UNSIGNED_SHORT_5_5_5_1&&(l=n.RGB5_A1)),t===n.RGBA_INTEGER&&(i===n.UNSIGNED_BYTE&&(l=n.RGBA8UI),i===n.UNSIGNED_SHORT&&(l=n.RGBA16UI),i===n.UNSIGNED_INT&&(l=n.RGBA32UI),i===n.BYTE&&(l=n.RGBA8I),i===n.SHORT&&(l=n.RGBA16I),i===n.INT&&(l=n.RGBA32I)),t===n.DEPTH_COMPONENT&&(i===n.UNSIGNED_INT&&(l=n.DEPTH24_STENCIL8),i===n.FLOAT&&(l=n.DEPTH_COMPONENT32F)),t===n.DEPTH_STENCIL&&i===n.UNSIGNED_INT_24_8&&(l=n.DEPTH24_STENCIL8),(l===n.R16F||l===n.R32F||l===n.RG16F||l===n.RG32F||l===n.RGBA16F||l===n.RGBA32F)&&o.get("EXT_color_buffer_float"),l}setTextureParameters(e,t){let{gl:i,extensions:s,backend:r}=this;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,t.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE),i.texParameteri(e,i.TEXTURE_WRAP_S,yW[t.wrapS]),i.texParameteri(e,i.TEXTURE_WRAP_T,yW[t.wrapT]),(e===i.TEXTURE_3D||e===i.TEXTURE_2D_ARRAY)&&i.texParameteri(e,i.TEXTURE_WRAP_R,yW[t.wrapR]),i.texParameteri(e,i.TEXTURE_MAG_FILTER,yH[t.magFilter]);let n=void 0!==t.mipmaps&&t.mipmaps.length>0,a=1006===t.minFilter&&n?1008:t.minFilter;if(i.texParameteri(e,i.TEXTURE_MIN_FILTER,yH[a]),t.compareFunction&&(i.texParameteri(e,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE),i.texParameteri(e,i.TEXTURE_COMPARE_FUNC,yj[t.compareFunction])),!0===s.has("EXT_texture_filter_anisotropic")){if(1003===t.magFilter||1005!==t.minFilter&&1008!==t.minFilter||1015===t.type&&!1===s.has("OES_texture_float_linear"))return;if(t.anisotropy>1){let n=s.get("EXT_texture_filter_anisotropic");i.texParameterf(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,r.getMaxAnisotropy()))}}}createDefaultTexture(e){let{gl:t,backend:i,defaultTextures:s}=this,r=this.getGLTextureType(e),n=s[r];void 0===n&&(n=t.createTexture(),i.state.bindTexture(r,n),t.texParameteri(r,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(r,t.TEXTURE_MAG_FILTER,t.NEAREST),s[r]=n),i.set(e,{textureGPU:n,glTextureType:r,isDefault:!0})}createTexture(e,t){let{gl:i,backend:s}=this,{levels:r,width:n,height:a,depth:o}=t,l=s.utils.convert(e.format,e.colorSpace),h=s.utils.convert(e.type),u=this.getInternalFormat(e.internalFormat,l,h,e.colorSpace,e.isVideoTexture),d=i.createTexture(),c=this.getGLTextureType(e);s.state.bindTexture(c,d),this.setTextureParameters(c,e),e.isDataArrayTexture||e.isCompressedArrayTexture?i.texStorage3D(i.TEXTURE_2D_ARRAY,r,u,n,a,o):e.isData3DTexture?i.texStorage3D(i.TEXTURE_3D,r,u,n,a,o):e.isVideoTexture||i.texStorage2D(c,r,u,n,a),s.set(e,{textureGPU:d,glTextureType:c,glFormat:l,glType:h,glInternalFormat:u})}copyBufferToTexture(e,t){let{gl:i,backend:s}=this,{textureGPU:r,glTextureType:n,glFormat:a,glType:o}=s.get(t),{width:l,height:h}=t.source.data;i.bindBuffer(i.PIXEL_UNPACK_BUFFER,e),s.state.bindTexture(n,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i.texSubImage2D(n,0,0,0,l,h,a,o,0),i.bindBuffer(i.PIXEL_UNPACK_BUFFER,null),s.state.unbindTexture()}updateTexture(e,t){let{gl:i}=this,{width:s,height:r}=t,{textureGPU:n,glTextureType:a,glFormat:o,glType:l,glInternalFormat:h}=this.backend.get(e);if(e.isRenderTargetTexture||void 0===n)return;let u=e=>e.isDataTexture?e.image.data:e instanceof ImageBitmap||e instanceof OffscreenCanvas||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement?e:e.data;if(this.backend.state.bindTexture(a,n),this.setTextureParameters(a,e),e.isCompressedTexture){let s=e.mipmaps,r=t.image;for(let t=0;t<s.length;t++){let n=s[t];e.isCompressedArrayTexture?e.format!==i.RGBA?null!==o?i.compressedTexSubImage3D(i.TEXTURE_2D_ARRAY,t,0,0,0,n.width,n.height,r.depth,o,n.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texSubImage3D(i.TEXTURE_2D_ARRAY,t,0,0,0,n.width,n.height,r.depth,o,l,n.data):null!==o?i.compressedTexSubImage2D(i.TEXTURE_2D,t,0,0,n.width,n.height,o,n.data):console.warn("Unsupported compressed texture format")}}else if(e.isCubeTexture){let e=t.images;for(let t=0;t<6;t++){let n=u(e[t]);i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,s,r,o,l,n)}}else if(e.isDataArrayTexture){let e=t.image;i.texSubImage3D(i.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isData3DTexture){let e=t.image;i.texSubImage3D(i.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isVideoTexture)e.update(),i.texImage2D(a,0,h,o,l,t.image);else{let e=u(t.image);i.texSubImage2D(a,0,0,0,s,r,o,l,e)}}generateMipmaps(e){let{gl:t,backend:i}=this,{textureGPU:s,glTextureType:r}=i.get(e);i.state.bindTexture(r,s),t.generateMipmap(r)}deallocateRenderBuffers(e){let{gl:t,backend:i}=this;if(e){let s=i.get(e);if(s.renderBufferStorageSetup=void 0,s.framebuffers){for(let e in s.framebuffers)t.deleteFramebuffer(s.framebuffers[e]);delete s.framebuffers}if(s.depthRenderbuffer&&(t.deleteRenderbuffer(s.depthRenderbuffer),delete s.depthRenderbuffer),s.stencilRenderbuffer&&(t.deleteRenderbuffer(s.stencilRenderbuffer),delete s.stencilRenderbuffer),s.msaaFrameBuffer&&(t.deleteFramebuffer(s.msaaFrameBuffer),delete s.msaaFrameBuffer),s.msaaRenderbuffers){for(let e=0;e<s.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(s.msaaRenderbuffers[e]);delete s.msaaRenderbuffers}}}destroyTexture(e){let{gl:t,backend:i}=this,{textureGPU:s,renderTarget:r}=i.get(e);this.deallocateRenderBuffers(r),t.deleteTexture(s),i.delete(e)}copyTextureToTexture(e,t,i=null,s=null,r=0){let n,a,o,l,h,u;let{gl:d,backend:c}=this,{state:p}=this.backend,{textureGPU:m,glTextureType:g,glType:f,glFormat:y}=c.get(t);null!==i?(n=i.max.x-i.min.x,a=i.max.y-i.min.y,o=i.min.x,l=i.min.y):(n=e.image.width,a=e.image.height,o=0,l=0),null!==s?(h=s.x,u=s.y):(h=0,u=0),p.bindTexture(g,m),d.pixelStorei(d.UNPACK_ALIGNMENT,t.unpackAlignment),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,t.flipY),d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),d.pixelStorei(d.UNPACK_ALIGNMENT,t.unpackAlignment);let x=d.getParameter(d.UNPACK_ROW_LENGTH),b=d.getParameter(d.UNPACK_IMAGE_HEIGHT),v=d.getParameter(d.UNPACK_SKIP_PIXELS),T=d.getParameter(d.UNPACK_SKIP_ROWS),S=d.getParameter(d.UNPACK_SKIP_IMAGES),_=e.isCompressedTexture?e.mipmaps[r]:e.image;d.pixelStorei(d.UNPACK_ROW_LENGTH,_.width),d.pixelStorei(d.UNPACK_IMAGE_HEIGHT,_.height),d.pixelStorei(d.UNPACK_SKIP_PIXELS,o),d.pixelStorei(d.UNPACK_SKIP_ROWS,l),e.isDataTexture?d.texSubImage2D(d.TEXTURE_2D,r,h,u,n,a,y,f,_.data):e.isCompressedTexture?d.compressedTexSubImage2D(d.TEXTURE_2D,r,h,u,_.width,_.height,y,_.data):d.texSubImage2D(d.TEXTURE_2D,r,h,u,n,a,y,f,_),d.pixelStorei(d.UNPACK_ROW_LENGTH,x),d.pixelStorei(d.UNPACK_IMAGE_HEIGHT,b),d.pixelStorei(d.UNPACK_SKIP_PIXELS,v),d.pixelStorei(d.UNPACK_SKIP_ROWS,T),d.pixelStorei(d.UNPACK_SKIP_IMAGES,S),0===r&&t.generateMipmaps&&d.generateMipmap(d.TEXTURE_2D),p.unbindTexture()}copyFramebufferToTexture(e,t){let{gl:i}=this,{state:s}=this.backend,{textureGPU:r}=this.backend.get(e),n=e.image.width,a=e.image.height;if(!0===e.isDepthTexture||t.renderTarget&&t.renderTarget.samples>0){let o,l;!0===e.isDepthTexture?(o=i.DEPTH_BUFFER_BIT,l=i.DEPTH_ATTACHMENT,t.stencil&&(o|=i.STENCIL_BUFFER_BIT)):(o=i.COLOR_BUFFER_BIT,l=i.COLOR_ATTACHMENT0);let h=i.createFramebuffer();s.bindFramebuffer(i.DRAW_FRAMEBUFFER,h),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,l,i.TEXTURE_2D,r,0),i.blitFramebuffer(0,0,n,a,0,0,n,a,o,i.NEAREST),i.deleteFramebuffer(h)}else s.bindTexture(i.TEXTURE_2D,r),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,0,0,n,a),s.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t){let{gl:i}=this,{samples:s,depthTexture:r,depthBuffer:n,stencilBuffer:a,width:o,height:l}=t.renderTarget;if(i.bindRenderbuffer(i.RENDERBUFFER,e),n&&!a){let t=i.DEPTH_COMPONENT24;s>0?(r&&r.isDepthTexture&&r.type===i.FLOAT&&(t=i.DEPTH_COMPONENT32F),i.renderbufferStorageMultisample(i.RENDERBUFFER,s,t,o,l)):i.renderbufferStorage(i.RENDERBUFFER,t,o,l),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e)}else n&&a&&(s>0?i.renderbufferStorageMultisample(i.RENDERBUFFER,s,i.DEPTH24_STENCIL8,o,l):i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,o,l),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e))}async copyTextureToBuffer(e,t,i,s,r){let{backend:n,gl:a}=this,{textureGPU:o,glFormat:l,glType:h}=this.backend.get(e),u=a.createFramebuffer();a.bindFramebuffer(a.READ_FRAMEBUFFER,u),a.framebufferTexture2D(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,o,0);let d=this._getTypedArrayType(h),c=s*r*this._getBytesPerTexel(l),p=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,p),a.bufferData(a.PIXEL_PACK_BUFFER,c,a.STREAM_READ),a.readPixels(t,i,s,r,l,h,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),await n.utils._clientWaitAsync();let m=new d(c/d.BYTES_PER_ELEMENT);return a.bindBuffer(a.PIXEL_PACK_BUFFER,p),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,m),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteFramebuffer(u),m}_getTypedArrayType(e){let{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4||e===t.UNSIGNED_SHORT_5_5_5_1||e===t.UNSIGNED_SHORT_5_6_5||e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.FLOAT)return Float32Array;throw Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e){let{gl:t}=this;return e===t.RGBA?4:e===t.RGB?3:e===t.ALPHA?1:void 0}}class yq{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}}class yX{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;let e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){let i=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}}let yY={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBKIT_WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-bc",EXT_texture_compression_bptc:"texture-compression-bptc",EXT_disjoint_timer_query_webgl2:"timestamp-query"};class yJ{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){let{gl:i,mode:s,object:r,type:n,info:a,index:o}=this;0!==o?i.drawElements(s,t,n,e):i.drawArrays(s,e,t),a.update(r,t,s,1)}renderInstances(e,t,i){let{gl:s,mode:r,type:n,index:a,object:o,info:l}=this;0!==i&&(0!==a?s.drawElementsInstanced(r,t,n,e,i):s.drawArraysInstanced(r,e,t,i),l.update(o,t,r,i))}renderMultiDraw(e,t,i){let{extensions:s,mode:r,object:n,info:a}=this;if(0===i)return;let o=s.get("WEBGL_multi_draw");if(null===o)for(let s=0;s<i;s++)this.render(e[s],t[s]);else{0!==this.index?o.multiDrawElementsWEBGL(r,t,0,this.type,e,0,i):o.multiDrawArraysWEBGL(r,e,0,t,0,i);let s=0;for(let e=0;e<i;e++)s+=t[e];a.update(n,s,r,1)}}renderMultiDrawInstances(e,t,i,s){let{extensions:r,mode:n,object:a,info:o}=this;if(0===i)return;let l=r.get("WEBGL_multi_draw");if(null===l)for(let r=0;r<i;r++)this.renderInstances(e[r],t[r],s[r]);else{0!==this.index?l.multiDrawElementsInstancedWEBGL(n,t,0,this.type,e,0,s,0,i):l.multiDrawArraysInstancedWEBGL(n,e,0,t,0,s,0,i);let r=0;for(let e=0;e<i;e++)r+=t[e];for(let e=0;e<s.length;e++)o.update(a,r,n,s[e])}}}class yK extends yP{constructor(e={}){super(e),this.isWebGLBackend=!0}init(e){super.init(e);let t=this.parameters,i=void 0!==t.context?t.context:e.domElement.getContext("webgl2");this.gl=i,this.extensions=new yq(this),this.capabilities=new yX(this),this.attributeUtils=new yO(this),this.textureUtils=new y$(this),this.bufferRenderer=new yJ(this),this.state=new yV(this),this.utils=new yk(this),this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.trackTimestamp=!0===t.trackTimestamp,this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile"),this._currentContext=null}get coordinateSystem(){return 2e3}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}initTimestampQuery(e){if(!this.disjoint||!this.trackTimestamp)return;let t=this.get(e);if(this.queryRunning){t.queryQueue||(t.queryQueue=[]),t.queryQueue.push(e);return}t.activeQuery&&(this.gl.endQuery(this.disjoint.TIME_ELAPSED_EXT),t.activeQuery=null),t.activeQuery=this.gl.createQuery(),null!==t.activeQuery&&(this.gl.beginQuery(this.disjoint.TIME_ELAPSED_EXT,t.activeQuery),this.queryRunning=!0)}prepareTimestampBuffer(e){if(!this.disjoint||!this.trackTimestamp)return;let t=this.get(e);if(t.activeQuery&&(this.gl.endQuery(this.disjoint.TIME_ELAPSED_EXT),t.gpuQueries||(t.gpuQueries=[]),t.gpuQueries.push({query:t.activeQuery}),t.activeQuery=null,this.queryRunning=!1,t.queryQueue&&t.queryQueue.length>0)){let e=t.queryQueue.shift();this.initTimestampQuery(e)}}async resolveTimestampAsync(e,t="render"){if(!this.disjoint||!this.trackTimestamp)return;let i=this.get(e);i.gpuQueries||(i.gpuQueries=[]);for(let e=0;e<i.gpuQueries.length;e++){let s=i.gpuQueries[e],r=this.gl.getQueryParameter(s.query,this.gl.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(this.disjoint.GPU_DISJOINT_EXT);if(r&&!n){let r=Number(this.gl.getQueryParameter(s.query,this.gl.QUERY_RESULT))/1e6;this.gl.deleteQuery(s.query),i.gpuQueries.splice(e,1),e--,this.renderer.info.updateTimestamp(t,r)}}}getContext(){return this.gl}beginRender(e){let{gl:t}=this,i=this.get(e);if(this.initTimestampQuery(e),i.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1),e.viewport?this.updateViewport(e):t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),e.scissor){let{x:i,y:s,width:r,height:n}=e.scissorValue;t.scissor(i,e.height-n-s,r,n)}let s=e.occlusionQueryCount;s>0&&(i.currentOcclusionQueries=i.occlusionQueries,i.currentOcclusionQueryObjects=i.occlusionQueryObjects,i.lastOcclusionObject=null,i.occlusionQueries=Array(s),i.occlusionQueryObjects=Array(s),i.occlusionQueryIndex=0)}finishRender(e){let{gl:t,state:i}=this,s=this.get(e),r=s.previousContext,n=e.occlusionQueryCount;n>0&&(n>s.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));let a=e.textures;if(null!==a)for(let e=0;e<a.length;e++){let t=a[e];t.generateMipmaps&&this.generateMipmaps(t)}if(this._currentContext=r,null!==e.textures&&e.renderTarget){let s=this.get(e.renderTarget),{samples:r}=e.renderTarget;if(r>0){let r=s.framebuffers[e.getCacheKey()],n=t.COLOR_BUFFER_BIT,a=s.msaaFrameBuffer,o=e.textures;i.bindFramebuffer(t.READ_FRAMEBUFFER,a),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,r);for(let i=0;i<o.length;i++)if(e.scissor){let{x:i,y:r,width:a,height:o}=e.scissorValue,l=e.height-o-r;t.blitFramebuffer(i,l,i+a,l+o,i,l,i+a,l+o,n,t.NEAREST),t.invalidateSubFramebuffer(t.READ_FRAMEBUFFER,s.invalidationArray,i,l,a,o)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n,t.NEAREST),t.invalidateFramebuffer(t.READ_FRAMEBUFFER,s.invalidationArray)}}null!==r&&(this._setFramebuffer(r),r.viewport?this.updateViewport(r):t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)),this.prepareTimestampBuffer(e)}resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueries:i,currentOcclusionQueryObjects:s}=t;if(i&&s){let e=new WeakSet,{gl:r}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;let n=()=>{let a=0;for(let t=0;t<i.length;t++){let n=i[t];null!==n&&r.getQueryParameter(n,r.QUERY_RESULT_AVAILABLE)&&(r.getQueryParameter(n,r.QUERY_RESULT)>0&&e.add(s[t]),i[t]=null,r.deleteQuery(n),a++)}a<i.length?requestAnimationFrame(n):t.occluded=e};n()}}isOccluded(e,t){let i=this.get(e);return i.occluded&&i.occluded.has(t)}updateViewport(e){let t=this.gl,{x:i,y:s,width:r,height:n}=e.viewportValue;t.viewport(i,e.height-n-s,r,n)}setScissorTest(e){let t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}clear(e,t,i,s=null,r=!0){let{gl:n}=this;null===s&&(s={textures:null,clearColorValue:this.getClearColor()});let a=0;if(e&&(a|=n.COLOR_BUFFER_BIT),t&&(a|=n.DEPTH_BUFFER_BIT),i&&(a|=n.STENCIL_BUFFER_BIT),0!==a){let o=s.clearColorValue||this.getClearColor();if(o.r*=o.a,o.g*=o.a,o.b*=o.a,t&&this.state.setDepthMask(!0),null===s.textures)n.clearColor(o.r,o.g,o.b,o.a),n.clear(a);else{if(r&&this._setFramebuffer(s),e)for(let e=0;e<s.textures.length;e++)n.clearBufferfv(n.COLOR,e,[o.r,o.g,o.b,o.a]);t&&i?n.clearBufferfi(n.DEPTH_STENCIL,0,1,0):t?n.clearBufferfv(n.DEPTH,0,[1]):i&&n.clearBufferiv(n.STENCIL,0,[0])}}}beginCompute(e){let{state:t,gl:i}=this;t.bindFramebuffer(i.FRAMEBUFFER,null),this.initTimestampQuery(e)}compute(e,t,i,s){let{state:r,gl:n}=this;this.discard||(n.enable(n.RASTERIZER_DISCARD),this.discard=!0);let{programGPU:a,transformBuffers:o,attributes:l}=this.get(s),h=this._getVaoKey(null,l),u=this.vaoCache[h];void 0===u?this._createVao(null,l):n.bindVertexArray(u),r.useProgram(a),this._bindUniforms(i);let d=this._getTransformFeedback(o);n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,d),n.beginTransformFeedback(n.POINTS),l[0].isStorageInstancedBufferAttribute?n.drawArraysInstanced(n.POINTS,0,1,t.count):n.drawArrays(n.POINTS,0,t.count),n.endTransformFeedback(),n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,null);for(let e=0;e<o.length;e++){let t=o[e];t.pbo&&this.textureUtils.copyBufferToTexture(t.transformBuffer,t.pbo),t.switchBuffers()}}finishCompute(e){let t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(e)}draw(e){let t;let{object:i,pipeline:s,material:r,context:n}=e,{programGPU:a}=this.get(s),{gl:o,state:l}=this,h=this.get(n);this._bindUniforms(e.getBindings());let u=i.isMesh&&0>i.matrixWorld.determinant();l.setMaterial(r,u),l.useProgram(a);let d=e.staticVao;if(void 0===d){let t=this._getVaoKey(e.getIndex(),e.getAttributes());if(void 0===(d=this.vaoCache[t])){let t;({vaoGPU:d,staticVao:t}=this._createVao(e.getIndex(),e.getAttributes())),t&&(e.staticVao=d)}}o.bindVertexArray(d);let c=e.getIndex(),p=e.geometry,m=e.drawRange,g=m.start,f=h.lastOcclusionObject;if(f!==i&&void 0!==f){if(null!==f&&!0===f.occlusionTest&&(o.endQuery(o.ANY_SAMPLES_PASSED),h.occlusionQueryIndex++),!0===i.occlusionTest){let e=o.createQuery();o.beginQuery(o.ANY_SAMPLES_PASSED,e),h.occlusionQueries[h.occlusionQueryIndex]=e,h.occlusionQueryObjects[h.occlusionQueryIndex]=i}h.lastOcclusionObject=i}let y=this.bufferRenderer;if(i.isPoints?y.mode=o.POINTS:i.isLineSegments?y.mode=o.LINES:i.isLine?y.mode=o.LINE_STRIP:i.isLineLoop?y.mode=o.LINE_LOOP:!0===r.wireframe?(l.setLineWidth(r.wireframeLinewidth*this.renderer.getPixelRatio()),y.mode=o.LINES):y.mode=o.TRIANGLES,y.object=i,null!==c){let e=this.get(c),i=m.count!==1/0?m.count:c.count;y.index=c.count,y.type=e.type,t=i}else y.index=0,t=m.count!==1/0?m.count:p.attributes.position.count;let x=this.getInstanceCount(e);i.isBatchedMesh?null!==i._multiDrawInstances?y.renderMultiDrawInstances(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount,i._multiDrawInstances):this.hasFeature("WEBGL_multi_draw")?y.renderMultiDraw(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount):A("THREE.WebGLRenderer: WEBGL_multi_draw not supported."):x>1?y.renderInstances(g,t,x):y.render(g,t),o.bindVertexArray(null)}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}copyTextureToBuffer(e,t,i,s,r){return this.textureUtils.copyTextureToBuffer(e,t,i,s,r)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new yC(e,t)}createProgram(e){let t=this.gl,{stage:i,code:s}=e,r="fragment"===i?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(r,s),t.compileShader(r),this.set(e,{shaderGPU:r})}destroyProgram(){console.warn("Abstract class.")}createRenderPipeline(e,t){let i=this.gl,s=e.pipeline,{fragmentProgram:r,vertexProgram:n}=s,a=i.createProgram(),o=this.get(r).shaderGPU,l=this.get(n).shaderGPU;if(i.attachShader(a,o),i.attachShader(a,l),i.linkProgram(a),this.set(s,{programGPU:a,fragmentShader:o,vertexShader:l}),null!==t&&this.parallel){let r=new Promise(t=>{let r=this.parallel,n=()=>{i.getProgramParameter(a,r.COMPLETION_STATUS_KHR)?(this._completeCompile(e,s),t()):requestAnimationFrame(n)};n()});t.push(r);return}this._completeCompile(e,s)}_handleSource(e,t){let i=e.split("\n"),s=[],r=Math.max(t-6,0),n=Math.min(t+6,i.length);for(let e=r;e<n;e++){let r=e+1;s.push(`${r===t?">":" "} ${r}: ${i[e]}`)}return s.join("\n")}_getShaderErrors(e,t,i){let s=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(s&&""===r)return"";let n=/ERROR: 0:(\d+)/.exec(r);if(!n)return r;{let s=parseInt(n[1]);return i.toUpperCase()+"\n\n"+r+"\n\n"+this._handleSource(e.getShaderSource(t),s)}}_logProgramError(e,t,i){if(this.renderer.debug.checkShaderErrors){let s=this.gl,r=s.getProgramInfoLog(e).trim();if(!1===s.getProgramParameter(e,s.LINK_STATUS)){if("function"==typeof this.renderer.debug.onShaderError)this.renderer.debug.onShaderError(s,e,i,t);else{let n=this._getShaderErrors(s,i,"vertex"),a=this._getShaderErrors(s,t,"fragment");console.error("THREE.WebGLProgram: Shader Error "+s.getError()+" - VALIDATE_STATUS "+s.getProgramParameter(e,s.VALIDATE_STATUS)+"\n\nProgram Info Log: "+r+"\n"+n+"\n"+a)}}else""!==r&&console.warn("THREE.WebGLProgram: Program Info Log:",r)}}_completeCompile(e,t){let{state:i,gl:s}=this,{programGPU:r,fragmentShader:n,vertexShader:a}=this.get(t);!1===s.getProgramParameter(r,s.LINK_STATUS)&&this._logProgramError(r,n,a),i.useProgram(r);let o=e.getBindings();this._setupBindings(o,r),this.set(t,{programGPU:r})}createComputePipeline(e,t){let{state:i,gl:s}=this,r={stage:"fragment",code:"#version 300 es\nprecision highp float;\nvoid main() {}"};this.createProgram(r);let{computeProgram:n}=e,a=s.createProgram(),o=this.get(r).shaderGPU,l=this.get(n).shaderGPU,h=n.transforms,u=[],d=[];for(let e=0;e<h.length;e++){let t=h[e];u.push(t.varyingName),d.push(t.attributeNode)}s.attachShader(a,o),s.attachShader(a,l),s.transformFeedbackVaryings(a,u,s.SEPARATE_ATTRIBS),s.linkProgram(a),!1===s.getProgramParameter(a,s.LINK_STATUS)&&this._logProgramError(a,o,l),i.useProgram(a),this.createBindings(null,t),this._setupBindings(t,a);let c=n.attributes,p=[],m=[];for(let e=0;e<c.length;e++){let t=c[e].node.attribute;p.push(t),this.has(t)||this.attributeUtils.createAttribute(t,s.ARRAY_BUFFER)}for(let e=0;e<d.length;e++){let t=d[e].attribute;this.has(t)||this.attributeUtils.createAttribute(t,s.ARRAY_BUFFER);let i=this.get(t);m.push(i)}this.set(e,{programGPU:a,transformBuffers:m,attributes:p})}createBindings(e,t){this.updateBindings(e,t)}updateBindings(e,t){let{state:i,gl:s}=this,r=0,n=0;for(let e of t)for(let t of e.bindings)if(t.isUniformsGroup||t.isUniformBuffer){let e=s.createBuffer(),n=t.buffer;s.bindBuffer(s.UNIFORM_BUFFER,e),s.bufferData(s.UNIFORM_BUFFER,n,s.DYNAMIC_DRAW),i.bindBufferBase(s.UNIFORM_BUFFER,r,e),this.set(t,{index:r++,bufferGPU:e})}else if(t.isSampledTexture){let{textureGPU:e,glTextureType:i}=this.get(t.texture);this.set(t,{index:n++,textureGPU:e,glTextureType:i})}}updateBinding(e){let t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){let i=this.get(e).bufferGPU,s=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,i),t.bufferData(t.UNIFORM_BUFFER,s,t.DYNAMIC_DRAW)}}createIndexAttribute(e){let t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;let t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;let t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){}hasFeature(e){let t=Object.keys(yY).filter(t=>yY[t]===e),i=this.extensions;for(let e=0;e<t.length;e++)if(i.has(t[e]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,i,s){this.textureUtils.copyTextureToTexture(e,t,i,s)}copyFramebufferToTexture(e,t){this.textureUtils.copyFramebufferToTexture(e,t)}_setFramebuffer(e){let{gl:t,state:i}=this,s=null;if(null!==e.textures){let r;let n=e.renderTarget,a=this.get(n),{samples:o,depthBuffer:l,stencilBuffer:h}=n,u=!0===n.isWebGLCubeRenderTarget,d=a.msaaFrameBuffer,c=a.depthRenderbuffer,p=fy(e);if(u?(a.cubeFramebuffers||(a.cubeFramebuffers={}),r=a.cubeFramebuffers[p]):(a.framebuffers||(a.framebuffers={}),r=a.framebuffers[p]),void 0===r){r=t.createFramebuffer(),i.bindFramebuffer(t.FRAMEBUFFER,r);let s=e.textures;if(u){a.cubeFramebuffers[p]=r;let{textureGPU:e}=this.get(s[0]),i=this.renderer._activeCubeFace;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,e,0)}else{a.framebuffers[p]=r;for(let i=0;i<s.length;i++){let r=s[i],n=this.get(r);n.renderTarget=e.renderTarget;let a=t.COLOR_ATTACHMENT0+i;t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_2D,n.textureGPU,0)}i.drawBuffers(e,r)}if(null!==e.depthTexture){let i=this.get(e.depthTexture),s=h?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,i.textureGPU,0)}}if(o>0){if(void 0===d){let s=[];d=t.createFramebuffer(),i.bindFramebuffer(t.FRAMEBUFFER,d);let r=[],n=e.textures;for(let i=0;i<n.length;i++){if(r[i]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,r[i]),s.push(t.COLOR_ATTACHMENT0+i),l){let e=h?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;s.push(e)}let n=e.textures[i],a=this.get(n);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,a.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+i,t.RENDERBUFFER,r[i])}if(a.msaaFrameBuffer=d,a.msaaRenderbuffers=r,void 0===c){c=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(c,e),a.depthRenderbuffer=c;let i=h?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;s.push(i)}a.invalidationArray=s}s=a.msaaFrameBuffer}else s=r}i.bindFramebuffer(t.FRAMEBUFFER,s)}_getVaoKey(e,t){let i=[];null!==e&&(i+=":"+this.get(e).id);for(let e=0;e<t.length;e++)i+=":"+this.get(t[e]).id;return i}_createVao(e,t){let{gl:i}=this,s=i.createVertexArray(),r="",n=!0;if(i.bindVertexArray(s),null!==e){let t=this.get(e);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.bufferGPU),r+=":"+t.id}for(let e=0;e<t.length;e++){let s,a;let o=t[e],l=this.get(o);r+=":"+l.id,i.bindBuffer(i.ARRAY_BUFFER,l.bufferGPU),i.enableVertexAttribArray(e),(o.isStorageBufferAttribute||o.isStorageInstancedBufferAttribute)&&(n=!1),!0===o.isInterleavedBufferAttribute?(s=o.data.stride*l.bytesPerElement,a=o.offset*l.bytesPerElement):(s=0,a=0),l.isInteger?i.vertexAttribIPointer(e,o.itemSize,l.type,s,a):i.vertexAttribPointer(e,o.itemSize,l.type,o.normalized,s,a),o.isInstancedBufferAttribute&&!o.isInterleavedBufferAttribute?i.vertexAttribDivisor(e,o.meshPerAttribute):o.isInterleavedBufferAttribute&&o.data.isInstancedInterleavedBuffer&&i.vertexAttribDivisor(e,o.data.meshPerAttribute)}return i.bindBuffer(i.ARRAY_BUFFER,null),this.vaoCache[r]=s,{vaoGPU:s,staticVao:n}}_getTransformFeedback(e){let t="";for(let i=0;i<e.length;i++)t+=":"+e[i].id;let i=this.transformFeedbackCache[t];if(void 0!==i)return i;let{gl:s}=this;i=s.createTransformFeedback(),s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,i);for(let t=0;t<e.length;t++){let i=e[t];s.bindBufferBase(s.TRANSFORM_FEEDBACK_BUFFER,t,i.transformBuffer)}return s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=i,i}_setupBindings(e,t){let i=this.gl;for(let s of e)for(let e of s.bindings){let s=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){let r=i.getUniformBlockIndex(t,e.name);i.uniformBlockBinding(t,r,s)}else if(e.isSampledTexture){let r=i.getUniformLocation(t,e.name);i.uniform1i(r,s)}}}_bindUniforms(e){let{gl:t,state:i}=this;for(let s of e)for(let e of s.bindings){let s=this.get(e),r=s.index;e.isUniformsGroup||e.isUniformBuffer?i.bindBufferBase(t.UNIFORM_BUFFER,r,s.bufferGPU):e.isSampledTexture&&i.bindTexture(s.glTextureType,s.textureGPU,t.TEXTURE0+r)}}}class yQ extends yc{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.isSampler=!0}}class yZ extends yQ{constructor(e,t,i){super(e,t?t.value:null),this.textureNode=t,this.groupNode=i}update(){this.texture=this.textureNode.value}}class y0 extends yp{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}let y1=0;class y2 extends y0{constructor(e,t){super("StorageBuffer_"+y1++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:mq.Storage,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class y3 extends cY{constructor(e){super(),this.device=e;let t=`
struct VarysStruct {
	@builtin( position ) Position: vec4<f32>,
	@location( 0 ) vTex : vec2<f32>
};

@vertex
fn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {

	var Varys : VarysStruct;

	var pos = array< vec2<f32>, 4 >(
		vec2<f32>( -1.0,  1.0 ),
		vec2<f32>(  1.0,  1.0 ),
		vec2<f32>( -1.0, -1.0 ),
		vec2<f32>(  1.0, -1.0 )
	);

	var tex = array< vec2<f32>, 4 >(
		vec2<f32>( 0.0, 0.0 ),
		vec2<f32>( 1.0, 0.0 ),
		vec2<f32>( 0.0, 1.0 ),
		vec2<f32>( 1.0, 1.0 )
	);

	Varys.vTex = tex[ vertexIndex ];
	Varys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );

	return Varys;

}
`,i=`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vTex );

}
`,s=`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );

}
`;this.mipmapSampler=e.createSampler({minFilter:mG.Linear}),this.flipYSampler=e.createSampler({minFilter:mG.Nearest}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:t}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:i}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:s})}getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:mP.TriangleStrip,stripIndexFormat:mD.Uint32},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:mP.TriangleStrip,stripIndexFormat:mD.Uint32},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,i=0){let s=t.format,{width:r,height:n}=t.size,a=this.getTransferPipeline(s),o=this.getFlipYPipeline(s),l=this.device.createTexture({size:{width:r,height:n,depthOrArrayLayers:1},format:s,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),h=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:mK.TwoD,baseArrayLayer:i}),u=l.createView({baseMipLevel:0,mipLevelCount:1,dimension:mK.TwoD,baseArrayLayer:0}),d=this.device.createCommandEncoder({}),c=(e,t,i)=>{let s=e.getBindGroupLayout(0),r=this.device.createBindGroup({layout:s,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),n=d.beginRenderPass({colorAttachments:[{view:i,loadOp:mO.Clear,storeOp:mU.Store,clearValue:[0,0,0,0]}]});n.setPipeline(e),n.setBindGroup(0,r),n.draw(4,1,0,0),n.end()};c(a,h,u),c(o,u,h),this.device.queue.submit([d.finish()]),l.destroy()}generateMipmaps(e,t,i=0){let s=this.get(e);void 0===s.useCount&&(s.useCount=0,s.layers=[]);let r=s.layers[i]||this._mipmapCreateBundles(e,t,i),n=this.device.createCommandEncoder({});this._mipmapRunBundles(n,r),this.device.queue.submit([n.finish()]),0!==s.useCount&&(s.layers[i]=r),s.useCount++}_mipmapCreateBundles(e,t,i){let s=this.getTransferPipeline(t.format),r=s.getBindGroupLayout(0),n=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:mK.TwoD,baseArrayLayer:i}),a=[];for(let o=1;o<t.mipLevelCount;o++){let l=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:n}]}),h=e.createView({baseMipLevel:o,mipLevelCount:1,dimension:mK.TwoD,baseArrayLayer:i}),u={colorAttachments:[{view:h,loadOp:mO.Clear,storeOp:mU.Store,clearValue:[0,0,0,0]}]},d=this.device.createRenderBundleEncoder({colorFormats:[t.format]});d.setPipeline(s),d.setBindGroup(0,l),d.draw(4,1,0,0),a.push({renderBundles:[d.finish()],passDescriptor:u}),n=h}return a}_mipmapRunBundles(e,t){let i=t.length;for(let s=0;s<i;s++){let i=t[s],r=e.beginRenderPass(i.passDescriptor);r.executeBundles(i.renderBundles),r.end()}}}let y4={512:"never",513:"less",514:"equal",515:"less-equal",516:"greater",518:"greater-equal",519:"always",517:"not-equal"},y5=[0,1,3,2,4,5];class y6{constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new ib,this.depthTexture.name="depthBuffer"}createSampler(e){let t=this.backend,i=t.device,s=t.get(e),r={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:e.anisotropy};e.isDepthTexture&&null!==e.compareFunction&&(r.compare=y4[e.compareFunction]),s.sampler=i.createSampler(r)}createDefaultTexture(e){let t;let i=y8(e);e.isCubeTexture?t=this._getDefaultCubeTextureGPU(i):e.isVideoTexture?this.backend.get(e).externalTexture=this._getDefaultVideoFrame():t=this._getDefaultTextureGPU(i),this.backend.get(e).texture=t}createTexture(e,t={}){let i=this.backend,s=i.get(e);if(s.initialized)throw Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);let{width:r,height:n,depth:a,levels:o}=t,l=this._getDimension(e),h=e.internalFormat||t.format||y8(e,i.device),u=void 0!==t.sampleCount?t.sampleCount:1;u=i.utils.getSampleCount(u);let d=e.isRenderTargetTexture&&!e.isMultisampleRenderTargetTexture?1:u,c=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(c|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&!0!==e.isCompressedArrayTexture&&(c|=GPUTextureUsage.RENDER_ATTACHMENT);let p={label:e.name,size:{width:r,height:n,depthOrArrayLayers:a},mipLevelCount:o,sampleCount:d,dimension:l,format:h,usage:c};if(e.isVideoTexture){let t=e.source.data,i=new VideoFrame(t);p.size.width=i.displayWidth,p.size.height=i.displayHeight,i.close(),s.externalTexture=t}else{if(void 0===h)return console.warn("WebGPURenderer: Texture format not supported."),this.createDefaultTexture(e);s.texture=i.device.createTexture(p)}if(e.isRenderTargetTexture&&u>1&&!e.isMultisampleRenderTargetTexture){let e=Object.assign({},p);e.label=e.label+"-msaa",e.sampleCount=u,s.msaaTexture=i.device.createTexture(e)}s.initialized=!0,s.textureDescriptorGPU=p}destroyTexture(e){let t=this.backend,i=t.get(e);i.texture.destroy(),void 0!==i.msaaTexture&&i.msaaTexture.destroy(),t.delete(e)}destroySampler(e){let t=this.backend.get(e);delete t.sampler}generateMipmaps(e){let t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else{let i=e.image.depth||1;for(let e=0;e<i;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();let e=this.backend,{width:t,height:i}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:i,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){let i,s;let r=this.backend,{width:n,height:a}=r.getDrawingBufferSize(),o=this.depthTexture,l=r.get(o).texture;if(t?(i=1027,s=1020):e&&(i=1026,s=1014),void 0!==l){if(o.image.width===n&&o.image.height===a&&o.format===i&&o.type===s)return l;this.destroyTexture(o)}return o.name="depthBuffer",o.format=i,o.type=s,o.image.width=n,o.image.height=a,this.createTexture(o,{sampleCount:r.utils.getSampleCount(r.renderer.samples),width:n,height:a}),r.get(o).texture}updateTexture(e,t){let i=this.backend.get(e),{textureDescriptorGPU:s}=i;if(!e.isRenderTargetTexture&&void 0!==s){if(e.isDataTexture)this._copyBufferToTexture(t.image,i.texture,s,0,e.flipY);else if(e.isDataArrayTexture||e.isData3DTexture)for(let r=0;r<t.image.depth;r++)this._copyBufferToTexture(t.image,i.texture,s,r,e.flipY,r);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,i.texture,s);else if(e.isCubeTexture)this._copyCubeMapToTexture(t.images,i.texture,s,e.flipY);else if(e.isVideoTexture){let t=e.source.data;i.externalTexture=t}else this._copyImageToTexture(t.image,i.texture,s,0,e.flipY);i.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,i,s,r){let n=this.backend.device,a=this.backend.get(e),o=a.texture,l=a.textureDescriptorGPU.format,h=this._getBytesPerTexel(l),u=s*h;u=256*Math.ceil(u/256);let d=n.createBuffer({size:s*r*h,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),c=n.createCommandEncoder();c.copyTextureToBuffer({texture:o,origin:{x:t,y:i}},{buffer:d,bytesPerRow:u},{width:s,height:r});let p=this._getTypedArrayType(l);return n.queue.submit([c.finish()]),await d.mapAsync(GPUMapMode.READ),new p(d.getMappedRange())}_isEnvironmentTexture(e){let t=e.mapping;return 303===t||304===t||301===t||302===t}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){let i=new V;i.minFilter=1003,i.magFilter=1003,this.createTexture(i,{width:1,height:1,format:e}),this.defaultTexture[e]=t=i}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){let i=new t0;i.minFilter=1003,i.magFilter=1003,this.createTexture(i,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=i}return this.backend.get(t).texture}_getDefaultVideoFrame(){let e=this.defaultVideoFrame;return null===e&&(this.defaultVideoFrame=e=new VideoFrame(new Uint8Array([0,0,0,255]),{timestamp:0,codedWidth:1,codedHeight:1,format:"RGBA"})),e}_copyCubeMapToTexture(e,t,i,s){for(let r=0;r<6;r++){let n=e[r],a=!0===s?y5[r]:r;n.isDataTexture?this._copyBufferToTexture(n.image,t,i,a,s):this._copyImageToTexture(n,t,i,a,s)}}_copyImageToTexture(e,t,i,s,r){this.backend.device.queue.copyExternalImageToTexture({source:e},{texture:t,mipLevel:0,origin:{x:0,y:0,z:s}},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===r&&this._flipY(t,i,s)}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new y3(this.backend.device)),e}_generateMipmaps(e,t,i=0){this._getPassUtils().generateMipmaps(e,t,i)}_flipY(e,t,i=0){this._getPassUtils().flipY(e,t,i)}_copyBufferToTexture(e,t,i,s,r,n=0){let a=this.backend.device,o=e.data,l=this._getBytesPerTexel(i.format),h=e.width*l;a.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:s}},o,{offset:e.width*e.height*l*n,bytesPerRow:h},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===r&&this._flipY(t,i,s)}_copyCompressedBufferToTexture(e,t,i){let s=this.backend.device,r=this._getBlockData(i.format),n=i.size.depthOrArrayLayers>1;for(let a=0;a<e.length;a++){let o=e[a],l=o.width,h=o.height,u=n?i.size.depthOrArrayLayers:1,d=Math.ceil(l/r.width)*r.byteLength,c=d*Math.ceil(h/r.height);for(let e=0;e<u;e++)s.queue.writeTexture({texture:t,mipLevel:a,origin:{x:0,y:0,z:e}},o.data,{offset:e*c,bytesPerRow:d,rowsPerImage:Math.ceil(h/r.height)},{width:Math.ceil(l/r.width)*r.width,height:Math.ceil(h/r.height)*r.height,depthOrArrayLayers:1})}}_getBlockData(e){return e===mV.BC1RGBAUnorm||e===mV.BC1RGBAUnormSRGB?{byteLength:8,width:4,height:4}:e===mV.BC2RGBAUnorm||e===mV.BC2RGBAUnormSRGB||e===mV.BC3RGBAUnorm||e===mV.BC3RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===mV.BC4RUnorm||e===mV.BC4RSNorm?{byteLength:8,width:4,height:4}:e===mV.BC5RGUnorm||e===mV.BC5RGSnorm||e===mV.BC6HRGBUFloat||e===mV.BC6HRGBFloat||e===mV.BC7RGBAUnorm||e===mV.BC7RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===mV.ETC2RGB8Unorm||e===mV.ETC2RGB8UnormSRGB||e===mV.ETC2RGB8A1Unorm||e===mV.ETC2RGB8A1UnormSRGB?{byteLength:8,width:4,height:4}:e===mV.ETC2RGBA8Unorm||e===mV.ETC2RGBA8UnormSRGB?{byteLength:16,width:4,height:4}:e===mV.EACR11Unorm||e===mV.EACR11Snorm?{byteLength:8,width:4,height:4}:e===mV.EACRG11Unorm||e===mV.EACRG11Snorm||e===mV.ASTC4x4Unorm||e===mV.ASTC4x4UnormSRGB?{byteLength:16,width:4,height:4}:e===mV.ASTC5x4Unorm||e===mV.ASTC5x4UnormSRGB?{byteLength:16,width:5,height:4}:e===mV.ASTC5x5Unorm||e===mV.ASTC5x5UnormSRGB?{byteLength:16,width:5,height:5}:e===mV.ASTC6x5Unorm||e===mV.ASTC6x5UnormSRGB?{byteLength:16,width:6,height:5}:e===mV.ASTC6x6Unorm||e===mV.ASTC6x6UnormSRGB?{byteLength:16,width:6,height:6}:e===mV.ASTC8x5Unorm||e===mV.ASTC8x5UnormSRGB?{byteLength:16,width:8,height:5}:e===mV.ASTC8x6Unorm||e===mV.ASTC8x6UnormSRGB?{byteLength:16,width:8,height:6}:e===mV.ASTC8x8Unorm||e===mV.ASTC8x8UnormSRGB?{byteLength:16,width:8,height:8}:e===mV.ASTC10x5Unorm||e===mV.ASTC10x5UnormSRGB?{byteLength:16,width:10,height:5}:e===mV.ASTC10x6Unorm||e===mV.ASTC10x6UnormSRGB?{byteLength:16,width:10,height:6}:e===mV.ASTC10x8Unorm||e===mV.ASTC10x8UnormSRGB?{byteLength:16,width:10,height:8}:e===mV.ASTC10x10Unorm||e===mV.ASTC10x10UnormSRGB?{byteLength:16,width:10,height:10}:e===mV.ASTC12x10Unorm||e===mV.ASTC12x10UnormSRGB?{byteLength:16,width:12,height:10}:e===mV.ASTC12x12Unorm||e===mV.ASTC12x12UnormSRGB?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=mk.ClampToEdge;return 1e3===e?t=mk.Repeat:1002===e&&(t=mk.MirrorRepeat),t}_convertFilterMode(e){let t=mG.Linear;return(1003===e||1004===e||1005===e)&&(t=mG.Nearest),t}_getBytesPerTexel(e){return e===mV.R8Unorm||e===mV.R8Snorm||e===mV.R8Uint||e===mV.R8Sint?1:e===mV.R16Uint||e===mV.R16Sint||e===mV.R16Float||e===mV.RG8Unorm||e===mV.RG8Snorm||e===mV.RG8Uint||e===mV.RG8Sint?2:e===mV.R32Uint||e===mV.R32Sint||e===mV.R32Float||e===mV.RG16Uint||e===mV.RG16Sint||e===mV.RG16Float||e===mV.RGBA8Unorm||e===mV.RGBA8UnormSRGB||e===mV.RGBA8Snorm||e===mV.RGBA8Uint||e===mV.RGBA8Sint||e===mV.BGRA8Unorm||e===mV.BGRA8UnormSRGB||e===mV.RGB9E5UFloat||e===mV.RGB10A2Unorm||e===mV.RG11B10UFloat||e===mV.Depth32Float||e===mV.Depth24Plus||e===mV.Depth24PlusStencil8||e===mV.Depth32FloatStencil8?4:e===mV.RG32Uint||e===mV.RG32Sint||e===mV.RG32Float||e===mV.RGBA16Uint||e===mV.RGBA16Sint||e===mV.RGBA16Float?8:e===mV.RGBA32Uint||e===mV.RGBA32Sint||e===mV.RGBA32Float?16:void 0}_getTypedArrayType(e){return e===mV.R8Uint?Uint8Array:e===mV.R8Sint?Int8Array:e===mV.R8Unorm?Uint8Array:e===mV.R8Snorm?Int8Array:e===mV.RG8Uint?Uint8Array:e===mV.RG8Sint?Int8Array:e===mV.RG8Unorm?Uint8Array:e===mV.RG8Snorm?Int8Array:e===mV.RGBA8Uint?Uint8Array:e===mV.RGBA8Sint?Int8Array:e===mV.RGBA8Unorm?Uint8Array:e===mV.RGBA8Snorm?Int8Array:e===mV.R16Uint?Uint16Array:e===mV.R16Sint?Int16Array:e===mV.RG16Uint?Uint16Array:e===mV.RG16Sint?Int16Array:e===mV.RGBA16Uint?Uint16Array:e===mV.RGBA16Sint?Int16Array:e===mV.R16Float||e===mV.RG16Float||e===mV.RGBA16Float?Float32Array:e===mV.R32Uint?Uint32Array:e===mV.R32Sint?Int32Array:e===mV.R32Float?Float32Array:e===mV.RG32Uint?Uint32Array:e===mV.RG32Sint?Int32Array:e===mV.RG32Float?Float32Array:e===mV.RGBA32Uint?Uint32Array:e===mV.RGBA32Sint?Int32Array:e===mV.RGBA32Float?Float32Array:e===mV.BGRA8Unorm||e===mV.BGRA8UnormSRGB?Uint8Array:e===mV.RGB10A2Unorm||e===mV.RGB9E5UFloat||e===mV.RG11B10UFloat?Uint32Array:e===mV.Depth32Float?Float32Array:e===mV.Depth24Plus||e===mV.Depth24PlusStencil8?Uint32Array:e===mV.Depth32FloatStencil8?Float32Array:void 0}_getDimension(e){return e.isData3DTexture?mJ.ThreeD:mJ.TwoD}}function y8(e,t=null){let i;let s=e.format,r=e.type,n=e.colorSpace;if(!0===e.isFramebufferTexture&&1009===e.type)i=mV.BGRA8Unorm;else if(!0===e.isCompressedTexture||!0===e.isCompressedArrayTexture)switch(s){case 33777:i=n===a?mV.BC1RGBAUnormSRGB:mV.BC1RGBAUnorm;break;case 33778:i=n===a?mV.BC2RGBAUnormSRGB:mV.BC2RGBAUnorm;break;case 33779:i=n===a?mV.BC3RGBAUnormSRGB:mV.BC3RGBAUnorm;break;case 37492:i=n===a?mV.ETC2RGB8UnormSRGB:mV.ETC2RGB8Unorm;break;case 37496:i=n===a?mV.ETC2RGBA8UnormSRGB:mV.ETC2RGBA8Unorm;break;case 37808:i=n===a?mV.ASTC4x4UnormSRGB:mV.ASTC4x4Unorm;break;case 37809:i=n===a?mV.ASTC5x4UnormSRGB:mV.ASTC5x4Unorm;break;case 37810:i=n===a?mV.ASTC5x5UnormSRGB:mV.ASTC5x5Unorm;break;case 37811:i=n===a?mV.ASTC6x5UnormSRGB:mV.ASTC6x5Unorm;break;case 37812:i=n===a?mV.ASTC6x6UnormSRGB:mV.ASTC6x6Unorm;break;case 37813:i=n===a?mV.ASTC8x5UnormSRGB:mV.ASTC8x5Unorm;break;case 37814:i=n===a?mV.ASTC8x6UnormSRGB:mV.ASTC8x6Unorm;break;case 37815:i=n===a?mV.ASTC8x8UnormSRGB:mV.ASTC8x8Unorm;break;case 37816:i=n===a?mV.ASTC10x5UnormSRGB:mV.ASTC10x5Unorm;break;case 37817:i=n===a?mV.ASTC10x6UnormSRGB:mV.ASTC10x6Unorm;break;case 37818:i=n===a?mV.ASTC10x8UnormSRGB:mV.ASTC10x8Unorm;break;case 37819:i=n===a?mV.ASTC10x10UnormSRGB:mV.ASTC10x10Unorm;break;case 37820:i=n===a?mV.ASTC12x10UnormSRGB:mV.ASTC12x10Unorm;break;case 37821:i=n===a?mV.ASTC12x12UnormSRGB:mV.ASTC12x12Unorm;break;default:console.error("WebGPURenderer: Unsupported texture format.",s)}else switch(s){case 1023:switch(r){case 1010:i=mV.RGBA8Snorm;break;case 1011:i=mV.RGBA16Sint;break;case 1012:i=mV.RGBA16Uint;break;case 1014:i=mV.RGBA32Uint;break;case 1013:i=mV.RGBA32Sint;break;case 1009:i=n===a?mV.RGBA8UnormSRGB:mV.RGBA8Unorm;break;case 1016:i=mV.RGBA16Float;break;case 1015:i=mV.RGBA32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAFormat.",r)}break;case 1022:35902===r?i=mV.RGB9E5UFloat:console.error("WebGPURenderer: Unsupported texture type with RGBFormat.",r);break;case 1028:switch(r){case 1010:i=mV.R8Snorm;break;case 1011:i=mV.R16Sint;break;case 1012:i=mV.R16Uint;break;case 1014:i=mV.R32Uint;break;case 1013:i=mV.R32Sint;break;case 1009:i=mV.R8Unorm;break;case 1016:i=mV.R16Float;break;case 1015:i=mV.R32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RedFormat.",r)}break;case 1030:switch(r){case 1010:i=mV.RG8Snorm;break;case 1011:i=mV.RG16Sint;break;case 1012:i=mV.RG16Uint;break;case 1014:i=mV.RG32Uint;break;case 1013:i=mV.RG32Sint;break;case 1009:i=mV.RG8Unorm;break;case 1016:i=mV.RG16Float;break;case 1015:i=mV.RG32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGFormat.",r)}break;case 1026:switch(r){case 1012:i=mV.Depth16Unorm;break;case 1014:i=mV.Depth24Plus;break;case 1015:i=mV.Depth32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthFormat.",r)}break;case 1027:switch(r){case 1020:i=mV.Depth24PlusStencil8;break;case 1015:t&&!1===t.features.has(m0.Depth32FloatStencil8)&&console.error('WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.'),i=mV.Depth32FloatStencil8;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthStencilFormat.",r)}break;case 1029:switch(r){case 1013:i=mV.R32Sint;break;case 1014:i=mV.R32Uint;break;default:console.error("WebGPURenderer: Unsupported texture type with RedIntegerFormat.",r)}break;case 1031:switch(r){case 1013:i=mV.RG32Sint;break;case 1014:i=mV.RG32Uint;break;default:console.error("WebGPURenderer: Unsupported texture type with RGIntegerFormat.",r)}break;case 1033:switch(r){case 1013:i=mV.RGBA32Sint;break;case 1014:i=mV.RGBA32Uint;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAIntegerFormat.",r)}break;default:console.error("WebGPURenderer: Unsupported texture format.",s)}return i}let y7=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,y9=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/ig,xe={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"},xt=e=>{let t=(e=e.trim()).match(y7);if(null!==t&&4===t.length){let i=t[2],s=[],r=null;for(;null!==(r=y9.exec(i));)s.push({name:r[1],type:r[2]});let n=[];for(let e=0;e<s.length;e++){let{name:t,type:i}=s[e],r=i;r.startsWith("texture")&&(r=i.split("<")[0]),r=xe[r]||r,n.push(new pZ(r,t))}let a=e.substring(t[0].length),o=t[3]||"void",l=void 0!==t[1]?t[1]:"";return{type:xe[o]||o,inputs:n,name:l,inputsCode:i,blockCode:a,outputType:o}}throw Error("FunctionNode: Function is not a WGSL code.")};class xi extends fr{constructor(e){let{type:t,inputs:i,name:s,inputsCode:r,blockCode:n,outputType:a}=xt(e);super(t,i,s),this.inputsCode=r,this.blockCode=n,this.outputType=a}getCode(e=this.name){let t="void"!==this.outputType?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}}class xs extends fs{parseFunction(e){return new xi(e)}}let xr=self.GPUShaderStage,xn={vertex:xr?xr.VERTEX:1,fragment:xr?xr.FRAGMENT:2,compute:xr?xr.COMPUTE:4},xa={instance:!0,swizzleAssign:!1,storageBuffer:!0},xo={"^^":"tsl_xor"},xl={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",imat2:"mat2x2<i32>",umat2:"mat2x2<u32>",bmat2:"mat2x2<bool>",mat3:"mat3x3<f32>",imat3:"mat3x3<i32>",umat3:"mat3x3<u32>",bmat3:"mat3x3<bool>",mat4:"mat4x4<f32>",imat4:"mat4x4<i32>",umat4:"mat4x4<u32>",bmat4:"mat4x4<bool>"},xh={tsl_xor:new po("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new po("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new po("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new po("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new po("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new po("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new po("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new po("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new po("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping:new po(`
fn tsl_repeatWrapping( uv : vec2<f32>, dimension : vec2<u32> ) -> vec2<u32> {

	let uvScaled = vec2<u32>( uv * vec2<f32>( dimension ) );

	return ( ( uvScaled % dimension ) + dimension ) % dimension;

}
`),biquadraticTexture:new po(`
fn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, level : i32 ) -> vec4f {

	let res = vec2f( textureDimensions( map, level ) );

	let uvScaled = coord * res;
	let uvWrapping = ( ( uvScaled % res ) + res ) % res;

	// https://www.shadertoy.com/view/WtyXRy

	let uv = uvWrapping - 0.5;
	let iuv = floor( uv );
	let f = fract( uv );

	let rg1 = textureLoad( map, vec2i( iuv + vec2( 0.5, 0.5 ) ), level );
	let rg2 = textureLoad( map, vec2i( iuv + vec2( 1.5, 0.5 ) ), level );
	let rg3 = textureLoad( map, vec2i( iuv + vec2( 0.5, 1.5 ) ), level );
	let rg4 = textureLoad( map, vec2i( iuv + vec2( 1.5, 1.5 ) ), level );

	return mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );

}
`)},xu={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};/Windows/g.test(navigator.userAgent)&&(xh.pow_float=new po("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),xh.pow_vec2=new po("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[xh.pow_float]),xh.pow_vec3=new po("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[xh.pow_float]),xh.pow_vec4=new po("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[xh.pow_float]),xu.pow_float="tsl_pow_float",xu.pow_vec2="tsl_pow_vec2",xu.pow_vec3="tsl_pow_vec3",xu.pow_vec4="tsl_pow_vec4");class xd extends pK{constructor(e,t){super(e,t,new xs),this.uniformGroups={},this.builtins={},this.directives={}}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&""!==e.colorSpace}_generateTextureSample(e,t,i,s,r=this.shaderStage){return"fragment"===r?s?`textureSample( ${t}, ${t}_sampler, ${i}, ${s} )`:`textureSample( ${t}, ${t}_sampler, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,i):this.generateTextureLod(e,t,i,"0")}_generateVideoSample(e,t,i=this.shaderStage){if("fragment"===i)return`textureSampleBaseClampToEdge( ${e}, ${e}_sampler, vec2<f32>( ${t}.x, 1.0 - ${t}.y ) )`;console.error(`WebGPURenderer: THREE.VideoTexture does not support ${i} shader.`)}_generateTextureSampleLevel(e,t,i,s,r,n=this.shaderStage){return"fragment"===n&&!1===this.isUnfilterable(e)?`textureSampleLevel( ${t}, ${t}_sampler, ${i}, ${s} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,i,s):this.generateTextureLod(e,t,i,s)}generateFilteredTexture(e,t,i,s="0"){return this._include("biquadraticTexture"),`tsl_biquadraticTexture( ${t}, ${i}, i32( ${s} ) )`}generateTextureLod(e,t,i,s="0"){this._include("repeatWrapping");let r=!0===e.isMultisampleRenderTargetTexture?`textureDimensions( ${t} )`:`textureDimensions( ${t}, 0 )`;return`textureLoad( ${t}, tsl_repeatWrapping( ${i}, ${r} ), i32( ${s} ) )`}generateTextureLoad(e,t,i,s,r="0u"){return s?`textureLoad( ${t}, ${i}, ${s}, ${r} )`:`textureLoad( ${t}, ${i}, ${r} )`}generateTextureStore(e,t,i,s){return`textureStore( ${t}, ${i}, ${s} )`}isUnfilterable(e){return"float"!==this.getComponentTypeFromTexture(e)||!this.isAvailable("float32Filterable")&&!0===e.isDataTexture&&1015===e.type||!0===e.isMultisampleRenderTargetTexture}generateTexture(e,t,i,s,r=this.shaderStage){return!0===e.isVideoTexture?this._generateVideoSample(t,i,r):this.isUnfilterable(e)?this.generateTextureLod(e,t,i,"0",s,r):this._generateTextureSample(e,t,i,s,r)}generateTextureGrad(e,t,i,s,r,n=this.shaderStage){if("fragment"===n)return`textureSampleGrad( ${t}, ${t}_sampler, ${i},  ${s[0]}, ${s[1]} )`;console.error(`WebGPURenderer: THREE.TextureNode.gradient() does not support ${n} shader.`)}generateTextureCompare(e,t,i,s,r,n=this.shaderStage){if("fragment"===n)return`textureSampleCompare( ${t}, ${t}_sampler, ${i}, ${s} )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${n} shader.`)}generateTextureLevel(e,t,i,s,r,n=this.shaderStage){return!0===e.isVideoTexture?this._generateVideoSample(t,i,n):this._generateTextureSampleLevel(e,t,i,s,r,n)}generateTextureBias(e,t,i,s,r,n=this.shaderStage){if("fragment"===n)return`textureSampleBias( ${t}, ${t}_sampler, ${i}, ${s} )`;console.error(`WebGPURenderer: THREE.TextureNode.biasNode does not support ${n} shader.`)}getPropertyName(e,t=this.shaderStage){if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return`varyings.${e.name}`}else if(!0===e.isNodeUniform){let t=e.name,i=e.type;return"texture"===i||"cubeTexture"===i||"storageTexture"===i||"texture3D"===i?t:"buffer"===i||"storageBuffer"===i?`NodeBuffer_${e.id}.${t}`:e.groupNode.name+"."+t}return super.getPropertyName(e)}getOutputStructName(){return"output"}_getUniformGroupCount(e){return Object.keys(this.uniforms[e]).length}getFunctionOperator(e){let t=xo[e];return void 0!==t?(this._include(t),t):null}getStorageAccess(e){if(e.isStorageTextureNode)switch(e.access){case mX.ReadOnly:return"read";case mX.WriteOnly:return"write";default:return"read_write"}else switch(e.access){case mq.Storage:return"read_write";case mq.ReadOnlyStorage:return"read";default:return"write"}}getUniformFromNode(e,t,i,s=null){let r=super.getUniformFromNode(e,t,i,s),n=this.getDataFromNode(e,i,this.globalCache);if(void 0===n.uniformGPU){let s;let a=e.groupNode,o=a.name,l=this.getBindGroupArray(o,i);if("texture"===t||"cubeTexture"===t||"storageTexture"===t||"texture3D"===t){let n=null;if("texture"===t||"storageTexture"===t?n=new yS(r.name,r.node,a,e.access?e.access:null):"cubeTexture"===t?n=new y_(r.name,r.node,a,e.access?e.access:null):"texture3D"===t&&(n=new yM(r.name,r.node,a,e.access?e.access:null)),n.store=!0===e.isStorageTextureNode,n.setVisibility(xn[i]),"fragment"===i&&!1===this.isUnfilterable(e.value)&&!1===n.store){let e=new yZ(`${r.name}_sampler`,r.node,a);e.setVisibility(xn[i]),l.push(e,n),s=[e,n]}else l.push(n),s=[n]}else if("buffer"===t||"storageBuffer"===t){let r=new("storageBuffer"===t?y2:yf)(e,a);r.setVisibility(xn[i]),l.push(r),s=r}else{let e=this.uniformGroups[i]||(this.uniformGroups[i]={}),n=e[o];void 0===n&&((n=new yb(o,a)).setVisibility(xn[i]),e[o]=n,l.push(n)),s=this.getNodeUniform(r,t),n.addUniform(s)}n.uniformGPU=s}return r}getBuiltin(e,t,i,s=this.shaderStage){let r=this.builtins[s]||(this.builtins[s]=new Map);return!1===r.has(e)&&r.set(e,{name:e,property:t,type:i}),t}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){let t=e.layout,i=this.flowShaderNode(e),s=[];for(let e of t.inputs)s.push(e.name+" : "+this.getType(e.type));let r=`fn ${t.name}( ${s.join(", ")} ) -> ${this.getType(t.type)} {
${i.vars}
${i.code}
`;return i.result&&(r+=`	return ${i.result};
`),r+="\n}\n"}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){let t=[],i=this.directives[e];if(void 0!==i)for(let e of i)t.push(`enable ${e};`);return t.join("\n")}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}getBuiltins(e){let t=[],i=this.builtins[e];if(void 0!==i)for(let{name:e,property:s,type:r}of i.values())t.push(`@builtin( ${e} ) ${s} : ${r}`);return t.join(",\n	")}getAttributes(e){let t=[];if("compute"===e&&(this.getBuiltin("global_invocation_id","id","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute")),"vertex"===e||"compute"===e){let e=this.getBuiltins("attribute");e&&t.push(e);let i=this.getAttributesArray();for(let e=0,s=i.length;e<s;e++){let s=i[e],r=s.name,n=this.getType(s.type);t.push(`@location( ${e} ) ${r} : ${n}`)}}return t.join(",\n	")}getStructMembers(e){let t=[],i=e.getMemberTypes();for(let e=0;e<i.length;e++){let s=i[e];t.push(`	@location( ${e} ) m${e} : ${s}<f32>`)}let s=this.getBuiltins("output");return s&&t.push("	"+s),t.join(",\n")}getStructs(e){let t=[],i=this.structs[e];for(let e=0,s=i.length;e<s;e++){let s=i[e],r=s.name,n=`struct ${r} {
`;n+=this.getStructMembers(s)+"\n}",t.push(n),t.push(`
var<private> output : ${r};

`)}return t.join("\n\n")}getVar(e,t){return`var ${t} : ${this.getType(e)}`}getVars(e){let t=[],i=this.vars[e];if(void 0!==i)for(let e of i)t.push(`	${this.getVar(e.type,e.name)};`);return`
${t.join("\n")}
`}getVaryings(e){let t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){let i=this.varyings,s=this.vars[e];for(let r=0;r<i.length;r++){let n=i[r];if(n.needsInterpolation){let e=`@location( ${r} )`;/^(int|uint|ivec|uvec)/.test(n.type)&&(e+=" @interpolate( flat )"),t.push(`${e} ${n.name} : ${this.getType(n.type)}`)}else"vertex"===e&&!1===s.includes(n)&&s.push(n)}}let i=this.getBuiltins(e);i&&t.push(i);let s=t.join(",\n	");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","	"+s):s}getUniforms(e){let t=this.uniforms[e],i=[],s=[],r=[],n={};for(let r of t){let t=r.groupNode.name,a=this.bindingsIndexes[t];if("texture"===r.type||"cubeTexture"===r.type||"storageTexture"===r.type||"texture3D"===r.type){let t;let s=r.node.value;"fragment"===e&&!1===this.isUnfilterable(s)&&!0!==r.node.isStorageTextureNode&&(!0===s.isDepthTexture&&null!==s.compareFunction?i.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name}_sampler : sampler_comparison;`):i.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name}_sampler : sampler;`));let n="";if(!0===s.isMultisampleRenderTargetTexture&&(n="_multisampled"),!0===s.isCubeTexture)t="texture_cube<f32>";else if(!0===s.isDataArrayTexture||!0===s.isCompressedArrayTexture)t="texture_2d_array<f32>";else if(!0===s.isDepthTexture)t=`texture_depth${n}_2d`;else if(!0===s.isVideoTexture)t="texture_external";else if(!0===s.isData3DTexture)t="texture_3d<f32>";else if(!0===r.node.isStorageTextureNode){let e=y8(s),i=this.getStorageAccess(r.node);t=`texture_storage_2d<${e}, ${i}>`}else{let e=this.getComponentTypeFromTexture(s).charAt(0);t=`texture${n}_2d<${e}32>`}i.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name} : ${t};`)}else if("buffer"===r.type||"storageBuffer"===r.type){let e=r.node,t=this.getType(e.bufferType),i=e.bufferCount,n=i>0?", "+i:"",o=`	${r.name} : array< ${t}${n} >
`,l=e.isStorageBufferNode?`storage, ${this.getStorageAccess(e)}`:"uniform";s.push(this._getWGSLStructBinding("NodeBuffer_"+e.id,o,l,a.binding++,a.group))}else{let e=this.getType(this.getVectorType(r.type)),t=r.groupNode.name;(n[t]||(n[t]={index:a.binding++,id:a.group,snippets:[]})).snippets.push(`	${r.name} : ${e}`)}}for(let e in n){let t=n[e];r.push(this._getWGSLStructBinding(e,t.snippets.join(",\n"),"uniform",t.index,t.id))}return i.join("\n")+(s.join("\n")+r.join("\n"))}buildCode(){let e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};for(let t in e){let i=e[t];i.uniforms=this.getUniforms(t),i.attributes=this.getAttributes(t),i.varyings=this.getVaryings(t),i.structs=this.getStructs(t),i.vars=this.getVars(t),i.codes=this.getCodes(t),i.directives=this.getDirectives(t);let s="// code\n\n";s+=this.flowCode[t];let r=this.flowNodes[t],n=r[r.length-1],a=n.outputNode,o=void 0!==a&&!0===a.isOutputStructNode;for(let e of r){let r=this.getFlowData(e),l=e.name;if(l&&(s.length>0&&(s+="\n"),s+=`	// flow -> ${l}
	`),s+=`${r.code}
	`,e===n&&"compute"!==t){if(s+="// result\n\n	","vertex"===t)s+=`varyings.Vertex = ${r.result};`;else if("fragment"===t){if(o)i.returnType=a.nodeType,s+=`return ${r.result};`;else{let e="	@location(0) color: vec4<f32>",t=this.getBuiltins("output");t&&(e+=",\n	"+t),i.returnType="OutputStruct",i.structs+=this._getWGSLStruct("OutputStruct",e),i.structs+="\nvar<private> output : OutputStruct;\n\n",s+=`output.color = ${r.result};

	return output;`}}}}i.flow=s}null!==this.material?(this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment)):this.computeShader=this._getWGSLComputeCode(e.compute,(this.object.workgroupSize||[64]).join(", "))}getMethod(e,t=null){let i;return null!==t&&(i=this._getWGSLMethod(e+"_"+t)),void 0===i&&(i=this._getWGSLMethod(e)),i||e}getType(e){return xl[e]||e}isAvailable(e){let t=xa[e];return void 0===t&&("float32Filterable"===e&&(t=this.renderer.hasFeature("float32-filterable")),xa[e]=t),t}_getWGSLMethod(e){return void 0!==xh[e]&&this._include(e),xu[e]}_include(e){let t=xh[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}
// directives
${e.directives}

// uniforms
${e.uniforms}

// varyings
${e.varyings}
var<private> varyings : VaryingsStruct;

// codes
${e.codes}

@vertex
fn main( ${e.attributes} ) -> VaryingsStruct {

	// vars
	${e.vars}

	// flow
	${e.flow}

	return varyings;

}
`}_getWGSLFragmentCode(e){return`${this.getSignature()}

diagnostic( off, derivative_uniformity );

// uniforms
${e.uniforms}

// structs
${e.structs}

// codes
${e.codes}

@fragment
fn main( ${e.varyings} ) -> ${e.returnType} {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLComputeCode(e,t){return`${this.getSignature()}
// directives
${e.directives}

// system
var<private> instanceIndex : u32;

// uniforms
${e.uniforms}

// codes
${e.codes}

@compute @workgroup_size( ${t} )
fn main( ${e.attributes} ) {

	// system
	instanceIndex = id.x + id.y * numWorkgroups.x * u32(${t}) + id.z * numWorkgroups.x * numWorkgroups.y * u32(${t});

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLStruct(e,t){return`
struct ${e} {
${t}
};`}_getWGSLStructBinding(e,t,i,s=0,r=0){let n=e+"Struct",a=this._getWGSLStruct(n,t);return`${a}
@binding( ${s} ) @group( ${r} )
var<${i}> ${e} : ${n};`}}class xc{constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=mV.Depth24PlusStencil8:e.depth&&(t=mV.Depth24Plus),t}getTextureFormatGPU(e){return this.backend.get(e).texture.format}getCurrentColorFormat(e){return null!==e.textures?this.getTextureFormatGPU(e.textures[0]):this.getPreferredCanvasFormat()}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?mP.PointList:e.isLineSegments||e.isMesh&&!0===t.wireframe?mP.LineList:e.isLine?mP.LineStrip:e.isMesh?mP.TriangleList:void 0}getSampleCount(e){let t=1;return e>1&&2===(t=Math.pow(2,Math.floor(Math.log2(e))))&&(t=4),t}getSampleCountRenderContext(e){return null!==e.textures?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.samples)}getPreferredCanvasFormat(){return navigator.userAgent.includes("Quest")?mV.BGRA8Unorm:navigator.gpu.getPreferredCanvasFormat()}}let xp=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]),xm=new Map([[tm,["float16"]]]),xg=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]);class xf{constructor(e){this.backend=e}createAttribute(e,t){let i=this._getBufferAttribute(e),s=this.backend,r=s.get(i),n=r.buffer;if(void 0===n){let a=s.device,o=i.array;if(!1===e.normalized&&(o.constructor===Int16Array||o.constructor===Uint16Array)){let e=new Uint32Array(o.length);for(let t=0;t<o.length;t++)e[t]=o[t];o=e}if(i.array=o,(i.isStorageBufferAttribute||i.isStorageInstancedBufferAttribute)&&3===i.itemSize){o=new o.constructor(4*i.count);for(let e=0;e<i.count;e++)o.set(i.array.subarray(3*e,3*e+3),4*e);i.itemSize=4,i.array=o}let l=o.byteLength+(4-o.byteLength%4)%4;n=a.createBuffer({label:i.name,size:l,usage:t,mappedAtCreation:!0}),new o.constructor(n.getMappedRange()).set(o),n.unmap(),r.buffer=n}}updateAttribute(e){let t=this._getBufferAttribute(e),i=this.backend,s=i.device,r=i.get(t).buffer,n=t.array,a=t.updateRanges;if(0===a.length)s.queue.writeBuffer(r,0,n,0);else{for(let e=0,t=a.length;e<t;e++){let t=a[e];s.queue.writeBuffer(r,0,n,t.start*n.BYTES_PER_ELEMENT,t.count*n.BYTES_PER_ELEMENT)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){let t=e.getAttributes(),i=new Map;for(let e=0;e<t.length;e++){let s=t[e],r=s.array.BYTES_PER_ELEMENT,n=this._getBufferAttribute(s),a=i.get(n);if(void 0===a){let e,t;!0===s.isInterleavedBufferAttribute?(e=s.data.stride*r,t=s.data.isInstancedInterleavedBuffer?mZ.Instance:mZ.Vertex):(e=s.itemSize*r,t=s.isInstancedBufferAttribute?mZ.Instance:mZ.Vertex),!1===s.normalized&&(s.array.constructor===Int16Array||s.array.constructor===Uint16Array)&&(e=4),a={arrayStride:e,attributes:[],stepMode:t},i.set(n,a)}let o=this._getVertexFormat(s),l=!0===s.isInterleavedBufferAttribute?s.offset*r:0;a.attributes.push({shaderLocation:e,offset:l,format:o})}return Array.from(i.values())}destroyAttribute(e){let t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){let t=this.backend,i=t.device,s=t.get(this._getBufferAttribute(e)),r=s.buffer,n=r.size,a=s.readBuffer,o=!0;void 0===a&&(a=i.createBuffer({label:e.name,size:n,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=!1,s.readBuffer=a);let l=i.createCommandEncoder({});l.copyBufferToBuffer(r,0,a,0,n),o&&a.unmap();let h=l.finish();return i.queue.submit([h]),await a.mapAsync(GPUMapMode.READ),a.getMappedRange()}_getVertexFormat(e){let t;let{itemSize:i,normalized:s}=e,r=e.array.constructor,n=e.constructor;if(1==i)t=xg.get(r);else{let e=(xm.get(n)||xp.get(r))[s?1:0];if(e){let s=4*Math.floor((r.BYTES_PER_ELEMENT*i+3)/4)/r.BYTES_PER_ELEMENT;if(s%1)throw Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");t=`${e}x${s}`}}return t||console.error("THREE.WebGPUAttributeUtils: Vertex format not supported yet."),t}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}class xy{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){let t=this.backend.device,i=[],s=0;for(let t of e.bindings){let e={binding:s++,visibility:t.visibility};if(t.isUniformBuffer||t.isStorageBuffer){let i={};t.isStorageBuffer&&(i.type=t.access),e.buffer=i}else if(t.isSampler){let i={};t.texture.isDepthTexture&&null!==t.texture.compareFunction&&(i.type="comparison"),e.sampler=i}else if(t.isSampledTexture&&t.texture.isVideoTexture)e.externalTexture={};else if(t.isSampledTexture&&t.store){let i=this.backend.get(t.texture).texture.format,s=t.access;e.storageTexture={format:i,access:s}}else if(t.isSampledTexture){let i={};if(!0===t.texture.isMultisampleRenderTargetTexture&&(i.multisampled=!0),t.texture.isDepthTexture)i.sampleType=mY.Depth;else if(t.texture.isDataTexture||t.texture.isDataArrayTexture||t.texture.isData3DTexture){let e=t.texture.type;1013===e?i.sampleType=mY.SInt:1014===e?i.sampleType=mY.UInt:1015===e&&(this.backend.hasFeature("float32-filterable")?i.sampleType=mY.Float:i.sampleType=mY.UnfilterableFloat)}t.isSampledCubeTexture?i.viewDimension=mK.Cube:t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?i.viewDimension=mK.TwoDArray:t.isSampledTexture3D&&(i.viewDimension=mK.ThreeD),e.texture=i}else console.error(`WebGPUBindingUtils: Unsupported binding "${t}".`);i.push(e)}return t.createBindGroupLayout({entries:i})}createBindings(e){let{backend:t,bindGroupLayoutCache:i}=this,s=t.get(e),r=i.get(e.bindingsReference);void 0===r&&(r=this.createBindingsLayout(e),i.set(e.bindingsReference,r));let n=this.createBindGroup(e,r);s.layout=r,s.group=n}updateBinding(e){let t=this.backend,i=t.device,s=e.buffer,r=t.get(e).buffer;i.queue.writeBuffer(r,0,s,0)}createBindGroup(e,t){let i=this.backend,s=i.device,r=0,n=[];for(let t of e.bindings){if(t.isUniformBuffer){let e=i.get(t);if(void 0===e.buffer){let i=t.byteLength,r=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,n=s.createBuffer({label:"bindingBuffer_"+t.name,size:i,usage:r});e.buffer=n}n.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){let e=i.get(t);if(void 0===e.buffer){let s=t.attribute;e.buffer=i.get(s).buffer}n.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isSampler){let e=i.get(t.texture);n.push({binding:r,resource:e.sampler})}else if(t.isSampledTexture){let e;let a=i.get(t.texture);if(void 0!==a.externalTexture)e=s.importExternalTexture({source:a.externalTexture});else{let i=t.store?1:a.texture.mipLevelCount,s=`view-${a.texture.width}-${a.texture.height}-${i}`;if(void 0===(e=a[s])){let r;let n=mQ.All;r=t.isSampledCubeTexture?mK.Cube:t.isSampledTexture3D?mK.ThreeD:t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?mK.TwoDArray:mK.TwoD,e=a[s]=a.texture.createView({aspect:n,dimension:r,mipLevelCount:i})}}n.push({binding:r,resource:e})}r++}return s.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:n})}}class xx{constructor(e){this.backend=e}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){let i;let{object:s,material:r,geometry:n,pipeline:a}=e,{vertexProgram:o,fragmentProgram:l}=a,h=this.backend,u=h.device,d=h.utils,c=h.get(a),p=[];for(let t of e.getBindings()){let e=h.get(t);p.push(e.layout)}let m=h.attributeUtils.createShaderVertexBuffers(e);!0===r.transparent&&0!==r.blending&&(i=this._getBlending(r));let g={};!0===r.stencilWrite&&(g={compare:this._getStencilCompare(r),failOp:this._getStencilOperation(r.stencilFail),depthFailOp:this._getStencilOperation(r.stencilZFail),passOp:this._getStencilOperation(r.stencilZPass)});let f=this._getColorWriteMask(r),y=[];if(null!==e.context.textures){let t=e.context.textures;for(let e=0;e<t.length;e++){let s=d.getTextureFormatGPU(t[e]);y.push({format:s,blend:i,writeMask:f})}}else{let t=d.getCurrentColorFormat(e.context);y.push({format:t,blend:i,writeMask:f})}let x=h.get(o).module,b=h.get(l).module,v=this._getPrimitiveState(s,n,r),T=this._getDepthCompare(r),S=d.getCurrentDepthStencilFormat(e.context),_=this._getSampleCount(e.context),M={label:`renderPipeline_${r.name||r.type}_${r.id}`,vertex:Object.assign({},x,{buffers:m}),fragment:Object.assign({},b,{targets:y}),primitive:v,depthStencil:{format:S,depthWriteEnabled:r.depthWrite,depthCompare:T,stencilFront:g,stencilBack:{},stencilReadMask:r.stencilFuncMask,stencilWriteMask:r.stencilWriteMask},multisample:{count:_,alphaToCoverageEnabled:r.alphaToCoverage},layout:u.createPipelineLayout({bindGroupLayouts:p})};if(null===t)c.pipeline=u.createRenderPipeline(M);else{let e=new Promise(e=>{u.createRenderPipelineAsync(M).then(t=>{c.pipeline=t,e()})});t.push(e)}}createBundleEncoder(e){let{utils:t,device:i}=this.backend,s=t.getCurrentDepthStencilFormat(e),r=t.getCurrentColorFormat(e),n=this._getSampleCount(e);return i.createRenderBundleEncoder({label:"renderBundleEncoder",colorFormats:[r],depthStencilFormat:s,sampleCount:n})}createComputePipeline(e,t){let i=this.backend,s=i.device,r=i.get(e.computeProgram).module,n=i.get(e),a=[];for(let e of t){let t=i.get(e);a.push(t.layout)}n.pipeline=s.createComputePipeline({compute:r,layout:s.createPipelineLayout({bindGroupLayouts:a})})}_getBlending(e){let t,i;let s=e.blending,r=e.blendSrc,n=e.blendDst,a=e.blendEquation;if(5===s){let s=null!==e.blendSrcAlpha?e.blendSrcAlpha:r,o=null!==e.blendDstAlpha?e.blendDstAlpha:n,l=null!==e.blendEquationAlpha?e.blendEquationAlpha:a;t={srcFactor:this._getBlendFactor(r),dstFactor:this._getBlendFactor(n),operation:this._getBlendOperation(a)},i={srcFactor:this._getBlendFactor(s),dstFactor:this._getBlendFactor(o),operation:this._getBlendOperation(l)}}else{let r=e.premultipliedAlpha,n=(e,s,r,n)=>{t={srcFactor:e,dstFactor:s,operation:mH.Add},i={srcFactor:r,dstFactor:n,operation:mH.Add}};if(r)switch(s){case 1:n(mW.One,mW.OneMinusSrcAlpha,mW.One,mW.OneMinusSrcAlpha);break;case 2:n(mW.One,mW.One,mW.One,mW.One);break;case 3:n(mW.Zero,mW.OneMinusSrc,mW.Zero,mW.One);break;case 4:n(mW.Zero,mW.Src,mW.Zero,mW.SrcAlpha)}else switch(s){case 1:n(mW.SrcAlpha,mW.OneMinusSrcAlpha,mW.One,mW.OneMinusSrcAlpha);break;case 2:n(mW.SrcAlpha,mW.One,mW.SrcAlpha,mW.One);break;case 3:n(mW.Zero,mW.OneMinusSrc,mW.Zero,mW.One);break;case 4:n(mW.Zero,mW.Src,mW.Zero,mW.Src)}}if(void 0!==t&&void 0!==i)return{color:t,alpha:i};console.error("THREE.WebGPURenderer: Invalid blending: ",s)}_getBlendFactor(e){let t;switch(e){case 200:t=mW.Zero;break;case 201:t=mW.One;break;case 202:t=mW.Src;break;case 203:t=mW.OneMinusSrc;break;case 204:t=mW.SrcAlpha;break;case 205:t=mW.OneMinusSrcAlpha;break;case 208:t=mW.Dst;break;case 209:t=mW.OneMinusDstColor;break;case 206:t=mW.DstAlpha;break;case 207:t=mW.OneMinusDstAlpha;break;case 210:t=mW.SrcAlphaSaturated;break;case 211:t=mW.Constant;break;case 212:t=mW.OneMinusConstant;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t}_getStencilCompare(e){let t;let i=e.stencilFunc;switch(i){case 512:t=mF.Never;break;case 519:t=mF.Always;break;case 513:t=mF.Less;break;case 515:t=mF.LessEqual;break;case 514:t=mF.Equal;break;case 518:t=mF.GreaterEqual;break;case 516:t=mF.Greater;break;case 517:t=mF.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",i)}return t}_getStencilOperation(e){let t;switch(e){case 7680:t=m$.Keep;break;case 0:t=m$.Zero;break;case 7681:t=m$.Replace;break;case 5386:t=m$.Invert;break;case 7682:t=m$.IncrementClamp;break;case 7683:t=m$.DecrementClamp;break;case 34055:t=m$.IncrementWrap;break;case 34056:t=m$.DecrementWrap;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t}_getBlendOperation(e){let t;switch(e){case 100:t=mH.Add;break;case 101:t=mH.Subtract;break;case 102:t=mH.ReverseSubtract;break;case 103:t=mH.Min;break;case 104:t=mH.Max;break;default:console.error("THREE.WebGPUPipelineUtils: Blend equation not supported.",e)}return t}_getPrimitiveState(e,t,i){let s={},r=this.backend.utils;switch(s.topology=r.getPrimitiveTopology(e,i),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(s.stripIndexFormat=t.index.array instanceof Uint16Array?mD.Uint16:mD.Uint32),i.side){case 0:s.frontFace=mz.CCW,s.cullMode=mL.Back;break;case 1:s.frontFace=mz.CCW,s.cullMode=mL.Front;break;case 2:s.frontFace=mz.CCW,s.cullMode=mL.None;break;default:console.error("THREE.WebGPUPipelineUtils: Unknown material.side value.",i.side)}return s}_getColorWriteMask(e){return!0===e.colorWrite?mj.All:mj.None}_getDepthCompare(e){let t;if(!1===e.depthTest)t=mF.Always;else{let i=e.depthFunc;switch(i){case 0:t=mF.Never;break;case 1:t=mF.Always;break;case 2:t=mF.Less;break;case 3:t=mF.LessEqual;break;case 4:t=mF.Equal;break;case 5:t=mF.GreaterEqual;break;case 6:t=mF.Greater;break;case 7:t=mF.NotEqual;break;default:console.error("THREE.WebGPUPipelineUtils: Invalid depth function.",i)}}return t}}class xb extends yP{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=void 0===e.alpha||e.alpha,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.trackTimestamp=!0===e.trackTimestamp,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new xc(this),this.attributeUtils=new xf(this),this.bindingUtils=new xy(this),this.pipelineUtils=new xx(this),this.textureUtils=new y6(this),this.occludedResolveCache=new Map}async init(e){let t;await super.init(e);let i=this.parameters;if(void 0===i.device){let e={powerPreference:i.powerPreference},s=await navigator.gpu.requestAdapter(e);if(null===s)throw Error("WebGPUBackend: Unable to create WebGPU adapter.");let r=Object.values(m0),n=[];for(let e of r)s.features.has(e)&&n.push(e);let a={requiredFeatures:n,requiredLimits:i.requiredLimits};t=await s.requestDevice(a)}else t=i.device;let s=void 0!==i.context?i.context:e.domElement.getContext("webgpu");this.device=t,this.context=s;let r=i.alpha?"premultiplied":"opaque";this.trackTimestamp=this.trackTimestamp&&this.hasFeature(m0.TimestampQuery),this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:r}),this.updateSize()}get coordinateSystem(){return 2001}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(null===e){let t=this.renderer,i=(e={colorAttachments:[{view:null}],depthStencilAttachment:{view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()}}).colorAttachments[0];this.renderer.samples>0?i.view=this.colorBuffer.createView():i.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}let t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_getRenderPassDescriptor(e){let t=e.renderTarget,i=this.get(t),s=i.descriptors;if(void 0===s||i.width!==t.width||i.height!==t.height||i.activeMipmapLevel!==t.activeMipmapLevel||i.samples!==t.samples){s={},i.descriptors=s;let e=()=>{t.removeEventListener("dispose",e),this.delete(t)};t.addEventListener("dispose",e)}let r=e.getCacheKey(),n=s[r];if(void 0===n){let a=e.textures,o=[];for(let t=0;t<a.length;t++){let i,s;let r=this.get(a[t]),n=r.texture.createView({baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,dimension:mK.TwoD});void 0!==r.msaaTexture?(i=r.msaaTexture.createView(),s=n):(i=n,s=void 0),o.push({view:i,resolveTarget:s,loadOp:mO.Load,storeOp:mU.Store})}n={colorAttachments:o,depthStencilAttachment:{view:this.get(e.depthTexture).texture.createView()}},s[r]=n,i.width=t.width,i.height=t.height,i.samples=t.samples,i.activeMipmapLevel=t.activeMipmapLevel}return n}beginRender(e){let t,i;let s=this.get(e),r=this.device,n=e.occlusionQueryCount;n>0&&(s.currentOcclusionQuerySet&&s.currentOcclusionQuerySet.destroy(),s.currentOcclusionQueryBuffer&&s.currentOcclusionQueryBuffer.destroy(),s.currentOcclusionQuerySet=s.occlusionQuerySet,s.currentOcclusionQueryBuffer=s.occlusionQueryBuffer,s.currentOcclusionQueryObjects=s.occlusionQueryObjects,t=r.createQuerySet({type:"occlusion",count:n}),s.occlusionQuerySet=t,s.occlusionQueryIndex=0,s.occlusionQueryObjects=Array(n),s.lastOcclusionObject=null),i=null===e.textures?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e),this.initTimestampQuery(e,i),i.occlusionQuerySet=t;let a=i.depthStencilAttachment;if(null!==e.textures){let t=i.colorAttachments;for(let i=0;i<t.length;i++){let s=t[i];e.clearColor?(s.clearValue=0===i?e.clearColorValue:{r:0,g:0,b:0,a:1},s.loadOp=mO.Clear):s.loadOp=mO.Load,s.storeOp=mU.Store}}else{let t=i.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=mO.Clear):t.loadOp=mO.Load,t.storeOp=mU.Store}e.depth&&(e.clearDepth?(a.depthClearValue=e.clearDepthValue,a.depthLoadOp=mO.Clear):a.depthLoadOp=mO.Load,a.depthStoreOp=mU.Store),e.stencil&&(e.clearStencil?(a.stencilClearValue=e.clearStencilValue,a.stencilLoadOp=mO.Clear):a.stencilLoadOp=mO.Load,a.stencilStoreOp=mU.Store);let o=r.createCommandEncoder({label:"renderContext_"+e.id}),l=o.beginRenderPass(i);if(s.descriptor=i,s.encoder=o,s.currentPass=l,s.currentSets={attributes:{},pipeline:null,index:null},s.renderBundles=[],e.viewport&&this.updateViewport(e),e.scissor){let{x:t,y:i,width:s,height:r}=e.scissorValue;l.setScissorRect(t,i,s,r)}}finishRender(e){let t=this.get(e),i=e.occlusionQueryCount;if(t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),i>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery(),t.currentPass.end(),i>0){let s=8*i,r=this.occludedResolveCache.get(s);void 0===r&&(r=this.device.createBuffer({size:s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(s,r));let n=this.device.createBuffer({size:s,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,i,r,0),t.encoder.copyBufferToBuffer(r,0,n,0,s),t.occlusionQueryBuffer=n,this.resolveOccludedAsync(e)}if(this.prepareTimestampBuffer(e,t.encoder),this.device.queue.submit([t.encoder.finish()]),null!==e.textures){let t=e.textures;for(let e=0;e<t.length;e++){let i=t[e];!0===i.generateMipmaps&&this.textureUtils.generateMipmaps(i)}}}isOccluded(e,t){let i=this.get(e);return i.occluded&&i.occluded.has(t)}async resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueryBuffer:i,currentOcclusionQueryObjects:s}=t;if(i&&s){let e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await i.mapAsync(GPUMapMode.READ);let r=new BigUint64Array(i.getMappedRange());for(let t=0;t<s.length;t++)r[t]!==BigInt(0)&&e.add(s[t]);i.destroy(),t.occluded=e}}updateViewport(e){let{currentPass:t}=this.get(e),{x:i,y:s,width:r,height:n,minDepth:a,maxDepth:o}=e.viewportValue;t.setViewport(i,s,r,n,a,o)}clear(e,t,i,s=null){let r,n,a,o;let l=this.device,h=this.renderer,u=[];if(e){let e=this.getClearColor();if(!0===this.renderer.alpha){let t=e.a;n={r:e.r*t,g:e.g*t,b:e.b*t,a:t}}else n={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===s){a=h.depth,o=h.stencil;let t=this._getDefaultRenderPassDescriptor();if(e){let e=(u=t.colorAttachments)[0];e.clearValue=n,e.loadOp=mO.Clear,e.storeOp=mU.Store}(a||o)&&(r=t.depthStencilAttachment)}else{if(a=s.depth,o=s.stencil,e)for(let e of s.textures){let t,i;let s=this.get(e),r=s.texture.createView();void 0!==s.msaaTexture?(t=s.msaaTexture.createView(),i=r):(t=r,i=void 0),u.push({view:t,resolveTarget:i,clearValue:n,loadOp:mO.Clear,storeOp:mU.Store})}(a||o)&&(r={view:this.get(s.depthTexture).texture.createView()})}a&&(t?(r.depthLoadOp=mO.Clear,r.depthClearValue=h.getClearDepth()):r.depthLoadOp=mO.Load,r.depthStoreOp=mU.Store),o&&(i?(r.stencilLoadOp=mO.Clear,r.stencilClearValue=h.getClearStencil()):r.stencilLoadOp=mO.Load,r.stencilStoreOp=mU.Store);let d=l.createCommandEncoder({});d.beginRenderPass({colorAttachments:u,depthStencilAttachment:r}).end(),l.queue.submit([d.finish()])}beginCompute(e){let t=this.get(e),i={};this.initTimestampQuery(e,i),t.cmdEncoderGPU=this.device.createCommandEncoder(),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(i)}compute(e,t,i,s){let{passEncoderGPU:r}=this.get(e),n=this.get(s).pipeline;r.setPipeline(n);for(let e=0,t=i.length;e<t;e++){let t=i[e],s=this.get(t);r.setBindGroup(e,s.group)}let a=this.device.limits.maxComputeWorkgroupsPerDimension,o=this.get(t);void 0===o.dispatchSize&&(o.dispatchSize={x:0,y:1,z:1});let{dispatchSize:l}=o;t.dispatchCount>a?(l.x=Math.min(t.dispatchCount,a),l.y=Math.ceil(t.dispatchCount/a)):l.x=t.dispatchCount,r.dispatchWorkgroups(l.x,l.y,l.z)}finishCompute(e){let t=this.get(e);t.passEncoderGPU.end(),this.prepareTimestampBuffer(e,t.cmdEncoderGPU),this.device.queue.submit([t.cmdEncoderGPU.finish()])}draw(e,t){let{object:i,geometry:s,context:r,pipeline:n}=e,a=e.getBindings(),o=this.get(r),l=this.get(n).pipeline,h=o.currentSets,u=o.currentPass;h.pipeline!==l&&(u.setPipeline(l),h.pipeline=l);for(let e=0,t=a.length;e<t;e++){let t=a[e],i=this.get(t);u.setBindGroup(t.index,i.group)}let d=e.getIndex(),c=null!==d;if(!0===c&&h.index!==d){let e=this.get(d).buffer,t=d.array instanceof Uint16Array?mD.Uint16:mD.Uint32;u.setIndexBuffer(e,t),h.index=d}let p=e.getVertexBuffers();for(let e=0,t=p.length;e<t;e++){let t=p[e];if(h.attributes[e]!==t){let i=this.get(t).buffer;u.setVertexBuffer(e,i),h.attributes[e]=t}}if(void 0!==o.occlusionQuerySet){let e=o.lastOcclusionObject;e!==i&&(null!==e&&!0===e.occlusionTest&&(u.endOcclusionQuery(),o.occlusionQueryIndex++),!0===i.occlusionTest&&(u.beginOcclusionQuery(o.occlusionQueryIndex),o.occlusionQueryObjects[o.occlusionQueryIndex]=i),o.lastOcclusionObject=i)}let m=e.drawRange,g=m.start,f=this.getInstanceCount(e);if(0!==f){if(!0===i.isBatchedMesh){let e=i._multiDrawStarts,t=i._multiDrawCounts,s=i._multiDrawCount,r=i._multiDrawInstances,n=c?d.array.BYTES_PER_ELEMENT:1;for(let i=0;i<s;i++){let s=r?r[i]:1,a=s>1?0:i;u.drawIndexed(t[i],s,e[i]/n,0,a)}}else if(!0===c){let e=m.count!==1/0?m.count:d.count;u.drawIndexed(e,f,g,0,0),t.update(i,e,f)}else{let e=s.attributes.position,r=m.count!==1/0?m.count:e.count;u.draw(r,f,g,0),t.update(i,r,f)}}}needsRenderUpdate(e){let t=this.get(e),{object:i,material:s}=e,r=this.utils,n=r.getSampleCountRenderContext(e.context),a=r.getCurrentColorSpace(e.context),o=r.getCurrentColorFormat(e.context),l=r.getCurrentDepthStencilFormat(e.context),h=r.getPrimitiveTopology(i,s),u=!1;return(t.material!==s||t.materialVersion!==s.version||t.transparent!==s.transparent||t.blending!==s.blending||t.premultipliedAlpha!==s.premultipliedAlpha||t.blendSrc!==s.blendSrc||t.blendDst!==s.blendDst||t.blendEquation!==s.blendEquation||t.blendSrcAlpha!==s.blendSrcAlpha||t.blendDstAlpha!==s.blendDstAlpha||t.blendEquationAlpha!==s.blendEquationAlpha||t.colorWrite!==s.colorWrite||t.depthWrite!==s.depthWrite||t.depthTest!==s.depthTest||t.depthFunc!==s.depthFunc||t.stencilWrite!==s.stencilWrite||t.stencilFunc!==s.stencilFunc||t.stencilFail!==s.stencilFail||t.stencilZFail!==s.stencilZFail||t.stencilZPass!==s.stencilZPass||t.stencilFuncMask!==s.stencilFuncMask||t.stencilWriteMask!==s.stencilWriteMask||t.side!==s.side||t.alphaToCoverage!==s.alphaToCoverage||t.sampleCount!==n||t.colorSpace!==a||t.colorFormat!==o||t.depthStencilFormat!==l||t.primitiveTopology!==h||t.clippingContextCacheKey!==e.clippingContext.cacheKey)&&(t.material=s,t.materialVersion=s.version,t.transparent=s.transparent,t.blending=s.blending,t.premultipliedAlpha=s.premultipliedAlpha,t.blendSrc=s.blendSrc,t.blendDst=s.blendDst,t.blendEquation=s.blendEquation,t.blendSrcAlpha=s.blendSrcAlpha,t.blendDstAlpha=s.blendDstAlpha,t.blendEquationAlpha=s.blendEquationAlpha,t.colorWrite=s.colorWrite,t.depthWrite=s.depthWrite,t.depthTest=s.depthTest,t.depthFunc=s.depthFunc,t.stencilWrite=s.stencilWrite,t.stencilFunc=s.stencilFunc,t.stencilFail=s.stencilFail,t.stencilZFail=s.stencilZFail,t.stencilZPass=s.stencilZPass,t.stencilFuncMask=s.stencilFuncMask,t.stencilWriteMask=s.stencilWriteMask,t.side=s.side,t.alphaToCoverage=s.alphaToCoverage,t.sampleCount=n,t.colorSpace=a,t.colorFormat=o,t.depthStencilFormat=l,t.primitiveTopology=h,t.clippingContextCacheKey=e.clippingContext.cacheKey,u=!0),u}getRenderCacheKey(e){let{object:t,material:i}=e,s=this.utils,r=e.context;return[i.transparent,i.blending,i.premultipliedAlpha,i.blendSrc,i.blendDst,i.blendEquation,i.blendSrcAlpha,i.blendDstAlpha,i.blendEquationAlpha,i.colorWrite,i.depthWrite,i.depthTest,i.depthFunc,i.stencilWrite,i.stencilFunc,i.stencilFail,i.stencilZFail,i.stencilZPass,i.stencilFuncMask,i.stencilWriteMask,i.side,s.getSampleCountRenderContext(r),s.getCurrentColorSpace(r),s.getCurrentColorFormat(r),s.getCurrentDepthStencilFormat(r),s.getPrimitiveTopology(t,i),e.clippingContext.cacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}copyTextureToBuffer(e,t,i,s,r){return this.textureUtils.copyTextureToBuffer(e,t,i,s,r)}initTimestampQuery(e,t){if(!this.trackTimestamp)return;let i=this.get(e);if(!i.timeStampQuerySet){let e=this.device.createQuerySet({type:"timestamp",count:2});Object.assign(t,{timestampWrites:{querySet:e,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}}),i.timeStampQuerySet=e}}prepareTimestampBuffer(e,t){if(!this.trackTimestamp)return;let i=this.get(e),s=2*BigInt64Array.BYTES_PER_ELEMENT;void 0===i.currentTimestampQueryBuffers&&(i.currentTimestampQueryBuffers={resolveBuffer:this.device.createBuffer({label:"timestamp resolve buffer",size:s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),resultBuffer:this.device.createBuffer({label:"timestamp result buffer",size:s,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),isMappingPending:!1});let{resolveBuffer:r,resultBuffer:n,isMappingPending:a}=i.currentTimestampQueryBuffers;!0!==a&&(t.resolveQuerySet(i.timeStampQuerySet,0,2,r,0),t.copyBufferToBuffer(r,0,n,0,s))}async resolveTimestampAsync(e,t="render"){if(!this.trackTimestamp)return;let i=this.get(e);if(void 0===i.currentTimestampQueryBuffers)return;let{resultBuffer:s,isMappingPending:r}=i.currentTimestampQueryBuffers;!0!==r&&(i.currentTimestampQueryBuffers.isMappingPending=!0,s.mapAsync(GPUMapMode.READ).then(()=>{let e=new BigUint64Array(s.getMappedRange()),r=Number(e[1]-e[0])/1e6;this.renderer.info.updateTimestamp(t,r),s.unmap(),i.currentTimestampQueryBuffers.isMappingPending=!1}))}createNodeBuilder(e,t){return new xd(e,t)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){let t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){let i=this.get(e),s=i.currentPass.finish();this.get(t).bundleGPU=s,i.currentSets=i._currentSets,i.currentPass=i._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e){this.bindingUtils.createBindings(e)}updateBindings(e){this.bindingUtils.createBindings(e)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,i=null,s=null,r=0){let n=0,a=0,o=0,l=0,h=e.image.width,u=e.image.height;null!==i&&(o=i.x,l=i.y,h=i.width,u=i.height),null!==s&&(n=s.x,a=s.y);let d=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),c=this.get(e).texture,p=this.get(t).texture;d.copyTextureToTexture({texture:c,mipLevel:r,origin:{x:o,y:l,z:0}},{texture:p,mipLevel:r,origin:{x:n,y:a,z:0}},[h,u]),this.device.queue.submit([d.finish()])}copyFramebufferToTexture(e,t){let i=this.get(t),{encoder:s,descriptor:r}=i,n=null;n=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();let a=this.get(e).texture;if(n.format!==a.format){console.error("WebGPUBackend: copyFramebufferToTexture: Source and destination formats do not match.",n.format,a.format);return}i.currentPass.end(),s.copyTextureToTexture({texture:n,origin:{x:0,y:0,z:0}},{texture:a},[e.image.width,e.image.height]),e.generateMipmaps&&this.textureUtils.generateMipmaps(e);for(let e=0;e<r.colorAttachments.length;e++)r.colorAttachments[e].loadOp=mO.Load;t.depth&&(r.depthStencilAttachment.depthLoadOp=mO.Load),t.stencil&&(r.depthStencilAttachment.stencilLoadOp=mO.Load),i.currentPass=s.beginRenderPass(r),i.currentSets={attributes:{},pipeline:null,index:null}}}class xv extends yd{constructor(e={}){let t;e.forceWebGL?t=yK:(t=xb,e.getFallback=()=>(console.warn("THREE.WebGPURenderer: WebGPU is not available, running under WebGL2 backend."),new yK(e))),super(new t(e),e),this.isWebGPURenderer=!0}}class xT extends V{constructor(e=1,t=1){super(),this.image={width:e,height:t},this.magFilter=1006,this.minFilter=1006,this.isStorageTexture=!0}}class xS extends t7{constructor(e,t,i=Float32Array){!1===ArrayBuffer.isView(e)&&(e=new i(e*t)),super(e,t),this.isStorageInstancedBufferAttribute=!0}}let x_=cR.createMaterialFromType;cR.createMaterialFromType=function(e){let t=function(e){let t=hG.get(e);if(void 0!==t)return new t}(e);return void 0!==t?t:x_.call(this,e)},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"168"}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__="168")}}]);